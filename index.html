<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Del√≠cias Urbanas - App de Pedidos com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Lobster Two', cursive; }
        .menu-option-card:has(input:checked) { border-color: #2563eb; background-color: #eff6ff; transform: scale(1.02); }
        .menu-option-card:has(input:checked) .checkmark { opacity: 1; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-height: 90vh; overflow-y: auto; width: 90%; max-width: 500px; }
        input:read-only { background-color: #f3f4f6; cursor: not-allowed; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-20">
        
        <div id="user-view">
            <div id="form-container">
                <header class="text-center mb-8"><h1 class="font-brand text-5xl text-blue-600">Del√≠cias Urbanas</h1><p class="mt-2 text-md text-gray-500">O seu card√°pio da semana est√° servido!</p></header>
                
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h2 class="block text-lg font-semibold text-gray-800 mb-2">üëã 1. Identifica√ß√£o</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div><label for="employeeRGF" class="block text-sm font-medium text-gray-700">Seu RGF</label><input type="text" id="employeeRGF" placeholder="Digite o seu RGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                        <div><label for="employeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="employeeName" placeholder="Preenchido automaticamente" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">üçî 2. Escolha os seus pratos</h2><div id="menu" class="space-y-8"><div class="text-center text-gray-500">A carregar o card√°pio...</div></div></div>
                <div id="guidanceSection" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6"><p id="guidanceText" class="font-semibold">Digite seu RGF e escolha uma op√ß√£o para cada dia.</p></div>
                <div id="submitButtonContainer" class="hidden text-center"><button id="openConfirmationModal" class="w-full sm:w-auto bg-green-500 text-white font-bold text-lg px-8 py-3 rounded-xl hover:bg-green-600 shadow-lg">Revisar e Finalizar Pedido</button></div>
            </div>
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Fazer Novo Pedido</button></div>
            <footer class="text-center mt-10">
                <button id="switchToAdmin" class="text-sm text-gray-500 hover:text-blue-600">Aceder ao Painel do Administrador</button>
            </footer>
        </div>

        <div id="admin-view" class="hidden">
            <header class="text-center border-b pb-6 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Painel do Administrador</h1>
                <p class="text-lg text-gray-600 mt-1">Del√≠cias Urbanas</p>
                <div class="mt-4"><button id="adminLogoutBtn" class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600">Sair do Painel</button></div>
            </header>
            
            <section id="order-status-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Status dos Pedidos da Semana</h2>
                <div id="status-loader" class="text-center text-gray-500">A verificar status...</div>
                <div id="status-container" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-lg text-green-600 mb-2">‚úÖ Pedidos Feitos</h3>
                        <ul id="ordered-list" class="space-y-1 text-sm list-disc list-inside"></ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-red-600 mb-2">‚ùå Pendentes</h3>
                        <ul id="not-ordered-list" class="space-y-1 text-sm list-disc list-inside"></ul>
                    </div>
                </div>
                <div id="report-button-container" class="hidden text-center mt-6">
                    <p class="text-green-600 font-semibold mb-2">üéâ Todos os pedidos foram recebidos!</p>
                    <button id="generateReportBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">üñ®Ô∏è Gerar Relat√≥rio Final</button>
                </div>
            </section>

            <section id="employee-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üë• Gerenciamento de Funcion√°rios</h2>
                <form id="add-employee-form" class="grid sm:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="newEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label>
                        <input type="text" id="newEmployeeRGF" placeholder="RGF do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="newEmployeeName" placeholder="Nome do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Funcion√°rio</button>
                </form>
                <div id="employee-list-container" class="overflow-x-auto"></div>
            </section>

            <section id="menu-updater-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-4">üçú Atualizar Card√°pio com Imagem (IA)</h2>
                <p class="text-gray-600 mb-4">Envie uma imagem do novo card√°pio. A nossa intelig√™ncia artificial ir√° ler e preencher os campos para si.</p>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <div id="loader" class="hidden mx-auto my-4 loader"></div>
                <div id="confirmation-form" class="hidden mt-6"></div>
            </section>
            
            <section id="orders-section">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Hist√≥rico de Pedidos</h2>
                    <div class="w-full sm:w-auto"><input type="text" id="searchInput" placeholder="üîé Buscar por nome..." class="w-full sm:w-64 px-4 py-2 border rounded-lg"></div>
                </div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden"><div class="modal-content fade-in"><h2 class="text-2xl font-bold mb-4">Confirme o seu Pedido</h2><p class="mb-6 text-gray-600">Por favor, revise as suas escolhas antes de enviar.</p><div id="confirmation-summary" class="space-y-2 mb-8"></div><div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Editar</button><button id="submitOrder" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">Confirmar e Enviar</button></div></div></div>
    <div id="admin-login-modal" class="modal-overlay hidden"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Aceder ao Painel de Administrador</h2><form id="admin-login-form"><div class="mb-4"><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="adminEmail" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="adminPassword" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="adminPassword" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Entrar</button></div></form></div></div>
    <div id="announce-menu-modal" class="modal-overlay hidden"><div class="modal-content text-center"><h2 class="text-2xl font-bold mb-2 text-green-600">Card√°pio Atualizado!</h2><p class="mb-6 text-gray-600">Lembre a equipe de fazer os pedidos.</p><button id="announce-whatsapp-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 text-lg">üì¢ Anunciar no WhatsApp</button><button class="cancel-modal-btn mt-3 text-sm text-gray-500">Fechar</button></div></div>
    
    <div id="app-toast"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI",
            authDomain: "cardapio-8ddea.firebaseapp.com",
            projectId: "cardapio-8ddea",
            storageBucket: "cardapio-8ddea.firebasestorage.app",
            messagingSenderId: "1019677985212",
            appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- CONSTANTES E ESTADO ---
        const menuDocRef = doc(db, "cardapio", "semanal");
        const pedidosCollectionRef = collection(db, "pedidosDaSemana");
        const funcionariosCollectionRef = collection(db, "funcionarios");
        const fixedOptions = [{ name: 'Omelete', emoji: 'üç≥' }, { name: 'Fil√© de frango', emoji: 'üçó' }];
        let weeklyMenu = [];
        let allOrders = [];
        let allEmployees = [];
        let tempOrderData = {};
        let unsubscribeStatusListener = null; 
        
        // --- FUN√á√ïES AUXILIARES ---
        function getDayId(dayName) { return dayName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, "").toLowerCase(); }
        
        function getWeekId(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            return new Intl.DateTimeFormat('pt-BR', {
                year: '2-digit', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
            }).format(timestamp.toDate());
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('app-toast');
            if(!toast) return;
            toast.textContent = message;
            toast.className = 'show';
            toast.classList.add(type);
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, duration);
        }

        // --- GERENCIAMENTO DE FUNCION√ÅRIOS ---
        function loadAndRenderEmployees() {
            onSnapshot(query(funcionariosCollectionRef, orderBy("nome")), (snapshot) => {
                const container = document.getElementById('employee-list-container');
                allEmployees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (snapshot.empty) { container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum funcion√°rio cadastrado.</p>'; return; }
                let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">RGF</th><th class="py-2 px-3 border-b text-left">Nome</th></tr></thead><tbody>`;
                allEmployees.forEach(employee => {
                    tableHTML += `<tr><td class="py-2 px-3 border-b font-mono">${employee.id}</td><td class="py-2 px-3 border-b font-semibold">${employee.nome}</td></tr>`;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            });
        }
        async function handleAddEmployee(e) {
            e.preventDefault();
            const rgf = document.getElementById('newEmployeeRGF').value.trim();
            const nome = document.getElementById('newEmployeeName').value.trim();
            if (!rgf || !nome) { showToast("Por favor, preencha o RGF e o Nome.", 'error'); return; }
            try {
                await setDoc(doc(db, "funcionarios", rgf), { nome });
                showToast("Funcion√°rio adicionado com sucesso!", 'success');
                e.target.reset();
            } catch (error) { showToast("Ocorreu um erro ao adicionar o funcion√°rio.", 'error'); }
        }
        async function findEmployeeByRGF(rgf) {
            const nameInput = document.getElementById('employeeName');
            if (!rgf) { nameInput.value = ''; validateForm(); return; }
            try {
                const docSnap = await getDoc(doc(db, "funcionarios", rgf));
                nameInput.value = docSnap.exists() ? docSnap.data().nome : '';
                validateForm();
            } catch (error) { showToast("Erro ao buscar funcion√°rio.", 'error'); }
        }

        // --- L√ìGICA DO CARD√ÅPIO E PEDIDOS ---
        function loadAndDisplayMenu() {
            onSnapshot(menuDocRef, (docSnap) => {
                weeklyMenu = (docSnap.exists() && docSnap.data().menu) ? docSnap.data().menu : [];
                createMenuHTML();
            });
        }
        function createMenuHTML() {
            const menuContainer = document.getElementById('menu');
            if (!menuContainer) return;
            menuContainer.innerHTML = weeklyMenu.length > 0 ? '' : '<div class="text-center text-gray-500">Card√°pio da semana n√£o dispon√≠vel.</div>';
            weeklyMenu.forEach(item => {
                const dayId = getDayId(item.day);
                let dayHTML = `<div class="day-section space-y-3">`;
                let headerContent = `<h3 class="text-xl font-bold text-gray-800">${item.day}</h3>`;
                
                if (item.isSpecial) {
                    headerContent = `<div class="flex items-center gap-3">${headerContent}<span class="text-sm font-semibold bg-amber-200 text-amber-800 px-3 py-1 rounded-full">‚ú® Almo√ßo Especial</span></div>`;
                }

                if (item.isHoliday) {
                    dayHTML += headerContent + `<div class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-md"><p class="font-bold">üéâ Feriado</p><p>N√£o haver√° refei√ß√£o neste dia.</p></div>`;
                } else {
                    dayHTML += headerContent;
                    if (item.guarnicao?.name) { dayHTML += `<div class="text-sm font-semibold text-blue-600 bg-blue-100 rounded-full inline-block px-3 py-1 mb-3">Guarni√ß√£o: ${item.guarnicao.name} ${item.guarnicao.emoji}</div>`; }
                    const allOptions = [ { ...item.pratoPrincipal, type: 'Prato Principal' }, ...(item.opcao?.name ? [{ ...item.opcao, type: 'Op√ß√£o do Dia' }] : []), ...fixedOptions.map(fixa => ({ ...fixa, type: 'Op√ß√£o Fixa' }))];
                    dayHTML += `<div class="space-y-3">`;
                    allOptions.forEach((option) => {
                        if (option.name) { dayHTML += `<label class="menu-option-card block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-transform duration-200"><input type="radio" name="${dayId}" value="${option.name}" class="hidden"><div class="flex items-center"><span class="text-3xl mr-4">${option.emoji}</span><div class="flex-grow"><p class="font-semibold text-gray-800">${option.name}</p><p class="text-sm text-gray-500">${option.type}</p></div><svg xmlns="http://www.w3.org/2000/svg" class="checkmark h-6 w-6 text-blue-600 opacity-0 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" /></svg></div></label>`; }
                    });
                    dayHTML += `</div><div class="mt-3"><textarea id="notes-${dayId}" name="notes-${dayId}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Anota√ß√µes? Ex: sem cebola..."></textarea></div>`;
                }
                dayHTML += `</div>`;
                menuContainer.innerHTML += dayHTML;
            });
            validateForm();
        }

        function validateForm() {
            const name = document.getElementById('employeeName')?.value.trim();
            const rgf = document.getElementById('employeeRGF')?.value.trim();
            const guidanceSection = document.getElementById('guidanceSection');
            const guidanceText = document.getElementById('guidanceText');
            const submitBtnContainer = document.getElementById('submitButtonContainer');
            if (!guidanceSection || !submitBtnContainer) return;

            const nonHolidayItems = weeklyMenu.filter(item => !item.isHoliday);
            const hasAllSelections = nonHolidayItems.length > 0 && nonHolidayItems.every(item => document.querySelector(`input[name="${getDayId(item.day)}"]:checked`));

            if (name && rgf && hasAllSelections) {
                guidanceSection.classList.add('hidden');
                submitBtnContainer.classList.remove('hidden');
            } else {
                submitBtnContainer.classList.add('hidden');
                guidanceSection.classList.remove('hidden');
                let message = 'Complete os passos para finalizar.';
                if(!rgf) message = 'Digite seu RGF para come√ßar.';
                else if(!name) message = 'RGF n√£o encontrado. Pe√ßa para um administrador cadastr√°-lo.';
                else if (!hasAllSelections) {
                    const missingDays = nonHolidayItems.filter(item => !document.querySelector(`input[name="${getDayId(item.day)}"]:checked`)).map(item => item.day);
                    if (missingDays.length > 0) message = `Falta selecionar op√ß√µes para: ${missingDays.join(', ')}.`;
                }
                guidanceText.textContent = message;
            }
        }

        function openConfirmationModal() {
            tempOrderData = {
                employeeName: document.getElementById('employeeName').value.trim(),
                employeeRGF: document.getElementById('employeeRGF').value.trim()
            };
            const summaryContainer = document.getElementById('confirmation-summary');
            summaryContainer.innerHTML = '';
            
            weeklyMenu.forEach(item => {
                if (item.isHoliday) return;
                const dayId = getDayId(item.day);
                const choice = document.querySelector(`input[name="${dayId}"]:checked`)?.value;
                const notes = document.getElementById(`notes-${dayId}`).value.trim();
                tempOrderData[dayId] = choice;
                if(notes) tempOrderData[`${dayId}_notes`] = notes;
                summaryContainer.innerHTML += `<p><span class="font-bold">${item.day}:</span> ${choice || 'N/A'} ${notes ? `<span class="text-sm text-gray-500 italic">(${notes})</span>` : ''}</p>`;
            });
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        async function submitOrder() {
            const button = document.getElementById('submitOrder');
            button.disabled = true; button.textContent = 'A enviar...';
            
            tempOrderData.createdAt = serverTimestamp();
            tempOrderData.weekId = getWeekId(new Date());

            try {
                const docId = `${tempOrderData.weekId}_${tempOrderData.employeeRGF}`;
                await setDoc(doc(db, "pedidosDaSemana", docId), tempOrderData, { merge: true });

                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-text').textContent = `Obrigado, ${tempOrderData.employeeName}. O seu pedido foi registado com sucesso.`;
                document.getElementById('success-message').classList.remove('hidden');
                showToast("Pedido enviado com sucesso!", 'success');
            } catch (error) {
                showToast("Ocorreu um erro ao enviar o seu pedido.", 'error');
            } finally {
                button.disabled = false; button.textContent = 'Confirmar e Enviar';
            }
        }
        
        // --- L√ìGICA DO PAINEL ADMIN ---
        function loadAdminData() {
            loadAndRenderEmployees();
            const q = query(pedidosCollectionRef, orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrdersTable(allOrders);
            });
            startStatusListener();
        }

        function renderOrdersTable(orders) {
            const container = document.getElementById('ordersTableContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredOrders = orders.filter(doc => doc.employeeName.toLowerCase().includes(searchTerm));

            if (filteredOrders.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum pedido encontrado.</p>'; return; }
            let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">Funcion√°rio</th><th class="py-2 px-3 border-b text-left">Data do Pedido</th><th class="py-2 px-3 border-b text-left">Semana</th></tr></thead><tbody>`;
            filteredOrders.forEach(order => {
                tableHTML += `<tr><td class="py-2 px-3 border-b font-bold">${order.employeeName}<br><span class="text-xs font-mono text-gray-500">${order.employeeRGF}</span></td><td class="py-2 px-3 border-b text-xs">${formatTimestamp(order.createdAt)}</td><td class="py-2 px-3 border-b text-xs">${order.weekId}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function startStatusListener() {
            if (unsubscribeStatusListener) unsubscribeStatusListener(); 

            const weekId = getWeekId(new Date());
            const q = query(pedidosCollectionRef, where("weekId", "==", weekId));

            unsubscribeStatusListener = onSnapshot(q, (snapshot) => {
                const orderedRGFs = new Set(snapshot.docs.map(doc => doc.data().employeeRGF));
                
                const orderedList = allEmployees.filter(emp => orderedRGFs.has(emp.id));
                const notOrderedList = allEmployees.filter(emp => !orderedRGFs.has(emp.id));

                const orderedListEl = document.getElementById('ordered-list');
                const notOrderedListEl = document.getElementById('not-ordered-list');
                
                orderedListEl.innerHTML = orderedList.length > 0 ? orderedList.map(e => `<li>${e.nome}</li>`).join('') : '<li class="text-gray-400">Ningu√©m fez pedido ainda.</li>';
                notOrderedListEl.innerHTML = notOrderedList.length > 0 ? notOrderedList.map(e => `<li>${e.nome}</li>`).join('') : '<li class="text-gray-400">Todos fizeram seus pedidos!</li>';
                
                document.getElementById('status-loader').classList.add('hidden');
                document.getElementById('status-container').classList.remove('hidden');

                if (notOrderedList.length === 0 && allEmployees.length > 0) {
                    document.getElementById('report-button-container').classList.remove('hidden');
                } else {
                    document.getElementById('report-button-container').classList.add('hidden');
                }
            });
        }
        
        function generateReportView() {
            const weekId = getWeekId(new Date());
            const weeklyOrders = allOrders.filter(o => o.weekId === weekId);
            if(weeklyOrders.length === 0 || weeklyMenu.length === 0) {
                showToast("N√£o h√° dados suficientes para gerar o relat√≥rio.", "error");
                return;
            }

            let reportHTML = `<h1>Relat√≥rio de Pedidos - Semana ${weekId}</h1>`;
            weeklyMenu.forEach(dayItem => {
                if (dayItem.isHoliday) return;
                const dayId = getDayId(dayItem.day);
                reportHTML += `<h2>${dayItem.day}</h2><table><thead><tr><th>RGF</th><th>Nome</th><th>Pedido</th></tr></thead><tbody>`;
                const dailyOrders = weeklyOrders.filter(o => o[dayId]).sort((a,b) => a.employeeName.localeCompare(b.employeeName));
                if(dailyOrders.length > 0) {
                    dailyOrders.forEach(order => {
                        let choice = order[dayId];
                        const notes = order[`${dayId}_notes`];
                        if (notes) choice += ` <small><i>(${notes})</i></small>`;
                        reportHTML += `<tr><td>${order.employeeRGF}</td><td>${order.employeeName}</td><td>${choice}</td></tr>`;
                    });
                } else {
                    reportHTML += '<tr><td colspan="3">Nenhum pedido para este dia.</td></tr>';
                }
                reportHTML += '</tbody></table>';
            });

            const reportWindow = window.open('', '_blank');
            const styles = `<style>body{font-family:sans-serif;margin:20px}h1{font-size:22pt;text-align:center;margin-bottom:20px}h2{font-size:16pt;margin-top:25px;margin-bottom:10px;border-bottom:1px solid #ccc;padding-bottom:5px}table{width:100%;border-collapse:collapse;font-size:10pt}th,td{border:1px solid #ccc;padding:6px;text-align:left}th{background-color:#f0f0f0}</style>`;
            reportWindow.document.write(`<html><head><title>Relat√≥rio da Semana ${weekId}</title>${styles}</head><body>${reportHTML}</body></html>`);
            reportWindow.document.close();
        }

        // --- ATUALIZA√á√ÉO DE CARD√ÅPIO POR IA ---
        document.getElementById('processImageBtn').addEventListener('click', async () => {
            document.getElementById('loader').classList.remove('hidden');
            const file = document.getElementById('imageUpload').files[0]; 
            if (!file) { showToast('Selecione um arquivo de imagem.', 'error'); return; }
            try {
                const compressedFile = await imageCompression(file, { maxSizeMB: 1, maxWidthOrHeight: 1920 });
                const base64ImageData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result.split(',')[1]);
                    reader.readAsDataURL(compressedFile);
                });
                
                const prompt = `Analise a imagem deste card√°pio semanal. Extraia as informa√ß√µes para cada dia (Segunda a Sexta). Para cada dia, identifique o 'Prato Principal', a 'Op√ß√£o' e a 'Guarni√ß√£o'. Adicionalmente, identifique se o dia √© um 'Almo√ßo Especial' (procurando por termos como 'especial', 'comemorativo', 'festivo') e se √© um 'Feriado'. Retorne um objeto JSON seguindo esta estrutura: {"menu": [{"day": "Segunda-feira", "isHoliday": false, "isSpecial": false, "pratoPrincipal": {"name": "Nome", "emoji": "üçõ"}, "opcao": {"name": "Nome", "emoji": "ü•ó"}, "guarnicao": {"name": "Nome", "emoji": "üçö"}}, ...]}. Se um campo n√£o existir, retorne o nome como string vazia. Atribua emojis apropriados. O JSON deve ser a √∫nica coisa na resposta.`;
                const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: compressedFile.type, data: base64ImageData } }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${firebaseConfig.apiKey}`; 

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const err = await response.json(); throw new Error(`API Error: ${err.error.message}`); }
                const result = await response.json();
                let textResponse = result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                const menuData = JSON.parse(textResponse);
                displayConfirmationForm(menuData.menu);
            } catch (error) { 
                showToast("Erro ao ler imagem com IA: " + error.message, 'error', 8000); 
            } finally { 
                document.getElementById('loader').classList.add('hidden');
            }
        });

        function displayConfirmationForm(menuData) {
            const container = document.getElementById('confirmation-form'); 
            container.innerHTML = '<h3 class="text-xl font-semibold mb-4">Confirme os Dados Extra√≠dos</h3>';
            menuData.forEach((item, index) => {
                container.innerHTML += `<div class="p-4 bg-gray-50 rounded-lg mb-4"><h4 class="font-bold">${item.day}</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2"><div><label class="block text-sm font-medium">Prato Principal</label><input type="text" id="prato-${index}" value="${item.pratoPrincipal.name || ''}" class="w-full border rounded p-1"></div><div><label class="block text-sm font-medium">Op√ß√£o</label><input type="text" id="opcao-${index}" value="${item.opcao.name || ''}" class="w-full border rounded p-1"></div><div><label class="block text-sm font-medium">Guarni√ß√£o</label><input type="text" id="guarnicao-${index}" value="${item.guarnicao.name || ''}" class="w-full border rounded p-1"></div></div><div class="mt-2 grid grid-cols-2 gap-4"><label class="flex items-center"><input type="checkbox" id="holiday-${index}" ${item.isHoliday ? 'checked' : ''} class="h-4 w-4"> <span class="ml-2 text-sm">Marcar como Feriado</span></label><label class="flex items-center"><input type="checkbox" id="special-${index}" ${item.isSpecial ? 'checked' : ''} class="h-4 w-4"> <span class="ml-2 text-sm">Marcar como Especial</span></label></div></div>`;
            });
            container.innerHTML += `<div class="text-center mt-4"><button id="saveNewMenuBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Salvar Novo Card√°pio</button></div>`;
            document.getElementById('saveNewMenuBtn').addEventListener('click', () => saveNewMenu(menuData));
        }
        
        async function saveNewMenu(menuData) {
             const newMenu = menuData.map((item, i) => ({ 
                 day: item.day, 
                 isHoliday: document.getElementById(`holiday-${i}`).checked,
                 isSpecial: document.getElementById(`special-${i}`).checked,
                 pratoPrincipal: { name: document.getElementById(`prato-${i}`).value.trim(), emoji: 'üçõ' }, 
                 opcao: { name: document.getElementById(`opcao-${i}`).value.trim(), emoji: 'ü•ó' }, 
                 guarnicao: { name: document.getElementById(`guarnicao-${i}`).value.trim(), emoji: 'üçö' },
             }));
             try { 
                 await setDoc(menuDocRef, { menu: newMenu }); 
                 showToast('Card√°pio atualizado com sucesso!', 'success'); 
                 document.getElementById('confirmation-form').classList.add('hidden');
                 document.getElementById('announce-menu-modal').classList.remove('hidden');
             } catch (error) { showToast("Erro ao salvar o novo card√°pio.", 'error'); }
        }

        // --- GEST√ÉO DE VIEWS E AUTENTICA√á√ÉO ---
        onAuthStateChanged(auth, (user) => {
            if (user && !user.isAnonymous) { 
                showAdminView();
            } else { 
                showUserView();
                if (!auth.currentUser) { signInAnonymously(auth).catch(console.error); }
            }
        });
        function showUserView() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            if (unsubscribeStatusListener) {
                unsubscribeStatusListener();
                unsubscribeStatusListener = null;
            }
            loadAndDisplayMenu(); 
        }
        function showAdminView() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            loadAdminData();
        }
        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { showToast("Email ou senha incorretos.", "error"); }
        }
        async function handleAdminLogout() {
            try { await signOut(auth); showToast("Logout bem-sucedido!", 'info'); } 
            catch (error) { showToast("Erro ao fazer logout.", 'error'); }
        }
        
        // --- INICIALIZA√á√ÉO E EVENTOS ---
        function main() {
            document.getElementById('employeeRGF').addEventListener('blur', (e) => findEmployeeByRGF(e.target.value));
            document.getElementById('menu').addEventListener('change', validateForm);
            document.getElementById('openConfirmationModal').addEventListener('click', openConfirmationModal);
            document.getElementById('submitOrder').addEventListener('click', submitOrder);
            
            document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.add('hidden')));

            document.getElementById('switchToAdmin').addEventListener('click', () => document.getElementById('admin-login-modal').classList.remove('hidden'));
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            
            document.getElementById('adminLogoutBtn').addEventListener('click', handleAdminLogout);
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('searchInput').addEventListener('input', () => renderOrdersTable(allOrders));
            document.getElementById('generateReportBtn').addEventListener('click', generateReportView);

            document.getElementById('announce-whatsapp-btn').addEventListener('click', () => {
                const appUrl = "https://netdiscada.github.io/Card-pio-Regional/";
                const message = encodeURIComponent(`Ol√°, equipe! üëã O delicioso card√°pio da semana j√° est√° dispon√≠vel no app Del√≠cias Urbanas. N√£o se esque√ßam de fazer seus pedidos! \n\n${appUrl}`);
                window.open(`whatsapp://send?text=${message}`, '_blank');
            });
        }

        main();
    </script
