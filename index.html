<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marmitas ‚Äì Multi-Regional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* utilidades simples */
    .btn{ @apply inline-flex items-center justify-center px-4 py-2 rounded-lg font-medium border; }
    .btn-primary{ @apply bg-blue-600 text-white border-blue-700 hover:bg-blue-700; }
    .btn-success{ @apply bg-green-600 text-white border-green-700 hover:bg-green-700; }
    .btn-danger{ @apply bg-red-600 text-white border-red-700 hover:bg-red-700; }
    .btn-outline{ @apply bg-white text-gray-800 border-gray-300 hover:bg-gray-50; }
    .chip{ @apply inline-block text-xs px-2 py-1 rounded bg-gray-100 border border-gray-200; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row gap-4 md:items-center md:justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">üç± Controle de Marmitas <span class="text-sm font-normal chip">Multi-Regional</span></h1>
        <p class="text-sm text-gray-600">GitHub Pages + Firebase Firestore (client-side)</p>
      </div>
      <div class="flex gap-2 items-center">
        <span id="auth-badge" class="chip">Visitante</span>
        <button id="btn-login" class="btn btn-outline text-sm">Entrar (Admin)</button>
        <button id="btn-logout" class="btn btn-outline text-sm hidden">Sair</button>
      </div>
    </header>

    <!-- Filtro de regional para Admin -->
    <section id="admin-toolbar" class="mt-6 hidden">
      <div class="flex flex-wrap items-center gap-3">
        <label class="text-sm font-medium">Regional:</label>
        <select id="region-filter" class="border rounded p-2"></select>
        <button id="btn-print-all" class="btn btn-primary hidden">Imprimir TODOS relat√≥rios</button>
        <span id="scope-chip" class="chip"></span>
      </div>
    </section>

    <!-- Status e Relat√≥rios -->
    <section id="order-status-section" class="mt-8">
      <h2 class="text-xl font-semibold mb-3">üìä Status de Pedidos da Semana</h2>
      <div id="order-status-container" class="grid md:grid-cols-2 gap-4"></div>
    </section>

    <!-- Pedido do funcion√°rio -->
    <section id="order-form-section" class="mt-10">
      <h2 class="text-xl font-semibold mb-3">Fazer meu pedido</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="bg-white rounded-xl border p-4">
          <div class="mb-2">
            <label class="block text-sm font-medium">RGF</label>
            <input id="inp-rgf" type="text" class="w-full border rounded p-2" placeholder="Ex: 12345" />
          </div>
          <div class="mb-2">
            <label class="block text-sm font-medium">Nome</label>
            <input id="inp-nome" type="text" class="w-full border rounded p-2" placeholder="Seu nome completo" />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium">Semana</label>
            <input id="inp-weekid" type="text" class="w-full border rounded p-2 bg-gray-50" disabled />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium">Itens (Seg‚ÄìSex)</label>
            <div class="grid grid-cols-5 gap-2 text-xs">
              <input id="seg" class="border rounded p-2" placeholder="Seg" />
              <input id="ter" class="border rounded p-2" placeholder="Ter" />
              <input id="qua" class="border rounded p-2" placeholder="Qua" />
              <input id="qui" class="border rounded p-2" placeholder="Qui" />
              <input id="sex" class="border rounded p-2" placeholder="Sex" />
            </div>
          </div>
          <div class="flex items-center gap-2 mb-4">
            <input id="chk-especial" type="checkbox" class="w-4 h-4" />
            <label for="chk-especial" class="text-sm">Pedido especial</label>
          </div>
          <div class="flex gap-2">
            <button id="btn-enviar" class="btn btn-success">Enviar pedido</button>
            <button id="btn-salvar-rascunho" class="btn btn-outline">Salvar rascunho</button>
          </div>
          <p id="form-hint" class="text-xs text-gray-500 mt-2">O sistema vai detectar automaticamente sua regional pelo seu RGF cadastrado.</p>
        </div>

        <!-- Painel de Funcion√°rios (Admin) -->
        <div id="admin-emps" class="bg-white rounded-xl border p-4 md:col-span-2 hidden">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Funcion√°rios</h3>
            <button id="btn-add-emp" class="btn btn-outline">Adicionar</button>
          </div>
          <div class="overflow-auto">
            <table class="w-full text-sm border-collapse">
              <thead class="bg-gray-100">
                <tr>
                  <th class="border p-2 text-left">RGF</th>
                  <th class="border p-2 text-left">Nome</th>
                  <th class="border p-2 text-left">Regional</th>
                  <th class="border p-2 text-left">Ativo</th>
                  <th class="border p-2"></th>
                </tr>
              </thead>
              <tbody id="emp-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabela de Pedidos (Admin) -->
    <section id="orders-table-section" class="mt-10 hidden">
      <h2 class="text-xl font-semibold mb-3">Pedidos da semana (por filtro de regional)</h2>
      <div class="overflow-auto bg-white rounded-xl border">
        <table class="w-full text-sm border-collapse">
          <thead class="bg-gray-100">
            <tr>
              <th class="border p-2 text-left">RGF</th>
              <th class="border p-2 text-left">Nome</th>
              <th class="border p-2 text-left">Regional</th>
              <th class="border p-2 text-left">Seg</th>
              <th class="border p-2 text-left">Ter</th>
              <th class="border p-2 text-left">Qua</th>
              <th class="border p-2 text-left">Qui</th>
              <th class="border p-2 text-left">Sex</th>
              <th class="border p-2 text-left">Especial</th>
            </tr>
          </thead>
          <tbody id="orders-tbody"></tbody>
        </table>
      </div>
    </section>

    <footer class="text-xs text-gray-500 mt-12">
      <p>Regras Firestore e estrutura <strong>RBAC por regional</strong>. Veja coment√°rios neste arquivo.</p>
    </footer>
  </div>

  <!-- Firebase v11 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, orderBy, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ===========================================
    // 1) CONFIGURA√á√ÉO DO FIREBASE
    // ===========================================
    // >>> MANTENHA seu bloco firebaseConfig atual (apiKey etc.).
    // >>> Copie/cole aqui o MESMO bloco que voc√™ j√° usa hoje.
    // >>> N√£o √© necess√°rio trocar apiKey/dom√≠nios.
    const firebaseConfig = {
      // !!! SUBSTITUA POR SEU BLOCO EXISTENTE !!!
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_PROJECT.firebaseapp.com",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===========================================
    // 2) CONSTANTES E ESTADO
    // ===========================================
    const REGIONS = ["QUATINGA","JUNDIAPEBA","ITAQUA","POA"];
    let ADMIN_SCOPE = { global: false, regions: [] };
    let ALL_ORDERS_CACHE = []; // snapshot consolidado
    const refs = {
      regionFilter: document.getElementById('region-filter'),
      ordersTbody: document.getElementById('orders-tbody'),
      empTbody: document.getElementById('emp-tbody'),
      statusContainer: document.getElementById('order-status-container'),
      statusSection: document.getElementById('order-status-section'),
      ordersTableSection: document.getElementById('orders-table-section'),
      adminToolbar: document.getElementById('admin-toolbar'),
      adminEmps: document.getElementById('admin-emps'),
      btnPrintAll: document.getElementById('btn-print-all'),
      btnLogin: document.getElementById('btn-login'),
      btnLogout: document.getElementById('btn-logout'),
      authBadge: document.getElementById('auth-badge'),
      scopeChip: document.getElementById('scope-chip'),
      weekInput: document.getElementById('inp-weekid'),
      form: {
        rgf: document.getElementById('inp-rgf'),
        nome: document.getElementById('inp-nome'),
        seg: document.getElementById('seg'),
        ter: document.getElementById('ter'),
        qua: document.getElementById('qua'),
        qui: document.getElementById('qui'),
        sex: document.getElementById('sex'),
        especial: document.getElementById('chk-especial'),
        enviar: document.getElementById('btn-enviar'),
        draft: document.getElementById('btn-salvar-rascunho'),
      }
    };

    // ===========================================
    // 3) UTILIT√ÅRIOS
    // ===========================================
    function showToast(msg, type='info', ms=3000){
      const div = document.createElement('div');
      const color = type==='success'?'bg-green-600':type==='error'?'bg-red-600':type==='warn'?'bg-amber-600':'bg-gray-800';
      div.className = `${color} text-white fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50`;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(()=>div.remove(), ms);
    }

    function getISOWeekId(d=new Date()){
      const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = (dt.getUTCDay() + 6) % 7;
      dt.setUTCDate(dt.getUTCDate() - dayNum + 3);
      const firstThursday = new Date(Date.UTC(dt.getUTCFullYear(),0,4));
      const week = 1 + Math.round(((dt - firstThursday)/86400000 - 3 + ((firstThursday.getUTCDay()+6)%7))/7);
      return `${dt.getUTCFullYear()}-W${String(week).padStart(2,'0')}`;
    }

    function groupLatestByRGF(arr){
      const map = new Map();
      for (const o of arr){
        const ts = o.timestamp?.toMillis?.() || 0;
        const prev = map.get(o.employeeRGF);
        if (!prev || ts > prev._ts) map.set(o.employeeRGF, { ...o, _ts: ts });
      }
      return Array.from(map.values()).sort((a,b)=> a.employeeName.localeCompare(b.employeeName));
    }

    function dayCell(val){
      if (!val || (typeof val==='object' && val?.skip)) return '-';
      if (typeof val==='string') return val;
      const prato = val?.prato || val?.nome || '';
      const obs = val?.observacao || '';
      return [prato, obs].filter(Boolean).join(' / ');
    }

    function activeRegion(){
      const v = refs.regionFilter.value;
      if (!v) return ADMIN_SCOPE.global ? 'TODAS' : (ADMIN_SCOPE.regions[0] || REGIONS[0]);
      return v;
    }

    function renderRegionFilter(){
      let options = [];
      if (ADMIN_SCOPE.global){
        options = ['TODAS', ...REGIONS];
        refs.btnPrintAll.classList.remove('hidden');
        refs.scopeChip.textContent = 'Escopo: Global';
      } else {
        options = [...ADMIN_SCOPE.regions];
        refs.btnPrintAll.classList.add('hidden');
        refs.scopeChip.textContent = `Escopo: ${options.join(', ')}`;
      }
      refs.regionFilter.innerHTML = options.map(r=>`<option value="${r}">${r}</option>`).join('');
    }

    // ===========================================
    // 4) AUTH
    // ===========================================
    refs.btnLogin.addEventListener('click', async ()=>{
      const email = prompt('E-mail do admin:');
      const senha = prompt('Senha:');
      if (!email || !senha) return;
      try {
        await signInWithEmailAndPassword(auth, email, senha);
      } catch(e){ showToast('Falha no login', 'error'); console.error(e); }
    });
    refs.btnLogout.addEventListener('click', async ()=>{
      await signOut(auth);
    });

    async function ensureVisitorAuth(){
      if (!auth.currentUser){
        try { await signInAnonymously(auth); } catch(e){ console.warn('Anon auth falhou', e); }
      }
    }

    async function loadAdminScope(){
      if (!auth.currentUser) return;
      const aSnap = await getDoc(doc(db,'admins', auth.currentUser.uid));
      ADMIN_SCOPE = { global:false, regions:[] };
      if (aSnap.exists()){
        const d = aSnap.data();
        ADMIN_SCOPE.global = !!d.globalAdmin;
        ADMIN_SCOPE.regions = Array.isArray(d.regions) ? d.regions : [];
      }
    }

    onAuthStateChanged(auth, async (user)=>{
      if (!user){
        refs.authBadge.textContent = 'Visitante';
        refs.btnLogin.classList.remove('hidden');
        refs.btnLogout.classList.add('hidden');
        refs.adminToolbar.classList.add('hidden');
        refs.adminEmps.classList.add('hidden');
        refs.ordersTableSection.classList.add('hidden');
        await ensureVisitorAuth();
        return;
      }
      // logado
      const isAnon = user.isAnonymous;
      refs.authBadge.textContent = isAnon ? 'Visitante' : `Admin: ${user.email||user.uid}`;
      refs.btnLogin.classList.toggle('hidden', !isAnon);
      refs.btnLogout.classList.toggle('hidden', isAnon);

      await loadAdminScope();
      const isAdmin = ADMIN_SCOPE.global || (ADMIN_SCOPE.regions?.length>0);
      refs.adminToolbar.classList.toggle('hidden', !isAdmin);
      refs.adminEmps.classList.toggle('hidden', !isAdmin);
      refs.ordersTableSection.classList.toggle('hidden', !isAdmin);

      if (isAdmin){
        renderRegionFilter();
      }
    });

    // ===========================================
    // 5) COLE√á√ïES
    // ===========================================
    const col = (name)=>collection(db, name);
    const colFuncionarios = col('funcionarios');
    const colPedidos = col('pedidosDaSemana');

    // ===========================================
    // 6) FORM PEDIDO (FUNCION√ÅRIO)
    // ===========================================
    refs.weekInput.value = getISOWeekId(new Date());

    refs.form.draft.addEventListener('click', ()=>{
      const draft = {
        rgf: refs.form.rgf.value.trim(),
        nome: refs.form.nome.value.trim(),
        seg: refs.form.seg.value.trim(),
        ter: refs.form.ter.value.trim(),
        qua: refs.form.qua.value.trim(),
        qui: refs.form.qui.value.trim(),
        sex: refs.form.sex.value.trim(),
        especial: refs.form.especial.checked
      };
      localStorage.setItem('pedidoDraft', JSON.stringify(draft));
      showToast('Rascunho salvo', 'success');
    });

    // Restaurar rascunho
    try {
      const d = JSON.parse(localStorage.getItem('pedidoDraft')||'null');
      if (d){
        refs.form.rgf.value = d.rgf||'';
        refs.form.nome.value = d.nome||'';
        refs.form.seg.value = d.seg||'';
        refs.form.ter.value = d.ter||'';
        refs.form.qua.value = d.qua||'';
        refs.form.qui.value = d.qui||'';
        refs.form.sex.value = d.sex||'';
        refs.form.especial.checked = !!d.especial;
      }
    } catch {}

    refs.form.enviar.addEventListener('click', async ()=>{
      const rgf = refs.form.rgf.value.trim();
      const nome = refs.form.nome.value.trim();
      if (!rgf || !nome){ showToast('Informe RGF e Nome', 'warn'); return; }

      // pega regional do funcion√°rio
      const empRef = doc(db, 'funcionarios', rgf);
      const empSnap = await getDoc(empRef);
      if (!empSnap.exists()){ showToast('RGF n√£o cadastrado', 'error'); return; }
      const region = empSnap.data().region;
      if (!region){ showToast('Funcion√°rio sem regional definida', 'error'); return; }

      const order = {
        weekId: getISOWeekId(new Date()),
        employeeRGF: rgf,
        employeeName: nome,
        employeeRegion: region,
        items: {
          seg: refs.form.seg.value.trim(),
          ter: refs.form.ter.value.trim(),
          qua: refs.form.qua.value.trim(),
          qui: refs.form.qui.value.trim(),
          sex: refs.form.sex.value.trim(),
        },
        isSpecial: !!refs.form.especial.checked,
        timestamp: serverTimestamp()
      };

      try {
        await addDoc(colPedidos, order);
        showToast('Pedido enviado!', 'success');
      } catch(e){
        console.error(e);
        showToast('Falha ao enviar pedido', 'error');
      }
    });

    // ===========================================
    // 7) ADMIN ‚Äì FUNCION√ÅRIOS
    // ===========================================
    document.getElementById('btn-add-emp').addEventListener('click', async ()=>{
      const rgf = prompt('RGF:');
      const nome = prompt('Nome:');
      const region = prompt('Regional (ex: QUATINGA):', REGIONS[0]);
      if (!rgf || !nome || !region) return;
      try {
        await setDoc(doc(db,'funcionarios', rgf), { nome, ativo: true, region }, { merge: true });
        showToast('Funcion√°rio salvo', 'success');
      } catch(e){ console.error(e); showToast('Erro ao salvar', 'error'); }
    });

    async function refreshEmployeesTable(){
      const qSnap = await getDocs(query(colFuncionarios, orderBy('nome')));
      const active = activeRegion();
      const rows = [];
      qSnap.forEach(d => {
        const data = d.data();
        // se admin escopo parcial, s√≥ ver suas regi√µes
        if (!ADMIN_SCOPE.global && !ADMIN_SCOPE.regions.includes(data.region)) return;
        if (active !== 'TODAS' && data.region !== active) return;
        rows.push({ rgf: d.id, ...data });
      });
      refs.empTbody.innerHTML = rows.map(emp => `
        <tr>
          <td class="border p-2">${emp.rgf}</td>
          <td class="border p-2">
            <input data-emp="${emp.rgf}" data-field="nome" class="w-full border rounded p-1" value="${emp.nome||''}" />
          </td>
          <td class="border p-2">
            <select data-emp="${emp.rgf}" data-field="region" class="border rounded p-1">
              ${REGIONS.map(r=>`<option value="${r}" ${r===emp.region?'selected':''}>${r}</option>`).join('')}
            </select>
          </td>
          <td class="border p-2 text-center">
            <input type="checkbox" data-emp="${emp.rgf}" data-field="ativo" ${emp.ativo?'checked':''} />
          </td>
          <td class="border p-2 text-right">
            <button class="btn btn-outline text-xs" data-del="${emp.rgf}">Remover</button>
          </td>
        </tr>
      `).join('');

      // binds
      refs.empTbody.querySelectorAll('input[data-emp],select[data-emp]').forEach(el=>{
        el.addEventListener('change', async (e)=>{
          const rgf = el.dataset.emp;
          const field = el.dataset.field;
          let val = el.type==='checkbox' ? el.checked : el.value;
          try {
            await updateDoc(doc(db,'funcionarios', rgf), { [field]: val });
            showToast('Atualizado', 'success', 1200);
          } catch(err){ console.error(err); showToast('Falha ao atualizar', 'error'); }
        });
      });
      refs.empTbody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          // opcional: soft delete (ativo=false) para manter hist√≥rico
          const rgf = btn.dataset.del;
          try {
            await updateDoc(doc(db,'funcionarios', rgf), { ativo: false });
            showToast('Marcado como inativo', 'success');
            refreshEmployeesTable();
          } catch(e){ console.error(e); showToast('Erro', 'error'); }
        });
      });
    }

    refs.regionFilter.addEventListener('change', ()=>{
      refreshEmployeesTable();
      renderOrdersTableFromCache();
      renderStatusCardsFromCache();
    });

    // ===========================================
    // 8) ADMIN ‚Äì PEDIDOS + STATUS POR REGIONAL
    // ===========================================
    onSnapshot(colPedidos, async (snapshot)=>{
      const all = [];
      snapshot.forEach(s => all.push({ id: s.id, ...s.data() }));
      ALL_ORDERS_CACHE = all;
      renderOrdersTableFromCache();
      await renderStatusCardsFromCache();
    }, (err)=>{
      console.error(err);
      showToast('Erro ao ler pedidos', 'error');
    });

    function renderOrdersTableFromCache(){
      const region = activeRegion();
      const latest = groupLatestByRGF(ALL_ORDERS_CACHE);
      const filtered = (region==='TODAS') ? latest : latest.filter(o=>o.employeeRegion===region);
      refs.ordersTbody.innerHTML = filtered.map(o=>`
        <tr>
          <td class="border p-2">${o.employeeRGF}</td>
          <td class="border p-2">${o.employeeName}</td>
          <td class="border p-2">${o.employeeRegion}</td>
          <td class="border p-2">${dayCell(o.items?.seg)}</td>
          <td class="border p-2">${dayCell(o.items?.ter)}</td>
          <td class="border p-2">${dayCell(o.items?.qua)}</td>
          <td class="border p-2">${dayCell(o.items?.qui)}</td>
          <td class="border p-2">${dayCell(o.items?.sex)}</td>
          <td class="border p-2">${o.isSpecial?'SIM':'‚Äî'}</td>
        </tr>
      `).join('');
    }

    async function renderStatusCardsFromCache(){
      // Carrega todos funcion√°rios (para cada regional)
      const empSnap = await getDocs(query(colFuncionarios));
      const employees = empSnap.docs.map(d => ({ rgf: d.id, ...d.data() }));
      // Agrupa funcion√°rios por region
      const byRegion = new Map();
      for (const e of employees){
        if (!byRegion.has(e.region)) byRegion.set(e.region, []);
        byRegion.get(e.region).push(e);
      }

      const latest = groupLatestByRGF(ALL_ORDERS_CACHE);
      const orderedRGFs = new Set(latest.map(o=>o.employeeRGF));

      const active = activeRegion();
      refs.statusContainer.innerHTML = '';

      for (const [region, emps] of byRegion){
        if (!region) continue;
        if (!ADMIN_SCOPE.global && !ADMIN_SCOPE.regions.includes(region)) continue;
        if (active !== 'TODAS' && region !== active) continue;

        const haveOrdered = emps.filter(e => orderedRGFs.has(e.rgf));
        const haveNot = emps.filter(e => !orderedRGFs.has(e.rgf));
        const total = emps.length, done = haveOrdered.length;
        const pct = total ? Math.round((done/total)*100) : 0;

        const card = document.createElement('div');
        card.className = 'p-4 rounded-xl border bg-white';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <h3 class="font-bold">üìç ${region} ‚Äî ${done}/${total} (${pct}%)</h3>
            <div class="flex gap-2">
              <button class="btn btn-outline text-xs" data-wpp="${region}">WhatsApp</button>
              <button class="btn btn-primary text-xs" data-print="${region}">Imprimir RELAT√ìRIO ${region}</button>
            </div>
          </div>
          <div class="w-full bg-gray-200 h-2 rounded my-2"><div class="h-2 rounded bg-green-600" style="width:${pct}%"></div></div>
          <details class="mt-2">
            <summary class="cursor-pointer text-sm text-gray-600">Ver quem falta</summary>
            <ul class="mt-2 text-sm">${haveNot.map(e=>`<li class="p-1 bg-red-50 rounded my-1">${e.nome}</li>`).join('') || '<li class="text-gray-500">Todos pediram!</li>'}</ul>
          </details>
        `;
        refs.statusContainer.appendChild(card);

        // Persistir status em /status/weekly-<week>-<region>
        const weekId = getISOWeekId(new Date());
        await setDoc(doc(db,'status', `weekly-${weekId}-${region}`), {
          weekId, region,
          allOrdered: total>0 && done===total,
          counts: { totalEmployees: total, totalOrdered: done },
          updatedAt: serverTimestamp()
        }, { merge: true });

        // Notificar 1x por regional (apenas admins permitidos)
        await maybeNotifyAllOrderedByRegion(weekId, region, total, done);
      }

      // binds por card
      refs.statusContainer.querySelectorAll('button[data-print]').forEach(btn=>{
        btn.onclick = ()=> generateAndPrintReportForRegion(btn.dataset.print);
      });
      refs.statusContainer.querySelectorAll('button[data-wpp]').forEach(btn=>{
        btn.onclick = ()=> {
          const region = btn.dataset.wpp;
          const msg = `[${region}] Status semana ${getISOWeekId(new Date())}: abra o relat√≥rio no painel ${location.href}`;
          window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
        };
      });

      // Tabela de funcion√°rios (admin)
      await refreshEmployeesTable();
    }

    // Notifica√ß√£o por regional (debounce persistente usando status.notifiedAt)
    async function maybeNotifyAllOrderedByRegion(weekId, region, total, done){
      const can = ADMIN_SCOPE.global || ADMIN_SCOPE.regions.includes(region);
      if (!can) return;
      const statusRef = doc(db,'status', `weekly-${weekId}-${region}`);
      const snap = await getDoc(statusRef);
      const already = snap.exists() && snap.data().notifiedAt;
      const allDone = total>0 && done===total;
      if (!allDone || already) return;

      showToast(`‚úÖ ${region}: todos (${total}) j√° fizeram o pedido`, 'success', 5000);
      // marca notificado
      await setDoc(statusRef, { notifiedAt: serverTimestamp() }, { merge: true });
    }

    // ===========================================
    // 9) RELAT√ìRIO ‚Äì POR REGIONAL
    // ===========================================
    function generateAndPrintReportForRegion(region){
      const latest = groupLatestByRGF(ALL_ORDERS_CACHE);
      const rows = latest.filter(o=>o.employeeRegion===region);
      const title = `RELAT√ìRIO ${region}`;
      const win = window.open('', '_blank');
      const styles = `
        <style>
          body{ font-family: system-ui, Arial, sans-serif; padding:24px; }
          h1{ font-size:18px; margin:0 0 12px; }
          table{ width:100%; border-collapse: collapse; font-size:12px; }
          th, td{ border:1px solid #999; padding:6px; text-align:left; }
          thead{ background:#f3f3f3; }
        </style>
      `;
      const header = `<h1>${title} ‚Äî Semana ${getISOWeekId(new Date())}</h1>`;
      const thead = `
        <thead>
          <tr>
            <th>RGF</th><th>Nome</th>
            <th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th>
            <th>Especial</th>
          </tr>
        </thead>`;
      const tbody = rows.map(o => `
        <tr>
          <td>${o.employeeRGF}</td>
          <td>${o.employeeName}</td>
          <td>${dayCell(o.items?.seg)}</td>
          <td>${dayCell(o.items?.ter)}</td>
          <td>${dayCell(o.items?.qua)}</td>
          <td>${dayCell(o.items?.qui)}</td>
          <td>${dayCell(o.items?.sex)}</td>
          <td>${o.isSpecial?'SIM':'‚Äî'}</td>
        </tr>
      `).join('');

      win.document.write(`${styles}${header}<table>${thead}<tbody>${tbody}</tbody></table>`);
      win.document.close();
      win.focus();
      win.print();
    }

    // Bot√£o "Imprimir TODOS"
    refs.btnPrintAll.addEventListener('click', async ()=>{
      // regi√µes que possuem funcion√°rios
      const empSnap = await getDocs(query(colFuncionarios));
      const regionsSet = new Set();
      empSnap.forEach(d => d.data().region && regionsSet.add(d.data().region));
      for (const r of regionsSet){
        generateAndPrintReportForRegion(r);
      }
    });

    // Inicializa√ß√£o
    (async function init(){
      await ensureVisitorAuth();
      await loadAdminScope();
      renderRegionFilter();
      // primeira render
      refs.ordersTbody.innerHTML = '';
      refs.statusContainer.innerHTML = '<p class="text-gray-500">Carregando...</p>';
    })();

  </script>

  <!-- ============================
       Firestore Rules (resumo)
       Publique no console ‚Üí Rules:
       - RBAC por regional usando /admins/{uid}
       - Ver README dentro do projeto
  =============================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function adminDoc() { return get(/databases/$(database)/documents/admins/$(request.auth.uid)); }
    function isGlobalAdmin() { return isSignedIn() && adminDoc().data.globalAdmin == true; }
    function isRegionAdmin(region) {
      return isGlobalAdmin() || (
        isSignedIn() &&
        adminDoc().data.regions != null &&
        region in adminDoc().data.regions
      );
    }
    match /{document=**} { allow read: if true; }
    match /funcionarios/{rgf} {
      allow create, update: if isRegionAdmin(request.resource.data.region);
      allow delete: if isRegionAdmin(resource.data.region);
    }
    match /pedidosDaSemana/{pid} {
      allow create: if isSignedIn()
        && request.resource.data.employeeRGF is string
        && request.resource.data.employeeRegion is string
        && get(/databases/$(database)/documents/funcionarios/$(request.resource.data.employeeRGF)).data.region
           == request.resource.data.employeeRegion;
      allow update, delete: if isRegionAdmin(resource.data.employeeRegion);
    }
    match /cardapio/{doc} { allow write: if isGlobalAdmin(); }
    match /status/{sid} {
      allow write: if isGlobalAdmin()
        || (isRegionAdmin(request.resource.data.region ?? resource.data.region));
    }
    match /admins/{uid} {
      allow read: if isSignedIn();
      allow write: if isGlobalAdmin();
    }
  }
}
  -->
</body>
</html>
