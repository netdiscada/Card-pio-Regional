<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card√°pio Quatinga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Lobster Two', cursive; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-print { }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-height: 90vh; overflow-y: auto; width: 90%; max-width: 500px; }
        #image-zoom-modal .modal-content { width: auto; max-width: 95%; padding: 0.5rem; background: none; box-shadow: none; }
        #zoomed-image { max-width: 90vw; max-height: 85vh; border-radius: 0.75rem; }
        input:read-only { background-color: #f3f4f6; cursor: not-allowed; }
        .wizard-btn { transition: all 0.2s ease-in-out; }
        .wizard-btn:hover { transform: scale(1.03); border-color: #3b82f6; }
        .wizard-btn:active { transform: scale(0.98); background-color: #eff6ff; }
        #print-report { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            body > *:not(#print-report) { display: none !important; }
            #print-report { display: block !important; }
            #print-report h1 { font-size: 18pt; text-align: center; margin-bottom: 15px; font-family: 'Poppins', sans-serif; font-weight: 600; }
            .report-day-section { margin-bottom: 12px; page-break-inside: avoid; }
            .report-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
            #print-report th, #print-report td { border: 1px solid #999; padding: 5px; text-align: left; }
            #print-report th { background-color: #e2e8f0; font-weight: 600; }
            #print-report .rgf-col { width: 15%; }
            #print-report .nome-col { width: 60%; }
            #print-report .pedido-col { width: 25%; background-color: #dbeafe; font-weight: bold; }
        }
        #app-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; pointer-events: none; transform: translateX(-50%) translateY(20px); }
        #app-toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
        #app-toast.success { background-color: #22c55e; }
        #app-toast.error { background-color: #ef4444; }
        #app-toast.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-20 shadow-sm no-print">
        <div class="container mx-auto max-w-4xl p-2 flex justify-between items-center">
            <h1 class="font-brand text-2xl text-blue-600">Del√≠cias Urbanas</h1>
            <button id="switchToAdmin" class="text-xs text-gray-500 hover:text-blue-600 font-semibold py-1 px-2 rounded-md hover:bg-gray-100">Painel ADM</button>
        </div>
    </header>

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-20">
        
        <div id="user-view" class="no-print">
            <div id="form-container">
                <p class="text-center mt-2 mb-8 text-md text-gray-500">O seu card√°pio da semana est√° servido!</p>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h2 class="block text-lg font-semibold text-gray-800 mb-2">üë§ 1. Identifica√ß√£o</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div><label for="employeeRGF" class="block text-sm font-medium text-gray-700">Seu RGF</label><input type="text" id="employeeRGF" placeholder="Digite o seu RGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                        <div><label for="employeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="employeeName" placeholder="Preenchido automaticamente" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div>
                    </div>
                </div>

                <div id="order-section" class="hidden">
                    <div id="menu-image-container" class="mb-4">
                        <div class="relative">
                            <img id="menu-image" src="" alt="Card√°pio da Semana" class="w-full h-auto rounded-xl shadow-lg border-4 border-white cursor-pointer">
                            <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                            </div>
                        </div>
                    </div>

                    <div id="order-wizard-container" class="bg-white rounded-xl shadow-sm p-4 sm:p-6">
                        <div id="order-wizard">
                            <div class="flex justify-between items-center mb-4">
                                 <h2 class="text-lg font-semibold text-gray-800">üçΩÔ∏è 2. Escolha para:</h2>
                                 <div id="wizard-progress" class="flex space-x-2"></div>
                            </div>
                            <h3 id="wizard-day-title" class="text-2xl font-bold text-blue-600 mb-4 text-center"></h3>
                            <div id="wizard-options" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                            <div class="mt-4">
                                <textarea id="wizard-notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Anota√ß√µes? Ex: sem cebola, ponto da carne, etc."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="guidanceSection" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6"><p id="guidanceText" class="font-semibold">Aguardando card√°pio...</p></div>
                <div id="submitButtonContainer" class="hidden text-center mt-6"><button id="openConfirmationModal" class="w-full sm:w-auto bg-green-500 text-white font-bold text-lg px-8 py-3 rounded-xl hover:bg-green-600 shadow-lg">Revisar e Finalizar Pedido</button></div>
            </div>
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Fazer Novo Pedido</button></div>
        </div>

        <div id="admin-view" class="hidden no-print">
            <header class="text-center border-b pb-6 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Painel do Administrador</h1>
                <p class="text-lg text-gray-600 mt-1">Del√≠cias Urbanas</p>
                <div class="mt-4">
                    <button id="adminLogoutBtn" class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600">Sair do Painel</button>
                </div>
            </header>
            <div class="mb-8">
                <button id="switchToUserFromAdmin" class="text-sm text-gray-500 hover:text-blue-600">‚¨ÖÔ∏è Voltar para o Card√°pio (Vis√£o Usu√°rio)</button>
            </div>
            
            <section id="menu-image-uploader-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-4">üñºÔ∏è Atualizar Imagem do Card√°pio</h2>
                <p class="text-gray-600 mb-4">Envie uma √∫nica imagem do novo card√°pio da semana. Ela ser√° exibida para os funcion√°rios.</p>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" class="mt-4 rounded-lg max-h-80 hidden border" />
                <div class="mt-4 text-center">
                    <button id="uploadImageBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400" disabled>Enviar Nova Imagem</button>
                </div>
                 <div id="whatsapp-notification-container" class="mt-6 text-center hidden">
                    <button id="notifyWhatsAppBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="white"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.287.492-1.24 4.515 4.639-1.219.452.273zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                        Notificar Funcion√°rios no WhatsApp
                    </button>
                </div>
            </section>
            
            <section id="order-status-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üìä Status de Pedidos da Semana</h2>
                <div id="order-status-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p class="text-gray-500">A carregar status dos pedidos...</p>
                </div>
            </section>

            <section id="employee-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üë• Gerenciamento de Funcion√°rios</h2>
                <form id="add-employee-form" class="grid sm:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="newEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label>
                        <input type="text" id="newEmployeeRGF" placeholder="RGF do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="newEmployeeName" placeholder="Nome do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Funcion√°rio</button>
                </form>
                <div id="employee-list-container" class="overflow-x-auto">
                    <p class="text-gray-500">A carregar lista de funcion√°rios...</p>
                </div>
            </section>

            <section id="orders-section">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Pedidos Recebidos</h2>
                    <div class="w-full sm:w-auto"><input type="text" id="searchInput" placeholder="üîé Buscar por nome..." class="w-full sm:w-64 px-4 py-2 border rounded-lg"></div>
                    <button id="generateReportBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">üñ®Ô∏è Salvar Relat√≥rio como PDF</button>
                </div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>
        </div>
    </div>

    <div id="image-zoom-modal" class="modal-overlay hidden no-print cursor-zoom-out"><div class="modal-content"><img id="zoomed-image" src=""></div></div>
    <div id="edit-order-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Pedido</h2><form id="edit-order-form"><input type="hidden" id="edit-order-id"><div class="mb-4"><label class="block text-lg font-semibold text-gray-800 mb-2">Nome do Funcion√°rio</label><input type="text" id="edit-order-employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly></div><div id="edit-menu-options" class="space-y-6"></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button></div></form></div></div>
    <div id="edit-employee-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Funcion√°rio</h2><form id="edit-employee-form"><div class="mb-4"><label for="editEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label><input type="text" id="editEmployeeRGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div><div class="mb-4"><label for="editEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="editEmployeeName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button></div></form></div></div>
    <div id="confirmation-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-2xl font-bold mb-4">Confirme o seu Pedido</h2><p class="mb-6 text-gray-600">Por favor, revise as suas escolhas antes de enviar.</p><div id="confirmation-summary" class="space-y-2 mb-8"></div><div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Editar</button><button id="submitOrder" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">Confirmar e Enviar</button></div></div></div>
    <div id="admin-login-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Aceder ao Painel de Administrador</h2><form id="admin-login-form"><div class="mb-4"><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="adminEmail" placeholder="seu-email@exemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="adminPassword" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="adminPassword" placeholder="Sua senha" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button></div></form></div></div>
    <div id="custom-confirm-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-xl font-bold mb-4" id="custom-confirm-title">Confirmar A√ß√£o</h2><p class="mb-6 text-gray-600" id="custom-confirm-message">Tem a certeza que deseja prosseguir?</p><div class="flex justify-end space-x-4"><button id="custom-confirm-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button id="custom-confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirmar</button></div></div></div>

    <div id="print-report"></div>
    <div id="app-toast"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, setDoc, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI",
            authDomain: "cardapio-8ddea.firebaseapp.com",
            projectId: "cardapio-8ddea",
            storageBucket: "cardapio-8ddea.appspot.com",
            messagingSenderId: "1019677985212",
            appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const APP_CONFIG = {
            ADMIN_UID: 'LqAXao4FuOQAvzS3uQAd9et6OnK2',
        };
        
        const menuDocRef = doc(db, "cardapio", "semanal");
        const pedidosCollectionRef = collection(db, "pedidosDaSemana");
        const funcionariosCollectionRef = collection(db, "funcionarios");
        
        const weekDays = ['Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];
        const mealOptions = [
            { name: "Prato Principal", emoji: "üçΩÔ∏è", description: "A op√ß√£o do dia, conforme a imagem" },
            { name: "Op√ß√£o", emoji: "üç≤", description: "A segunda op√ß√£o do dia, se houver" },
            { name: "Omelete", emoji: "üç≥", description: "Op√ß√£o fixa" },
            { name: "Fil√© de frango", emoji: "üçó", description: "Op√ß√£o fixa" }
        ];

        let weeklyMenu = {};
        let allOrders = [];
        let tempOrderData = {};
        let userChoices = [];
        let currentDayIndex = 0;
        let fileToUpload = null;
        
        function getDayId(dayName) { return dayName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, "").toLowerCase(); }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('app-toast');
            if(!toast) return;
            toast.textContent = message;
            toast.className = 'show';
            toast.classList.add(type);
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, duration);
        }
        
        function showCustomConfirm(message, onConfirm) {
            const modal = document.getElementById('custom-confirm-modal');
            const messageEl = document.getElementById('custom-confirm-message');
            const okBtn = document.getElementById('custom-confirm-ok-btn');
            
            messageEl.textContent = message;
            modal.classList.remove('hidden');

            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            newOkBtn.addEventListener('click', () => {
                onConfirm();
                modal.classList.add('hidden');
            });
        }

        async function loadAndRenderEmployees() {
            const container = document.getElementById('employee-list-container');
            try {
                const q = query(funcionariosCollectionRef, orderBy("nome"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum funcion√°rio cadastrado.</p>';
                    return;
                }
                let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">RGF</th><th class="py-2 px-3 border-b text-left">Nome</th><th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    tableHTML += `<tr>
                        <td class="py-2 px-3 border-b font-mono">${doc.id}</td>
                        <td class="py-2 px-3 border-b font-semibold">${employee.nome}</td>
                        <td class="py-2 px-3 border-b space-x-2">
                            <button data-id="${doc.id}" data-name="${employee.nome}" class="edit-employee-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button>
                            <button data-id="${doc.id}" data-name="${employee.nome}" class="delete-employee-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button>
                        </td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            } catch (error) {
                console.error("Erro ao carregar funcion√°rios:", error);
                container.innerHTML = `<p class="text-center text-red-500 font-semibold">Falha ao carregar funcion√°rios. Verifique as regras de seguran√ßa do Firestore.</p>`;
                showToast("Falha ao carregar a lista de funcion√°rios.", "error");
            }
        }

        async function handleAddEmployee(e) {
            e.preventDefault();
            const rgfInput = document.getElementById('newEmployeeRGF');
            const nameInput = document.getElementById('newEmployeeName');
            const rgf = rgfInput.value.trim();
            const nome = nameInput.value.trim();

            if (!rgf || !nome) { showToast("Por favor, preencha o RGF e o Nome.", 'error'); return; }

            try {
                await setDoc(doc(db, "funcionarios", rgf), { nome });
                showToast("Funcion√°rio adicionado com sucesso!", 'success');
                rgfInput.value = ''; nameInput.value = '';
                loadAndRenderEmployees(); // Re-carrega a lista
            } catch (error) {
                console.error("Erro ao adicionar funcion√°rio: ", error);
                showToast("Ocorreu um erro ao adicionar o funcion√°rio.", 'error');
            }
        }

        function handleDeleteEmployee(rgf, name) {
            const message = `Tem a certeza que deseja excluir o funcion√°rio ${name} (RGF: ${rgf})? Esta a√ß√£o n√£o pode ser desfeita.`;
            showCustomConfirm(message, async () => {
                try {
                    await deleteDoc(doc(db, "funcionarios", rgf));
                    showToast("Funcion√°rio exclu√≠do com sucesso.", 'success');
                    loadAndRenderEmployees(); // Re-carrega a lista
                } catch (error) {
                    console.error("Erro ao excluir funcion√°rio: ", error);
                    showToast("Falha ao excluir o funcion√°rio.", 'error');
                }
            });
        }
        
        function openEmployeeEditModal(rgf, nome) {
            document.getElementById('editEmployeeRGF').value = rgf;
            document.getElementById('editEmployeeName').value = nome;
            document.getElementById('edit-employee-modal').classList.remove('hidden');
        }

        async function handleSaveEmployeeChanges(e) {
            e.preventDefault();
            const rgf = document.getElementById('editEmployeeRGF').value;
            const newName = document.getElementById('editEmployeeName').value.trim();

            if (!newName) { showToast("O nome n√£o pode ficar em branco.", 'error'); return; }
            try {
                await updateDoc(doc(db, "funcionarios", rgf), { nome: newName });
                showToast("Funcion√°rio atualizado com sucesso!", 'success');
                document.getElementById('edit-employee-modal').classList.add('hidden');
                loadAndRenderEmployees(); // Re-carrega a lista
            } catch (error) {
                console.error("Erro ao salvar altera√ß√µes do funcion√°rio: ", error);
                showToast("Falha ao salvar as altera√ß√µes do funcion√°rio.", 'error');
            }
        }
        
        async function findEmployeeByRGF(rgf) {
            const nameInput = document.getElementById('employeeName');
            if (!rgf) { nameInput.value = ''; nameInput.placeholder = 'Preenchido automaticamente'; return; }
            try {
                const docSnap = await getDoc(doc(db, "funcionarios", rgf));
                if (docSnap.exists()) {
                    nameInput.value = docSnap.data().nome;
                } else {
                    nameInput.value = ''; nameInput.placeholder = 'RGF n√£o encontrado';
                }
            } catch (error) {
                console.error("Erro ao buscar funcion√°rio:", error);
                nameInput.value = ''; nameInput.placeholder = 'Erro na busca';
                showToast("Erro ao buscar funcion√°rio.", 'error');
            }
        }
        
        function renderWizardStep(index) {
            const wizardContainer = document.getElementById('order-wizard-container');
            if (index >= weekDays.length) {
                wizardContainer.classList.add('hidden');
                document.getElementById('submitButtonContainer').classList.remove('hidden');
                return;
            }

            const day = weekDays[index];
            document.getElementById('wizard-day-title').textContent = day;

            const optionsContainer = document.getElementById('wizard-options');
            optionsContainer.innerHTML = '';
            mealOptions.forEach(opt => {
                optionsContainer.innerHTML += `
                    <button data-value="${opt.name}" class="wizard-btn text-left p-3 border-2 border-gray-200 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${opt.emoji}</span>
                            <div>
                                <p class="font-semibold text-gray-800 text-sm">${opt.name}</p>
                                <p class="text-xs text-gray-500">${opt.description}</p>
                            </div>
                        </div>
                    </button>
                `;
            });

            document.getElementById('wizard-notes').value = '';
            updateWizardProgress(index);
            wizardContainer.classList.add('fade-in');
            setTimeout(() => wizardContainer.classList.remove('fade-in'), 300);
        }

        function updateWizardProgress(index) {
            const progressContainer = document.getElementById('wizard-progress');
            progressContainer.innerHTML = '';
            for(let i=0; i < weekDays.length; i++) {
                const dotClass = i < index ? 'bg-blue-600' : (i === index ? 'bg-blue-300' : 'bg-gray-300');
                progressContainer.innerHTML += `<div class="w-2.5 h-2.5 rounded-full ${dotClass}"></div>`;
            }
        }
        
        function handleWizardSelection(event) {
            const choiceBtn = event.target.closest('.wizard-btn');
            if (!choiceBtn) return;

            const choice = choiceBtn.dataset.value;
            const notes = document.getElementById('wizard-notes').value.trim();

            userChoices[currentDayIndex] = {
                day: weekDays[currentDayIndex],
                choice: choice,
                notes: notes
            };

            currentDayIndex++;
            renderWizardStep(currentDayIndex);
        }

        function loadAndDisplayMenu() {
            onSnapshot(menuDocRef, (docSnap) => {
                const menuData = (docSnap.exists() && docSnap.data()) ? docSnap.data() : { menuImageBase64: '' };
                const menuImage = document.getElementById('menu-image');

                if (menuData.menuImageBase64) {
                    weeklyMenu.menuImageBase64 = menuData.menuImageBase64;
                    menuImage.src = weeklyMenu.menuImageBase64;
                    currentDayIndex = 0;
                    userChoices = [];
                    renderWizardStep(0);
                } else {
                    weeklyMenu.menuImageBase64 = null;
                }
                validateForm();
                renderOrdersTable(allOrders);
            }, (error) => {
                 console.error("Erro ao carregar o card√°pio:", error);
                 showToast("Erro ao carregar o card√°pio.", 'error');
            });
        }
        
        function validateForm() {
            const name = document.getElementById('employeeName')?.value.trim();
            const rgf = document.getElementById('employeeRGF')?.value.trim();
            const guidanceSection = document.getElementById('guidanceSection');
            const orderSection = document.getElementById('order-section');

            if (weeklyMenu.menuImageBase64) {
                if (!name || !rgf) {
                    orderSection.classList.add('hidden');
                    guidanceSection.classList.remove('hidden');
                    document.getElementById('guidanceText').textContent = 'Por favor, preencha o seu RGF para come√ßar.';
                } else {
                    guidanceSection.classList.add('hidden');
                    orderSection.classList.remove('hidden');
                }
            } else {
                orderSection.classList.add('hidden');
                guidanceSection.classList.remove('hidden');
                document.getElementById('guidanceText').textContent = 'O administrador ainda n√£o enviou o card√°pio da semana.';
            }
        }

        function openConfirmationModal() {
            tempOrderData = {
                employeeName: document.getElementById('employeeName').value.trim(),
                employeeRGF: document.getElementById('employeeRGF').value.trim(),
                timestamp: serverTimestamp()
            };
            const summaryContainer = document.getElementById('confirmation-summary');
            summaryContainer.innerHTML = '';
            
            userChoices.forEach(item => {
                const dayId = getDayId(item.day);
                tempOrderData[dayId] = item.choice;
                if(item.notes) {
                    tempOrderData[`${dayId}_notes`] = item.notes;
                }
                summaryContainer.innerHTML += `<p><span class="font-bold">${item.day}:</span> ${item.choice} ${item.notes ? `<span class="text-sm text-gray-500 italic">(${item.notes})</span>` : ''}</p>`;
            });
            
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        async function submitOrder() {
            const button = document.getElementById('submitOrder');
            button.disabled = true; button.textContent = 'A enviar...';
            try {
                await addDoc(pedidosCollectionRef, tempOrderData);
                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');
                document.getElementById('success-text').textContent = `Obrigado, ${tempOrderData.employeeName}. O seu pedido foi registado com sucesso.`;
                showToast("Pedido enviado com sucesso!", 'success');
            } catch (error) {
                console.error("Erro ao enviar pedido: ", error);
                showToast("Ocorreu um erro ao enviar o seu pedido.", 'error');
            } finally {
                button.disabled = false; button.textContent = 'Confirmar e Enviar';
            }
        }
        
        function loadAdminData() {
            onSnapshot(pedidosCollectionRef, (snapshot) => {
                const latestOrdersMap = new Map();
                snapshot.forEach(doc => {
                    const orderData = doc.data();
                    if (orderData.employeeRGF) {
                        const timestamp = orderData.timestamp ? orderData.timestamp.toMillis() : 0;
                         if (!latestOrdersMap.has(orderData.employeeRGF) || timestamp > latestOrdersMap.get(orderData.employeeRGF).timestamp) {
                             latestOrdersMap.set(orderData.employeeRGF, { doc: doc, timestamp: timestamp });
                         }
                    }
                });
                
                allOrders = Array.from(latestOrdersMap.values())
                    .map(item => item.doc)
                    .sort((a, b) => a.data().employeeName.localeCompare(b.data().employeeName));

                renderOrdersTable(allOrders);
                renderOrderStatus(allOrders);
            }, (error) => {
                console.error("Erro ao carregar dados do administrador:", error);
                showToast("Erro ao carregar dados do administrador.", 'error');
            });
        }
        
        async function renderOrderStatus(orders) {
            const container = document.getElementById('order-status-container');
            container.innerHTML = '<p class="text-gray-500">A processar...</p>';

            try {
                const employeeSnapshot = await getDocs(query(funcionariosCollectionRef, orderBy("nome")));
                const allEmployees = employeeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const orderedRGFs = new Set(orders.map(orderDoc => orderDoc.data().employeeRGF));

                const haveOrdered = allEmployees.filter(emp => orderedRGFs.has(emp.id));
                const haveNotOrdered = allEmployees.filter(emp => !orderedRGFs.has(emp.id));

                let html = `
                    <div>
                        <h3 class="font-semibold text-lg text-green-600 mb-2">‚úÖ J√° Pediram (${haveOrdered.length})</h3>
                        <ul class="space-y-1 text-sm">${haveOrdered.map(e => `<li class="p-2 bg-green-50 rounded-md">${e.nome}</li>`).join('') || '<li class="text-gray-500">Ningu√©m fez pedido ainda.</li>'}</ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg text-red-600 mb-2">‚ùå Ainda N√£o Pediram (${haveNotOrdered.length})</h3>
                        <ul class="space-y-1 text-sm">${haveNotOrdered.map(e => `<li class="p-2 bg-red-50 rounded-md">${e.nome}</li>`).join('') || '<li class="text-gray-500">Todos os funcion√°rios fizeram pedido!</li>'}</ul>
                    </div>
                `;
                container.innerHTML = html;

            } catch (error) {
                console.error("Erro ao renderizar status de pedidos:", error);
                container.innerHTML = '<p class="text-red-500">Falha ao carregar status dos funcion√°rios.</p>';
            }
        }
        
        function renderOrdersTable(orders) {
            const container = document.getElementById('ordersTableContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredOrders = orders.filter(doc => doc.data().employeeName.toLowerCase().includes(searchTerm));

            if (!weeklyMenu.menuImageBase64) { container.innerHTML = '<p class="text-gray-500 text-center py-4">Aguardando card√°pio...</p>'; return; }
            if (filteredOrders.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum pedido encontrado.</p>'; return; }
            
            let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">Funcion√°rio</th><th class="py-2 px-3 border-b text-left">RGF</th>`;
            weekDays.forEach(item => tableHTML += `<th class="py-2 px-3 border-b text-left">${item.substring(0,3)}</th>`);
            tableHTML += `<th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;

            filteredOrders.forEach(doc => {
                const order = doc.data();
                tableHTML += `<tr><td class="py-2 px-3 border-b font-bold">${order.employeeName}</td><td class="py-2 px-3 border-b">${order.employeeRGF || 'N/A'}</td>`;
                weekDays.forEach(day => {
                    const dayId = getDayId(day);
                    let choice = order[dayId] || 'N/A';
                    const notes = order[`${dayId}_notes`];
                    
                    let cellContent = choice;
                    if (notes) {
                        cellContent += ` <span title="${notes}" class="cursor-help text-blue-500 font-bold">*</span>`;
                    }
                    tableHTML += `<td class="py-2 px-3 border-b">${cellContent}</td>`;
                });
                tableHTML += `<td class="py-2 px-3 border-b space-x-2"><button data-id="${doc.id}" class="edit-order-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button><button data-id="${doc.id}" data-name="${order.employeeName}" class="delete-order-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button></td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function generateAndPrintReport() {
            const reportContainer = document.getElementById('print-report');
            if (allOrders.length === 0) {
                showToast("N√£o h√° pedidos para gerar o relat√≥rio.", "info");
                return;
            }
            reportContainer.innerHTML = '<h1>Regional Quatinga</h1>';
            
            let allDaysHTML = '';
            weekDays.forEach(day => {
                const dayId = getDayId(day);
                let tableHTML = `<div class="report-day-section"><table class="report-table"><thead><tr><th class="rgf-col">RGF</th><th class="nome-col">NOME</th><th class="pedido-col">${day}</th></tr></thead><tbody>`;
                
                const dailyOrders = allOrders
                    .filter(orderDoc => orderDoc.data()[dayId])
                    .sort((a,b) => a.data().employeeName.localeCompare(b.data().employeeName));
                
                dailyOrders.forEach(orderDoc => {
                    const order = orderDoc.data();
                    let choice = (order[dayId] || '').toUpperCase();
                    const notes = order[`${dayId}_notes`];
                    let choiceHTML = choice;

                    if (choice === 'PRATO PRINCIPAL') choiceHTML = 'PRATO';
                    if (choice === 'OP√á√ÉO') choiceHTML = 'OP√á√ÉO';

                    if (notes) { choiceHTML += ` <span style="font-style: italic; font-weight: normal;">(${notes})</span>`; }

                    tableHTML += `<tr><td>${order.employeeRGF || 'N/A'}</td><td>${order.employeeName}</td><td>${choiceHTML}</td></tr>`;
                });
                tableHTML += '</tbody></table></div>';
                allDaysHTML += tableHTML;
            });
            reportContainer.innerHTML += allDaysHTML;
            window.print();
        }
        
        async function clearAllOrders() {
            console.log("Iniciando a limpeza de todos os pedidos da semana...");
            const querySnapshot = await getDocs(pedidosCollectionRef);
            const deletionPromises = [];
            querySnapshot.forEach((doc) => {
                deletionPromises.push(deleteDoc(doc.ref));
            });
            await Promise.all(deletionPromises);
            console.log(`${deletionPromises.length} pedidos foram exclu√≠dos com sucesso.`);
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileToUpload = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('uploadImageBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function uploadImageAndSaveMenu() {
            if (!fileToUpload) {
                showToast("Nenhuma imagem selecionada.", "error");
                return;
            }

            const message = "Tem a certeza que deseja atualizar o card√°pio? TODOS os pedidos da semana anterior ser√£o exclu√≠dos permanentemente.";
            showCustomConfirm(message, async () => {
                const uploadBtn = document.getElementById('uploadImageBtn');
                uploadBtn.disabled = true;
                uploadBtn.textContent = "A enviar...";

                try {
                    const options = { maxSizeMB: 0.5, maxWidthOrHeight: 1024 };
                    const compressedFile = await imageCompression(fileToUpload, options);
                    const base64String = await toBase64(compressedFile);

                    await setDoc(menuDocRef, { menuImageBase64: base64String });
                    await clearAllOrders();
                    
                    showToast("Card√°pio atualizado e pedidos zerados!", "success");
                    document.getElementById('whatsapp-notification-container').classList.remove('hidden');
                    document.getElementById('imageUpload').value = '';
                    document.getElementById('imagePreview').classList.add('hidden');
                    fileToUpload = null;

                } catch (error) {
                    console.error("Erro ao processar e guardar imagem:", error);
                    showToast("Falha ao guardar a imagem. A imagem pode ser grande demais.", "error");
                } finally {
                    uploadBtn.disabled = true;
                    uploadBtn.textContent = "Enviar Nova Imagem";
                }
            });
        }

        function handleWhatsAppNotification() {
            const message = `O card√°pio da semana foi atualizado! ‚ú® Confira as del√≠cias e fa√ßa seu pedido: ${window.location.href}`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            showToast('Abra o WhatsApp para enviar a notifica√ß√£o.', 'info');
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === APP_CONFIG.ADMIN_UID) {
                showAdminView();
            } else {
                if (!auth.currentUser) {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Erro no login an√≥nimo:", error);
                        showToast("N√£o foi poss√≠vel conectar-se. Verifique a sua liga√ß√£o.", "error");
                    });
                }
                showUserView();
            }
        });

        function showUserView() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            loadAndDisplayMenu(); 
        }

        function showAdminView() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            loadAndDisplayMenu(); 
            loadAdminData();
            loadAndRenderEmployees();
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Entrando...';
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (userCredential.user.uid !== APP_CONFIG.ADMIN_UID) {
                    await signOut(auth);
                    showToast("Credenciais v√°lidas, mas este usu√°rio n√£o √© um administrador.", 'error');
                }
            } catch (error) {
                console.error("Erro no login de administrador:", error);
                const msg = (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') ? "Email ou senha incorretos." : "Ocorreu um erro no login.";
                showToast(msg, 'error', 5000);
            } finally {
                btn.disabled = false; btn.textContent = 'Entrar';
            }
        }

        async function handleAdminLogout() {
            try { await signOut(auth); showToast("Logout de administrador bem-sucedido!", 'info'); } 
            catch (error) { console.error("Erro no logout:", error); showToast("Erro ao fazer logout.", 'error'); }
        }

        function main() {
            const rgfInput = document.getElementById('employeeRGF');
            rgfInput.addEventListener('input', () => {
                findEmployeeByRGF(rgfInput.value);
                validateForm();
            });
            rgfInput.addEventListener('blur', () => localStorage.setItem('employeeRGF', rgfInput.value));
            
            rgfInput.value = localStorage.getItem('employeeRGF') || '';
            if(rgfInput.value) { findEmployeeByRGF(rgfInput.value); validateForm(); }
            
            document.getElementById('wizard-options').addEventListener('click', handleWizardSelection);
            document.getElementById('openConfirmationModal').addEventListener('click', openConfirmationModal);
            document.getElementById('submitOrder').addEventListener('click', submitOrder);
            
            document.querySelectorAll('.cancel-modal-btn, #custom-confirm-cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.add('hidden'));
            });

            document.getElementById('switchToAdmin').addEventListener('click', () => document.getElementById('admin-login-modal').classList.remove('hidden'));
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            
            document.getElementById('adminLogoutBtn').addEventListener('click', handleAdminLogout);
            document.getElementById('switchToUserFromAdmin').addEventListener('click', showUserView);
            
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('employee-list-container').addEventListener('click', (e) => {
                if (e.target.closest('.edit-employee-btn')) { openEmployeeEditModal(e.target.closest('.edit-employee-btn').dataset.id, e.target.closest('.edit-employee-btn').dataset.name); }
                if (e.target.closest('.delete-employee-btn')) { handleDeleteEmployee(e.target.closest('.delete-employee-btn').dataset.id, e.target.closest('.delete-employee-btn').dataset.name); }
            });
            document.getElementById('edit-employee-form').addEventListener('submit', handleSaveEmployeeChanges);
            
            document.getElementById('searchInput').addEventListener('input', () => renderOrdersTable(allOrders));
            document.getElementById('generateReportBtn').addEventListener('click', generateAndPrintReport);
            
            document.getElementById('notifyWhatsAppBtn').addEventListener('click', handleWhatsAppNotification);
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            document.getElementById('uploadImageBtn').addEventListener('click', uploadImageAndSaveMenu);

            const zoomModal = document.getElementById('image-zoom-modal');
            const menuImage = document.getElementById('menu-image');
            menuImage.addEventListener('click', () => {
                document.getElementById('zoomed-image').src = menuImage.src;
                zoomModal.classList.remove('hidden');
            });
            zoomModal.addEventListener('click', () => zoomModal.classList.add('hidden'));
        }

        main();
    </script>
</body>
</html>
