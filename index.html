<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card√°pio Quatinga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Lobster Two', cursive; }
        .menu-option-card:has(input:checked) { border-color: #2563eb; background-color: #eff6ff; transform: scale(1.02); }
        .menu-option-card:has(input:checked) .checkmark { opacity: 1; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-print { }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-height: 90vh; overflow-y: auto; width: 90%; max-width: 500px; }
        input:read-only { background-color: #f3f4f6; cursor: not-allowed; }
        textarea:disabled, input[type="radio"]:disabled + div { cursor: not-allowed; opacity: 0.7; }
        .menu-option-card:has(input:disabled) { background-color: #f9fafb; border-color: #e5e7eb; cursor: not-allowed; }

        #print-report { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            body > *:not(#print-report) { display: none !important; }
            #print-report { display: block !important; }
            #print-report h1 { font-size: 18pt; text-align: center; margin-bottom: 15px; font-family: 'Poppins', sans-serif; font-weight: 600; }
            .report-day-section { margin-bottom: 12px; page-break-inside: avoid; }
            .report-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
            #print-report th, #print-report td { border: 1px solid #999; padding: 5px; text-align: left; }
            #print-report th { background-color: #e2e8f0; font-weight: 600; }
            #print-report .rgf-col { width: 15%; }
            #print-report .nome-col { width: 60%; }
            #print-report .pedido-col { width: 25%; background-color: #dbeafe; font-weight: bold; }
        }
        #app-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; pointer-events: none; transform: translateX(-50%) translateY(20px); }
        #app-toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
        #app-toast.success { background-color: #22c55e; }
        #app-toast.error { background-color: #ef4444; }
        #app-toast.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-20">
        
        <div id="user-view" class="no-print">
            <div id="form-container">
                <header class="text-center mb-8"><h1 class="font-brand text-5xl text-blue-600">Del√≠cias Urbanas</h1><p class="mt-2 text-md text-gray-500">O seu card√°pio da semana est√° servido!</p></header>
                
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h2 class="block text-lg font-semibold text-gray-800 mb-2">üë§ 1. Identifica√ß√£o</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div><label for="employeeRGF" class="block text-sm font-medium text-gray-700">Seu RGF</label><input type="text" id="employeeRGF" placeholder="Digite o seu RGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                        <div><label for="employeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="employeeName" placeholder="Preenchido automaticamente" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div>
                    </div>
                </div>

                <div id="current-week-order-display" class="mb-8 bg-white rounded-xl shadow-sm p-6"></div>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">üçΩÔ∏è 2. Escolha os seus pratos (Pr√≥xima Semana)</h2><div id="menu" class="space-y-8"><div class="text-center text-gray-500">A carregar o card√°pio...</div></div></div>
                <div id="guidanceSection" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6"><p id="guidanceText" class="font-semibold">Digite seu RGF e escolha uma op√ß√£o para cada dia.</p></div>
                <div id="submitButtonContainer" class="hidden text-center"><button id="openConfirmationModal" class="w-full sm:w-auto bg-green-500 text-white font-bold text-lg px-8 py-3 rounded-xl hover:bg-green-600 shadow-lg">Revisar e Finalizar Pedido</button></div>
            </div>
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Fazer Novo Pedido</button></div>
            <footer class="text-center mt-10">
                <button id="switchToAdmin" class="text-sm text-gray-500 hover:text-blue-600">Aceder ao Painel do Administrador</button>
            </footer>
        </div>

        <div id="admin-view" class="hidden no-print">
            <header class="text-center border-b pb-6 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Painel do Administrador</h1>
                <p class="text-lg text-gray-600 mt-1">Del√≠cias Urbanas</p>
                <div class="mt-4">
                    <button id="adminLogoutBtn" class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600">Sair do Painel</button>
                </div>
            </header>
            <div class="mb-8">
                <button id="switchToUserFromAdmin" class="text-sm text-gray-500 hover:text-blue-600">‚¨ÖÔ∏è Voltar para o Card√°pio (Vis√£o Usu√°rio)</button>
            </div>
            
            <section id="order-status-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üìä Status de Pedidos da Semana Atual</h2>
                <div id="order-status-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p class="text-gray-500">A carregar status dos pedidos...</p>
                </div>
            </section>

            <section id="menu-updater-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-4">üçú Atualizar Card√°pio da PR√ìXIMA Semana com Imagem (IA)</h2>
                <p class="text-gray-600 mb-4">Envie uma imagem do novo card√°pio para a pr√≥xima semana. A nossa intelig√™ncia artificial ir√° ler e preencher os campos para si.</p>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" class="mt-4 rounded-lg max-h-80 hidden" />
                <div id="image-processor-container" class="mt-4 text-center hidden"><button id="processImageBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Analisar Card√°pio da Pr√≥xima Semana</button></div>
                <div id="loader" class="hidden mx-auto my-4 loader"></div>
                <div id="confirmation-form" class="hidden mt-6"></div>
                <div id="whatsapp-notification-container" class="mt-4 text-center hidden">
                    <button id="notifyWhatsAppBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="white"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.287.492-1.24 4.515 4.639-1.219.452.273zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                        Notificar Funcion√°rios no WhatsApp (Pr√≥xima Semana)
                    </button>
                </div>
                <div class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">üöÄ Gerenciamento de Transi√ß√£o de Card√°pio</h3>
                    <button id="promoteMenuBtn" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 shadow-md">
                        Promover Card√°pio da Pr√≥xima Semana para Atual
                    </button>
                    <p class="text-sm text-gray-500 mt-2">Esta a√ß√£o tornar√° o card√°pio da "pr√≥xima semana" o card√°pio "atual". O card√°pio da "pr√≥xima semana" ser√° ent√£o reiniciado. Os pedidos da pr√≥xima semana ser√£o movidos para a semana atual.</p>
                </div>
            </section>

            <section id="employee-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üë• Gerenciamento de Funcion√°rios</h2>
                <form id="add-employee-form" class="grid sm:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="newEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label>
                        <input type="text" id="newEmployeeRGF" placeholder="RGF do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="newEmployeeName" placeholder="Nome do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Funcion√°rio</button>
                </form>
                <div id="employee-list-container" class="overflow-x-auto">
                    <p class="text-gray-500">A carregar lista de funcion√°rios...</p>
                </div>
            </section>

            <section id="orders-section">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Pedidos Recebidos (Semana Atual)</h2>
                    <div class="w-full sm:w-auto"><input type="text" id="searchInput" placeholder="üîé Buscar por nome..." class="w-full sm:w-64 px-4 py-2 border rounded-lg"></div>
                    <button id="generateReportBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">üñ®Ô∏è Salvar Relat√≥rio como PDF</button>
                </div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>

            <section id="next-week-orders-section" class="mt-12">
                <h2 class="text-xl font-semibold text-gray-700 mb-3 mt-8 border-t pt-6">üîî Pedidos para Pr√≥xima Semana</h2>
                <div id="nextWeekOrdersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos da pr√≥xima semana...</p></div>
            </section>
        </div>
    </div>

    <div id="edit-order-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Pedido</h2><form id="edit-order-form"><input type="hidden" id="edit-order-id"><input type="hidden" id="edit-order-type"><div class="mb-4"><label class="block text-lg font-semibold text-gray-800 mb-2">Nome do Funcion√°rio</label><input type="text" id="edit-order-employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly></div><div id="edit-menu-options" class="space-y-6"></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button></div></form></div></div>
    <div id="edit-employee-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Funcion√°rio</h2><form id="edit-employee-form"><div class="mb-4"><label for="editEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label><input type="text" id="editEmployeeRGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div><div class="mb-4"><label for="editEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="editEmployeeName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button></div></form></div></div>
    <div id="confirmation-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-2xl font-bold mb-4">Confirme o seu Pedido (Pr√≥xima Semana)</h2><p class="mb-6 text-gray-600">Por favor, revise as suas escolhas antes de enviar.</p><div id="confirmation-summary" class="space-y-2 mb-8"></div><div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Editar</button><button id="submitOrder" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">Confirmar e Enviar</button></div></div></div>
    <div id="admin-login-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Aceder ao Painel de Administrador</h2><form id="admin-login-form"><div class="mb-4"><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="adminEmail" placeholder="seu-email@exemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="adminPassword" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="adminPassword" placeholder="Sua senha" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button></div></form></div></div>
    <div id="custom-confirm-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-xl font-bold mb-4" id="custom-confirm-title">Confirmar A√ß√£o</h2><p class="mb-6 text-gray-600" id="custom-confirm-message">Tem a certeza que deseja prosseguir?</p><div class="flex justify-end space-x-4"><button id="custom-confirm-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button id="custom-confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirmar</button></div></div></div>

    <div id="print-report"></div>
    <div id="app-toast"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, setDoc, deleteDoc, updateDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI",
            authDomain: "cardapio-8ddea.firebaseapp.com",
            projectId: "cardapio-8ddea",
            storageBucket: "cardapio-8ddea.appspot.com",
            messagingSenderId: "1019677985212",
            appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const APP_CONFIG = {
            ADMIN_UID: 'LqAXao4FuOQAvzS3uQAd9et6OnK2',
        };
        
        const refCardapioSemanaAtual = doc(db, "cardapio", "currentWeek");
        const refCardapioProximaSemana = doc(db, "cardapio", "nextWeek");
        const refPedidosDaSemana = collection(db, "pedidosDaSemana"); 
        const refPedidosProximaSemana = collection(db, "pedidosProximaSemana");
        const refFuncionarios = collection(db, "funcionarios");
        
        const opcoesFixas = [{ name: 'Omelete', emoji: 'üç≥' }, { name: 'Fil√© de frango', emoji: 'üçó' }];
        
        let cardapioProximaSemana = []; 
        let cardapioSemanaAtual = []; 
        let todosPedidosSemanaAtual = []; 
        let todosPedidosProximaSemana = [];
        let dadosTemporariosPedido = {}; 
        let pedidoAtualFuncionario = null;
        let pedidoProximaSemanaFuncionario = null;
        
        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro
        function obterIdDia(nomeDia) { 
            return nomeDia.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, "").toLowerCase(); 
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metros
        function exibirToast(mensagem, tipo = 'info', duracao = 3000) {
            const toast = document.getElementById('app-toast');
            if(!toast) return;
            toast.textContent = mensagem; 
            toast.className = 'show';
            toast.classList.add(tipo);
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, duracao);
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metros
        function exibirConfirmacaoPersonalizada(mensagem, aoConfirmar) {
            const modal = document.getElementById('custom-confirm-modal');
            const elementoMensagem = document.getElementById('custom-confirm-message');
            const botaoOk = document.getElementById('custom-confirm-ok-btn');
            
            elementoMensagem.textContent = mensagem; 
            modal.classList.remove('hidden');

            const novoBotaoOk = botaoOk.cloneNode(true); 
            botaoOk.parentNode.replaceChild(novoBotaoOk, botaoOk); 
            
            novoBotaoOk.addEventListener('click', () => {
                aoConfirmar();
                modal.classList.add('hidden');
            });
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function carregarErenderizarFuncionarios() {
            const q = query(refFuncionarios, orderBy("nome"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('employee-list-container');
                container.innerHTML = ''; 

                if (snapshot.empty) {
                    const p = document.createElement('p');
                    p.className = 'text-gray-500 text-center py-4';
                    p.textContent = 'Nenhum funcion√°rio cadastrado.';
                    container.appendChild(p);
                    return;
                }

                const table = document.createElement('table');
                table.className = 'min-w-full bg-white border';
                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                const headers = ['RGF', 'Nome', 'A√ß√µes'];
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.className = 'py-2 px-3 border-b text-left';
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                
                const tbody = table.createTBody();
                snapshot.forEach(doc => { // doc √© idiom√°tico do Firebase, mantido
                    const funcionario = doc.data(); // funcionario √© mais claro que dadosFuncionario aqui
                    const tr = tbody.insertRow();
                    
                    let tdRGF = tr.insertCell();
                    tdRGF.className = 'py-2 px-3 border-b font-mono';
                    tdRGF.textContent = doc.id;

                    let tdNome = tr.insertCell();
                    tdNome.className = 'py-2 px-3 border-b font-semibold';
                    tdNome.textContent = funcionario.nome;

                    let tdAcoes = tr.insertCell();
                    tdAcoes.className = 'py-2 px-3 border-b space-x-2';
                    
                    const botaoEditar = document.createElement('button');
                    botaoEditar.dataset.id = doc.id;
                    botaoEditar.dataset.name = funcionario.nome;
                    botaoEditar.className = 'edit-employee-btn text-blue-600 hover:text-blue-800 text-sm font-semibold';
                    botaoEditar.textContent = 'Editar';
                    tdAcoes.appendChild(botaoEditar);

                    const botaoExcluir = document.createElement('button');
                    botaoExcluir.dataset.id = doc.id;
                    botaoExcluir.dataset.name = funcionario.nome;
                    botaoExcluir.className = 'delete-employee-btn text-red-600 hover:text-red-800 text-sm font-semibold';
                    botaoExcluir.textContent = 'Excluir';
                    tdAcoes.appendChild(botaoExcluir);
                });
                container.appendChild(table);
            }, (erro) => {
                 console.error("Erro ao carregar funcion√°rios:", erro);
                 exibirToast("Falha ao carregar funcion√°rios. Verifique o console para mais detalhes.", "error");
            });
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro (evento)
        async function manipularAdicionarFuncionario(evento) {
            evento.preventDefault();
            const campoRGF = document.getElementById('newEmployeeRGF');
            const campoNome = document.getElementById('newEmployeeName');
            const rgf = campoRGF.value.trim();
            const nome = campoNome.value.trim();

            if (!rgf || !nome) { exibirToast("Por favor, preencha o RGF e o Nome.", 'error'); return; }

            try {
                await setDoc(doc(db, "funcionarios", rgf), { nome });
                exibirToast("Funcion√°rio adicionado com sucesso!", 'success');
                campoRGF.value = ''; campoNome.value = '';
            } catch (erro) {
                console.error("Erro ao adicionar funcion√°rio: ", erro);
                exibirToast("Ocorreu um erro ao adicionar o funcion√°rio.", 'error');
            }
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro (nome)
        function manipularExcluirFuncionario(rgf, nome) {
            const mensagem = `Tem a certeza que deseja excluir o funcion√°rio ${nome} (RGF: ${rgf})? Esta a√ß√£o n√£o pode ser desfeita.`;
            exibirConfirmacaoPersonalizada(mensagem, async () => {
                try {
                    await deleteDoc(doc(db, "funcionarios", rgf));
                    exibirToast("Funcion√°rio exclu√≠do com sucesso.", 'success');
                } catch (erro) {
                    console.error("Erro ao excluir funcion√°rio: ", erro);
                    exibirToast("Falha ao excluir o funcion√°rio.", 'error');
                }
            });
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro (nome)
        function abrirModalEdicaoFuncionario(rgf, nome) {
            document.getElementById('editEmployeeRGF').value = rgf;
            document.getElementById('editEmployeeName').value = nome;
            document.getElementById('edit-employee-modal').classList.remove('hidden');
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro (evento)
        async function manipularSalvarAlteracoesFuncionario(evento) {
            evento.preventDefault();
            const rgf = document.getElementById('editEmployeeRGF').value;
            const novoNome = document.getElementById('editEmployeeName').value.trim();

            if (!novoNome) { exibirToast("O nome n√£o pode ficar em branco.", 'error'); return; }
            try {
                await updateDoc(doc(db, "funcionarios", rgf), { nome: novoNome });
                exibirToast("Funcion√°rio atualizado com sucesso!", 'success');
                document.getElementById('edit-employee-modal').classList.add('hidden');
            } catch (erro) {
                console.error("Erro ao salvar altera√ß√µes do funcion√°rio: ", erro);
                exibirToast("Falha ao salvar as altera√ß√µes do funcion√°rio.", 'error');
            }
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o
        async function buscarFuncionarioPorRGF(rgf) {
            const campoNome = document.getElementById('employeeName');
            if (!rgf) { 
                campoNome.value = ''; 
                campoNome.placeholder = 'Preenchido automaticamente'; 
                pedidoAtualFuncionario = null; 
                pedidoProximaSemanaFuncionario = null;
                exibirPedidoSemanaAtual(); 
                criarHTMLCardapio(); 
                validarFormulario(); 
                return; 
            }
            try {
                const snapshotDocumento = await getDoc(doc(db, "funcionarios", rgf));
                if (snapshotDocumento.exists()) {
                    campoNome.value = snapshotDocumento.data().nome; 
                    await buscarEExibirPedidosFuncionario(rgf); 
                } else {
                    campoNome.value = ''; 
                    campoNome.placeholder = 'RGF n√£o encontrado';
                    pedidoAtualFuncionario = null;
                    pedidoProximaSemanaFuncionario = null;
                    exibirPedidoSemanaAtual();
                    criarHTMLCardapio(); 
                }
                validarFormulario(); 
            } catch (erro) {
                console.error("Erro ao buscar funcion√°rio:", erro);
                campoNome.value = ''; campoNome.placeholder = 'Erro na busca';
                exibirToast("Erro ao buscar funcion√°rio.", 'error');
                pedidoAtualFuncionario = null;
                pedidoProximaSemanaFuncionario = null;
                exibirPedidoSemanaAtual();
                criarHTMLCardapio();
                validarFormulario();
            }
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        async function buscarEExibirPedidosFuncionario(rgf) {
            pedidoAtualFuncionario = null;
            pedidoProximaSemanaFuncionario = null;
            try {
                const qAtual = query(refPedidosDaSemana, where("employeeRGF", "==", rgf), orderBy("timestamp", "desc"));
                const snapshotPedidoAtual = await getDocs(qAtual);
                if (!snapshotPedidoAtual.empty) {
                    pedidoAtualFuncionario = snapshotPedidoAtual.docs[0].data();
                }
            } catch (erro) { console.error("Erro ao buscar pedido da semana atual:", erro); exibirToast("Erro ao buscar pedido da semana atual.", "error");}
            try {
                const qProxima = query(refPedidosProximaSemana, where("employeeRGF", "==", rgf), orderBy("timestamp", "desc"));
                const snapshotPedidoProximo = await getDocs(qProxima);
                if (!snapshotPedidoProximo.empty) {
                    pedidoProximaSemanaFuncionario = snapshotPedidoProximo.docs[0].data();
                }
            } catch (erro) { console.error("Erro ao buscar pedido da pr√≥xima semana:", erro); exibirToast("Erro ao buscar pedido da pr√≥xima semana.", "error");}
            exibirPedidoSemanaAtual();
            criarHTMLCardapio(); 
            validarFormulario(); 
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function exibirPedidoSemanaAtual() {
            const divDisplay = document.getElementById('current-week-order-display');
            if (!divDisplay) return;

            divDisplay.innerHTML = ''; 
            const tituloH2 = document.createElement('h2');
            tituloH2.className = 'text-xl font-bold text-gray-800 mb-3';
            tituloH2.textContent = 'üóìÔ∏è Seu Pedido para a Semana Atual:';
            divDisplay.appendChild(tituloH2);

            if (!cardapioSemanaAtual || cardapioSemanaAtual.length === 0) {
                const p = document.createElement('p');
                p.className = 'text-gray-500';
                p.textContent = 'Card√°pio da semana atual n√£o dispon√≠vel.';
                divDisplay.appendChild(p);
                return;
            }
            if (!pedidoAtualFuncionario) {
                const p = document.createElement('p');
                p.className = 'text-gray-500';
                p.textContent = 'Nenhum pedido encontrado para a semana atual.';
                divDisplay.appendChild(p);
                return;
            }

            const containerSumario = document.createElement('div');
            containerSumario.className = 'space-y-3';
            cardapioSemanaAtual.forEach(itemDia => {
                const divDia = document.createElement('div');
                divDia.className = 'p-3 bg-gray-50 rounded-md';

                const pDia = document.createElement('p');
                pDia.className = 'font-semibold';
                pDia.textContent = `${itemDia.day}: `;

                if (itemDia.isHoliday) {
                    const spanFeriado = document.createElement('span');
                    spanFeriado.className = 'text-indigo-600';
                    spanFeriado.textContent = 'Feriado';
                    pDia.appendChild(spanFeriado);
                } else {
                    const idDia = obterIdDia(itemDia.day);
                    const escolha = pedidoAtualFuncionario[idDia];
                    const anotacoes = pedidoAtualFuncionario[`${idDia}_notes`];
                    
                    const spanEscolha = document.createElement('span');
                    spanEscolha.className = 'text-blue-700 font-normal';
                    spanEscolha.textContent = escolha || 'N√£o selecionado';
                    pDia.appendChild(spanEscolha);

                    if (anotacoes) {
                        const pAnotacoes = document.createElement('p');
                        pAnotacoes.className = 'text-sm text-gray-600 italic';
                        pAnotacoes.textContent = `Anota√ß√µes: ${anotacoes}`;
                        divDia.appendChild(pAnotacoes);
                    }
                }
                divDia.insertBefore(pDia, divDia.firstChild); 
                containerSumario.appendChild(divDia);
            });
            divDisplay.appendChild(containerSumario);
        }
        
        // Tradu√ß√£o de par√¢metro
        function createFallbackMenu(tipoSemana = "Pr√≥xima Semana") {
            const dias = ['Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];
            const nomeMenu = tipoSemana === "Semana Atual" ? 'Card√°pio da semana atual n√£o definido' : 'Card√°pio da pr√≥xima semana n√£o definido';
            return dias.map(dia => ({ day: dia, isHoliday: false, isSpecial: false, pratoPrincipal: { name: nomeMenu, emoji: 'üöß' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } }));
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function carregarCardapios() {
            onSnapshot(refCardapioProximaSemana, (snapshotDocumento) => {
                console.log("Carregando refCardapioProximaSemana. Existe:", snapshotDocumento.exists()); // Traduzido
                cardapioProximaSemana = (snapshotDocumento.exists() && snapshotDocumento.data().menu?.length > 0) ? snapshotDocumento.data().menu : createFallbackMenu("Pr√≥xima Semana");
                if (document.getElementById('user-view').classList.contains('hidden') === false) criarHTMLCardapio();
                if (document.getElementById('admin-view').classList.contains('hidden') === false) renderizarTabelaPedidosProximaSemana(); 
            }, (erro) => {
                 console.error("Erro ao carregar o card√°pio da pr√≥xima semana:", erro);
                 exibirToast("Erro ao carregar card√°pio da pr√≥xima semana. Usando padr√£o.", 'error');
                 cardapioProximaSemana = createFallbackMenu("Pr√≥xima Semana");
                 if (document.getElementById('user-view').classList.contains('hidden') === false) criarHTMLCardapio();
                 if (document.getElementById('admin-view').classList.contains('hidden') === false) renderizarTabelaPedidosProximaSemana();
            });

            onSnapshot(refCardapioSemanaAtual, (snapshotDocumento) => {
                console.log("Carregando refCardapioSemanaAtual. Existe:", snapshotDocumento.exists()); // Traduzido
                cardapioSemanaAtual = (snapshotDocumento.exists() && snapshotDocumento.data().menu?.length > 0) ? snapshotDocumento.data().menu : createFallbackMenu("Semana Atual");
                if (document.getElementById('user-view').classList.contains('hidden') === false) exibirPedidoSemanaAtual();
                if (document.getElementById('admin-view').classList.contains('hidden') === false) renderizarTabelaPedidosSemanaAtual(); 
            }, (erro) => {
                 console.error("Erro ao carregar o card√°pio da semana atual:", erro);
                 exibirToast("Erro ao carregar card√°pio da semana atual. Usando padr√£o.", 'error');
                 cardapioSemanaAtual = createFallbackMenu("Semana Atual");
                 if (document.getElementById('user-view').classList.contains('hidden') === false) exibirPedidoSemanaAtual();
                 if (document.getElementById('admin-view').classList.contains('hidden') === false) renderizarTabelaPedidosSemanaAtual();
            });
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o
        function criarHTMLCardapio() {
            const containerCardapio = document.getElementById('menu');
            const secaoOrientacao = document.getElementById('guidanceSection');
            const textoOrientacao = document.getElementById('guidanceText');
            const containerBotaoEnvio = document.getElementById('submitButtonContainer');
            if (!containerCardapio || !secaoOrientacao || !textoOrientacao || !containerBotaoEnvio) return;
            
            containerCardapio.innerHTML = ''; 
            const proximoPedidoBloqueado = !!pedidoProximaSemanaFuncionario;
            if (proximoPedidoBloqueado) {
                textoOrientacao.textContent = "Seu pedido para a pr√≥xima semana j√° foi registrado e n√£o pode ser alterado. Abaixo suas escolhas:";
                secaoOrientacao.classList.remove('hidden'); containerBotaoEnvio.classList.add('hidden');
            } else {
                textoOrientacao.textContent = "Digite seu RGF e escolha uma op√ß√£o para cada dia."; 
            }

            cardapioProximaSemana.forEach(itemDia => { // itemDia √© mais espec√≠fico
                const divSecaoDia = document.createElement('div');
                divSecaoDia.className = 'day-section space-y-3';

                let elementoTituloDia = document.createElement('h3');
                elementoTituloDia.className = 'text-xl font-bold text-gray-800';
                elementoTituloDia.textContent = itemDia.day;

                if (itemDia.isSpecial) {
                    const divEspecial = document.createElement('div');
                    divEspecial.className = 'flex items-center gap-3';
                    divEspecial.appendChild(elementoTituloDia); 
                    const spanEspecial = document.createElement('span');
                    spanEspecial.className = 'text-sm font-semibold text-purple-800 bg-purple-200 rounded-full px-3 py-1';
                    spanEspecial.textContent = '‚ú® Almo√ßo Especial';
                    divEspecial.appendChild(spanEspecial);
                    divSecaoDia.appendChild(divEspecial);
                } else {
                    divSecaoDia.appendChild(elementoTituloDia);
                }

                if (itemDia.isHoliday) {
                    const divFeriado = document.createElement('div');
                    divFeriado.className = 'bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-md';
                    const pNegrito = document.createElement('p');
                    pNegrito.className = 'font-bold';
                    pNegrito.textContent = 'üéä Feriado';
                    const pNormal = document.createElement('p');
                    pNormal.textContent = 'N√£o haver√° refei√ß√£o neste dia.';
                    divFeriado.appendChild(pNegrito);
                    divFeriado.appendChild(pNormal);
                    divSecaoDia.appendChild(divFeriado);
                } else {
                    const todasOpcoes = [ { ...itemDia.pratoPrincipal, type: 'Prato Principal' }, ...(itemDia.opcao?.name ? [{ ...itemDia.opcao, type: 'Op√ß√£o do Dia' }] : []), ...opcoesFixas.map(fixa => ({ ...fixa, type: 'Op√ß√£o Fixa' })), ];
                    
                    if (itemDia.guarnicao?.name) {
                        const divGuarnicao = document.createElement('div');
                        divGuarnicao.className = 'text-sm font-semibold text-blue-600 bg-blue-100 rounded-full inline-block px-3 py-1 mb-3';
                        divGuarnicao.textContent = `Guarni√ß√£o: ${itemDia.guarnicao.name} ${itemDia.guarnicao.emoji || ''}`;
                        divSecaoDia.appendChild(divGuarnicao);
                    }

                    const containerOpcoesDiv = document.createElement('div');
                    containerOpcoesDiv.className = 'space-y-3';
                    todasOpcoes.forEach((opcao) => {
                        if (opcao.name) {
                            const idDia = obterIdDia(itemDia.day);
                            const label = document.createElement('label');
                            label.className = `menu-option-card block p-4 border-2 border-gray-200 rounded-lg ${proximoPedidoBloqueado ? 'bg-gray-100 cursor-not-allowed opacity-70' : 'cursor-pointer transition-transform duration-200'}`;
                            
                            const inputRadio = document.createElement('input');
                            inputRadio.type = 'radio';
                            inputRadio.name = idDia;
                            inputRadio.value = opcao.name;
                            inputRadio.className = 'hidden';
                            if (proximoPedidoBloqueado) inputRadio.disabled = true;
                            if (proximoPedidoBloqueado && pedidoProximaSemanaFuncionario[idDia] === opcao.name) inputRadio.checked = true;
                            
                            const divConteudo = document.createElement('div');
                            divConteudo.className = 'flex items-center';
                            
                            const spanEmoji = document.createElement('span');
                            spanEmoji.className = 'text-3xl mr-4';
                            spanEmoji.textContent = opcao.emoji || 'üçΩÔ∏è';
                            
                            const divTexto = document.createElement('div');
                            divTexto.className = 'flex-grow';
                            const pNome = document.createElement('p');
                            pNome.className = 'font-semibold text-gray-800';
                            pNome.textContent = opcao.name;
                            const pTipo = document.createElement('p');
                            pTipo.className = 'text-sm text-gray-500';
                            pTipo.textContent = opcao.type;
                            divTexto.appendChild(pNome);
                            divTexto.appendChild(pTipo);
                            
                            const svgCheckmark = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                            svgCheckmark.setAttribute('class', `checkmark h-6 w-6 text-blue-600 ${proximoPedidoBloqueado && inputRadio.checked ? 'opacity-100' : 'opacity-0'} transition-opacity`);
                            svgCheckmark.setAttribute('fill', 'none');
                            svgCheckmark.setAttribute('viewBox', '0 0 24 24');
                            svgCheckmark.setAttribute('stroke', 'currentColor');
                            svgCheckmark.setAttribute('stroke-width', '3');
                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            path.setAttribute('d', 'M5 13l4 4L19 7');
                            svgCheckmark.appendChild(path);

                            divConteudo.appendChild(spanEmoji);
                            divConteudo.appendChild(divTexto);
                            divConteudo.appendChild(svgCheckmark);
                            label.appendChild(inputRadio);
                            label.appendChild(divConteudo);
                            containerOpcoesDiv.appendChild(label);
                        }
                    });
                    divSecaoDia.appendChild(containerOpcoesDiv);

                    const divAnotacoes = document.createElement('div');
                    divAnotacoes.className = 'mt-3';
                    const textareaAnotacoes = document.createElement('textarea');
                    textareaAnotacoes.id = `notes-${obterIdDia(itemDia.day)}`;
                    textareaAnotacoes.name = `notes-${obterIdDia(itemDia.day)}`;
                    textareaAnotacoes.rows = 2;
                    textareaAnotacoes.className = `w-full px-3 py-2 border border-gray-300 rounded-lg text-sm ${proximoPedidoBloqueado ? 'bg-gray-100 cursor-not-allowed' : ''}`;
                    textareaAnotacoes.placeholder = "Anota√ß√µes? Ex: sem cebola, ponto da carne, etc.";
                    if (proximoPedidoBloqueado) {
                        textareaAnotacoes.disabled = true;
                        textareaAnotacoes.value = (pedidoProximaSemanaFuncionario && pedidoProximaSemanaFuncionario[`${obterIdDia(itemDia.day)}_notes`]) ? pedidoProximaSemanaFuncionario[`${obterIdDia(itemDia.day)}_notes`] : '';
                    }
                    divAnotacoes.appendChild(textareaAnotacoes);
                    divSecaoDia.appendChild(divAnotacoes);
                }
                containerCardapio.appendChild(divSecaoDia);
            });
            if (!proximoPedidoBloqueado) validarFormulario();
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function validarFormulario() {
            const nome = document.getElementById('employeeName')?.value.trim();
            const rgf = document.getElementById('employeeRGF')?.value.trim();
            const secaoOrientacao = document.getElementById('guidanceSection');
            const textoOrientacao = document.getElementById('guidanceText');
            const containerBotaoEnvio = document.getElementById('submitButtonContainer');
            if (!secaoOrientacao || !containerBotaoEnvio || !textoOrientacao) return;
            if (pedidoProximaSemanaFuncionario) { containerBotaoEnvio.classList.add('hidden'); return; }
            const itensNaoFeriado = cardapioProximaSemana.filter(item => !item.isHoliday);
            const todasSelecoesFeitas = itensNaoFeriado.length > 0 && itensNaoFeriado.every(item => document.querySelector(`input[name="${obterIdDia(item.day)}"]:checked`));
            if (nome && rgf && todasSelecoesFeitas) {
                secaoOrientacao.classList.add('hidden'); containerBotaoEnvio.classList.remove('hidden');
            } else {
                containerBotaoEnvio.classList.add('hidden'); secaoOrientacao.classList.remove('hidden');
                let mensagem = '';
                if(!rgf) mensagem = 'Digite seu RGF para come√ßar. ';
                else if(!nome) mensagem = 'RGF n√£o encontrado. Pe√ßa para um administrador cadastr√°-lo. ';
                else if (!todasSelecoesFeitas && cardapioProximaSemana.length > 0 && cardapioProximaSemana.some(d => !d.isHoliday && d.pratoPrincipal.name !== 'Card√°pio da pr√≥xima semana n√£o definido')) {
                    const diasFaltantes = itensNaoFeriado.filter(item => !document.querySelector(`input[name="${obterIdDia(item.day)}"]:checked`)).map(item => item.day);
                    if (diasFaltantes.length > 0) mensagem += `Falta selecionar op√ß√µes para: ${diasFaltantes.join(', ')}.`;
                } else if (cardapioProximaSemana.length === 0 || cardapioProximaSemana.every(d => d.pratoPrincipal.name === 'Card√°pio da pr√≥xima semana n√£o definido')) {
                     mensagem = 'Card√°pio da pr√≥xima semana ainda n√£o dispon√≠vel. Tente novamente mais tarde.';
                }
                textoOrientacao.textContent = mensagem || 'Por favor, preencha todos os campos e selecione suas op√ß√µes.';
            }
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o
        function abrirModalConfirmacao() {
            dadosTemporariosPedido = { employeeName: document.getElementById('employeeName').value.trim(), employeeRGF: document.getElementById('employeeRGF').value.trim(), timestamp: serverTimestamp() };
            const containerSumario = document.getElementById('confirmation-summary');
            containerSumario.innerHTML = ''; 
            cardapioProximaSemana.forEach(item => {
                const idDia = obterIdDia(item.day);
                if (!item.isHoliday) {
                    const inputEscolha = document.querySelector(`input[name="${idDia}"]:checked`);
                    if (!inputEscolha) return;
                    const escolha = inputEscolha.value;
                    const anotacoes = document.getElementById(`notes-${idDia}`).value.trim();
                    dadosTemporariosPedido[idDia] = escolha;
                    if(anotacoes) dadosTemporariosPedido[`${idDia}_notes`] = anotacoes;
                    
                    const p = document.createElement('p');
                    const spanDia = document.createElement('span');
                    spanDia.className = 'font-bold';
                    spanDia.textContent = `${item.day}: `;
                    p.appendChild(spanDia);
                    p.appendChild(document.createTextNode(escolha));
                    if (anotacoes) {
                        const spanAnotacoes = document.createElement('span');
                        spanAnotacoes.className = 'text-sm text-gray-500 italic';
                        spanAnotacoes.textContent = ` (${anotacoes})`;
                        p.appendChild(spanAnotacoes);
                    }
                    containerSumario.appendChild(p);
                }
            });
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        async function enviarPedido() {
            const botao = document.getElementById('submitOrder');
            botao.disabled = true; botao.textContent = 'A enviar...';
            try {
                await addDoc(refPedidosProximaSemana, dadosTemporariosPedido); 
                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-text').textContent = `Obrigado, ${dadosTemporariosPedido.employeeName}. O seu pedido para a pr√≥xima semana foi registado com sucesso.`;
                document.getElementById('success-message').classList.remove('hidden');
                exibirToast("Pedido para pr√≥xima semana enviado com sucesso!", 'success');
                await buscarEExibirPedidosFuncionario(dadosTemporariosPedido.employeeRGF); 
            } catch (erro) {
                console.error("Erro ao enviar pedido: ", erro);
                exibirToast("Ocorreu um erro ao enviar o seu pedido.", 'error');
            } finally {
                botao.disabled = false; botao.textContent = 'Confirmar e Enviar';
            }
        }
        
        function loadAdminData() {
            onSnapshot(refPedidosDaSemana, (snapshot) => {
                const latestOrdersMap = new Map();
                snapshot.forEach(doc => { // doc √© idiom√°tico
                    const orderData = doc.data();
                    if (orderData.employeeRGF) {
                        const timestamp = orderData.timestamp ? orderData.timestamp.toMillis() : 0;
                         if (!latestOrdersMap.has(orderData.employeeRGF) || timestamp > latestOrdersMap.get(orderData.employeeRGF).timestamp) {
                             latestOrdersMap.set(orderData.employeeRGF, { id: doc.id, ...orderData, timestampMillis: timestamp });
                         }
                    }
                });
                todosPedidosSemanaAtual = Array.from(latestOrdersMap.values()).sort((a, b) => a.employeeName.localeCompare(b.employeeName));
                renderizarTabelaPedidosSemanaAtual(); 
                renderizarStatusPedidos(todosPedidosSemanaAtual); 
            }, (erro) => {
                console.error("Erro ao carregar pedidos da semana atual:", erro);
                exibirToast("Erro ao carregar pedidos da semana atual.", 'error');
            });

            onSnapshot(refPedidosProximaSemana, (snapshot) => {
                const latestOrdersMapNextWeek = new Map();
                snapshot.forEach(doc => { // doc √© idiom√°tico
                    const orderData = doc.data();
                     if (orderData.employeeRGF) {
                        const timestamp = orderData.timestamp ? orderData.timestamp.toMillis() : 0;
                        if (!latestOrdersMapNextWeek.has(orderData.employeeRGF) || timestamp > latestOrdersMapNextWeek.get(orderData.employeeRGF).timestampMillis) {
                            latestOrdersMapNextWeek.set(orderData.employeeRGF, { id: doc.id, ...orderData, timestampMillis: timestamp });
                        }
                    }
                });
                todosPedidosProximaSemana = Array.from(latestOrdersMapNextWeek.values()).sort((a,b) => a.employeeName.localeCompare(b.employeeName));
                renderizarTabelaPedidosProximaSemana();
            }, (erro) => {
                console.error("Erro ao carregar pedidos da pr√≥xima semana:", erro);
                exibirToast("Erro ao carregar pedidos da pr√≥xima semana.", 'error');
            });
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro
        async function renderizarStatusPedidos(pedidos) {
            const container = document.getElementById('order-status-container');
            container.innerHTML = ''; 
            const pProcessando = document.createElement('p');
            pProcessando.className = 'text-gray-500';
            pProcessando.textContent = 'A processar...';
            container.appendChild(pProcessando);

            try {
                const snapshotFuncionarios = await getDocs(query(refFuncionarios, orderBy("nome")));
                const todosFuncionarios = snapshotFuncionarios.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const rgfsComPedido = new Set(pedidos.map(pedido => pedido.employeeRGF)); 
                const jaPediram = todosFuncionarios.filter(func => rgfsComPedido.has(func.id));
                const aindaNaoPediram = todosFuncionarios.filter(func => !rgfsComPedido.has(func.id));
                
                container.innerHTML = ''; 

                const divJaPediram = document.createElement('div');
                const h3JaPediram = document.createElement('h3');
                h3JaPediram.className = 'font-semibold text-lg text-green-600 mb-2';
                h3JaPediram.textContent = `‚úÖ J√° Pediram (${jaPediram.length}) (Semana Atual)`;
                const ulJaPediram = document.createElement('ul');
                ulJaPediram.className = 'space-y-1 text-sm';
                if (jaPediram.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'text-gray-500';
                    li.textContent = 'Ningu√©m fez pedido ainda.';
                    ulJaPediram.appendChild(li);
                } else {
                    jaPediram.forEach(e => {
                        const li = document.createElement('li');
                        li.className = 'p-2 bg-green-50 rounded-md';
                        li.textContent = e.nome;
                        ulJaPediram.appendChild(li);
                    });
                }
                divJaPediram.appendChild(h3JaPediram);
                divJaPediram.appendChild(ulJaPediram);
                container.appendChild(divJaPediram);

                const divNaoPediram = document.createElement('div');
                const h3NaoPediram = document.createElement('h3');
                h3NaoPediram.className = 'font-semibold text-lg text-red-600 mb-2';
                h3NaoPediram.textContent = `‚ùå Ainda N√£o Pediram (${aindaNaoPediram.length}) (Semana Atual)`;
                const ulNaoPediram = document.createElement('ul');
                ulNaoPediram.className = 'space-y-1 text-sm';
                if (aindaNaoPediram.length === 0 && todosFuncionarios.length > 0) {
                     const li = document.createElement('li');
                    li.className = 'text-gray-500';
                    li.textContent = 'Todos os funcion√°rios fizeram pedido!';
                    ulNaoPediram.appendChild(li);
                } else if (aindaNaoPediram.length === 0 && todosFuncionarios.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'text-gray-500';
                    li.textContent = 'Nenhum funcion√°rio cadastrado.';
                    ulNaoPediram.appendChild(li);
                }else {
                    aindaNaoPediram.forEach(e => {
                        const li = document.createElement('li');
                        li.className = 'p-2 bg-red-50 rounded-md';
                        li.textContent = e.nome;
                        ulNaoPediram.appendChild(li);
                    });
                }
                divNaoPediram.appendChild(h3NaoPediram);
                divNaoPediram.appendChild(ulNaoPediram);
                container.appendChild(divNaoPediram);

            } catch (erro) {
                console.error("Erro ao renderizar status de pedidos:", erro);
                container.innerHTML = '';
                const pErro = document.createElement('p');
                pErro.className = 'text-red-500';
                pErro.textContent = 'Falha ao carregar status dos funcion√°rios.';
                container.appendChild(pErro);
            }
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function renderizarTabelaPedidosSemanaAtual() {
            renderizarTabelaPedidos(todosPedidosSemanaAtual, cardapioSemanaAtual, 'ordersTableContainer', 'current');
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function renderizarTabelaPedidosProximaSemana() {
            renderizarTabelaPedidos(todosPedidosProximaSemana, cardapioProximaSemana, 'nextWeekOrdersTableContainer', 'next');
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metros
        function renderizarTabelaPedidos(pedidos, menuParaExibirContra, idContainerTabela, tipoPedido) {
            const container = document.getElementById(idContainerTabela);
            if (!container) return;
            container.innerHTML = ''; 

            const termoBusca = document.getElementById('searchInput').value.toLowerCase();
            const pedidosFiltrados = (tipoPedido === 'current') 
                ? pedidos.filter(pedido => pedido.employeeName.toLowerCase().includes(termoBusca))
                : pedidos; 

            const msgTipoMenu = menuParaExibirContra === cardapioSemanaAtual ? 'semana atual' : 'pr√≥xima semana';
            if (!menuParaExibirContra || menuParaExibirContra.length === 0) { 
                const p = document.createElement('p');
                p.className = 'text-gray-500 text-center py-4';
                p.textContent = `Aguardando card√°pio (${msgTipoMenu}) para exibi√ß√£o dos pedidos...`;
                container.appendChild(p);
                return; 
            }
            if (pedidosFiltrados.length === 0) { 
                const p = document.createElement('p');
                p.className = 'text-gray-500 text-center py-4';
                p.textContent = `Nenhum pedido encontrado para ${msgTipoMenu}.`;
                container.appendChild(p);
                return; 
            }
            
            const tabela = document.createElement('table');
            tabela.className = 'min-w-full bg-white border';
            const cabecalhoTabela = tabela.createTHead();
            const linhaCabecalho = cabecalhoTabela.insertRow();
            const titulos = ['Funcion√°rio', 'RGF'];
            menuParaExibirContra.forEach(item => titulos.push(item.day.substring(0,3)));
            titulos.push('A√ß√µes');

            titulos.forEach(textoTitulo => {
                const th = document.createElement('th');
                th.className = 'py-2 px-3 border-b text-left';
                th.textContent = textoTitulo;
                linhaCabecalho.appendChild(th);
            });
            
            const corpoTabela = tabela.createTBody();
            pedidosFiltrados.forEach(pedido => { 
                const linha = corpoTabela.insertRow();
                
                let tdNome = linha.insertCell();
                tdNome.className = 'py-2 px-3 border-b font-bold';
                tdNome.textContent = pedido.employeeName;

                let tdRGF = linha.insertCell();
                tdRGF.className = 'py-2 px-3 border-b';
                tdRGF.textContent = pedido.employeeRGF || 'N/A';

                menuParaExibirContra.forEach(itemMenuDia => {
                    const tdDia = linha.insertCell();
                    tdDia.className = 'py-2 px-3 border-b';
                    const idDia = obterIdDia(itemMenuDia.day);
                    if (itemMenuDia.isHoliday) {
                        const spanFeriado = document.createElement('span');
                        spanFeriado.className = 'text-xs text-indigo-600';
                        spanFeriado.textContent = 'Feriado';
                        tdDia.appendChild(spanFeriado);
                    } else {
                        let escolha = pedido[idDia] || 'N/A';
                        const anotacoes = pedido[`${idDia}_notes`];
                        const nomePratoPrincipal = itemMenuDia.pratoPrincipal.name;
                        const nomeOpcao = itemMenuDia.opcao?.name;
                        let escolhaRelatorio = escolha;
                        if (escolha === nomePratoPrincipal) escolhaRelatorio = 'Prato';
                        else if (nomeOpcao && escolha === nomeOpcao) escolhaRelatorio = 'Op√ß√£o';
                        
                        tdDia.textContent = escolhaRelatorio; 

                        if (anotacoes) {
                            tdDia.appendChild(document.createTextNode(' ')); 
                            const spanAnotacoes = document.createElement('span');
                            spanAnotacoes.title = anotacoes;
                            spanAnotacoes.className = 'cursor-help text-blue-500 font-bold';
                            spanAnotacoes.textContent = '*';
                            tdDia.appendChild(spanAnotacoes);
                        }
                    }
                });

                const tdAcoes = linha.insertCell();
                tdAcoes.className = 'py-2 px-3 border-b space-x-2';
                const botaoEditar = document.createElement('button');
                botaoEditar.dataset.id = pedido.id;
                botaoEditar.dataset.orderType = tipoPedido; // Correto: tipoPedido
                botaoEditar.className = 'edit-order-btn text-blue-600 hover:text-blue-800 text-sm font-semibold';
                botaoEditar.textContent = 'Editar';
                tdAcoes.appendChild(botaoEditar);

                const botaoExcluir = document.createElement('button');
                botaoExcluir.dataset.id = pedido.id;
                botaoExcluir.dataset.name = pedido.employeeName;
                botaoExcluir.dataset.orderType = tipoPedido; // Correto: tipoPedido
                botaoExcluir.className = 'delete-order-btn text-red-600 hover:text-red-800 text-sm font-semibold';
                botaoExcluir.textContent = 'Excluir';
                tdAcoes.appendChild(botaoExcluir);
            });
            container.appendChild(tabela);
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function gerarEImprimirRelatorio() {
            const containerRelatorio = document.getElementById('print-report');
            containerRelatorio.innerHTML = ''; 

            if (todosPedidosSemanaAtual.length === 0 || !cardapioSemanaAtual || cardapioSemanaAtual.length === 0) {
                exibirToast("N√£o h√° pedidos ou card√°pio da semana atual para gerar o relat√≥rio.", "info");
                return;
            }
            
            const h1 = document.createElement('h1');
            h1.textContent = 'Regional Quatinga (Semana Atual)';
            containerRelatorio.appendChild(h1);

            cardapioSemanaAtual.forEach(itemMenuDia => {
                if (itemMenuDia.isHoliday) return; 
                const idDia = obterIdDia(itemMenuDia.day);

                const divSecaoDia = document.createElement('div');
                divSecaoDia.className = 'report-day-section';

                const tabela = document.createElement('table');
                tabela.className = 'report-table';
                const cabecalhoTabela = tabela.createTHead();
                const linhaCabecalho = cabecalhoTabela.insertRow();
                
                const thRGF = document.createElement('th');
                thRGF.className = 'rgf-col';
                thRGF.textContent = 'RGF';
                linhaCabecalho.appendChild(thRGF);

                const thNome = document.createElement('th');
                thNome.className = 'nome-col';
                thNome.textContent = 'NOME';
                linhaCabecalho.appendChild(thNome);
                
                const thPedido = document.createElement('th');
                thPedido.className = 'pedido-col';
                thPedido.textContent = itemMenuDia.day;
                linhaCabecalho.appendChild(thPedido);
                
                const corpoTabela = tabela.createTBody();
                const pedidosDiarios = todosPedidosSemanaAtual.filter(pedido => pedido[idDia]).sort((a,b) => a.employeeName.localeCompare(b.employeeName)); 
                
                pedidosDiarios.forEach(pedido => { 
                    const linha = corpoTabela.insertRow();
                    const tdRGFConteudo = linha.insertCell();
                    tdRGFConteudo.textContent = pedido.employeeRGF || 'N/A';
                    const tdNomeConteudo = linha.insertCell();
                    tdNomeConteudo.textContent = pedido.employeeName;
                    const tdPedidoConteudo = linha.insertCell();

                    const escolha = pedido[idDia];
                    const anotacoes = pedido[`${idDia}_notes`];
                    const nomePratoPrincipal = itemMenuDia.pratoPrincipal.name;
                    const nomeOpcao = itemMenuDia.opcao?.name;
                    let escolhaRelatorio = '';
                    if (escolha === nomePratoPrincipal) escolhaRelatorio = 'PRATO'; 
                    else if (nomeOpcao && escolha === nomeOpcao) escolhaRelatorio = 'OP√á√ÉO'; 
                    else escolhaRelatorio = escolha.toUpperCase();
                    
                    tdPedidoConteudo.textContent = escolhaRelatorio;
                    if (anotacoes) {
                        const spanAnotacoes = document.createElement('span');
                        spanAnotacoes.style.fontStyle = 'italic';
                        spanAnotacoes.style.fontWeight = 'normal';
                        spanAnotacoes.textContent = ` (${anotacoes})`;
                        tdPedidoConteudo.appendChild(spanAnotacoes);
                    }
                });
                divSecaoDia.appendChild(tabela);
                containerRelatorio.appendChild(divSecaoDia);
            });
            window.print();
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metros
        async function abrirModalEdicaoPedido(idDocumento, tipoPedido = 'current') {
            const modal = document.getElementById('edit-order-modal');
            const conteudoFormulario = document.getElementById('edit-menu-options');
            const campoNomeFuncionario = document.getElementById('edit-order-employeeName');
            const campoIdPedido = document.getElementById('edit-order-id');
            const campoTipoPedido = document.getElementById('edit-order-type'); 

            conteudoFormulario.innerHTML = '<p class="text-center text-gray-500">A carregar...</p>';
            modal.classList.remove('hidden');
            
            const menuRelevante = tipoPedido === 'current' ? cardapioSemanaAtual : cardapioProximaSemana;
            const nomeColecao = tipoPedido === 'current' ? "pedidosDaSemana" : "pedidosProximaSemana";

            if (!menuRelevante || menuRelevante.length === 0) {
                exibirToast(`Card√°pio para ${tipoPedido === 'current' ? 'semana atual' : 'pr√≥xima semana'} n√£o carregado. N√£o √© poss√≠vel editar o pedido.`, "error");
                modal.classList.add('hidden'); return;
            }

            try {
                const snapshotDocumento = await getDoc(doc(db, nomeColecao, idDocumento));
                if (!snapshotDocumento.exists()) { exibirToast("Erro: Pedido n√£o encontrado.", 'error'); modal.classList.add('hidden'); return; }
                const dadosPedido = snapshotDocumento.data();
                campoNomeFuncionario.value = dadosPedido.employeeName; 
                campoIdPedido.value = idDocumento; 
                campoTipoPedido.value = tipoPedido;  
                
                conteudoFormulario.innerHTML = ''; 
                
                menuRelevante.forEach(item => { 
                    const idDia = obterIdDia(item.day);
                    const fieldset = document.createElement('fieldset');
                    fieldset.className = 'day-section border p-4 rounded-lg';
                    
                    const legend = document.createElement('legend');
                    legend.className = 'font-bold text-lg text-gray-800 px-2';
                    legend.textContent = item.day;
                    fieldset.appendChild(legend);

                    if(item.isHoliday) {
                        const divFeriado = document.createElement('div');
                        divFeriado.className = 'bg-indigo-100 text-indigo-700 p-3 rounded-md text-center';
                        divFeriado.textContent = 'Feriado';
                        fieldset.appendChild(divFeriado);
                    } else {
                        const escolhaAtual = dadosPedido[idDia];
                        const anotacoesAtuais = dadosPedido[`${idDia}_notes`] || '';
                        const todasOpcoes = [ { ...item.pratoPrincipal }, ...(item.opcao?.name ? [{ ...item.opcao }] : []), ...opcoesFixas ];
                        
                        const divOpcoes = document.createElement('div');
                        divOpcoes.className = 'space-y-2 mt-2';
                        todasOpcoes.forEach((opcao, index) => {
                            if (opcao.name) {
                                const divOpcao = document.createElement('div');
                                divOpcao.className = 'flex items-center';
                                const inputRadio = document.createElement('input');
                                inputRadio.type = 'radio';
                                inputRadio.id = `edit-${idDia}-${index}`;
                                inputRadio.name = idDia;
                                inputRadio.value = opcao.name;
                                inputRadio.className = 'h-4 w-4 text-blue-600 border-gray-300';
                                inputRadio.required = true;
                                if (opcao.name === escolhaAtual) inputRadio.checked = true;
                                
                                const label = document.createElement('label');
                                label.htmlFor = inputRadio.id;
                                label.className = 'ml-3 block text-sm font-medium text-gray-700';
                                label.textContent = `${opcao.emoji || ''} ${opcao.name}`;
                                
                                divOpcao.appendChild(inputRadio);
                                divOpcao.appendChild(label);
                                divOpcoes.appendChild(divOpcao);
                            }
                        });
                        fieldset.appendChild(divOpcoes);
                        
                        const divAnotacoesExterno = document.createElement('div');
                        divAnotacoesExterno.className = 'mt-4';
                        const labelAnotacoes = document.createElement('label');
                        labelAnotacoes.htmlFor = `edit-notes-${idDia}`;
                        labelAnotacoes.className = 'block text-sm font-medium text-gray-700';
                        labelAnotacoes.textContent = 'Anota√ß√µes';
                        const textareaAnotacoes = document.createElement('textarea');
                        textareaAnotacoes.id = `edit-notes-${idDia}`;
                        textareaAnotacoes.name = `edit-notes-${idDia}`;
                        textareaAnotacoes.rows = 2;
                        textareaAnotacoes.className = 'mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm';
                        textareaAnotacoes.value = anotacoesAtuais; 

                        divAnotacoesExterno.appendChild(labelAnotacoes);
                        divAnotacoesExterno.appendChild(textareaAnotacoes);
                        fieldset.appendChild(divAnotacoesExterno);
                    }
                    conteudoFormulario.appendChild(fieldset);
                });
            } catch (erro) {
                console.error("Erro ao abrir modal de edi√ß√£o:", erro);
                exibirToast("N√£o foi poss√≠vel carregar os dados do pedido.", 'error');
                modal.classList.add('hidden');
            }
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro (evento)
        async function salvarAlteracoesPedido(evento) {
            evento.preventDefault();
            const botao = evento.target.querySelector('button[type="submit"]');
            botao.disabled = true; botao.textContent = 'A salvar...';
            const idDocumento = document.getElementById('edit-order-id').value;
            const tipoPedido = document.getElementById('edit-order-type').value;
            const dadosAtualizacao = {};

            const menuRelevante = tipoPedido === 'current' ? cardapioSemanaAtual : cardapioProximaSemana;
            const nomeColecao = tipoPedido === 'current' ? "pedidosDaSemana" : "pedidosProximaSemana";

            if (!menuRelevante || menuRelevante.length === 0) {
                 exibirToast(`Card√°pio (${tipoPedido}) n√£o carregado. N√£o √© poss√≠vel salvar altera√ß√µes.`, "error");
                 botao.disabled = false; botao.textContent = 'Salvar Altera√ß√µes'; return;
            }

            menuRelevante.forEach(item => { 
                if (!item.isHoliday) {
                    const idDia = obterIdDia(item.day);
                    const opcaoSelecionada = document.querySelector(`#edit-order-form input[name="${idDia}"]:checked`);
                    if (opcaoSelecionada) dadosAtualizacao[idDia] = opcaoSelecionada.value; 
                    const anotacoes = document.getElementById(`edit-notes-${idDia}`).value.trim();
                    dadosAtualizacao[`${idDia}_notes`] = anotacoes;
                }
            });
            try {
                await updateDoc(doc(db, nomeColecao, idDocumento), dadosAtualizacao);
                exibirToast("Pedido atualizado com sucesso!", 'success');
                document.getElementById('edit-order-modal').classList.add('hidden');
            } catch (erro) {
                console.error("Erro ao salvar altera√ß√µes do pedido:", erro);
                exibirToast("Falha ao salvar as altera√ß√µes do pedido.", 'error');
            } finally {
                botao.disabled = false; botao.textContent = 'Salvar Altera√ß√µes';
            }
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metros
        function excluirPedido(idDocumento, nome, tipoPedido = 'current') {
            const nomeColecao = tipoPedido === 'current' ? "pedidosDaSemana" : "pedidosProximaSemana";
            const mensagem = `Tem a certeza que deseja excluir o pedido de ${nome} (${tipoPedido === 'current' ? 'semana atual' : 'pr√≥xima semana'})? Esta a√ß√£o n√£o pode ser desfeita.`;
            
            exibirConfirmacaoPersonalizada(mensagem, async () => {
                try {
                    await deleteDoc(doc(db, nomeColecao, idDocumento));
                    exibirToast("Pedido exclu√≠do com sucesso.", 'success');
                } catch (erro) {
                    console.error("Erro ao excluir pedido: ", erro);
                    exibirToast("Falha ao excluir o pedido.", 'error');
                }
            });
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro
        const paraBase64 = arquivo => new Promise((resolve, reject) => { const leitor = new FileReader(); leitor.readAsDataURL(arquivo); leitor.onload = () => resolve(leitor.result.split(',')[1]); leitor.onerror = erro => reject(erro); });
        
        document.getElementById('imageUpload').addEventListener('change', function(evento) {
            const arquivo = evento.target.files[0]; if (!arquivo) return;
            const leitor = new FileReader();
            leitor.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('image-processor-container').classList.remove('hidden');
                document.getElementById('whatsapp-notification-container').classList.add('hidden');
            }
            leitor.readAsDataURL(arquivo);
        });

        document.getElementById('processImageBtn').addEventListener('click', async () => {
            if (typeof imageCompression === 'undefined') {
                exibirToast('Erro: Biblioteca de compress√£o n√£o carregou.', 'error'); return;
            }
            const elementoCarregador = document.getElementById('loader'); const botao = document.getElementById('processImageBtn'); const formularioConfirmacao = document.getElementById('confirmation-form');
            botao.disabled = true; botao.textContent = 'A analisar...'; elementoCarregador.classList.remove('hidden'); formularioConfirmacao.classList.add('hidden');
            const arquivo = document.getElementById('imageUpload').files[0]; 
            const opcoesCompressao = { maxSizeMB: 1.5, maxWidthOrHeight: 1500, useWebWorker: true };
            try {
                const arquivoComprimido = await imageCompression(arquivo, opcoesCompressao);
                const dadosImagemBase64 = await paraBase64(arquivoComprimido);
                const prompt = `Analise a imagem deste card√°pio semanal. Extraia as informa√ß√µes para cada dia (Segunda a Sexta). Para cada dia, identifique o 'Prato Principal', a 'Op√ß√£o' e a 'Guarni√ß√£o'. Se o dia for um feriado, marque-o. Al√©m disso, determine se o almo√ßo √© 'especial' (ex: uma refei√ß√£o comemorativa, tem√°tica ou de maior qualidade) e defina o campo booleano 'isSpecial'. Retorne um objeto JSON seguindo esta estrutura: {"menu": [{"day": "Segunda-feira", "isHoliday": false, "isSpecial": false, "pratoPrincipal": {"name": "Nome", "emoji": "üçõ"}, "opcao": {"name": "Nome", "emoji": "üç≤"}, "guarnicao": {"name": "Nome", "emoji": "ü•ó"}}, ...]}. Se um campo n√£o existir, retorne o nome como string vazia. Atribua emojis apropriados. O JSON deve ser a √∫nica coisa na resposta.`;
                const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: arquivoComprimido.type, data: dadosImagemBase64 } }] }] };
                const apiKey = firebaseConfig.apiKey; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`; 
                const resposta = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!resposta.ok) { const err = await resposta.json(); throw new Error(`API Error: ${err.error.message}`); }
                const resultado = await resposta.json();
                let textoResposta = resultado.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textoResposta) { throw new Error("Resposta da IA vazia ou mal formatada."); }
                textoResposta = textoResposta.replace(/```json/g, '').replace(/```/g, '').trim();
                const dadosCardapioIA = JSON.parse(textoResposta); 
                if (!dadosCardapioIA || !Array.isArray(dadosCardapioIA.menu)) { throw new Error("Estrutura do JSON da IA inv√°ƒ∫ida."); }
                exibirFormularioConfirmacaoCardapioIA(dadosCardapioIA.menu); 
            } catch (erro) { 
                console.error("Erro ao processar IA:", erro); exibirToast("Erro ao ler imagem com IA: " + erro.message, 'error', 8000); 
            } finally { 
                botao.disabled = false; botao.textContent = 'Analisar Card√°pio da Pr√≥xima Semana'; elementoCarregador.classList.add('hidden'); 
            }
        });

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro
        function exibirFormularioConfirmacaoCardapioIA(arrayItensCardapioIA) {
            const container = document.getElementById('confirmation-form'); 
            container.innerHTML = ''; 
            const titleH3 = document.createElement('h3');
            titleH3.className = 'text-xl font-semibold mb-4';
            titleH3.textContent = 'Confirme os Dados Extra√≠dos (Pr√≥xima Semana)';
            container.appendChild(titleH3);

            arrayItensCardapioIA.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-4 bg-gray-50 rounded-lg mb-4';
                
                const dayH4 = document.createElement('h4');
                dayH4.className = 'font-bold';
                dayH4.textContent = item.day;
                itemDiv.appendChild(dayH4);

                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 mt-2';
                
                const fields = [
                    { idBase: 'prato', label: 'Prato Principal', value: item.pratoPrincipal.name },
                    { idBase: 'opcao', label: 'Op√ß√£o', value: item.opcao.name },
                    { idBase: 'guarnicao', label: 'Guarni√ß√£o', value: item.guarnicao.name }
                ];
                fields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    const fieldLabel = document.createElement('label');
                    fieldLabel.className = 'block text-sm font-medium';
                    fieldLabel.textContent = field.label;
                    const fieldInput = document.createElement('input');
                    fieldInput.type = 'text';
                    fieldInput.id = `${field.idBase}-${index}`;
                    fieldInput.value = field.value || ''; 
                    fieldInput.className = 'w-full border rounded p-1';
                    fieldDiv.appendChild(fieldLabel);
                    fieldDiv.appendChild(fieldInput);
                    gridDiv.appendChild(fieldDiv);
                });
                itemDiv.appendChild(gridDiv);

                const checksDiv = document.createElement('div');
                checksDiv.className = 'mt-3 flex items-center space-x-6';
                const holidayLabel = document.createElement('label');
                holidayLabel.className = 'flex items-center';
                const holidayInput = document.createElement('input');
                holidayInput.type = 'checkbox';
                holidayInput.id = `holiday-${index}`;
                if(item.isHoliday) holidayInput.checked = true;
                holidayInput.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600';
                const holidaySpan = document.createElement('span');
                holidaySpan.className = 'ml-2 text-sm text-gray-900';
                holidaySpan.textContent = 'Marcar como Feriado';
                holidayLabel.appendChild(holidayInput);
                holidayLabel.appendChild(holidaySpan);
                checksDiv.appendChild(holidayLabel);

                const specialLabel = document.createElement('label');
                specialLabel.className = 'flex items-center';
                const specialInput = document.createElement('input');
                specialInput.type = 'checkbox';
                specialInput.id = `special-${index}`;
                if(item.isSpecial) specialInput.checked = true;
                specialInput.className = 'h-4 w-4 rounded border-gray-300 text-purple-600';
                const specialSpan = document.createElement('span');
                specialSpan.className = 'ml-2 text-sm text-gray-900';
                specialSpan.textContent = '‚ú® Almo√ßo Especial';
                specialLabel.appendChild(specialInput);
                specialLabel.appendChild(specialSpan);
                checksDiv.appendChild(specialLabel);
                itemDiv.appendChild(checksDiv);
                container.appendChild(itemDiv);
            });

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'text-center mt-4';
            const saveBtn = document.createElement('button');
            saveBtn.id = 'saveNewMenuBtn';
            saveBtn.className = 'w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600';
            saveBtn.textContent = 'Salvar Card√°pio da Pr√≥xima Semana';
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.id = 'cancelNewMenuBtn';
            cancelBtn.className = 'w-full mt-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400';
            cancelBtn.textContent = 'Cancelar';
            buttonsDiv.appendChild(saveBtn);
            buttonsDiv.appendChild(cancelBtn);
            container.appendChild(buttonsDiv);
            
            container.classList.remove('hidden'); 
            
            saveBtn.addEventListener('click', () => {
                const message = "Tem certeza que deseja salvar este card√°pio para a PR√ìXIMA semana? Os pedidos da semana ATUAL N√ÉO ser√£o afetados por esta a√ß√£o.";
                exibirConfirmacaoPersonalizada(message, () => { salvarNovoCardapioParaProximaSemana(arrayItensCardapioIA); });
            });
            cancelBtn.addEventListener('click', () => {
                container.classList.add('hidden'); document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('image-processor-container').classList.add('hidden'); document.getElementById('imageUpload').value = ''; 
                exibirToast("Atualiza√ß√£o do card√°pio da pr√≥xima semana cancelada.", 'info');
            });
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro
        async function salvarNovoCardapioParaProximaSemana(arrayItensCardapioConfirmados) {
            const botaoSalvar = document.getElementById('saveNewMenuBtn'); 
            const botaoCancelar = document.getElementById('cancelNewMenuBtn');
            botaoSalvar.disabled = true; botaoCancelar.disabled = true;
            botaoSalvar.textContent = 'A salvar para Pr√≥xima Semana...'; 
            const payloadNovoCardapioProximaSemana = arrayItensCardapioConfirmados.map((item, i) => ({ 
                day: item.day, 
                pratoPrincipal: { name: document.getElementById(`prato-${i}`).value.trim(), emoji: item.pratoPrincipal.emoji || 'üçõ' }, 
                opcao: { name: document.getElementById(`opcao-${i}`).value.trim(), emoji: item.opcao.emoji || 'üç≤' }, 
                guarnicao: { name: document.getElementById(`guarnicao-${i}`).value.trim(), emoji: item.guarnicao.emoji || 'ü•ó' },
                isHoliday: document.getElementById(`holiday-${i}`).checked,
                isSpecial: document.getElementById(`special-${i}`).checked,
            })); 
            try { 
                await setDoc(refCardapioProximaSemana, { menu: payloadNovoCardapioProximaSemana });
                exibirToast('Card√°pio da pr√≥xima semana atualizado com sucesso!', 'success'); 
                document.getElementById('confirmation-form').classList.add('hidden'); 
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('image-processor-container').classList.add('hidden'); 
                document.getElementById('imageUpload').value = ''; 
                document.getElementById('whatsapp-notification-container').classList.remove('hidden');
            } catch (erro) { 
                console.error("Erro ao salvar o card√°pio da pr√≥xima semana:", erro); 
                exibirToast("Erro ao salvar o novo card√°pio da pr√≥xima semana.", 'error'); 
            } finally { 
                botaoSalvar.disabled = false; botaoCancelar.disabled = false;
                botaoSalvar.textContent = 'Salvar Card√°pio da Pr√≥xima Semana'; 
            }
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        async function promoverCardapioProximaSemanaParaAtual() {
            const mensagemConfirmacao = "Tem certeza que deseja promover o card√°pio da PR√ìXIMA semana para ATUAL? O card√°pio da pr√≥xima semana ser√° reiniciado e os pedidos da pr√≥xima semana ser√£o movidos para a semana atual.";
            exibirConfirmacaoPersonalizada(mensagemConfirmacao, async () => {
                const botaoPromover = document.getElementById('promoteMenuBtn');
                botaoPromover.disabled = true; botaoPromover.textContent = "A promover...";
                try {
                    const snapshotDocProximaSemana = await getDoc(refCardapioProximaSemana);
                    if (!snapshotDocProximaSemana.exists() || !snapshotDocProximaSemana.data().menu || snapshotDocProximaSemana.data().menu.length === 0) {
                        exibirToast("Card√°pio da pr√≥xima semana est√° vazio ou n√£o existe. N√£o √© poss√≠vel promover.", "error");
                        botaoPromover.disabled = false; botaoPromover.textContent = "Promover Card√°pio da Pr√≥xima Semana para Atual";
                        return;
                    }
                    const cardapioParaPromover = snapshotDocProximaSemana.data(); 
                    
                    await setDoc(refCardapioSemanaAtual, cardapioParaPromover);
                    exibirToast("Card√°pio da pr√≥xima semana promovido para atual com sucesso!", "success");

                    exibirToast("A iniciar a transi√ß√£o dos pedidos...", "info");
                    console.log("Iniciando transi√ß√£o de pedidos..."); // Traduzido
                    try {
                        const snapshotPedidosProximaSemana = await getDocs(refPedidosProximaSemana);
                        if (!snapshotPedidosProximaSemana.empty) {
                            const promessasAdicionar = [];
                            snapshotPedidosProximaSemana.docs.forEach(docPedido => {
                                promessasAdicionar.push(addDoc(refPedidosDaSemana, docPedido.data()));
                            });
                            await Promise.all(promessasAdicionar);
                            console.log(`${promessasAdicionar.length} pedidos copiados com sucesso para refPedidosDaSemana.`); // Traduzido

                            const promessasExcluir = [];
                            snapshotPedidosProximaSemana.docs.forEach(docPedido => {
                                promessasExcluir.push(deleteDoc(docPedido.ref));
                            });
                            await Promise.all(promessasExcluir);
                            console.log(`${promessasExcluir.length} pedidos originais exclu√≠dos com sucesso de refPedidosProximaSemana.`); // Traduzido
                            exibirToast("Pedidos da pr√≥xima semana transitaram para a semana atual com sucesso!", "success");
                        } else {
                            exibirToast("Nenhum pedido encontrado na pr√≥xima semana para transitar.", "info");
                            console.log("Nenhum pedido em refPedidosProximaSemana para transitar."); // Traduzido
                        }
                        await setDoc(refCardapioProximaSemana, { menu: [] }); 
                        exibirToast("Card√°pio da pr√≥xima semana foi reiniciado.", "info");
                    } catch (erroPedidos) {
                        console.error("Erro cr√≠tico ao transitar os pedidos:", erroPedidos);
                        exibirToast("Erro cr√≠tico ao transitar os pedidos! Verifique o console. O card√°pio pode ter sido promovido, mas os pedidos n√£o.", "error", 8000);
                        return; 
                    }
                } catch (erroMenu) {
                    console.error("Erro ao promover card√°pio (etapa de menu):", erroMenu);
                    exibirToast("Falha ao promover o card√°pio. Verifique o console.", "error");
                } finally {
                    botaoPromover.disabled = false; botaoPromover.textContent = "Promover Card√°pio da Pr√≥xima Semana para Atual";
                }
            });
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o
        async function limparTodosPedidos() { 
            console.log("Iniciando a limpeza de todos os pedidos da semana (cole√ß√£o refPedidosDaSemana)...");
            const snapshotPedidos = await getDocs(refPedidosDaSemana);
            const promessasExcluir = [];
            snapshotPedidos.forEach((doc) => { promessasExcluir.push(deleteDoc(doc.ref)); });
            await Promise.all(promessasExcluir);
            console.log(`${promessasExcluir.length} pedidos foram exclu√≠dos com sucesso.`);
        }
        
        // Tradu√ß√£o de nome de fun√ß√£o
        function manipularNotificacaoWhatsApp() {
            const mensagem = `O card√°pio da pr√≥xima semana foi atualizado! ‚ú® Confira as del√≠cias e fa√ßa seu pedido: ${window.location.href}`;
            const mensagemCodificada = encodeURIComponent(mensagem);
            const urlWhatsApp = `https://api.whatsapp.com/send?text=${mensagemCodificada}`;
            window.open(urlWhatsApp, '_blank');
            exibirToast('Abra o WhatsApp para enviar a notifica√ß√£o.', 'info');
        }

        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === APP_CONFIG.ADMIN_UID) {
                exibirVisaoAdmin();
            } else {
                if (!auth.currentUser) {
                    signInAnonymously(auth).catch((erro) => {
                        console.error("Erro no login an√≥nimo:", erro);
                        exibirToast("N√£o foi poss√≠vel conectar-se. Verifique a sua liga√ß√£o.", "error");
                    });
                }
                exibirVisaoUsuario(); 
            }
        });

        // Tradu√ß√£o de nome de fun√ß√£o
        function exibirVisaoUsuario() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            carregarCardapios(); 
            const rgf = localStorage.getItem('employeeRGF'); 
            if (rgf) {
                document.getElementById('employeeRGF').value = rgf;
                buscarFuncionarioPorRGF(rgf);
            }
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function exibirVisaoAdmin() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            carregarCardapios(); 
            loadAdminData(); // Mantido, pois lida com dados e n√£o diretamente com a vis√£o.
            carregarErenderizarFuncionarios();
        }

        // Tradu√ß√£o de nome de fun√ß√£o e par√¢metro (evento)
        async function manipularLoginAdmin(evento) {
            evento.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const botao = evento.target.querySelector('button[type="submit"]');
            botao.disabled = true; botao.textContent = 'Entrando...';
            try {
                const credencialUsuario = await signInWithEmailAndPassword(auth, email, password);
                if (credencialUsuario.user.uid !== APP_CONFIG.ADMIN_UID) {
                    await signOut(auth);
                    exibirToast("Credenciais v√°lidas, mas este usu√°rio n√£o √© um administrador.", 'error');
                }
                // onAuthStateChanged cuidar√° de exibir a vis√£o de admin
            } catch (erro) {
                console.error("Erro no login de administrador:", erro);
                const msg = (erro.code === 'auth/invalid-credential' || erro.code === 'auth/wrong-password' || erro.code === 'auth/user-not-found') ? "Email ou senha incorretos." : "Ocorreu um erro no login.";
                exibirToast(msg, 'error', 5000);
            } finally {
                botao.disabled = false; botao.textContent = 'Entrar';
            }
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        async function manipularLogoutAdmin() {
            try { await signOut(auth); exibirToast("Logout de administrador bem-sucedido!", 'info'); } 
            catch (erro) { console.error("Erro no logout:", erro); exibirToast("Erro ao fazer logout.", 'error'); }
             // onAuthStateChanged cuidar√° de exibir a vis√£o de usu√°rio
        }

        // Tradu√ß√£o de nome de fun√ß√£o
        function principal() {
            const campoRGF = document.getElementById('employeeRGF');
            campoRGF.value = localStorage.getItem('employeeRGF') || '';
            campoRGF.addEventListener('blur', (evento) => { localStorage.setItem('employeeRGF', evento.target.value); buscarFuncionarioPorRGF(evento.target.value); });
            campoRGF.addEventListener('input', validarFormulario); 
            
            document.getElementById('menu').addEventListener('change', validarFormulario);
            document.getElementById('openConfirmationModal').addEventListener('click', abrirModalConfirmacao);
            document.getElementById('submitOrder').addEventListener('click', enviarPedido);
            
            document.querySelectorAll('.cancel-modal-btn, #custom-confirm-cancel-btn').forEach(botao => {
                botao.addEventListener('click', () => botao.closest('.modal-overlay').classList.add('hidden'));
            });

            document.getElementById('switchToAdmin').addEventListener('click', () => document.getElementById('admin-login-modal').classList.remove('hidden'));
            document.getElementById('admin-login-form').addEventListener('submit', manipularLoginAdmin);
            
            document.getElementById('adminLogoutBtn').addEventListener('click', manipularLogoutAdmin);
            document.getElementById('switchToUserFromAdmin').addEventListener('click', exibirVisaoUsuario);
            
            document.getElementById('add-employee-form').addEventListener('submit', manipularAdicionarFuncionario);
            document.getElementById('employee-list-container').addEventListener('click', (evento) => {
                if (evento.target.closest('.edit-employee-btn')) { abrirModalEdicaoFuncionario(evento.target.closest('.edit-employee-btn').dataset.id, evento.target.closest('.edit-employee-btn').dataset.name); }
                if (evento.target.closest('.delete-employee-btn')) { manipularExcluirFuncionario(evento.target.closest('.delete-employee-btn').dataset.id, evento.target.closest('.delete-employee-btn').dataset.name); }
            });
            document.getElementById('edit-employee-form').addEventListener('submit', manipularSalvarAlteracoesFuncionario);
            
            document.getElementById('searchInput').addEventListener('input', () => {
                renderizarTabelaPedidosSemanaAtual();
                // renderizarTabelaPedidosProximaSemana(); // A busca n√£o se aplica √† pr√≥xima semana por enquanto
            });
            document.getElementById('generateReportBtn').addEventListener('click', gerarEImprimirRelatorio);
            document.getElementById('promoteMenuBtn')?.addEventListener('click', promoverCardapioProximaSemanaParaAtual);
            
            document.getElementById('admin-view').addEventListener('click', function(evento) {
                const botaoEditar = evento.target.closest('.edit-order-btn');
                const botaoExcluir = evento.target.closest('.delete-order-btn');

                if (botaoEditar) {
                    const idDocumento = botaoEditar.dataset.id;
                    const tipoPedido = botaoEditar.dataset.orderType;
                    abrirModalEdicaoPedido(idDocumento, tipoPedido);
                }
                if (botaoExcluir) {
                    const idDocumento = botaoExcluir.dataset.id;
                    const nome = botaoExcluir.dataset.name;
                    const tipoPedido = botaoExcluir.dataset.orderType;
                    excluirPedido(idDocumento, nome, tipoPedido);
                }
            });
            
            document.getElementById('edit-order-form').addEventListener('submit', salvarAlteracoesPedido);
            document.getElementById('notifyWhatsAppBtn').addEventListener('click', manipularNotificacaoWhatsApp);
        }
        principal();
    </script>
</body>
</html>

[end of index.html]

[end of index.html]
