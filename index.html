<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card√°pio Regional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Lobster Two', cursive; }
        .menu-option-card:has(input:checked) { border-color: #2563eb; background-color: #eff6ff; transform: scale(1.02); }
        .menu-option-card:has(input:checked) .checkmark { opacity: 1; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-print { }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-height: 90vh; overflow-y: auto; width: 90%; max-width: 500px; }
        input:read-only, textarea:read-only { background-color: #f3f4f6; cursor: not-allowed; }
        #print-report { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            body > *:not(#print-report) { display: none !important; }
            #print-report { display: block !important; }
            #print-report .regional-title { font-size: 20pt; text-align: center; margin-bottom: 15px; font-family: 'Poppins', sans-serif; font-weight: 700; page-break-before: always; }
            #print-report .regional-title:first-of-type { page-break-before: auto; }
            .report-day-section { margin-bottom: 12px; page-break-inside: avoid; }
            .report-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
            #print-report th, #print-report td { border: 1px solid #999; padding: 5px; text-align: left; }
            #print-report th { background-color: #e2e8f0; font-weight: 600; }
            #print-report .rgf-col { width: 15%; }
            #print-report .nome-col { width: 60%; }
            #print-report .pedido-col { width: 25%; background-color: #dbeafe; font-weight: bold; }
        }
        #app-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; pointer-events: none; transform: translateX(-50%) translateY(20px); }
        #app-toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
        #app-toast.success { background-color: #22c55e; }
        #app-toast.error { background-color: #ef4444; }
        #app-toast.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-20">
        
        <div id="user-view" class="no-print">
            <div id="form-container">
                <header class="relative text-center mb-8">
                    <h1 class="font-brand text-5xl text-blue-600">Del√≠cias Urbanas</h1>
                    <p class="mt-2 text-md text-gray-500">O seu card√°pio da semana est√° servido!</p>
                    <button id="switchToAdmin" class="absolute top-0 right-0 p-2 text-gray-500 hover:text-blue-600" title="Aceder ao Painel do Administrador">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </header>
                
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h2 class="block text-lg font-semibold text-gray-800 mb-2">üë§ 1. Identifica√ß√£o</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div><label for="employeeRGF" class="block text-sm font-medium text-gray-700">Seu RGF</label><input type="text" id="employeeRGF" placeholder="Digite o seu RGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                        <div><label for="employeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="employeeName" placeholder="Preenchido automaticamente" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div>
                    </div>
                </div>

                <div id="user-view-info" class="hidden bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-6"></div>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6"><h2 id="menu-title" class="text-lg font-semibold text-gray-800 mb-4">üçΩÔ∏è 2. Escolha os seus pratos</h2><div id="menu" class="space-y-8"><div class="text-center text-gray-500">Digite o seu RGF para come√ßar.</div></div></div>
                <div id="guidanceSection" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6"><p id="guidanceText" class="font-semibold">Complete os passos acima.</p></div>
                <div id="submitButtonContainer" class="hidden text-center"><button id="openConfirmationModal" class="w-full sm:w-auto bg-green-500 text-white font-bold text-lg px-8 py-3 rounded-xl hover:bg-green-600 shadow-lg">Revisar e Finalizar Pedido</button></div>
            </div>
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Fazer Novo Pedido</button></div>
        </div>

        <div id="admin-view" class="hidden no-print">
            <header class="text-center border-b pb-6 mb-6">
                <h1 id="admin-title" class="text-4xl font-bold text-gray-800">Painel do Administrador</h1>
                <p class="text-lg text-gray-600 mt-1">Del√≠cias Urbanas</p>
                <div class="mt-4">
                    <button id="adminLogoutBtn" class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600">Sair do Painel</button>
                </div>
            </header>
            <div class="mb-8">
                <button id="switchToUserFromAdmin" class="text-sm text-gray-500 hover:text-blue-600">‚¨ÖÔ∏è Voltar para o Card√°pio (Vis√£o Usu√°rio)</button>
            </div>
            
            <section id="approval-section" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-6 rounded-xl shadow-sm mb-8">
                <h2 class="text-2xl font-semibold mb-2">‚ö†Ô∏è Aprova√ß√£o Pendente</h2>
                <div id="approval-info"></div>
                <div id="approval-buttons" class="mt-4 space-x-4"></div>
            </section>
            
            <section id="order-status-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üìä Status de Pedidos (Pr√≥xima Semana)</h2>
                <div id="order-status-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"><p class="text-gray-500">A carregar status dos pedidos...</p></div>
            </section>

            <section id="menu-updater-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üçú Enviar Novo Card√°pio para Aprova√ß√£o</h2>
                <p class="text-gray-600 mb-4">Envie uma imagem do card√°pio da pr√≥xima semana. Ele ficar√° pendente at√© um Super Administrador o aprovar.</p>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" class="mt-4 rounded-lg max-h-80 hidden" />
                <div id="image-processor-container" class="mt-4 text-center hidden"><button id="processImageBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Analisar Card√°pio</button></div>
                <div id="loader" class="hidden mx-auto my-4 loader"></div>
                <div id="confirmation-form" class="hidden mt-6"></div>
                <div id="whatsapp-notification-container" class="mt-4 text-center hidden"><button id="notifyWhatsAppBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="white"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.287.492-1.24 4.515 4.639-1.219.452.273zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>Notificar Funcion√°rios no WhatsApp</button>
                </div>
            </section>

            <section id="admin-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üëë Gerenciamento de Administradores</h2>
                <form id="add-admin-form" class="grid sm:grid-cols-4 gap-4 items-end mb-6">
                    <div class="sm:col-span-2">
                        <label for="admin-employee-select" class="block text-sm font-medium text-gray-700">Funcion√°rio</label>
                        <select id="admin-employee-select" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required></select>
                    </div>
                     <div>
                        <label for="admin-email-input" class="block text-sm font-medium text-gray-700">Email do Admin</label>
                        <input type="email" id="admin-email-input" placeholder="email.login@exemplo.com" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="admin-password-input" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="admin-password-input" placeholder="Crie uma senha" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="sm:col-span-4">
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Promover a Administrador Regional</button>
                    </div>
                </form>
                <h3 class="text-lg font-semibold text-gray-700 mt-8 mb-2">Super Administradores Atuais</h3>
                <div id="super-admin-list-container" class="overflow-x-auto"></div>
                <h3 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Administradores Regionais Atuais</h3>
                <div id="admin-list-container" class="overflow-x-auto"></div>
            </section>

            <section id="employee-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üë• Gerenciamento de Funcion√°rios</h2>
                <form id="add-employee-form" class="grid sm:grid-cols-4 gap-4 items-end mb-6">
                    <div>
                        <label for="newEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label>
                        <input type="text" id="newEmployeeRGF" placeholder="RGF do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="newEmployeeName" placeholder="Nome do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="newEmployeeRegional" class="block text-sm font-medium text-gray-700">Regional</label>
                        <input type="text" id="newEmployeeRegional" placeholder="Ex: Quatinga" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full sm:col-span-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Funcion√°rio</button>
                </form>
                <div id="employee-list-container" class="overflow-x-auto"><p class="text-gray-500">A carregar lista de funcion√°rios...</p></div>
            </section>

            <section id="orders-section">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Pedidos Recebidos (Pr√≥xima Semana)</h2>
                    <div class="w-full sm:w-auto"><input type="text" id="searchInput" placeholder="üîé Buscar por nome..." class="w-full sm:w-64 px-4 py-2 border rounded-lg"></div>
                    <button id="generateReportBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">üñ®Ô∏è Salvar Relat√≥rio como PDF</button>
                </div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>
        </div>
    </div>

    <div id="edit-order-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Pedido</h2><form id="edit-order-form"><input type="hidden" id="edit-order-id"><div class="mb-4"><label class="block text-lg font-semibold text-gray-800 mb-2">Nome do Funcion√°rio</label><input type="text" id="edit-order-employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly></div><div id="edit-menu-options" class="space-y-6"></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button></div></form></div></div>
    <div id="edit-employee-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Funcion√°rio</h2><form id="edit-employee-form"><div class="mb-4"><label for="editEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label><input type="text" id="editEmployeeRGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div><div class="mb-4"><label for="editEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="editEmployeeName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="editEmployeeRegional" class="block text-sm font-medium text-gray-700">Regional</label><input type="text" id="editEmployeeRegional" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button></div></form></div></div>
    <div id="confirmation-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-2xl font-bold mb-4">Confirme o seu Pedido</h2><p class="mb-6 text-gray-600">Por favor, revise as suas escolhas antes de enviar.</p><div id="confirmation-summary" class="space-y-2 mb-8"></div><div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Editar</button><button id="submitOrder" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">Confirmar e Enviar</button></div></div></div>
    <div id="admin-login-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Aceder ao Painel de Administrador</h2><form id="admin-login-form"><div class="mb-4"><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="adminEmail" placeholder="seu-email@exemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="adminPassword" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="adminPassword" placeholder="Sua senha" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button></div></form></div></div>
    <div id="custom-confirm-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-xl font-bold mb-4" id="custom-confirm-title">Confirmar A√ß√£o</h2><p class="mb-6 text-gray-600" id="custom-confirm-message">Tem a certeza que deseja prosseguir?</p><div class="flex justify-end space-x-4"><button id="custom-confirm-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button id="custom-confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirmar</button></div></div></div>

    <div id="print-report"></div>
    <div id="app-toast"></div>
    
    <script type="module">
        // =================================================================================
        // INICIALIZA√á√ÉO E CONFIGURA√á√ÉO DO FIREBASE
        // =================================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, setDoc, deleteDoc, updateDoc, getDocs, where, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI",
            authDomain: "cardapio-8ddea.firebaseapp.com",
            projectId: "cardapio-8ddea",
            storageBucket: "cardapio-8ddea.appspot.com",
            messagingSenderId: "1019677985212",
            appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // =================================================================================
        // REFER√äNCIAS E CONSTANTES GLOBAIS
        // =================================================================================
        const pendingMenuDocRef = doc(db, "cardapio", "proximo"); // Para o fluxo de aprova√ß√£o
        const menusCollectionRef = collection(db, "menus"); // Nova cole√ß√£o para card√°pios datados
        const pedidosCollectionRef = collection(db, "pedidosDaSemana");
        const funcionariosCollectionRef = collection(db, "funcionarios");
        const usuariosCollectionRef = collection(db, "usuarios");
        
        const fixedOptions = [{ name: 'Omelete', emoji: 'üç≥' }, { name: 'Fil√© de frango', emoji: 'üçó' }];
        let weeklyMenu = [];
        let allOrders = [];
        let allEmployees = [];
        let tempOrderData = {};
        
        let currentUserRole = null;
        let currentUserRegional = null;

        // =================================================================================
        // FUN√á√ïES DE DATA (O CORA√á√ÉO DO "CALEND√ÅRIO INTELIGENTE")
        // =================================================================================
        
        /**
         * Retorna o ID da semana (data da √∫ltima segunda-feira) para uma data fornecida.
         * @param {Date} d - A data de refer√™ncia.
         * @returns {string} A data no formato YYYY-MM-DD.
         */
        function getWeekId(d) {
            d = new Date(d);
            const day = d.getDay(); // 0 = Domingo, 1 = Segunda, ...
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajusta para a √∫ltima segunda-feira
            const monday = new Date(d.setDate(diff));
            return monday.toISOString().split('T')[0];
        }

        const today = new Date();
        const currentWeekId = getWeekId(today);
        const nextWeekDate = new Date(today);
        nextWeekDate.setDate(today.getDate() + 7);
        const nextWeekId = getWeekId(nextWeekDate);

        // =================================================================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // =================================================================================

        function getDayId(dayName) { return dayName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, "").toLowerCase(); }
        function showToast(message, type = 'info', duration = 3000) { /* ...c√≥digo mantido... */ }
        function showCustomConfirm(message, onConfirm) { /* ...c√≥digo mantido... */ }
        
        // =================================================================================
        // L√ìGICA DE AUTENTICA√á√ÉO E CONTROLO DE ACESSO
        // =================================================================================
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(usuariosCollectionRef, user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role;
                    currentUserRegional = userData.regional;
                    showAdminView();
                } else {
                    if (!user.isAnonymous) await signOut(auth);
                    showUserView();
                }
            } else {
                signInAnonymously(auth).catch((error) => console.error("Erro no login an√≥nimo:", error));
                showUserView();
            }
        });

        function showUserView() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
        }

        function showAdminView() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            
            if (currentUserRole === 'superadm') {
                document.getElementById('admin-title').textContent = 'Painel Central (Super Adm)';
                document.getElementById('admin-management-section').classList.remove('hidden');
                const regionalInput = document.getElementById('newEmployeeRegional');
                regionalInput.value = '';
                regionalInput.readOnly = false;
                loadAdminsList();
                loadSuperAdminsList();
                loadPendingMenu(); // Carrega o menu pendente para aprova√ß√£o
            } else if (currentUserRole === 'adm') {
                document.getElementById('admin-title').textContent = `Painel Regional (${currentUserRegional})`;
                document.getElementById('admin-management-section').classList.add('hidden');
                const regionalInput = document.getElementById('newEmployeeRegional');
                regionalInput.value = currentUserRegional;
                regionalInput.readOnly = true;
                loadPendingMenu(); // Apenas para ver o aviso
            }
            
            loadAdminData();
            loadAndRenderEmployees();
        }

        async function handleAdminLogin(e) { /* ...c√≥digo mantido... */ }
        async function handleAdminLogout() { /* ...c√≥digo mantido... */ }
        
        // =================================================================================
        // L√ìGICA DA VIS√ÉO DO FUNCION√ÅRIO (COM CALEND√ÅRIO INTELIGENTE)
        // =================================================================================

        async function findEmployeeByRGF(rgf) {
            const nameInput = document.getElementById('employeeName');
            const menuContainer = document.getElementById('menu');
            const userViewInfo = document.getElementById('user-view-info');
            const menuTitle = document.getElementById('menu-title');
            userViewInfo.classList.add('hidden');
            menuContainer.innerHTML = '<div class="text-center text-gray-500">A verificar...</div>';
            
            if (!rgf) { 
                nameInput.value = ''; 
                menuContainer.innerHTML = '<div class="text-center text-gray-500">Digite o seu RGF para come√ßar.</div>'; 
                validateForm(); return; 
            }
            try {
                const docSnap = await getDoc(doc(db, "funcionarios", rgf));
                if (docSnap.exists()) {
                    nameInput.value = docSnap.data().nome;
                    
                    // L√ìGICA INTELIGENTE: Verificar se j√° existe pedido para a semana ATUAL
                    const q = query(pedidosCollectionRef, where("employeeRGF", "==", rgf), where("semana", "==", currentWeekId));
                    const orderSnapshot = await getDocs(q);

                    if (!orderSnapshot.empty) {
                        // Se encontrou, mostra o pedido J√Å FEITO para a semana ATUAL
                        const orderData = orderSnapshot.docs[0].data();
                        const menuRef = doc(menusCollectionRef, currentWeekId);
                        const menuDoc = await getDoc(menuRef);
                        userViewInfo.innerHTML = `<p class="font-bold">Este √© o seu pedido j√° registado para a semana de ${currentWeekId}.</p>`;
                        userViewInfo.classList.remove('hidden');
                        menuTitle.textContent = `üçΩÔ∏è O seu pedido para a semana atual:`;
                        displayMenu(menuDoc, orderData, true); // true = modo de visualiza√ß√£o (bloqueado)
                    } else {
                        // Se n√£o encontrou, mostra o card√°pio para fazer pedido para a PR√ìXIMA SEMANA
                        const menuRef = doc(menusCollectionRef, nextWeekId);
                        const menuDoc = await getDoc(menuRef);
                        if (!menuDoc.exists()) {
                            throw new Error("Card√°pio da pr√≥xima semana ainda n√£o publicado.");
                        }
                        userViewInfo.innerHTML = `<p class="font-bold">Fa√ßa o seu pedido para a pr√≥xima semana (${nextWeekId}).</p>`;
                        userViewInfo.classList.remove('hidden');
                        menuTitle.textContent = `üóìÔ∏è Card√°pio para a pr√≥xima semana:`;
                        displayMenu(menuDoc, null, false); // false = modo de pedido (edit√°vel)
                    }

                } else {
                    nameInput.value = '';
                    menuContainer.innerHTML = '<div class="text-center text-red-500 font-bold">RGF n√£o encontrado. Contacte um administrador.</div>';
                }
                validateForm();
            } catch (error) {
                console.error("Erro ao buscar funcion√°rio ou card√°pio:", error);
                menuContainer.innerHTML = `<div class="text-center text-red-500 font-bold">${error.message}</div>`;
                showToast(error.message, 'error');
            }
        }

        function displayMenu(menuDoc, orderData = null, isViewOnly = false) {
            weeklyMenu = (menuDoc.exists() && menuDoc.data().menu?.length > 0) ? menuDoc.data().menu : createFallbackMenu();
            createMenuHTML(orderData, isViewOnly);
        }

        function createMenuHTML(orderData, isViewOnly) {
            const menuContainer = document.getElementById('menu');
            menuContainer.innerHTML = '';

            weeklyMenu.forEach(item => {
                const dayId = getDayId(item.day);
                let dayHTML = `<div class="day-section space-y-3 opacity-100 ${isViewOnly ? 'opacity-75' : ''}">`;
                let dayTitleHTML = `<h3 class="text-xl font-bold text-gray-800">${item.day}</h3>`;
                // ... (c√≥digo de renderiza√ß√£o do t√≠tulo igual ao anterior)
                
                if (item.isHoliday) { /* ...c√≥digo de feriado mantido... */ } 
                else {
                    const allOptions = [ { ...item.pratoPrincipal, type: 'Prato Principal' }, ...(item.opcao?.name ? [{ ...item.opcao, type: 'Op√ß√£o do Dia' }] : []), ...fixedOptions.map(fixa => ({ ...fixa, type: 'Op√ß√£o Fixa' })), ];
                    dayHTML += dayTitleHTML;
                    if (item.guarnicao?.name) { /* ...c√≥digo da guarni√ß√£o mantido... */ }
                    
                    dayHTML += `<div class="space-y-3">`;
                    allOptions.forEach((option) => {
                        if (option.name) {
                            const isChecked = orderData && orderData[dayId] === option.name ? 'checked' : '';
                            const disabled = isViewOnly ? 'disabled' : '';
                            dayHTML += `<label class="menu-option-card block p-4 border-2 border-gray-200 rounded-lg ${disabled ? 'cursor-not-allowed' : 'cursor-pointer'} transition-transform duration-200">
                                <input type="radio" name="${dayId}" value="${option.name}" class="hidden" ${isChecked} ${disabled}>
                                <div class="flex items-center">
                                    <span class="text-3xl mr-4">${option.emoji || 'üçΩÔ∏è'}</span>
                                    <div class="flex-grow"><p class="font-semibold text-gray-800">${option.name}</p><p class="text-sm text-gray-500">${option.type}</p></div>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="checkmark h-6 w-6 text-blue-600 opacity-0 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" /></svg>
                                </div>
                            </label>`;
                        }
                    });
                    dayHTML += `</div>`;
                    
                    const notes = orderData ? (orderData[`${dayId}_notes`] || '') : '';
                    const readonly = isViewOnly ? 'readonly' : '';
                    dayHTML += `<div class="mt-3"><textarea id="notes-${dayId}" name="notes-${dayId}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Anota√ß√µes? Ex: sem cebola, etc." ${readonly}>${notes}</textarea></div>`;
                }
                dayHTML += `</div>`;
                menuContainer.innerHTML += dayHTML;
            });

            // Se for apenas visualiza√ß√£o, n√£o mostrar o bot√£o de submeter
            document.getElementById('submitButtonContainer').classList.toggle('hidden', isViewOnly);
            validateForm();
        }

        async function submitOrder() {
            const button = document.getElementById('submitOrder');
            button.disabled = true; button.textContent = 'A enviar...';
            try {
                const rgf = document.getElementById('employeeRGF').value.trim();
                const empDoc = await getDoc(doc(funcionariosCollectionRef, rgf));
                if (!empDoc.exists()) throw new Error("Funcion√°rio n√£o encontrado.");
                
                tempOrderData.semana = nextWeekId; // Associa o pedido √† pr√≥xima semana
                tempOrderData.regional = empDoc.data().regional;

                await addDoc(pedidosCollectionRef, tempOrderData);
                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-text').textContent = `Obrigado, ${tempOrderData.employeeName}. O seu pedido para a semana de ${nextWeekId} foi registado com sucesso.`;
                document.getElementById('success-message').classList.remove('hidden');
                showToast("Pedido enviado com sucesso!", 'success');
            } catch (error) {
                console.error("Erro ao enviar pedido: ", error); showToast("Ocorreu um erro ao enviar o seu pedido.", 'error');
            } finally {
                button.disabled = false; button.textContent = 'Confirmar e Enviar';
            }
        }
        
        // =================================================================================
        // L√ìGICA DA VIS√ÉO DO ADMINISTRADOR (COM FLUXO DE APROVA√á√ÉO E CALEND√ÅRIO)
        // =================================================================================
        
        function loadPendingMenu() {
            onSnapshot(pendingMenuDocRef, (docSnap) => {
                const approvalSection = document.getElementById('approval-section');
                const approvalInfo = document.getElementById('approval-info');
                const approvalButtons = document.getElementById('approval-buttons');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const date = data.propostoEm?.toDate().toLocaleString('pt-BR') || 'data desconhecida';
                    approvalInfo.innerHTML = `<p>Um novo card√°pio para a semana de <strong>${nextWeekId}</strong> foi enviado por <strong>${data.propostoPor}</strong> em ${date}.</p>`;
                    approvalSection.classList.remove('hidden');

                    if (currentUserRole === 'superadm') {
                        approvalButtons.innerHTML = `
                            <button id="approveMenuBtn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Aprovar e Publicar</button>
                            <button id="rejectMenuBtn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Rejeitar</button>
                        `;
                        document.getElementById('approveMenuBtn').onclick = handleApproveMenu;
                        document.getElementById('rejectMenuBtn').onclick = handleRejectMenu;
                    } else {
                        approvalButtons.innerHTML = '';
                    }
                } else {
                    approvalSection.classList.add('hidden');
                }
            });
        }
        
        async function handleApproveMenu() {
            const message = "Tem a certeza que deseja aprovar e publicar este card√°pio? Ele ficar√° vis√≠vel para os funcion√°rios e os pedidos antigos para esta semana ser√£o apagados.";
            showCustomConfirm(message, async () => {
                try {
                    const pendingDoc = await getDoc(pendingMenuDocRef);
                    if (!pendingDoc.exists()) throw new Error("Card√°pio pendente n√£o encontrado.");
                    
                    // 1. Copia o card√°pio para a cole√ß√£o de menus datados
                    await setDoc(doc(menusCollectionRef, nextWeekId), pendingDoc.data());
                    
                    // 2. Apaga o documento pendente
                    await deleteDoc(pendingMenuDocRef);
                    
                    // 3. Limpa pedidos antigos para a pr√≥xima semana
                    await clearAllOrdersForWeek(nextWeekId);
                    
                    showToast("Card√°pio aprovado e publicado com sucesso!", "success");
                } catch(error) {
                    console.error("Erro ao aprovar card√°pio:", error);
                    showToast("Erro ao aprovar card√°pio.", "error");
                }
            });
        }

        async function handleRejectMenu() {
            showCustomConfirm("Tem a certeza que deseja rejeitar este card√°pio? Ele ser√° permanentemente apagado.", async () => {
                try {
                    await deleteDoc(pendingMenuDocRef);
                    showToast("Card√°pio pendente rejeitado e apagado.", "info");
                } catch(error) {
                    console.error("Erro ao rejeitar card√°pio:", error);
                    showToast("Erro ao rejeitar card√°pio.", "error");
                }
            });
        }

        async function saveNewMenu(menuData) { // Antiga 'processImageBtn'
            const button = document.getElementById('saveNewMenuBtn'); 
            button.disabled = true; button.textContent = 'A enviar para aprova√ß√£o...'; 
            const newMenu = menuData.map((item, i) => ({ /* ...c√≥digo de mapeamento mantido... */ })); 
            try { 
                await setDoc(pendingMenuDocRef, { 
                    menu: newMenu,
                    propostoPor: auth.currentUser.email,
                    propostoEm: serverTimestamp()
                });
                showToast('Card√°pio enviado para aprova√ß√£o!', 'success'); 
                document.getElementById('confirmation-form').classList.add('hidden'); 
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('imageUpload').value = ''; 
            } catch (error) { 
                console.error("Erro ao enviar card√°pio para aprova√ß√£o:", error); 
                showToast("Erro ao enviar card√°pio.", 'error'); 
            } finally { 
                button.disabled = false; button.textContent = 'Salvar Novo Card√°pio'; 
            }
        }

        async function clearAllOrdersForWeek(weekId) {
            const q = query(pedidosCollectionRef, where("semana", "==", weekId));
            const querySnapshot = await getDocs(q);
            const deletionPromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletionPromises);
        }

        function loadAdminData() { // Mostra pedidos da PR√ìXIMA semana
            const q = query(pedidosCollectionRef, where("semana", "==", nextWeekId));
            onSnapshot(q, (snapshot) => {
                let ordersForNextWeek = snapshot.docs.map(doc => doc);
                
                if (currentUserRole === 'adm') {
                    ordersForNextWeek = ordersForNextWeek.filter(doc => doc.data().regional === currentUserRegional);
                }

                allOrders = ordersForNextWeek.sort((a, b) => a.data().employeeName.localeCompare(b.data().employeeName));
                renderOrdersTable(allOrders);
                renderOrderStatus(allOrders);
            }, (error) => { console.error("Erro ao carregar dados:", error); });
        }
        
        function generateAndPrintReport() { // Gera relat√≥rio da PR√ìXIMA semana
            // ... (c√≥digo da fun√ß√£o mantido, pois j√° opera na vari√°vel global 'allOrders' que agora √© filtrada por semana)
        }

        function loadSuperAdminsList() { /* ...c√≥digo mantido... */ }
        function loadAdminsList() { /* ...c√≥digo mantido... */ }
        async function handlePromoteToSuperAdmin(uid, email) { /* ...c√≥digo mantido... */ }
        function handleDeleteAdmin(uid, email) { /* ...c√≥digo mantido... */ }
        async function handleAddAdmin(e) { /* ...c√≥digo mantido... */ }
        function populateAdminEmployeeSelect() { /* ...c√≥digo mantido... */ }
        
        // ... (todas as outras fun√ß√µes de gerenciamento, CRUDs, etc., permanecem as mesmas)
        
        // =================================================================================
        // INICIALIZA√á√ÉO E EVENT LISTENERS
        // =================================================================================
        function main() {
            // ... (todos os event listeners existentes)
            document.getElementById('super-admin-list-container')?.addEventListener('click', (e) => {
                 const deleteAdminBtn = e.target.closest('.delete-admin-btn');
                 if(deleteAdminBtn) { handleDeleteAdmin(deleteAdminBtn.dataset.id, deleteAdminBtn.dataset.email); }
            });

            // O RGF input agora s√≥ dispara a busca ao sair do campo (blur)
            const rgfInput = document.getElementById('employeeRGF');
            if (rgfInput) {
                rgfInput.value = localStorage.getItem('employeeRGF') || '';
                if(rgfInput.value) { findEmployeeByRGF(rgfInput.value); }
                rgfInput.addEventListener('blur', (e) => { 
                    localStorage.setItem('employeeRGF', e.target.value);
                    findEmployeeByRGF(e.target.value); 
                });
            }
        }
        main();
    </script>
</body>
</html>
