<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Del√≠cias Urbanas - App de Pedidos com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Lobster Two', cursive; }
        .menu-option-card:has(input:checked) { border-color: #2563eb; background-color: #eff6ff; transform: scale(1.02); }
        .menu-option-card:has(input:checked) .checkmark { opacity: 1; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos para o Modal de Edi√ß√£o */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
            max-width: 640px;
        }

        @media print {
            @page { size: landscape; margin: 15mm; }
            .no-print, .modal-overlay { display: none !important; }
            body, #app-container { margin: 0; padding: 0; box-shadow: none; background: none; }
            #admin-view h1 { font-size: 24pt; } #admin-view h2 { font-size: 16pt; }
            #admin-view table { font-size: 10pt; width: 100%; } #admin-view th, #admin-view td { padding: 6px; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-8">
        
        <div id="user-view" class="no-print">
            <div id="form-container">
                <header class="text-center mb-8"><h1 class="font-brand text-5xl text-blue-600">Del√≠cias Urbanas</h1><p class="mt-2 text-md text-gray-500">O seu card√°pio da semana est√° servido!</p></header>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6"><label for="employeeName" class="block text-lg font-semibold text-gray-800 mb-2">üë§ 1. Qual o seu nome?</label><input type="text" id="employeeName" placeholder="Digite o seu nome aqui" class="w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">üç≤ 2. Escolha os seus pratos</h2><div id="menu" class="space-y-8"><div class="text-center text-gray-500">A carregar o card√°pio...</div></div></div>
                <div id="guidanceSection" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6"><p id="guidanceText" class="font-semibold">Preencha o seu nome e escolha um prato para cada dia da semana.</p></div>
                <div id="submitButtonContainer" class="hidden text-center"><button id="submitOrder" class="w-full sm:w-auto bg-green-500 text-white font-bold text-lg px-8 py-3 rounded-xl hover:bg-green-600 shadow-lg">Finalizar e Enviar Pedido</button></div>
            </div>
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Fazer Novo Pedido</button></div>
            <footer class="text-center mt-10"><button id="switchToAdmin" class="text-sm text-gray-500 hover:text-blue-600">Aceder ao Painel do Administrador</button></footer>
        </div>

        <div id="admin-view" class="hidden">
            <header class="text-center border-b pb-6 mb-6"><h1 class="text-4xl font-bold text-gray-800">Painel do Administrador</h1><p class="text-lg text-gray-600 mt-1">Del√≠cias Urbanas</p></header>
            <div class="no-print mb-8"><button id="switchToUser" class="text-sm text-gray-500 hover:text-blue-600">‚Üê Voltar para o Card√°pio</button></div>
            
            <section id="menu-updater-section" class="no-print bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">ü§ñ Atualizar Card√°pio com Imagem (IA)</h2>
                <p class="text-gray-600 mb-4">Envie uma imagem do novo card√°pio. A nossa intelig√™ncia artificial ir√° ler e preencher os campos para si.</p>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" class="mt-4 rounded-lg max-h-80 hidden" />
                <div id="image-processor-container" class="mt-4 text-center hidden"><button id="processImageBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Analisar Card√°pio</button></div>
                <div id="loader" class="hidden mx-auto my-4 loader"></div>
                <div id="confirmation-form" class="hidden mt-6"></div>
            </section>

            <section id="orders-section">
                <div class="no-print mb-4 flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-700">Pedidos Recebidos</h2><button onclick="window.print()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">üñ®Ô∏è Salvar como PDF</button></div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Editar Pedido</h2>
            <form id="edit-order-form">
                <input type="hidden" id="edit-order-id">
                <div class="mb-4">
                    <label for="edit-employeeName" class="block text-lg font-semibold text-gray-800 mb-2">Nome do Funcion√°rio</label>
                    <input type="text" id="edit-employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg" readonly>
                </div>
                <div id="edit-menu-options" class="space-y-6">
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancel-edit" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI",
          authDomain: "cardapio-8ddea.firebaseapp.com",
          projectId: "cardapio-8ddea",
          storageBucket: "cardapio-8ddea.firebasestorage.app",
          messagingSenderId: "1019677985212",
          appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const menuDocRef = doc(db, "cardapio", "semanal");
        const opcoesFixas = [{ name: 'Omelete', emoji: 'üç≥' }, { name: 'Fil√© de frango', emoji: 'üêî' }];
        let menuDaSemana = [];

        function createFallbackMenu() {
            return [
                { day: 'Segunda-feira', pratoPrincipal: { name: 'Card√°pio n√£o definido', emoji: 'ü§∑' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } },
                { day: 'Ter√ßa-feira', pratoPrincipal: { name: 'Card√°pio n√£o definido', emoji: 'ü§∑' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } },
                { day: 'Quarta-feira', pratoPrincipal: { name: 'Card√°pio n√£o definido', emoji: 'ü§∑' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } },
                { day: 'Quinta-feira', pratoPrincipal: { name: 'Card√°pio n√£o definido', emoji: 'ü§∑' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } },
                { day: 'Sexta-feira', pratoPrincipal: { name: 'Card√°pio n√£o definido', emoji: 'ü§∑' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } }
            ];
        }

        async function loadAndDisplayMenu() {
            try {
                const docSnap = await getDoc(menuDocRef);
                if (docSnap.exists() && docSnap.data().menu && docSnap.data().menu.length > 0) {
                    menuDaSemana = docSnap.data().menu;
                } else {
                    console.log("Documento do card√°pio n√£o encontrado ou vazio! A usar dados de fallback.");
                    menuDaSemana = createFallbackMenu();
                }
            } catch (error) {
                console.error("Erro ao carregar o card√°pio:", error);
                menuDaSemana = createFallbackMenu();
            }
            createMenuHTML();
        }
        
        function createMenuHTML() {
            const menuContainer = document.getElementById('menu');
            if (!menuContainer) return;
            menuContainer.innerHTML = '';
            menuDaSemana.forEach(item => {
                const dayId = item.day.replace(/[^a-zA-Z]/g, "").toLowerCase();
                const allOptions = [{ ...item.pratoPrincipal, type: 'Prato Principal' }, ...(item.opcao && item.opcao.name ? [{ ...item.opcao, type: 'Op√ß√£o do Dia' }] : []), ...opcoesFixas.map(fixa => ({ ...fixa, type: 'Op√ß√£o Fixa' }))];
                let dayHTML = `<div class="day-section"><h3 class="text-xl font-bold text-gray-800">${item.day}</h3><div class="text-sm font-semibold text-blue-600 bg-blue-100 rounded-full inline-block px-3 py-1 mb-3">Guarni√ß√£o do dia: ${item.guarnicao.name} ${item.guarnicao.emoji}</div><div class="space-y-3">`;
                allOptions.forEach((option) => {
                    if (option.name) {
                        dayHTML += `<label class="menu-option-card block p-4 border-2 border-gray-200 rounded-lg cursor-pointer"><input type="radio" name="${dayId}" value="${option.name}" class="hidden"><div class="flex items-center"><span class="text-3xl mr-4">${option.emoji}</span><div class="flex-grow"><p class="font-semibold text-gray-800">${option.name}</p><p class="text-sm text-gray-500">${option.type}</p></div><svg xmlns="http://www.w3.org/2000/svg" class="checkmark h-6 w-6 text-blue-600 opacity-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" /></svg></div></label>`;
                    }
                });
                dayHTML += `</div></div>`;
                menuContainer.innerHTML += dayHTML;
            });
            validateForm();
        }
        
        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('image-processor-container').classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        });
        
        document.getElementById('processImageBtn').addEventListener('click', async () => {
            const loader = document.getElementById('loader');
            const button = document.getElementById('processImageBtn');
            const confirmationForm = document.getElementById('confirmation-form');
            button.disabled = true; button.textContent = 'A analisar...';
            loader.classList.remove('hidden'); confirmationForm.classList.add('hidden');
            const file = document.getElementById('imageUpload').files[0];
            const base64ImageData = (await toBase64(file)).split(',')[1];
            const prompt = "Analise a imagem deste card√°pio. Extraia as informa√ß√µes para cada dia da semana (de Segunda a Sexta). Para cada dia, identifique o 'Prato Principal', a 'Op√ß√£o' e a 'Guarni√ß√£o'. Retorne os dados como um objeto JSON. A estrutura do JSON deve ser um objeto com uma chave 'menu', que cont√©m um array. Cada objeto no array representa um dia e deve conter as chaves 'day', 'pratoPrincipal' (com sub-chaves 'name' e 'emoji'), 'opcao' (com 'name' e 'emoji') e 'guarnicao' (com 'name' e 'emoji'). Se um campo n√£o existir para um dia (ex: sem 'Op√ß√£o'), o valor de 'name' deve ser uma string vazia. Atribua emojis apropriados para cada prato.";
            const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: file.type, data: base64ImageData } }] }] };
            const apiKey = "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Erro da API:", errorBody);
                    throw new Error(`Erro da API: ${errorBody.error.message}`);
                }
                const result = await response.json();
                let textResponse = result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                const menuData = JSON.parse(textResponse);
                displayConfirmationForm(menuData.menu);
            } catch (error) {
                console.error("Erro ao analisar a imagem:", error);
                alert("Ocorreu um erro ao ler a imagem. Verifique o console de desenvolvedor (F12) para mais detalhes.");
            } finally {
                button.disabled = false; button.textContent = 'Analisar Card√°pio';
                loader.classList.add('hidden');
            }
        });

        function displayConfirmationForm(menuData) {
            const container = document.getElementById('confirmation-form');
            container.innerHTML = '<h3 class="text-xl font-semibold mb-4">Confirme os Dados Extra√≠dos</h3>';
            menuData.forEach((item, index) => {
                container.innerHTML += `<div class="p-4 bg-gray-50 rounded-lg mb-4"><h4 class="font-bold">${item.day}</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2"><div><label class="block text-sm font-medium">Prato Principal</label><input type="text" id="prato-${index}" value="${item.pratoPrincipal.name}" class="w-full border rounded p-1"></div><div><label class="block text-sm font-medium">Op√ß√£o</label><input type="text" id="opcao-${index}" value="${item.opcao.name}" class="w-full border rounded p-1"></div><div><label class="block text-sm font-medium">Guarni√ß√£o</label><input type="text" id="guarnicao-${index}" value="${item.guarnicao.name}" class="w-full border rounded p-1"></div></div></div>`;
            });
            container.innerHTML += `<div class="text-center mt-4"><button id="saveNewMenuBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Salvar Novo Card√°pio</button></div>`;
            container.classList.remove('hidden');
            document.getElementById('saveNewMenuBtn').addEventListener('click', () => saveNewMenu(menuData.length));
        }

        async function saveNewMenu(itemCount) {
             const button = document.getElementById('saveNewMenuBtn');
             button.disabled = true; button.textContent = 'A salvar...';
             const newMenu = [];
             for(let i=0; i < itemCount; i++) {
                newMenu.push({
                    day: document.querySelector(`#prato-${i}`).closest('.p-4').querySelector('h4').textContent,
                    pratoPrincipal: { name: document.getElementById(`prato-${i}`).value, emoji: 'üçΩÔ∏è' },
                    opcao: { name: document.getElementById(`opcao-${i}`).value, emoji: 'ü•£' },
                    guarnicao: { name: document.getElementById(`guarnicao-${i}`).value, emoji: 'ü•ó' }
                });
             }
             try {
                await setDoc(menuDocRef, { menu: newMenu });
                alert('Card√°pio atualizado com sucesso!');
                document.getElementById('confirmation-form').classList.add('hidden');
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('image-processor-container').classList.add('hidden');
                document.getElementById('imageUpload').value = '';
                await loadAndDisplayMenu();
             } catch (error) {
                console.error("Erro ao salvar o card√°pio:", error);
                alert("Ocorreu um erro ao salvar o novo card√°pio.");
             } finally {
                button.disabled = false; button.textContent = 'Salvar Novo Card√°pio';
             }
        }
        
        const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });

        function validateForm() {
            if(!document.getElementById('employeeName')) return;
            const employeeName = document.getElementById('employeeName').value.trim();
            const guidanceSection = document.getElementById('guidanceSection');
            const guidanceText = document.getElementById('guidanceText');
            const submitButtonContainer = document.getElementById('submitButtonContainer');
            const missingDays = menuDaSemana.filter(item => !document.querySelector(`input[name="${item.day.replace(/[^a-zA-Z]/g, "").toLowerCase()}"]:checked`)).map(item => item.day);
            if (employeeName && missingDays.length === 0) {
                guidanceSection.classList.add('hidden');
                submitButtonContainer.classList.remove('hidden');
            } else {
                submitButtonContainer.classList.add('hidden');
                guidanceSection.classList.remove('hidden');
                let message = !employeeName ? 'Por favor, preencha o seu nome. ' : `Ol√°, ${employeeName}! `;
                if (missingDays.length > 0) message += `Falta selecionar o(s) prato(s) para: ${missingDays.join(', ')}.`;
                guidanceText.textContent = message;
            }
        }
        async function submitOrder() {
            const employeeName = document.getElementById('employeeName').value.trim();
            const orderData = { employeeName, timestamp: serverTimestamp() };
            menuDaSemana.forEach(item => {
                const dayId = item.day.replace(/[^a-zA-Z]/g, "").toLowerCase();
                orderData[dayId] = document.querySelector(`input[name="${dayId}"]:checked`).value;
            });
            try {
                const button = document.getElementById('submitOrder');
                button.disabled = true; button.textContent = 'A enviar...';
                await addDoc(collection(db, "pedidosDaSemana"), orderData);
                document.getElementById('form-container').classList.add('hidden');
                const successMessage = document.getElementById('success-message');
                document.getElementById('success-text').textContent = `Obrigado, ${employeeName}. O seu pedido foi registado.`;
                successMessage.classList.remove('hidden');
            } catch (error) {
                console.error("Erro ao enviar pedido: ", error);
                alert("Ocorreu um erro ao enviar o seu pedido. Tente novamente.");
                document.getElementById('submitOrder').disabled = false; document.getElementById('submitOrder').textContent = 'Finalizar e Enviar Pedido';
            }
        }
        
        function loadAdminOrders() {
            const ordersQuery = query(collection(db, "pedidosDaSemana"), orderBy("timestamp", "desc"));
            const ordersTableContainer = document.getElementById('ordersTableContainer');

            onSnapshot(ordersQuery, (snapshot) => {
                if (snapshot.empty) {
                    ordersTableContainer.innerHTML = '<p class="text-gray-500">Nenhum pedido recebido ainda.</p>';
                    return;
                }

                const processedEmployees = new Set();
                const uniqueDocs = [];
                snapshot.docs.forEach(doc => {
                    const orderData = doc.data();
                    if (orderData.employeeName && !processedEmployees.has(orderData.employeeName)) {
                        processedEmployees.add(orderData.employeeName);
                        uniqueDocs.push(doc);
                    }
                });

                const nomesPratosFixos = opcoesFixas.map(p => p.name);
                let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">Funcion√°rio</th><th class="py-2 px-3 border-b text-left">Data do Pedido</th>`;
                menuDaSemana.forEach(item => tableHTML += `<th class="py-2 px-3 border-b text-left">${item.day}</th>`);
                tableHTML += `<th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;

                uniqueDocs.forEach(doc => {
                    const order = doc.data();
                    const docId = doc.id;
                    tableHTML += `<tr><td class="py-2 px-3 border-b font-bold">${order.employeeName}</td>`;

                    let dataFormatada = 'N/A';
                    if (order.timestamp && typeof order.timestamp.toDate === 'function') {
                        dataFormatada = order.timestamp.toDate().toLocaleString('pt-BR');
                    }
                    tableHTML += `<td class="py-2 px-3 border-b text-sm">${dataFormatada}</td>`;

                    menuDaSemana.forEach(dayMenuItem => {
                        const dayId = dayMenuItem.day.replace(/[^a-zA-Z]/g, "").toLowerCase();
                        const pratoSelecionado = order[dayId] || 'N/A';
                        let textoDaCelula = '';

                        if (pratoSelecionado === 'N/A') {
                            textoDaCelula = 'N/A';
                        } else if (nomesPratosFixos.includes(pratoSelecionado)) {
                            textoDaCelula = pratoSelecionado;
                        } else if (dayMenuItem.pratoPrincipal.name === pratoSelecionado) {
                            textoDaCelula = 'Prato Principal';
                        } else if (dayMenuItem.opcao.name === pratoSelecionado) {
                            textoDaCelula = 'Op√ß√£o do Dia';
                        } else {
                            textoDaCelula = pratoSelecionado; 
                        }
                        
                        tableHTML += `<td class="py-2 px-3 border-b">${textoDaCelula}</td>`;
                    });

                    tableHTML += `<td class="py-2 px-3 border-b space-x-2">
                        <button data-id="${docId}" class="edit-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button>
                        <button data-id="${docId}" class="delete-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button>
                    </td></tr>`;
                });

                tableHTML += `</tbody></table>`;
                ordersTableContainer.innerHTML = tableHTML;
            });
        }
        
        async function openEditModal(docId) {
            const modal = document.getElementById('edit-modal');
            const form = document.getElementById('edit-order-form');
            const menuOptionsContainer = document.getElementById('edit-menu-options');
            try {
                const orderDocRef = doc(db, "pedidosDaSemana", docId);
                const orderSnap = await getDoc(orderDocRef);
                if (!orderSnap.exists()) {
                    alert("Erro: Pedido n√£o encontrado.");
                    return;
                }
                const orderData = orderSnap.data();
                form.querySelector('#edit-order-id').value = docId;
                form.querySelector('#edit-employeeName').value = orderData.employeeName;
                menuOptionsContainer.innerHTML = '';
                menuDaSemana.forEach(item => {
                    const dayId = item.day.replace(/[^a-zA-Z]/g, "").toLowerCase();
                    const allOptions = [{ ...item.pratoPrincipal, type: 'Prato Principal' }, ...(item.opcao && item.opcao.name ? [{ ...item.opcao, type: 'Op√ß√£o do Dia' }] : []), ...opcoesFixas.map(fixa => ({ ...fixa, type: 'Op√ß√£o Fixa' }))];
                    let dayHTML = `<div class="day-section"><h3 class="text-lg font-bold text-gray-800">${item.day}</h3><div class="space-y-2 mt-2">`;
                    allOptions.forEach((option) => {
                        if (option.name) {
                            const isChecked = orderData[dayId] === option.name ? 'checked' : '';
                            dayHTML += `<label class="block p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50"><input type="radio" name="edit-${dayId}" value="${option.name}" class="mr-2" ${isChecked}><span class="font-semibold">${option.name}</span> <span class="text-sm text-gray-500">(${option.type})</span></label>`;
                        }
                    });
                    dayHTML += `</div></div>`;
                    menuOptionsContainer.innerHTML += dayHTML;
                });
                modal.classList.remove('hidden');
            } catch(error) {
                console.error("Erro ao abrir modal de edi√ß√£o:", error);
                alert("N√£o foi poss√≠vel carregar os dados para edi√ß√£o.");
            }
        }

        async function saveOrderChanges(event) {
            event.preventDefault();
            const form = event.target;
            const docId = form.querySelector('#edit-order-id').value;
            const updatedData = {};
            menuDaSemana.forEach(item => {
                const dayId = item.day.replace(/[^a-zA-Z]/g, "").toLowerCase();
                const selectedOption = form.querySelector(`input[name="edit-${dayId}"]:checked`);
                if (selectedOption) {
                    updatedData[dayId] = selectedOption.value;
                }
            });
            try {
                const orderDocRef = doc(db, "pedidosDaSemana", docId);
                await updateDoc(orderDocRef, updatedData);
                alert("Pedido atualizado com sucesso!");
                document.getElementById('edit-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar altera√ß√µes:", error);
                alert("Falha ao salvar as altera√ß√µes do pedido.");
            }
        }

        async function deleteOrder(docId) {
            if (confirm("Tem a certeza que deseja excluir este pedido? Esta a√ß√£o n√£o pode ser desfeita.")) {
                try {
                    await deleteDoc(doc(db, "pedidosDaSemana", docId));
                    alert("Pedido exclu√≠do com sucesso.");
                } catch (error) {
                    console.error("Erro ao excluir pedido:", error);
                    alert("Falha ao excluir o pedido.");
                }
            }
        }
        
        document.getElementById('ordersTableContainer').addEventListener('click', function(event) {
            if (event.target.classList.contains('edit-btn')) {
                openEditModal(event.target.dataset.id);
            }
            if (event.target.classList.contains('delete-btn')) {
                deleteOrder(event.target.dataset.id);
            }
        });

        document.getElementById('cancel-edit').addEventListener('click', () => {
            document.getElementById('edit-modal').classList.add('hidden');
        });
        document.getElementById('edit-order-form').addEventListener('submit', saveOrderChanges);

        async function main() {
            await signInAnonymously(auth);
            const userView = document.getElementById('user-view');
            const adminView = document.getElementById('admin-view');
            await loadAndDisplayMenu();
            document.getElementById('switchToAdmin').addEventListener('click', () => {
                const senhaDigitada = prompt("Para aceder ao painel, por favor, digite a senha:");
                const SENHA_CORRETA = "admin123";
                if (senhaDigitada === SENHA_CORRETA) {
                    userView.classList.add('hidden');
                    adminView.classList.remove('hidden');
                    loadAdminOrders();
                } else if (senhaDigitada !== null) {
                    alert("Senha incorreta. Acesso negado.");
                }
            });
            document.getElementById('switchToUser').addEventListener('click', () => {
                adminView.classList.add('hidden');
                userView.classList.remove('hidden');
            });
            if (document.getElementById('employeeName')) {
                document.getElementById('employeeName').addEventListener('input', validateForm);
                document.getElementById('menu').addEventListener('change', validateForm);
                document.getElementById('submitOrder').addEventListener('click', submitOrder);
            }
        }

        main().catch(error => console.error("Falha na inicializa√ß√£o principal:", error));
    </script>
</body>
</html>
