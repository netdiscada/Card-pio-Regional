<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card√°pio Quatinga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Lobster Two', cursive; }
        .menu-option-card:has(input:checked) { border-color: #2563eb; background-color: #eff6ff; transform: scale(1.02); }
        .menu-option-card:has(input:checked) .checkmark { opacity: 1; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-print { }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-height: 90vh; overflow-y: auto; width: 90%; max-width: 500px; }
        input:read-only { background-color: #f3f4f6; cursor: not-allowed; }
        #print-report { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            body > *:not(#print-report) { display: none !important; }
            #print-report { display: block !important; }
            #print-report h1 { font-size: 18pt; text-align: center; margin-bottom: 15px; font-family: 'Poppins', sans-serif; font-weight: 600; }
            .report-day-section { margin-bottom: 12px; page-break-inside: avoid; }
            .report-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
            #print-report th, #print-report td { border: 1px solid #999; padding: 5px; text-align: left; }
            #print-report th { background-color: #e2e8f0; font-weight: 600; }
            #print-report .rgf-col { width: 15%; }
            #print-report .nome-col { width: 60%; }
            #print-report .pedido-col { width: 25%; background-color: #dbeafe; font-weight: bold; }
        }
        #app-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; pointer-events: none; transform: translateX(-50%) translateY(20px); }
        #app-toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
        #app-toast.success { background-color: #22c55e; }
        #app-toast.error { background-color: #ef4444; }
        #app-toast.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-20">

        <div id="user-view" class="no-print">
            <!-- Bot√µes de altern√¢ncia de visualiza√ß√£o de card√°pio para usu√°rio -->
            <div id="nextWeekToggleContainer" class="my-4 text-center hidden">
                <button id="toggleToNextWeekViewBtn" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm sm:text-base">
                    Escolher/Ver Card√°pio da Pr√≥xima Semana
                </button>
            </div>
            <div id="currentWeekViewInfo" class="my-4 text-center hidden p-3 bg-purple-100 text-purple-700 rounded-md">
                <p>Voc√™ est√° visualizando/editando o card√°pio da <strong>pr√≥xima semana</strong>.</p>
                <button id="switchToCurrentWeekViewBtn" class="mt-2 text-sm text-purple-600 hover:text-purple-800 underline">
                    Voltar para o card√°pio da semana atual
                </button>
            </div>

            <div id="form-container">
                <header class="text-center mb-8"><h1 class="font-brand text-5xl text-blue-600">Del√≠cias Urbanas</h1><p id="cardapio-view-title" class="mt-2 text-md text-gray-500">O seu card√°pio da semana est√° servido!</p></header>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h2 class="block text-lg font-semibold text-gray-800 mb-2">üë§ 1. Identifica√ß√£o</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div><label for="employeeRGF" class="block text-sm font-medium text-gray-700">Seu RGF</label><input type="text" id="employeeRGF" placeholder="Digite o seu RGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                        <div><label for="employeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="employeeName" placeholder="Preenchido automaticamente" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">üçΩÔ∏è 2. Escolha os seus pratos</h2><div id="menu" class="space-y-8"><div class="text-center text-gray-500">A carregar o card√°pio...</div></div></div>
                <div id="guidanceSection" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6"><p id="guidanceText" class="font-semibold">Digite seu RGF e escolha uma op√ß√£o para cada dia.</p></div>
                <div id="submitButtonContainer" class="hidden text-center"><button id="openConfirmationModal" class="w-full sm:w-auto bg-green-500 text-white font-bold text-lg px-8 py-3 rounded-xl hover:bg-green-600 shadow-lg">Revisar e Finalizar Pedido</button></div>
            </div>
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Fazer Novo Pedido</button></div>
            <footer class="text-center mt-10">
                <button id="switchToAdmin" class="text-sm text-gray-500 hover:text-blue-600">Aceder ao Painel do Administrador</button>
            </footer>
        </div>

        <div id="admin-view" class="hidden no-print">
            <header class="text-center border-b pb-6 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Painel do Administrador</h1>
                <p class="text-lg text-gray-600 mt-1">Del√≠cias Urbanas</p>
                <div class="mt-4">
                    <button id="adminLogoutBtn" class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600">Sair do Painel</button>
                </div>
            </header>
            <div class="mb-8">
                <button id="switchToUserFromAdmin" class="text-sm text-gray-500 hover:text-blue-600">‚¨ÖÔ∏è Voltar para o Card√°pio (Vis√£o Usu√°rio)</button>
            </div>

            <section class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">‚öôÔ∏è Controles do Card√°pio</h2>
                <div id="admin-cardapio-status-display" class="mb-4 p-4 bg-slate-100 rounded-md text-sm">
                    <p>A carregar estado do card√°pio...</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="toggleAtualAbertoBtn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">Alternar Abertura (Atual)</button>
                    <button id="toggleProximoAbertoBtn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Alternar Abertura (Pr√≥ximo)</button>
                </div>
                 <p class="text-xs text-gray-500 mt-2">Estes bot√µes controlam se os funcion√°rios podem fazer pedidos para o card√°pio atual ou para o card√°pio da pr√≥xima semana.</p>
            </section>

            <section id="order-status-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üìä Status de Pedidos da Semana</h2>
                <div id="order-status-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p class="text-gray-500">A carregar status dos pedidos...</p>
                </div>
            </section>

            <section id="menu-updater-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-4">üçú Atualizar Card√°pio com Imagem (IA)</h2>
                 <p class="text-gray-600 mb-2">Use para definir o card√°pio da <strong>pr√≥xima semana</strong>. Ao salvar, ele ser√° copiado para <code class="text-xs bg-gray-200 p-1 rounded">cardapio/proximaSemana</code>.</p>
                <p class="text-gray-600 mb-4">Envie uma imagem do novo card√°pio. A nossa intelig√™ncia artificial ir√° ler e preencher os campos para si.</p>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" class="mt-4 rounded-lg max-h-80 hidden" />
                <div id="image-processor-container" class="mt-4 text-center hidden"><button id="processImageBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Analisar Card√°pio</button></div>
                <div id="loader" class="hidden mx-auto my-4 loader"></div>
                <div id="confirmation-form" class="hidden mt-6"></div>
                <div id="whatsapp-notification-container" class="mt-4 text-center hidden">
                    <button id="notifyWhatsAppBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="white"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.287.492-1.24 4.515 4.639-1.219.452.273zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                        Notificar Funcion√°rios no WhatsApp
                    </button>
                </div>
                 <button id="publishNextWeekMenuBtn" class="mt-6 w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 shadow-md">Publicar Card√°pio da Pr√≥xima Semana COMO ATUAL</button>
                 <p class="text-xs text-gray-500 mt-2">Este bot√£o copia o conte√∫do de <code class="text-xs bg-gray-200 p-1 rounded">cardapio/proximaSemana</code> para <code class="text-xs bg-gray-200 p-1 rounded">cardapio/semanal</code> e ZERA os pedidos atuais.</p>
            </section>

            <section id="employee-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üë• Gerenciamento de Funcion√°rios</h2>
                <form id="add-employee-form" class="grid sm:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="newEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label>
                        <input type="text" id="newEmployeeRGF" placeholder="RGF do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="newEmployeeName" placeholder="Nome do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Funcion√°rio</button>
                </form>
                <div id="employee-list-container" class="overflow-x-auto">
                    <p class="text-gray-500">A carregar lista de funcion√°rios...</p>
                </div>
            </section>

            <section id="orders-section">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Pedidos Recebidos (Card√°pio Atual)</h2>
                    <div class="w-full sm:w-auto"><input type="text" id="searchInput" placeholder="üîé Buscar por nome..." class="w-full sm:w-64 px-4 py-2 border rounded-lg"></div>
                    <button id="generateReportBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">üñ®Ô∏è Salvar Relat√≥rio como PDF</button>
                </div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>
        </div>
    </div>

    <div id="edit-order-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Pedido</h2><form id="edit-order-form"><input type="hidden" id="edit-order-id"><div class="mb-4"><label class="block text-lg font-semibold text-gray-800 mb-2">Nome do Funcion√°rio</label><input type="text" id="edit-order-employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly></div><div id="edit-menu-options" class="space-y-6"></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button></div></form></div></div>
    <div id="edit-employee-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Funcion√°rio</h2><form id="edit-employee-form"><div class="mb-4"><label for="editEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label><input type="text" id="editEmployeeRGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div><div class="mb-4"><label for="editEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="editEmployeeName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button></div></form></div></div>
    <div id="confirmation-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-2xl font-bold mb-4">Confirme o seu Pedido</h2><p class="mb-6 text-gray-600">Por favor, revise as suas escolhas antes de enviar.</p><div id="confirmation-summary" class="space-y-2 mb-8"></div><div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Editar</button><button id="submitOrder" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">Confirmar e Enviar</button></div></div></div>
    <div id="admin-login-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Aceder ao Painel de Administrador</h2><form id="admin-login-form"><div class="mb-4"><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="adminEmail" placeholder="seu-email@exemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="adminPassword" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="adminPassword" placeholder="Sua senha" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button></div></form></div></div>
    <div id="custom-confirm-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-xl font-bold mb-4" id="custom-confirm-title">Confirmar A√ß√£o</h2><p class="mb-6 text-gray-600" id="custom-confirm-message">Tem a certeza que deseja prosseguir?</p><div class="flex justify-end space-x-4"><button id="custom-confirm-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button id="custom-confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirmar</button></div></div></div>

    <div id="print-report"></div>
    <div id="app-toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, setDoc, deleteDoc, updateDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI", // Substitua pela sua chave de API real se necess√°rio
            authDomain: "cardapio-8ddea.firebaseapp.com",
            projectId: "cardapio-8ddea",
            storageBucket: "cardapio-8ddea.appspot.com",
            messagingSenderId: "1019677985212",
            appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const APP_CONFIG = {
            ADMIN_UID: 'LqAXao4FuOQAvzS3uQAd9et6OnK2',
        };

        const menuDocRef = doc(db, "cardapio", "semanal");
        const proximoMenuDocRef = doc(db, "cardapio", "proximaSemana");
        const estadoCardapioDocRef = doc(db, "configuracoes", "estadoCardapio");
        const pedidosCollectionRef = collection(db, "pedidosDaSemana");
        const funcionariosCollectionRef = collection(db, "funcionarios");

        const fixedOptions = [{ name: 'Omelete', emoji: 'üç≥' }, { name: 'Fil√© de frango', emoji: 'üçó' }];

        let weeklyMenu = []; // Card√°pio atualmente em vigor (semanal)
        let proximoWeeklyMenu = []; // Card√°pio para a pr√≥xima semana
        let pedidosDoUsuarioLogado = { atual: null, proxima: null }; // Pedidos do usu√°rio logado

        let allOrders = []; // Usado pelo Admin para ver todos os pedidos
        let tempOrderData = {}; // Usado para submiss√£o de pedido
        let currentUserID = null;
        let currentUserRGF = null; // Armazena RGF do usu√°rio logado para buscar seus pedidos

        let estadoCardapio = {
            cardapioAtualAbertoParaEscolha: false,
            cardapioProximoAbertoParaEscolha: false,
            dataPublicacaoProximoCardapio: null,
            // Adicionar um campo para controlar qual card√°pio o usu√°rio est√° vendo por padr√£o
            // Isso ser√° √∫til para quinta-feira, quando ambos podem estar relevantes.
            // Por agora, vamos focar em 'visualizandoCardapioProximaSemana' controlado por UI.
        };
        // `visualizandoCardapioProximaSemana` controla qual card√°pio o usu√°rio est√° vendo/interagindo na UI.
        // Esta vari√°vel ser√° crucial para a l√≥gica de quinta-feira.
        let visualizandoCardapioProximaSemana = false;

        function getDayId(dayName) { return dayName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, "").toLowerCase(); }

        function getDiaDaSemanaAtual(timezone = 'America/Sao_Paulo') {
            // Retorna o n√∫mero do dia da semana: 0 para Domingo, 1 para Segunda, ..., 4 para Quinta, 6 para S√°bado
            // Usar toLocaleDateString para obter o dia na timezone correta e depois mapear
            // ou mais simples, assumir que o getDay() do browser est√° na timezone do usu√°rio, o que √© geralmente o caso.
            return new Date().getDay();
        }

        function isQuintaFeira() {
            return getDiaDaSemanaAtual() === 4; // 4 representa Quinta-feira
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('app-toast');
            if(!toast) return;
            toast.textContent = message;
            toast.className = 'show'; // Remove todas as classes de tipo anteriores
            toast.classList.add(type); // Adiciona a classe do tipo atual
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, duration);
        }

        function showCustomConfirm(message, onConfirm, title = "Confirmar A√ß√£o", okLabel = "Confirmar", cancelLabel = "Cancelar") {
            const modal = document.getElementById('custom-confirm-modal');
            const titleEl = document.getElementById('custom-confirm-title');
            const messageEl = document.getElementById('custom-confirm-message');
            const okBtn = document.getElementById('custom-confirm-ok-btn');
            const cancelBtn = document.getElementById('custom-confirm-cancel-btn');

            titleEl.textContent = title;
            messageEl.innerHTML = message; // Usar innerHTML para permitir formata√ß√£o b√°sica se necess√°rio
            okBtn.textContent = okLabel;
            cancelBtn.textContent = cancelLabel;
            modal.classList.remove('hidden');

            const newOkBtn = okBtn.cloneNode(true); // Clonar para remover event listeners antigos
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);

            newOkBtn.addEventListener('click', () => {
                onConfirm();
                modal.classList.add('hidden');
            });
            // O event listener do cancelBtn j√° est√° configurado no main() para fechar o modal
        }

        function loadAndRenderEmployees() {
            const q = query(funcionariosCollectionRef, orderBy("nome"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('employee-list-container');
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum funcion√°rio cadastrado.</p>';
                    return;
                }
                let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">RGF</th><th class="py-2 px-3 border-b text-left">Nome</th><th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    tableHTML += `<tr>
                        <td class="py-2 px-3 border-b font-mono">${doc.id}</td>
                        <td class="py-2 px-3 border-b font-semibold">${employee.nome}</td>
                        <td class="py-2 px-3 border-b space-x-2">
                            <button data-id="${doc.id}" data-name="${employee.nome}" class="edit-employee-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button>
                            <button data-id="${doc.id}" data-name="${employee.nome}" class="delete-employee-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button>
                        </td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            }, (error) => {
                 console.error("Erro ao carregar funcion√°rios:", error);
                 showToast("Falha ao carregar funcion√°rios. Verifique o console para mais detalhes.", "error");
            });
        }

        async function handleAddEmployee(e) {
            e.preventDefault();
            const rgfInput = document.getElementById('newEmployeeRGF');
            const nameInput = document.getElementById('newEmployeeName');
            const rgf = rgfInput.value.trim();
            const nome = nameInput.value.trim();

            if (!rgf || !nome) { showToast("Por favor, preencha o RGF e o Nome.", 'error'); return; }

            try {
                await setDoc(doc(db, "funcionarios", rgf), { nome });
                showToast("Funcion√°rio adicionado com sucesso!", 'success');
                rgfInput.value = ''; nameInput.value = '';
            } catch (error) {
                console.error("Erro ao adicionar funcion√°rio: ", error);
                showToast("Ocorreu um erro ao adicionar o funcion√°rio.", 'error');
            }
        }

        function handleDeleteEmployee(rgf, name) {
            const message = `Tem a certeza que deseja excluir o funcion√°rio ${name} (RGF: ${rgf})? Esta a√ß√£o n√£o pode ser desfeita.`;
            showCustomConfirm(message, async () => {
                try {
                    await deleteDoc(doc(db, "funcionarios", rgf));
                    showToast("Funcion√°rio exclu√≠do com sucesso.", 'success');
                } catch (error) {
                    console.error("Erro ao excluir funcion√°rio: ", error);
                    showToast("Falha ao excluir o funcion√°rio.", 'error');
                }
            });
        }

        function openEmployeeEditModal(rgf, nome) {
            document.getElementById('editEmployeeRGF').value = rgf;
            document.getElementById('editEmployeeName').value = nome;
            document.getElementById('edit-employee-modal').classList.remove('hidden');
        }

        async function handleSaveEmployeeChanges(e) {
            e.preventDefault();
            const rgf = document.getElementById('editEmployeeRGF').value;
            const newName = document.getElementById('editEmployeeName').value.trim();

            if (!newName) { showToast("O nome n√£o pode ficar em branco.", 'error'); return; }
            try {
                await updateDoc(doc(db, "funcionarios", rgf), { nome: newName });
                showToast("Funcion√°rio atualizado com sucesso!", 'success');
                document.getElementById('edit-employee-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar altera√ß√µes do funcion√°rio: ", error);
                showToast("Falha ao salvar as altera√ß√µes do funcion√°rio.", 'error');
            }
        }

        async function findEmployeeByRGF(rgf) {
            const nameInput = document.getElementById('employeeName');
            currentUserRGF = rgf.trim(); // Armazena o RGF para buscar pedidos depois
            if (!currentUserRGF) {
                nameInput.value = '';
                nameInput.placeholder = 'Preenchido automaticamente';
                pedidosDoUsuarioLogado = { atual: null, proxima: null }; // Limpa pedidos se RGF for removido
                validateForm();
                return;
            }
            try {
                const docSnap = await getDoc(doc(db, "funcionarios", currentUserRGF));
                if (docSnap.exists()) {
                    nameInput.value = docSnap.data().nome;
                } else {
                    nameInput.value = ''; nameInput.placeholder = 'RGF n√£o encontrado';
                }
                // Ap√≥s encontrar funcion√°rio (ou n√£o), buscar seus pedidos
                await loadUserPedidos();
                validateForm(); // Valida o formul√°rio que pode depender dos pedidos carregados
            } catch (error) {
                console.error("Erro ao buscar funcion√°rio:", error);
                nameInput.value = ''; nameInput.placeholder = 'Erro na busca';
                showToast("Erro ao buscar funcion√°rio.", 'error');
                 pedidosDoUsuarioLogado = { atual: null, proxima: null };
                validateForm();
            }
        }

        async function loadUserPedidos() {
            if (!currentUserID || !currentUserRGF) {
                pedidosDoUsuarioLogado = { atual: null, proxima: null };
                return;
            }

            // Busca pedido para o card√°pio atual
            const qAtual = query(pedidosCollectionRef,
                                 orderBy("timestamp", "desc"),
                                 where("userId", "==", currentUserID),
                                 where("employeeRGF", "==", currentUserRGF),
                                 where("referenciaCardapio", "==", "atual")
                                 // limit(1) // Pega apenas o mais recente se houver m√∫ltiplos (embora n√£o devesse)
                                 );
            // Busca pedido para o card√°pio da pr√≥xima semana
            const qProxima = query(pedidosCollectionRef,
                                   orderBy("timestamp", "desc"),
                                   where("userId", "==", currentUserID),
                                   where("employeeRGF", "==", currentUserRGF),
                                   where("referenciaCardapio", "==", "proxima")
                                   // limit(1)
                                   );
            try {
                const [snapshotAtual, snapshotProxima] = await Promise.all([getDocs(qAtual), getDocs(qProxima)]);

                pedidosDoUsuarioLogado.atual = snapshotAtual.empty ? null : { id: snapshotAtual.docs[0].id, ...snapshotAtual.docs[0].data() };
                pedidosDoUsuarioLogado.proxima = snapshotProxima.empty ? null : { id: snapshotProxima.docs[0].id, ...snapshotProxima.docs[0].data() };

                // console.log("Pedidos do usu√°rio carregados:", pedidosDoUsuarioLogado);
                // Ap√≥s carregar os pedidos, a UI do card√°pio precisa ser atualizada para refletir as escolhas ou o estado bloqueado.
                // A fun√ß√£o createMenuHTML ser√° respons√°vel por isso.
                renderCurrentViewBasedOnState(); // Re-renderiza o menu com os pedidos carregados

            } catch (error) {
                console.error("Erro ao buscar pedidos do usu√°rio:", error);
                showToast("Erro ao buscar seus pedidos salvos.", "error");
                pedidosDoUsuarioLogado = { atual: null, proxima: null };
                renderCurrentViewBasedOnState(); // Tenta renderizar mesmo assim
            }
        }

        function createFallbackMenu() {
            const days = ['Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];
            return days.map(day => ({ day, isHoliday: false, isSpecial: false, pratoPrincipal: { name: 'Card√°pio n√£o definido', emoji: 'üöß' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } }));
        }

        // Ajustado para aceitar qual refer√™ncia de menu carregar e se est√° aberto
        function loadAndDisplayMenu(menuToLoadRef = menuDocRef, escolhasEstaoAbertas = false) {
            const menuContainer = document.getElementById('menu');
            menuContainer.innerHTML = '<div class="text-center text-gray-500">A carregar o card√°pio...</div>';

            onSnapshot(menuToLoadRef, (docSnap) => {
                const menuData = (docSnap.exists() && docSnap.data().menu?.length > 0) ? docSnap.data().menu : createFallbackMenu();

                if (menuToLoadRef.path === proximoMenuDocRef.path) { // Comparar path para robustez
                    proximoWeeklyMenu = menuData;
                } else {
                    weeklyMenu = menuData;
                }

                createMenuHTML(visualizandoCardapioProximaSemana ? proximoWeeklyMenu : weeklyMenu, escolhasEstaoAbertas);

                if (auth.currentUser && auth.currentUser.uid === APP_CONFIG.ADMIN_UID) {
                    renderOrdersTable(allOrders); // Admin v√™ pedidos do card√°pio atual
                }
            }, (error) => {
                 console.error("Erro ao carregar o card√°pio:", error, menuToLoadRef.path);
                 showToast("Erro ao carregar o card√°pio. Usando card√°pio padr√£o.", 'error');
                 const fallbackMenu = createFallbackMenu();
                 if (menuToLoadRef.path === proximoMenuDocRef.path) {
                    proximoWeeklyMenu = fallbackMenu;
                } else {
                    weeklyMenu = fallbackMenu;
                }
                 createMenuHTML(fallbackMenu, false);
                 if (auth.currentUser && auth.currentUser.uid === APP_CONFIG.ADMIN_UID) {
                    renderOrdersTable(allOrders);
                 }
            });
        }

        // Ajustado para desabilitar inputs e mostrar escolhas salvas
        function createMenuHTML(menuItemsToDisplay, escolhasEstaoAbertas) {
            const menuContainer = document.getElementById('menu');
            if (!menuContainer) return;
            menuContainer.innerHTML = '';
            const isAdmin = auth.currentUser && auth.currentUser.uid === APP_CONFIG.ADMIN_UID;
            const pedidoDoUsuarioParaEsteCardapio = visualizandoCardapioProximaSemana ? pedidosDoUsuarioLogado.proxima : pedidosDoUsuarioLogado.atual;

            if (!escolhasEstaoAbertas && !isAdmin && !pedidoDoUsuarioParaEsteCardapio) {
                const statusMsg = visualizandoCardapioProximaSemana ?
                    "As escolhas para o card√°pio da pr√≥xima semana est√£o encerradas e voc√™ n√£o possui um pedido salvo." :
                    "As escolhas para o card√°pio desta semana est√£o encerradas e voc√™ n√£o possui um pedido salvo.";
                menuContainer.innerHTML = `<div class="text-center p-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md">
                                               <p class="font-semibold">${statusMsg}</p>
                                               <p class="mt-2 text-sm">Consulte o administrador para mais informa√ß√µes.</p>
                                           </div>`;
                validateForm();
                return;
            }

            if (menuItemsToDisplay.length === 0 || menuItemsToDisplay.every(d => d.pratoPrincipal.name === 'Card√°pio n√£o definido')) {
                 menuContainer.innerHTML = `<div class="text-center p-6 bg-blue-100 border-l-4 border-blue-500 text-blue-700 rounded-md">
                                               <p class="font-semibold">O card√°pio ainda n√£o foi definido para este per√≠odo.</p>
                                               <p class="mt-2 text-sm">Por favor, volte mais tarde.</p>
                                           </div>`;
                validateForm();
                return;
            }


            menuItemsToDisplay.forEach(item => {
                const dayId = getDayId(item.day);
                let dayHTML = `<div class="day-section space-y-3 p-4 rounded-lg ${!escolhasEstaoAbertas && pedidoDoUsuarioParaEsteCardapio ? 'bg-slate-100' : ''}">`;

                let dayTitleHTML = `<h3 class="text-xl font-bold text-gray-800">${item.day}</h3>`;
                if (item.isSpecial) {
                    dayTitleHTML = `<div class="flex items-center gap-3">
                        <h3 class="text-xl font-bold text-gray-800">${item.day}</h3>
                        <span class="text-sm font-semibold text-purple-800 bg-purple-200 rounded-full px-3 py-1">‚ú® Almo√ßo Especial</span>
                    </div>`;
                }

                if (item.isHoliday) {
                    dayHTML += dayTitleHTML;
                    dayHTML += `<div class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 rounded-md"><p class="font-bold">üéä Feriado</p><p>N√£o haver√° refei√ß√£o neste dia.</p></div>`;
                } else {
                    const userChoiceForDay = pedidoDoUsuarioParaEsteCardapio ? pedidoDoUsuarioParaEsteCardapio[dayId] : null;
                    const userNotesForDay = pedidoDoUsuarioParaEsteCardapio ? pedidoDoUsuarioParaEsteCardapio[`${dayId}_notes`] || '' : '';
                    const canEditThisDay = escolhasEstaoAbertas || isAdmin;

                    dayHTML += dayTitleHTML;
                    if (item.guarnicao?.name) {
                        dayHTML += `<div class="text-sm font-semibold text-blue-600 bg-blue-100 rounded-full inline-block px-3 py-1 mb-3">Guarni√ß√£o: ${item.guarnicao.name} ${item.guarnicao.emoji || ''}</div>`;
                    }

                    if (!canEditThisDay && userChoiceForDay) { // Mostrar apenas a escolha feita, n√£o os inputs
                        dayHTML += `<div class="p-4 border-2 border-green-300 bg-green-50 rounded-lg">
                                        <p class="font-semibold text-gray-800">Sua escolha: <span class="text-green-700 font-bold">${userChoiceForDay}</span></p>
                                        ${userNotesForDay ? `<p class="text-sm text-gray-600 mt-1">Anota√ß√µes: <span class="italic">${userNotesForDay}</span></p>` : ''}
                                    </div>`;
                    } else if (!canEditThisDay && !userChoiceForDay) { // Escolhas fechadas e sem pedido salvo para este dia
                         dayHTML += `<div class="p-4 border-2 border-gray-300 bg-gray-50 rounded-lg">
                                        <p class="font-semibold text-gray-600">Escolha n√£o realizada ou per√≠odo encerrado.</p>
                                    </div>`;
                    } else { // Escolhas abertas ou admin vendo
                        const allOptions = [
                            { ...item.pratoPrincipal, type: 'Prato Principal' },
                            ...(item.opcao?.name ? [{ ...item.opcao, type: 'Op√ß√£o do Dia' }] : []),
                            ...fixedOptions.map(fixa => ({ ...fixa, type: 'Op√ß√£o Fixa' })),
                        ];
                        dayHTML += `<div class="space-y-3">`;
                        allOptions.forEach((option) => {
                            if (option.name) {
                                const isChecked = userChoiceForDay === option.name;
                                dayHTML += `<label class="menu-option-card block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-transform duration-200">
                                    <input type="radio" name="${dayId}" value="${option.name}" class="hidden" ${isChecked ? 'checked' : ''}>
                                    <div class="flex items-center">
                                        <span class="text-3xl mr-4">${option.emoji || 'üçΩÔ∏è'}</span>
                                        <div class="flex-grow">
                                            <p class="font-semibold text-gray-800">${option.name}</p>
                                            <p class="text-sm text-gray-500">${option.type}</p>
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="checkmark h-6 w-6 text-blue-600 opacity-0 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" /></svg>
                                    </div>
                                </label>`;
                            }
                        });
                        dayHTML += `</div>`;
                        dayHTML += `<div class="mt-3">
                            <textarea id="notes-${dayId}" name="notes-${dayId}" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Anota√ß√µes? Ex: sem cebola, ponto da carne, etc.">${userNotesForDay}</textarea>
                        </div>`;
                    }
                }
                dayHTML += `</div>`;
                menuContainer.innerHTML += dayHTML;
            });
            validateForm();
        }


        function validateForm() {
            const name = document.getElementById('employeeName')?.value.trim();
            const rgf = document.getElementById('employeeRGF')?.value.trim();
            const guidanceSection = document.getElementById('guidanceSection');
            const guidanceText = document.getElementById('guidanceText');
            const submitBtnContainer = document.getElementById('submitButtonContainer');
            if (!guidanceSection || !submitBtnContainer) return;

            const menuItemsParaValidar = visualizandoCardapioProximaSemana ? proximoWeeklyMenu : weeklyMenu;
             // Se n√£o h√° itens no menu (ex: fallback ou n√£o carregado), n√£o h√° o que validar.
            if (!menuItemsParaValidar || menuItemsParaValidar.length === 0 || menuItemsParaValidar.every(d => d.pratoPrincipal.name === 'Card√°pio n√£o definido')) {
                submitBtnContainer.classList.add('hidden');
                guidanceSection.classList.remove('hidden');
                guidanceText.textContent = 'Card√°pio ainda n√£o dispon√≠vel ou n√£o carregado.';
                return;
            }

            const nonHolidayItems = menuItemsParaValidar.filter(item => !item.isHoliday);
            const hasAllSelections = nonHolidayItems.length > 0 && nonHolidayItems.every(item => {
                const dayId = getDayId(item.day);
                return document.querySelector(`input[name="${dayId}"]:checked`);
            });

            const escolhasAtualmenteAbertas = visualizandoCardapioProximaSemana ?
                                              (estadoCardapio.cardapioProximoAbertoParaEscolha || false) :
                                              (estadoCardapio.cardapioAtualAbertoParaEscolha || false);

            const isAdmin = auth.currentUser && auth.currentUser.uid === APP_CONFIG.ADMIN_UID;
            const pedidoExistente = visualizandoCardapioProximaSemana ? pedidosDoUsuarioLogado.proxima : pedidosDoUsuarioLogado.atual;

            // L√≥gica para mostrar o bot√£o de submiss√£o
            // Usu√°rio normal: precisa de nome, RGF, todas as sele√ß√µes E escolhas abertas.
            // Admin: pode ver o bot√£o para testar, mesmo que fechado para usu√°rios.
            if (name && rgf && hasAllSelections && (escolhasAtualmenteAbertas || isAdmin)) {
                guidanceSection.classList.add('hidden');
                submitBtnContainer.classList.remove('hidden');
                document.getElementById('openConfirmationModal').textContent = pedidoExistente ? 'Revisar e Atualizar Pedido' : 'Revisar e Finalizar Pedido';

                if (!escolhasAtualmenteAbertas && isAdmin) {
                     guidanceText.innerHTML = '<strong>Modo Admin:</strong> Escolhas fechadas para usu√°rios. Voc√™ pode submeter/atualizar para teste.';
                     guidanceSection.classList.remove('hidden');
                     guidanceSection.className = 'bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-6'; // Reset classes
                }
            } else {
                submitBtnContainer.classList.add('hidden');
                guidanceSection.classList.remove('hidden');
                guidanceSection.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6'; // Reset classes

                let message = '';
                if (!currentUserID && !(auth.currentUser && auth.currentUser.isAnonymous)) message = 'A autenticar... Por favor, aguarde. ';
                else if (!rgf) message = 'Digite seu RGF para come√ßar. ';
                else if (!name) message = 'RGF n√£o encontrado. Pe√ßa para um administrador cadastr√°-lo. ';
                else if (!escolhasAtualmenteAbertas && !isAdmin) {
                    if (pedidoExistente) {
                        message = visualizandoCardapioProximaSemana ?
                                  'As escolhas para o <strong>card√°pio da pr√≥xima semana</strong> est√£o encerradas. Seu pedido j√° foi registrado.' :
                                  'As escolhas para o <strong>card√°pio desta semana</strong> est√£o encerradas. Seu pedido j√° foi registrado.';
                        guidanceSection.className = 'bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-md mb-6';
                    } else {
                        message = visualizandoCardapioProximaSemana ?
                                  'As escolhas para o <strong>card√°pio da pr√≥xima semana</strong> est√£o encerradas.' :
                                  'As escolhas para o <strong>card√°pio desta semana</strong> est√£o encerradas.';
                    }
                } else if (!hasAllSelections) {
                    const missingDays = nonHolidayItems
                        .filter(item => !document.querySelector(`input[name="${getDayId(item.day)}"]:checked`))
                        .map(item => item.day);
                    if (missingDays.length > 0) message += `Falta selecionar op√ß√µes para: ${missingDays.join(', ')}.`;
                }
                guidanceText.innerHTML = message || 'Por favor, preencha todos os campos e verifique se as escolhas est√£o abertas.';
            }
        }


        function openConfirmationModal() {
            if (!currentUserID) {
                showToast("Voc√™ precisa estar autenticado para enviar um pedido. Aguarde ou recarregue.", 'error');
                return;
            }

            const escolhasAtualmenteAbertas = visualizandoCardapioProximaSemana ?
                                              (estadoCardapio.cardapioProximoAbertoParaEscolha || false) :
                                              (estadoCardapio.cardapioAtualAbertoParaEscolha || false);
            const isAdmin = auth.currentUser && auth.currentUser.uid === APP_CONFIG.ADMIN_UID;

            if (!escolhasAtualmenteAbertas && !isAdmin) {
                showToast("As escolhas est√£o encerradas no momento.", 'error');
                return;
            }

            const menuAtualOuProximo = visualizandoCardapioProximaSemana ? proximoWeeklyMenu : weeklyMenu;

            tempOrderData = {
                employeeName: document.getElementById('employeeName').value.trim(),
                employeeRGF: document.getElementById('employeeRGF').value.trim(),
                timestamp: serverTimestamp(),
                userId: currentUserID,
                referenciaCardapio: visualizandoCardapioProximaSemana ? "proxima" : "atual"
            };
            const summaryContainer = document.getElementById('confirmation-summary');
            summaryContainer.innerHTML = '';

            menuAtualOuProximo.forEach(item => {
                const dayId = getDayId(item.day);
                if (!item.isHoliday) {
                    const choiceInput = document.querySelector(`input[name="${dayId}"]:checked`);
                    if (!choiceInput) return; // Deveria ser prevenido por validateForm
                    const choice = choiceInput.value;
                    const notes = document.getElementById(`notes-${dayId}`).value.trim();

                    tempOrderData[dayId] = choice;
                    if(notes) {
                        tempOrderData[`${dayId}_notes`] = notes;
                    }
                    summaryContainer.innerHTML += `<p><span class="font-bold">${item.day}:</span> ${choice} ${notes ? `<span class="text-sm text-gray-500 italic">(${notes})</span>` : ''}</p>`;
                }
            });
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        async function submitOrder() {
            const button = document.getElementById('submitOrder');
            button.disabled = true; button.textContent = 'A enviar...';

            if (!currentUserID) {
                showToast("Autentica√ß√£o perdida. Recarregue a p√°gina.", 'error');
                button.disabled = false; button.textContent = 'Confirmar e Enviar';
                return;
            }
            tempOrderData.userId = currentUserID; // Garantir que est√° aqui
            tempOrderData.referenciaCardapio = visualizandoCardapioProximaSemana ? "proxima" : "atual"; // Garantir

            const escolhasAtualmenteAbertas = visualizandoCardapioProximaSemana ?
                                             (estadoCardapio.cardapioProximoAbertoParaEscolha || false) :
                                             (estadoCardapio.cardapioAtualAbertoParaEscolha || false);
            const isAdmin = auth.currentUser && auth.currentUser.uid === APP_CONFIG.ADMIN_UID;

            if (!escolhasAtualmenteAbertas && !isAdmin) {
                showToast("As escolhas foram encerradas enquanto voc√™ revisava o pedido.", 'error');
                document.getElementById('confirmation-modal').classList.add('hidden');
                button.disabled = false; button.textContent = 'Confirmar e Enviar';
                validateForm();
                return;
            }

            try {
                const pedidoExistente = visualizandoCardapioProximaSemana ? pedidosDoUsuarioLogado.proxima : pedidosDoUsuarioLogado.atual;

                if (pedidoExistente && pedidoExistente.id) { // Se existe um pedido, atualiza
                    const pedidoRef = doc(db, "pedidosDaSemana", pedidoExistente.id);
                    await updateDoc(pedidoRef, tempOrderData);
                    showToast("Pedido atualizado com sucesso!", 'success');
                } else { // Sen√£o, cria um novo
                    await addDoc(pedidosCollectionRef, tempOrderData);
                    showToast("Pedido enviado com sucesso!", 'success');
                }

                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-text').textContent = `Obrigado, ${tempOrderData.employeeName}. O seu pedido (${tempOrderData.referenciaCardapio}) foi ${pedidoExistente ? 'atualizado' : 'registado'} com sucesso.`;
                document.getElementById('success-message').classList.remove('hidden');

                // Recarregar os pedidos do usu√°rio para refletir a mudan√ßa
                await loadUserPedidos();
                // A UI do card√°pio ser√° atualizada por createMenuHTML chamado por loadUserPedidos -> renderCurrentViewBasedOnState

            } catch (error) {
                console.error("Erro ao enviar/atualizar pedido: ", error);
                if (error.code === 'permission-denied') {
                    showToast("Erro de permiss√£o. Verifique se as escolhas ainda est√£o abertas ou se voc√™ tem permiss√£o para editar.", 'error');
                } else {
                    showToast("Ocorreu um erro ao processar o seu pedido.", 'error');
                }
            } finally {
                button.disabled = false; button.textContent = 'Confirmar e Enviar';
            }
        }

        function loadAdminData() {
            // Focar em pedidos do card√°pio ATUAL para a tabela principal do admin
            const q = query(pedidosCollectionRef, where("referenciaCardapio", "==", "atual"), orderBy("employeeName"));
            onSnapshot(q, (snapshot) => {
                // A l√≥gica de `latestOrdersMap` precisa ser ajustada se quisermos mostrar o √∫ltimo pedido
                // independentemente de ser 'atual' ou 'proximo' em algum lugar, ou se a tabela √© estritamente 'atual'.
                // Por agora, a query j√° filtra por 'atual'.
                allOrders = snapshot.docs; // Simplificado, pois j√° filtramos e ordenamos na query.
                                        // Se a regra de "√∫ltimo pedido por RGF" for importante aqui, precisar√° de p√≥s-processamento.

                renderOrdersTable(allOrders); // Passa os pedidos filtrados (apenas 'atual')
                renderOrderStatus(allOrders); // O status tamb√©m ser√° baseado nos pedidos para o card√°pio 'atual'
            }, (error) => {
                console.error("Erro ao carregar dados do administrador (pedidos atuais):", error);
                showToast("Erro ao carregar pedidos atuais do administrador.", 'error');
            });
        }

        async function renderOrderStatus(orders) { // orders aqui s√£o os pedidos para o card√°pio atual
            const container = document.getElementById('order-status-container');
            container.innerHTML = '<p class="text-gray-500">A processar...</p>';

            try {
                const employeeSnapshot = await getDocs(query(funcionariosCollectionRef, orderBy("nome")));
                const allEmployees = employeeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Considera apenas pedidos para o card√°pio atual para o status
                const orderedRGFs = new Set(orders.map(orderDoc => orderDoc.data().employeeRGF));

                const haveOrdered = allEmployees.filter(emp => orderedRGFs.has(emp.id));
                const haveNotOrdered = allEmployees.filter(emp => !orderedRGFs.has(emp.id));

                let html = `
                    <div>
                        <h3 class="font-semibold text-lg text-green-600 mb-2">‚úÖ J√° Pediram (Semana Atual) (${haveOrdered.length})</h3>
                        <ul class="space-y-1 text-sm">${haveOrdered.map(e => `<li class="p-2 bg-green-50 rounded-md">${e.nome}</li>`).join('') || '<li class="text-gray-500">Ningu√©m fez pedido ainda para esta semana.</li>'}</ul>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg text-red-600 mb-2">‚ùå Ainda N√£o Pediram (Semana Atual) (${haveNotOrdered.length})</h3>
                        <ul class="space-y-1 text-sm">${haveNotOrdered.map(e => `<li class="p-2 bg-red-50 rounded-md">${e.nome}</li>`).join('') || '<li class="text-gray-500">Todos os funcion√°rios fizeram pedido para esta semana!</li>'}</ul>
                    </div>
                `;
                container.innerHTML = html;

            } catch (error) {
                console.error("Erro ao renderizar status de pedidos:", error);
                container.innerHTML = '<p class="text-red-500">Falha ao carregar status dos funcion√°rios.</p>';
            }
        }

        function renderOrdersTable(ordersToRender) { // ordersToRender s√£o os pedidos do card√°pio atual
            const container = document.getElementById('ordersTableContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredOrders = ordersToRender.filter(doc => doc.data().employeeName.toLowerCase().includes(searchTerm));

            // O card√°pio usado para as colunas da tabela deve ser o 'weeklyMenu' (card√°pio atual)
            if (!weeklyMenu || weeklyMenu.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">Aguardando card√°pio atual...</p>'; return; }
            if (filteredOrders.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum pedido encontrado para o card√°pio atual.</p>'; return; }

            let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">Funcion√°rio</th><th class="py-2 px-3 border-b text-left">RGF</th>`;
            weeklyMenu.forEach(item => tableHTML += `<th class="py-2 px-3 border-b text-left">${item.day.substring(0,3)}</th>`);
            tableHTML += `<th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;

            filteredOrders.forEach(doc => {
                const order = doc.data();
                // Garante que estamos processando um pedido referente ao card√°pio 'atual'
                if (order.referenciaCardapio !== "atual") return;

                tableHTML += `<tr><td class="py-2 px-3 border-b font-bold">${order.employeeName}</td><td class="py-2 px-3 border-b">${order.employeeRGF || 'N/A'}</td>`;
                weeklyMenu.forEach(dayMenuItem => { // Usar weeklyMenu (atual) para as colunas
                    const dayId = getDayId(dayMenuItem.day);
                    let cellContent = '';

                    if (dayMenuItem.isHoliday) {
                        cellContent = '<span class="text-xs text-indigo-600">Feriado</span>';
                    } else {
                        let choice = order[dayId] || 'N/A';
                        const notes = order[`${dayId}_notes`];
                        const mainDishName = dayMenuItem.pratoPrincipal.name;
                        const optionDishName = dayMenuItem.opcao?.name;

                        let reportChoice = choice;
                        if (choice === mainDishName) {
                            reportChoice = 'Prato';
                        } else if (optionDishName && choice === optionDishName) {
                            reportChoice = 'Op√ß√£o';
                        }

                        cellContent = reportChoice;
                        if (notes) {
                            cellContent += ` <span title="${notes}" class="cursor-help text-blue-500 font-bold">*</span>`;
                        }
                    }
                    tableHTML += `<td class="py-2 px-3 border-b">${cellContent}</td>`;
                });
                tableHTML += `<td class="py-2 px-3 border-b space-x-2"><button data-id="${doc.id}" class="edit-order-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button><button data-id="${doc.id}" data-name="${order.employeeName}" class="delete-order-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button></td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function generateAndPrintReport() {
            const reportContainer = document.getElementById('print-report');
            // Usar 'allOrders' que s√£o os pedidos do card√°pio atual, e 'weeklyMenu'
            if (allOrders.length === 0 || weeklyMenu.length === 0) {
                showToast("N√£o h√° pedidos (do card√°pio atual) ou card√°pio atual para gerar o relat√≥rio.", "info");
                return;
            }
            reportContainer.innerHTML = '<h1>Regional Quatinga - Card√°pio Atual</h1>';

            let allDaysHTML = '';
            weeklyMenu.forEach(dayMenuItem => { // Baseado no weeklyMenu (atual)
                if (dayMenuItem.isHoliday) return;

                const dayId = getDayId(dayMenuItem.day);
                let tableHTML = `<div class="report-day-section"><table class="report-table"><thead><tr><th class="rgf-col">RGF</th><th class="nome-col">NOME</th><th class="pedido-col">${dayMenuItem.day}</th></tr></thead><tbody>`;

                const dailyOrders = allOrders // allOrders j√° s√£o filtrados para 'atual'
                    .filter(orderDoc => orderDoc.data()[dayId])
                    .sort((a,b) => a.data().employeeName.localeCompare(b.data().employeeName));

                dailyOrders.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const choice = order[dayId];
                    const notes = order[`${dayId}_notes`];

                    const mainDishName = dayMenuItem.pratoPrincipal.name;
                    const optionDishName = dayMenuItem.opcao?.name;
                    let reportChoice = '';

                    if (choice === mainDishName) { reportChoice = 'PRATO'; }
                    else if (optionDishName && choice === optionDishName) { reportChoice = 'OP√á√ÉO'; }
                    else { reportChoice = choice.toUpperCase(); }

                    let choiceHTML = reportChoice;
                    if (notes) { choiceHTML += ` <span style="font-style: italic; font-weight: normal;">(${notes})</span>`; }

                    tableHTML += `<tr><td>${order.employeeRGF || 'N/A'}</td><td>${order.employeeName}</td><td>${choiceHTML}</td></tr>`;
                });
                tableHTML += '</tbody></table></div>';
                allDaysHTML += tableHTML;
            });
            reportContainer.innerHTML += allDaysHTML;
            window.print();
        }

        async function openOrderEditModal(docId) {
            const modal = document.getElementById('edit-order-modal');
            const formContent = document.getElementById('edit-menu-options');
            const employeeNameInput = document.getElementById('edit-order-employeeName');
            const orderIdInput = document.getElementById('edit-order-id');

            formContent.innerHTML = '<p class="text-center text-gray-500">A carregar...</p>';
            modal.classList.remove('hidden');

            try {
                const docSnap = await getDoc(doc(db, "pedidosDaSemana", docId));
                if (!docSnap.exists()) { showToast("Erro: Pedido n√£o encontrado.", 'error'); modal.classList.add('hidden'); return; }

                const orderData = docSnap.data();
                employeeNameInput.value = orderData.employeeName;
                orderIdInput.value = docId;
                formContent.innerHTML = '';

                // Determinar qual card√°pio usar para o modal de edi√ß√£o
                const menuParaEdicao = orderData.referenciaCardapio === "proxima" ? proximoWeeklyMenu : weeklyMenu;
                if (!menuParaEdicao || menuParaEdicao.length === 0) {
                    showToast("Card√°pio correspondente ao pedido n√£o carregado.", "error");
                    modal.classList.add('hidden');
                    return;
                }


                menuParaEdicao.forEach(item => {
                    const dayId = getDayId(item.day);
                    let dayHTML = `<fieldset class="day-section border p-4 rounded-lg"><legend class="font-bold text-lg text-gray-800 px-2">${item.day}</legend>`;

                    if(item.isHoliday) {
                        dayHTML += `<div class="bg-indigo-100 text-indigo-700 p-3 rounded-md text-center">Feriado</div>`;
                    } else {
                        const currentChoice = orderData[dayId];
                        const currentNotes = orderData[`${dayId}_notes`] || '';
                        const allOptions = [ { ...item.pratoPrincipal }, ...(item.opcao?.name ? [{ ...item.opcao }] : []), ...fixedOptions ];

                        dayHTML += `<div class="space-y-2 mt-2">`;
                        allOptions.forEach((option, index) => {
                            if (option.name) {
                                const uniqueId = `edit-${dayId}-${index}`;
                                const isChecked = (option.name === currentChoice) ? 'checked' : '';
                                dayHTML += `<div class="flex items-center"><input type="radio" id="${uniqueId}" name="edit-${dayId}" value="${option.name}" class="h-4 w-4 text-blue-600 border-gray-300" ${isChecked} required><label for="${uniqueId}" class="ml-3 block text-sm font-medium text-gray-700">${option.emoji || ''} ${option.name}</label></div>`;
                            }
                        });
                        dayHTML += `</div>`;

                        dayHTML += `<div class="mt-4">
                            <label for="edit-notes-${dayId}" class="block text-sm font-medium text-gray-700">Anota√ß√µes</label>
                            <textarea id="edit-notes-${dayId}" name="edit-notes-${dayId}" rows="2" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">${currentNotes}</textarea>
                        </div>`;
                    }

                    dayHTML += `</fieldset>`;
                    formContent.innerHTML += dayHTML;
                });
            } catch (error) {
                console.error("Erro ao abrir modal de edi√ß√£o:", error);
                showToast("N√£o foi poss√≠vel carregar os dados do pedido.", 'error');
                modal.classList.add('hidden');
            }
        }

        async function saveOrderChanges(event) { // Admin editando um pedido
            event.preventDefault();
            const button = event.target.querySelector('button[type="submit"]');
            button.disabled = true; button.textContent = 'A salvar...';
            const docId = document.getElementById('edit-order-id').value;

            const orderDocSnap = await getDoc(doc(db, "pedidosDaSemana", docId));
            if(!orderDocSnap.exists()) {
                 showToast("Pedido original n√£o encontrado para edi√ß√£o.", 'error');
                 button.disabled = false; button.textContent = 'Salvar Altera√ß√µes';
                 return;
            }
            const orderDataOriginal = orderDocSnap.data();
            const menuParaEdicao = orderDataOriginal.referenciaCardapio === "proxima" ? proximoWeeklyMenu : weeklyMenu;

            const updateData = {
                // Manter os campos originais que n√£o s√£o de dias espec√≠ficos, como RGF, Nome, userId, referenciaCardapio, timestamp
                employeeName: orderDataOriginal.employeeName,
                employeeRGF: orderDataOriginal.employeeRGF,
                userId: orderDataOriginal.userId,
                referenciaCardapio: orderDataOriginal.referenciaCardapio,
                timestamp: orderDataOriginal.timestamp, // Manter timestamp original ou atualizar? Por ora, manter.
                                                        // Se atualizar, usar serverTimestamp()
            };

            menuParaEdicao.forEach(item => {
                if (!item.isHoliday) {
                    const dayId = getDayId(item.day);
                    const selectedOption = document.querySelector(`#edit-order-form input[name="edit-${dayId}"]:checked`);
                    if (selectedOption) {
                        updateData[dayId] = selectedOption.value;
                    } else { // Se nada estiver selecionado para um dia, remover a escolha (ou manter a original?)
                        // Para garantir que n√£o salve undefined, podemos remover o campo ou deixar como estava.
                        // Se a inten√ß√£o √© limpar a escolha, precisamos lidar com isso.
                        // Por ora, se n√£o houver sele√ß√£o, a escolha anterior (se houver) ser√° mantida implicitamente
                        // a menos que a regra seja limpar. Vamos assumir que uma escolha √© obrigat√≥ria se n√£o feriado.
                        // Se um campo de dia n√£o estiver em updateData, ele n√£o ser√° alterado no Firestore.
                        // Se quisermos permitir limpar uma escolha, devemos explicitamente setar para null ou string vazia.
                        // Para este caso, a regra de 'required' no input deve garantir uma sele√ß√£o.
                    }
                    const notes = document.getElementById(`edit-notes-${dayId}`).value.trim();
                    updateData[`${dayId}_notes`] = notes; // Salva mesmo que vazia para limpar notas anteriores
                }
            });

            try {
                await updateDoc(doc(db, "pedidosDaSemana", docId), updateData);
                showToast("Pedido atualizado com sucesso pelo admin!", 'success');
                document.getElementById('edit-order-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar altera√ß√µes do pedido (admin):", error);
                showToast("Falha ao salvar as altera√ß√µes do pedido.", 'error');
            } finally {
                button.disabled = false; button.textContent = 'Salvar Altera√ß√µes';
            }
        }

        function deleteOrder(docId, name) {
            const message = `Tem a certeza que deseja excluir o pedido de ${name}? Esta a√ß√£o n√£o pode ser desfeita.`;
            showCustomConfirm(message, async () => {
                try {
                    await deleteDoc(doc(db, "pedidosDaSemana", docId));
                    showToast("Pedido exclu√≠do com sucesso.", 'success');
                } catch (error) {
                    console.error("Erro ao excluir pedido: ", error);
                    showToast("Falha ao excluir o pedido.", 'error');
                }
            });
        }

        const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); });

        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('image-processor-container').classList.remove('hidden');
                document.getElementById('whatsapp-notification-container').classList.add('hidden');
            }
            reader.readAsDataURL(file);
        });

        document.getElementById('processImageBtn').addEventListener('click', async () => {
            if (typeof imageCompression === 'undefined') {
                showToast('Erro: Biblioteca de compress√£o n√£o carregou.', 'error');
                return;
            }

            const loader = document.getElementById('loader'); const button = document.getElementById('processImageBtn'); const confirmationForm = document.getElementById('confirmation-form');
            button.disabled = true; button.textContent = 'A analisar...'; loader.classList.remove('hidden'); confirmationForm.classList.add('hidden');
            const file = document.getElementById('imageUpload').files[0];
            const options = { maxSizeMB: 1.5, maxWidthOrHeight: 1500, useWebWorker: true };
            try {
                const compressedFile = await imageCompression(file, options);
                const base64ImageData = await toBase64(compressedFile);

                const prompt = `Analise a imagem deste card√°pio semanal. Extraia as informa√ß√µes para cada dia (Segunda a Sexta). Para cada dia, identifique o 'Prato Principal', a 'Op√ß√£o' e a 'Guarni√ß√£o'. Se o dia for um feriado, marque-o. Al√©m disso, determine se o almo√ßo √© 'especial' (ex: uma refei√ß√£o comemorativa, tem√°tica ou de maior qualidade) e defina o campo booleano 'isSpecial'. Retorne um objeto JSON seguindo esta estrutura: {"menu": [{"day": "Segunda-feira", "isHoliday": false, "isSpecial": false, "pratoPrincipal": {"name": "Nome", "emoji": "üçõ"}, "opcao": {"name": "Nome", "emoji": "üç≤"}, "guarnicao": {"name": "Nome", "emoji": "ü•ó"}}, ...]}. Se um campo n√£o existir, retorne o nome como string vazia. Atribua emojis apropriados. O JSON deve ser a √∫nica coisa na resposta.`;

                const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: compressedFile.type, data: base64ImageData } }] }] };
                const apiKey = firebaseConfig.apiKey; // Usar a chave de API do Firebase config
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errText = await response.text(); throw new Error(`API Error (${response.status}): ${errText}`); }
                const result = await response.json();

                let textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResponse) { throw new Error("Resposta da IA vazia ou mal formatada."); }

                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                const menuDataFromAI = JSON.parse(textResponse); // Renomeada para evitar conflito

                if (!menuDataFromAI || !Array.isArray(menuDataFromAI.menu)) { throw new Error("Estrutura do JSON da IA inv√°ƒ∫ida."); }

                displayConfirmationForm(menuDataFromAI.menu); // Passa menuDataFromAI.menu

            } catch (error) {
                console.error("Erro ao processar IA:", error); showToast("Erro ao ler imagem com IA: " + error.message, 'error', 8000);
            } finally {
                button.disabled = false; button.textContent = 'Analisar Card√°pio'; loader.classList.add('hidden');
            }
        });

        function displayConfirmationForm(menuDataToConfirm) { // Renomeada para evitar conflito
            const container = document.getElementById('confirmation-form');
            container.innerHTML = '<h3 class="text-xl font-semibold mb-4">Confirme os Dados Extra√≠dos (para Pr√≥xima Semana)</h3>';

            menuDataToConfirm.forEach((item, index) => {
                container.innerHTML += `<div class="p-4 bg-gray-50 rounded-lg mb-4">
                    <h4 class="font-bold">${item.day}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
                        <div><label class="block text-sm font-medium">Prato Principal</label><input type="text" id="prato-${index}" value="${item.pratoPrincipal.name || ''}" class="w-full border rounded p-1"></div>
                        <div><label class="block text-sm font-medium">Op√ß√£o</label><input type="text" id="opcao-${index}" value="${item.opcao.name || ''}" class="w-full border rounded p-1"></div>
                        <div><label class="block text-sm font-medium">Guarni√ß√£o</label><input type="text" id="guarnicao-${index}" value="${item.guarnicao.name || ''}" class="w-full border rounded p-1"></div>
                    </div>
                    <div class="mt-3 flex items-center space-x-6">
                        <label class="flex items-center"><input type="checkbox" id="holiday-${index}" ${item.isHoliday ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600"> <span class="ml-2 text-sm text-gray-900">Marcar como Feriado</span></label>
                        <label class="flex items-center"><input type="checkbox" id="special-${index}" ${item.isSpecial ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-purple-600"> <span class="ml-2 text-sm text-gray-900">‚ú® Almo√ßo Especial</span></label>
                    </div>
                    </div>`;
            });
            container.innerHTML += `<div class="text-center mt-4"><button id="saveNewMenuBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Salvar Card√°pio da Pr√≥xima Semana</button><button type="button" id="cancelNewMenuBtn" class="w-full mt-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button></div>`;
            container.classList.remove('hidden');

            document.getElementById('saveNewMenuBtn').addEventListener('click', () => {
                // Salva em /cardapio/proximaSemana, n√£o mexe nos pedidos ainda.
                const message = "Tem certeza que deseja salvar este card√°pio para a PR√ìXIMA SEMANA? Os pedidos atuais N√ÉO ser√£o afetados agora.";
                showCustomConfirm(message, () => {
                    saveNextWeekMenu(menuDataToConfirm); // Passa menuDataToConfirm
                }, "Confirmar Card√°pio da Pr√≥xima Semana");
            });

            document.getElementById('cancelNewMenuBtn').addEventListener('click', () => {
                container.classList.add('hidden'); document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('image-processor-container').classList.add('hidden'); document.getElementById('imageUpload').value = '';
                showToast("Atualiza√ß√£o do card√°pio da pr√≥xima semana cancelada.", 'info');
            });
        }

        async function clearAllOrders() { // Usado ao publicar novo card√°pio semanal
            console.log("Iniciando a limpeza de todos os pedidos da semana (refer√™ncia: atual)...");
            const q = query(pedidosCollectionRef, where("referenciaCardapio", "==", "atual"));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                console.log("Nenhum pedido 'atual' para excluir.");
                return 0;
            }

            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            console.log(`${querySnapshot.size} pedidos 'atuais' foram exclu√≠dos com sucesso.`);
            return querySnapshot.size;
        }

        // Salva o menu extra√≠do pela IA em /cardapio/proximaSemana
        async function saveNextWeekMenu(menuDataFromForm) { // Renomeada e recebe o menu do formul√°rio de confirma√ß√£o
            const button = document.getElementById('saveNewMenuBtn');
            const cancelButton = document.getElementById('cancelNewMenuBtn');
            button.disabled = true; cancelButton.disabled = true;
            button.textContent = 'A salvar para pr√≥xima semana...';

            const newMenuForNextWeek = menuDataFromForm.map((item, i) => ({
                day: item.day,
                pratoPrincipal: { name: document.getElementById(`prato-${i}`).value.trim(), emoji: 'üçõ' },
                opcao: { name: document.getElementById(`opcao-${i}`).value.trim(), emoji: 'üç≤' },
                guarnicao: { name: document.getElementById(`guarnicao-${i}`).value.trim(), emoji: 'ü•ó' },
                isHoliday: document.getElementById(`holiday-${i}`).checked,
                isSpecial: document.getElementById(`special-${i}`).checked,
            }));

            try {
                await setDoc(proximoMenuDocRef, { menu: newMenuForNextWeek });
                showToast('Card√°pio da pr√≥xima semana salvo com sucesso!', 'success');
                document.getElementById('confirmation-form').classList.add('hidden');
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('image-processor-container').classList.add('hidden');
                document.getElementById('imageUpload').value = '';
                // N√£o mostrar notifica√ß√£o do WhatsApp ainda, s√≥ quando for publicado como atual.
                // document.getElementById('whatsapp-notification-container').classList.remove('hidden');
            } catch (error) {
                console.error("Erro ao salvar o card√°pio da pr√≥xima semana:", error);
                showToast("Erro ao salvar o card√°pio da pr√≥xima semana.", 'error');
            } finally {
                button.disabled = false; cancelButton.disabled = false;
                button.textContent = 'Salvar Card√°pio da Pr√≥xima Semana';
            }
        }

        // Nova fun√ß√£o para o Admin: Publicar o card√°pio da pr√≥xima semana como o atual
        async function publishNextWeekMenuAsCurrent() {
            const button = document.getElementById('publishNextWeekMenuBtn');
            button.disabled = true; button.textContent = 'A publicar...';

            try {
                const proximoMenuSnap = await getDoc(proximoMenuDocRef);
                if (!proximoMenuSnap.exists() || !proximoMenuSnap.data().menu || proximoMenuSnap.data().menu.length === 0) {
                    showToast("Nenhum card√°pio da pr√≥xima semana para publicar. Defina um primeiro.", "error");
                    button.disabled = false; button.textContent = 'Publicar Card√°pio da Pr√≥xima Semana COMO ATUAL';
                    return;
                }

                const newCurrentMenu = proximoMenuSnap.data().menu;

                // 1. Limpar pedidos da semana atual (referenciaCardapio == "atual")
                const numDeleted = await clearAllOrders();
                showToast(`${numDeleted} pedidos da semana anterior (atual) foram zerados.`, 'info');

                // 2. Migrar pedidos da PR√ìXIMA SEMANA para ATUAL
                const qProximaPedidos = query(pedidosCollectionRef, where("referenciaCardapio", "==", "proxima"));
                const proximaPedidosSnap = await getDocs(qProximaPedidos);
                const batch = writeBatch(db);
                let migradosCount = 0;
                proximaPedidosSnap.forEach(pedidoDoc => {
                    batch.update(doc(db, "pedidosDaSemana", pedidoDoc.id), { referenciaCardapio: "atual" });
                    migradosCount++;
                });
                await batch.commit();
                if (migradosCount > 0) {
                    showToast(`${migradosCount} pedidos da pr√≥xima semana foram migrados para a semana atual.`, 'info');
                }

                // 3. Copiar /cardapio/proximaSemana para /cardapio/semanal
                await setDoc(menuDocRef, { menu: newCurrentMenu });
                showToast('Card√°pio da pr√≥xima semana publicado como atual!', 'success');

                // 4. Limpar /cardapio/proximaSemana ap√≥s publica√ß√£o
                await setDoc(proximoMenuDocRef, { menu: createFallbackMenu() });
                showToast('Card√°pio da pr√≥xima semana foi limpo.', 'info');

                // 5. Atualizar estado
                await updateDoc(estadoCardapioDocRef, {
                    cardapioAtualAbertoParaEscolha: true,
                    cardapioProximoAbertoParaEscolha: false,
                    // dataPublicacaoProximoCardapio: serverTimestamp() // Opcional
                });
                showToast('Estado do card√°pio atualizado: Atual aberto, Pr√≥ximo fechado.', 'info');

                const wnC = document.getElementById('whatsapp-notification-container');
                if(wnC) wnC.classList.remove('hidden');

            } catch (error) {
                console.error("Erro ao publicar card√°pio da pr√≥xima semana:", error);
                showToast("Erro ao publicar o novo card√°pio semanal.", 'error');
            } finally {
                button.disabled = false; button.textContent = 'Publicar Card√°pio da Pr√≥xima Semana COMO ATUAL';
            }
        }

        function handleWhatsAppNotification() {
            const message = `O card√°pio da semana foi atualizado! ‚ú® Confira as del√≠cias e fa√ßa seu pedido: ${window.location.href}`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            showToast('Abra o WhatsApp para enviar a notifica√ß√£o.', 'info');
        }

        // --- Fun√ß√µes de Controle de Estado do Card√°pio (Admin) ---
        async function toggleCardapioAtualAberto() {
            const newState = !estadoCardapio.cardapioAtualAbertoParaEscolha;
            try {
                await updateDoc(estadoCardapioDocRef, { cardapioAtualAbertoParaEscolha: newState });
                showToast(`Escolhas para card√°pio ATUAL ${newState ? 'ABERTAS' : 'FECHADAS'}.`, 'success');
            } catch (e) {
                showToast("Erro ao atualizar estado do card√°pio atual.", "error");
                console.error("Erro ao mudar estado cardapioAtualAbertoParaEscolha:", e);
            }
        }

        async function toggleCardapioProximoAberto() {
            const newState = !estadoCardapio.cardapioProximoAbertoParaEscolha;
            try {
                await updateDoc(estadoCardapioDocRef, { cardapioProximoAbertoParaEscolha: newState });
                showToast(`Escolhas para card√°pio PR√ìXIMO ${newState ? 'ABERTAS' : 'FECHADAS'}.`, 'success');
            } catch (e) {
                showToast("Erro ao atualizar estado do card√°pio pr√≥ximo.", "error");
                console.error("Erro ao mudar estado cardapioProximoAbertoParaEscolha:", e);
            }
        }


        // --- L√≥gica de Autentica√ß√£o e Inicializa√ß√£o ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserID = user.uid;
                // console.log("Usu√°rio autenticado:", currentUserID, "An√¥nimo:", user.isAnonymous);

                // Sempre ouvir o estado do card√°pio e os card√°pios primeiro
                listenToCardapiosAndEstado().then(async () => {
                    // Depois de obter o estado e os card√°pios, carregar dados espec√≠ficos da vis√£o
                    if (user.uid === APP_CONFIG.ADMIN_UID) {
                        showAdminView();
                    } else {
                        showUserView();
                        const rgfStorage = localStorage.getItem('employeeRGF');
                        if (rgfStorage) {
                            document.getElementById('employeeRGF').value = rgfStorage;
                            await findEmployeeByRGF(rgfStorage);
                        } else {
                           pedidosDoUsuarioLogado = { atual: null, proxima: null };
                           renderCurrentViewBasedOnState();
                        }
                    }
                });

            } else { // Nenhum usu√°rio logado
                currentUserID = null;
                currentUserRGF = null;
                pedidosDoUsuarioLogado = { atual: null, proxima: null };
                signInAnonymously(auth)
                    .then((anonUser) => {
                        // O onAuthStateChanged ser√° chamado novamente com o usu√°rio an√¥nimo.
                    })
                    .catch((error) => {
                        console.error("Erro no login an√≥nimo:", error);
                        showToast("N√£o foi poss√≠vel conectar-se ao sistema. Algumas funcionalidades estar√£o desabilitadas.", "error");
                        // Tenta carregar dados p√∫blicos mesmo sem login an√¥nimo completo
                        listenToCardapiosAndEstado().then(() => {
                             showUserView();
                             renderCurrentViewBasedOnState();
                        });
                    });
            }
        });

        // Renomeada para refletir que carrega mais do que apenas o estado
        async function listenToCardapiosAndEstado() {
            const estadoPromise = new Promise(async (resolve, reject) => {
                const snap = await getDoc(estadoCardapioDocRef);
                if (!snap.exists()) {
                    console.warn("Documento /configuracoes/estadoCardapio n√£o encontrado. Tentando criar com valores padr√£o.");
                    try {
                        await setDoc(estadoCardapioDocRef, {
                            cardapioAtualAbertoParaEscolha: true,
                            cardapioProximoAbertoParaEscolha: false,
                            dataPublicacaoProximoCardapio: null
                            // Adicionar outros campos padr√£o se necess√°rio
                        });
                        console.log("Documento de estado do card√°pio criado com valores padr√£o.");
                        // Recarrega o estado ap√≥s cria√ß√£o
                         const newSnap = await getDoc(estadoCardapioDocRef);
                         if (newSnap.exists()) estadoCardapio = newSnap.data();
                    } catch (e) {
                        console.error("Falha ao criar documento de estado do card√°pio:", e);
                        // Mant√©m o estado padr√£o em mem√≥ria se a cria√ß√£o falhar
                         estadoCardapio = { cardapioAtualAbertoParaEscolha: false, cardapioProximoAbertoParaEscolha: false, dataPublicacaoProximoCardapio: null };
                    }
                } else {
                    estadoCardapio = snap.data();
                }
            };

            await ensureEstadoExists(); // Garante que existe antes de tentar ouvir

            return new Promise((resolve) => {
                onSnapshot(estadoCardapioDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        estadoCardapio = docSnap.data();
                        // console.log("Estado do card√°pio atualizado via onSnapshot:", estadoCardapio);
                    } else {
                        // Isso n√£o deveria acontecer se ensureEstadoExists funcionou, mas como fallback:
                        console.warn("/configuracoes/estadoCardapio desapareceu. Usando padr√£o.");
                        estadoCardapio = { cardapioAtualAbertoParaEscolha: false, cardapioProximoAbertoParaEscolha: false, dataPublicacaoProximoCardapio: null };
                    }

                    // Atualiza UI com base no novo estado
                    if (auth.currentUser) { // S√≥ atualiza se houver um usu√°rio (admin ou comum)
                        if (auth.currentUser.uid === APP_CONFIG.ADMIN_UID) {
                            updateAdminUIBasedOnState();
                        } else {
                            renderCurrentViewBasedOnState();
                        }
                    } else { // Se n√£o houver usu√°rio (ex: durante logout antes do login an√¥nimo)
                         renderCurrentViewBasedOnState(); // Mostra card√°pio como se fosse usu√°rio comum (provavelmente bloqueado)
                    }
                    resolve();
                }, (error) => {
                    console.error("Erro ao ouvir estado do card√°pio:", error);
                    showToast("Erro ao verificar o estado do card√°pio.", "error");
                    estadoCardapio = { cardapioAtualAbertoParaEscolha: false, cardapioProximoAbertoParaEscolha: false, dataPublicacaoProximoCardapio: null };
                     if (auth.currentUser && auth.currentUser.uid !== APP_CONFIG.ADMIN_UID) renderCurrentViewBasedOnState();
                     else if (auth.currentUser && auth.currentUser.uid === APP_CONFIG.ADMIN_UID) updateAdminUIBasedOnState();
                     else renderCurrentViewBasedOnState();
                    resolve(); // Resolve mesmo em erro para n√£o bloquear a cadeia de promises
                });
            });
        }

        function renderCurrentViewBasedOnState() {
            // Esta fun√ß√£o √© chamada quando o estado do card√°pio muda ou o usu√°rio loga.
            // Ela decide qual card√°pio (atual ou pr√≥ximo) mostrar e se est√° aberto para escolhas.
            // A vari√°vel `visualizandoCardapioProximaSemana` ser√° usada mais tarde para permitir ao usu√°rio alternar.
            // Por enquanto, ela √© sempre `false` para o usu√°rio comum, focando no card√°pio atual.
            // O admin pode ter uma maneira de alternar isso para teste ou gerenciamento.

            // TODO: Adicionar UI para o usu√°rio (se permitido na quinta) escolher ver/pedir para pr√≥xima semana.
            // Por agora, usu√°rio sempre v√™ o 'atual' (weeklyMenu)
            // E as escolhas s√£o baseadas em `estadoCardapio.cardapioAtualAbertoParaEscolha`

            let menuRefParaCarregar = visualizandoCardapioProximaSemana ? proximoMenuDocRef : menuDocRef;
            let escolhasAbertasParaViewAtual = visualizandoCardapioProximaSemana ?
                                              (estadoCardapio.cardapioProximoAbertoParaEscolha || false) :
                                              (estadoCardapio.cardapioAtualAbertoParaEscolha || false);

            // Carrega o card√°pio (semanal ou proximaSemana) e passa o estado de abertura
            loadAndDisplayMenu(menuRefParaCarregar, escolhasAbertasParaViewAtual);
            // validateForm ser√° chamado dentro de createMenuHTML -> loadAndDisplayMenu
        }

        function updateAdminUIBasedOnState() {
            const statusContainer = document.getElementById('admin-cardapio-status-display');
            if (statusContainer) {
                statusContainer.innerHTML = `
                    <p>Card√°pio ATUAL Aberto para Escolhas: <strong class="${estadoCardapio.cardapioAtualAbertoParaEscolha ? 'text-green-600' : 'text-red-600'}">${estadoCardapio.cardapioAtualAbertoParaEscolha ? 'SIM' : 'N√ÉO'}</strong></p>
                    <p>Card√°pio PR√ìXIMA SEMANA Aberto para Escolhas: <strong class="${estadoCardapio.cardapioProximoAbertoParaEscolha ? 'text-green-600' : 'text-red-600'}">${estadoCardapio.cardapioProximoAbertoParaEscolha ? 'SIM' : 'N√ÉO'}</strong></p>
                `;
            }
            // O admin geralmente gerencia o card√°pio atual e o pr√≥ximo, ent√£o ambos podem ser carregados.
            // A tabela de pedidos (renderOrdersTable) deve continuar mostrando os pedidos do card√°pio ATUAL.
            loadAndDisplayMenu(menuDocRef, true); // Para visualiza√ß√£o e edi√ß√£o de pedidos do card√°pio atual. Admin sempre v√™ habilitado.
            // Poder√≠amos adicionar uma visualiza√ß√£o do card√°pio da pr√≥xima semana para o admin tamb√©m, se necess√°rio.
            // Ex: loadAndDisplayMenu(proximoMenuDocRef, true, 'admin-proximo-menu-container');
            loadAdminData(); // Recarrega dados dos pedidos (baseado no card√°pio atual pela query)
            loadAndRenderEmployees();
        }


        function showUserView() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');

            // A renderiza√ß√£o do card√°pio e valida√ß√£o do formul√°rio agora dependem do estadoCardapio
            // que √© carregado por listenToEstadoCardapio.
            // Se estadoCardapio j√° foi carregado, renderiza. Sen√£o, listenToEstadoCardapio far√°.
            // A chamada para renderCurrentViewBasedOnState ou findEmployeeByRGF √© feita agora no onAuthStateChanged.
            document.getElementById('form-container').classList.remove('hidden'); // Garante que o form seja vis√≠vel inicialmente
            document.getElementById('success-message').classList.add('hidden'); // Esconde msg de sucesso
            const rgfInput = document.getElementById('employeeRGF');
    if (rgfInput) {
                rgfInput.readOnly = false;
                rgfInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
            }
    // A renderiza√ß√£o efetiva ocorre via renderCurrentViewBasedOnState, chamada por onAuthStateChanged/listenToEstadoCardapio
}

function renderCurrentViewBasedOnState() {
    let menuRefParaCarregar = visualizandoCardapioProximaSemana ? proximoMenuDocRef : menuDocRef;
    let escolhasAbertasParaViewAtual = visualizandoCardapioProximaSemana ?
                                      (estadoCardapio.cardapioProximoAbertoParaEscolha || false) :
                                      (estadoCardapio.cardapioAtualAbertoParaEscolha || false);

    const pedidoDoUsuarioParaEsteCardapio = visualizandoCardapioProximaSemana ? pedidosDoUsuarioLogado.proxima : pedidosDoUsuarioLogado.atual;
    const formContainer = document.getElementById('form-container'); // J√° definido no escopo global, mas ok redeclarar localmente se preferir
    const successMessage = document.getElementById('success-message');
    const isAdmin = auth.currentUser && auth.currentUser.uid === APP_CONFIG.ADMIN_UID;
    const employeeRGFInput = document.getElementById('employeeRGF');

    successMessage.classList.add('hidden'); // Esconde mensagem de sucesso ao re-renderizar

    if (!escolhasAbertasParaViewAtual && pedidoDoUsuarioParaEsteCardapio && !isAdmin) {
        // Escolhas fechadas, pedido existe, n√£o √© admin: Modo "visualiza√ß√£o de pedido"
        if(formContainer) formContainer.classList.remove('hidden');
        if(employeeRGFInput) {
            employeeRGFInput.readOnly = true;
            employeeRGFInput.classList.add('bg-gray-100', 'cursor-not-allowed');
        }
    } else {
        if(formContainer) formContainer.classList.remove('hidden');
        if(employeeRGFInput) {
            employeeRGFInput.readOnly = false;
            employeeRGFInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }
    }

    loadAndDisplayMenu(menuRefParaCarregar, escolhasAbertasParaViewAtual);
    // validateForm ser√° chamado dentro de createMenuHTML que √© chamado por loadAndDisplayMenu
        }


        function showAdminView() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');

            // A atualiza√ß√£o da UI do admin tamb√©m depende do estado do card√°pio
    // Garante que estadoCardapio n√£o √© o objeto vazio inicial antes de tentar us√°-lo.
    if (estadoCardapio && estadoCardapio.hasOwnProperty('cardapioAtualAbertoParaEscolha')) {
                updateAdminUIBasedOnState();
            }
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Entrando...';
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged vai lidar com a troca de view e carregamento de dados
                if (userCredential.user.uid !== APP_CONFIG.ADMIN_UID) {
                    await signOut(auth); // Faz logout se n√£o for o admin UID esperado
                    showToast("Credenciais v√°lidas, mas este usu√°rio n√£o √© um administrador.", 'error');
                     // onAuthStateChanged ser√° chamado novamente ap√≥s o signOut, voltando para an√¥nimo/user view.
                } else {
                    showToast("Login de administrador bem-sucedido!", 'success');
                    // onAuthStateChanged j√° foi/ser√° acionado e chamar√° showAdminView ap√≥s listenToEstadoCardapio
                }
            } catch (error) {
                console.error("Erro no login de administrador:", error);
                const msg = (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') ? "Email ou senha incorretos." : "Ocorreu um erro no login.";
                showToast(msg, 'error', 5000);
            } finally {
                btn.disabled = false; btn.textContent = 'Entrar';
            }
        }

        async function handleAdminLogout() {
            try {
                await signOut(auth);
                showToast("Logout de administrador bem-sucedido!", 'info');
                // onAuthStateChanged vai lidar com a transi√ß√£o para a vis√£o de usu√°rio/login an√¥nimo.
            }
            catch (error) { console.error("Erro no logout:", error); showToast("Erro ao fazer logout.", 'error'); }
        }

        function main() {
            const rgfInput = document.getElementById('employeeRGF');
            // O valor do RGF e a chamada a findEmployeeByRGF agora s√£o tratados principalmente
            // dentro do onAuthStateChanged e showUserView para garantir que currentUserID e estadoCardapio estejam dispon√≠veis.

            rgfInput.addEventListener('blur', (e) => {
                localStorage.setItem('employeeRGF', e.target.value);
                if(auth.currentUser && auth.currentUser.uid !== APP_CONFIG.ADMIN_UID) { // S√≥ busca se for usu√°rio normal
                    findEmployeeByRGF(e.target.value);
                }
            });
            rgfInput.addEventListener('input', validateForm); // Valida√ß√£o visual imediata

            document.getElementById('menu').addEventListener('change', validateForm); // Para os radio buttons
             // Para textareas de anota√ß√µes, validar no input ou blur tamb√©m
            document.getElementById('menu').addEventListener('input', (event) => {
                if (event.target.tagName === 'TEXTAREA') {
                    validateForm();
                }
            });

            document.getElementById('openConfirmationModal').addEventListener('click', openConfirmationModal);
            document.getElementById('submitOrder').addEventListener('click', submitOrder);

            document.querySelectorAll('.cancel-modal-btn, #custom-confirm-cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.add('hidden'));
            });

            document.getElementById('switchToAdmin').addEventListener('click', () => document.getElementById('admin-login-modal').classList.remove('hidden'));
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);

            document.getElementById('adminLogoutBtn').addEventListener('click', handleAdminLogout);
            document.getElementById('switchToUserFromAdmin').addEventListener('click', async () => {
                // Ao mudar de admin para usu√°rio, precisamos simular um logout n√£o-admin
                // A forma mais simples √© chamar signOut e deixar onAuthStateChanged lidar com o login an√¥nimo e user view.
                // No entanto, se o admin s√≥ quer *ver* como usu√°rio, isso √© mais complexo.
                // Por agora, vamos assumir que ele volta para a tela de login an√¥nima.
                // Se quisermos manter o admin logado mas ver como user, ter√≠amos que mudar a l√≥gica de showUserView
                // para n√£o depender de !isAdmin.
                // Para uma troca simples de visualiza√ß√£o sem mudar o auth state:
                visualizandoCardapioProximaSemana = false; // Resetar para card√°pio atual na vis√£o de usu√°rio
                showUserView();
                // Ser√° necess√°rio recarregar os dados do usu√°rio se o admin estava logado e tinha RGF diferente
                const rgfStorage = localStorage.getItem('employeeRGF');
                if (rgfStorage && currentUserID !== APP_CONFIG.ADMIN_UID) { // Se n√£o for mais admin
                     findEmployeeByRGF(rgfStorage);
                } else if (currentUserID !== APP_CONFIG.ADMIN_UID) {
                     pedidosDoUsuarioLogado = { atual: null, proxima: null }; // Limpa se n√£o h√° RGF
                     renderCurrentViewBasedOnState();
                }
            });

            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('employee-list-container').addEventListener('click', (e) => {
                if (e.target.closest('.edit-employee-btn')) { openEmployeeEditModal(e.target.closest('.edit-employee-btn').dataset.id, e.target.closest('.edit-employee-btn').dataset.name); }
                if (e.target.closest('.delete-employee-btn')) { handleDeleteEmployee(e.target.closest('.delete-employee-btn').dataset.id, e.target.closest('.delete-employee-btn').dataset.name); }
            });
            document.getElementById('edit-employee-form').addEventListener('submit', handleSaveEmployeeChanges);

            document.getElementById('searchInput').addEventListener('input', () => renderOrdersTable(allOrders)); // allOrders s√£o os pedidos atuais
            document.getElementById('generateReportBtn').addEventListener('click', generateAndPrintReport);

            document.getElementById('ordersTableContainer').addEventListener('click', function(e) {
                if (e.target.closest('.edit-order-btn')) { openOrderEditModal(e.target.closest('.edit-order-btn').dataset.id); }
                if (e.target.closest('.delete-order-btn')) { deleteOrder(e.target.closest('.delete-order-btn').dataset.id, e.target.closest('.delete-order-btn').dataset.name); }
            });
            document.getElementById('edit-order-form').addEventListener('submit', saveOrderChanges);

            document.getElementById('notifyWhatsAppBtn').addEventListener('click', handleWhatsAppNotification);
            document.getElementById('publishNextWeekMenuBtn').addEventListener('click', () => {
                const message = "Tem certeza que deseja publicar o card√°pio da PR√ìXIMA SEMANA como o card√°pio ATUAL? <br><br><strong>Esta a√ß√£o ir√°:</strong><br>1. Copiar o card√°pio de 'proximaSemana' para 'semanal'.<br>2. <strong>APAGAR PERMANENTEMENTE</strong> todos os pedidos feitos para o card√°pio atual.<br>3. Normalmente, abriria as escolhas para este novo card√°pio atual e fecharia as da pr√≥xima (que agora est√° vazia ou √© a antiga).<br><br>Esta a√ß√£o n√£o pode ser desfeita em rela√ß√£o aos pedidos apagados.";
                showCustomConfirm(message, publishNextWeekMenuAsCurrent, "Confirmar Publica√ß√£o de Novo Card√°pio Semanal", "Publicar e Apagar Pedidos Antigos");
            });

            // Bot√µes de controle de estado do card√°pio para Admin
            document.getElementById('toggleAtualAbertoBtn').addEventListener('click', toggleCardapioAtualAberto);
            document.getElementById('toggleProximoAbertoBtn').addEventListener('click', toggleCardapioProximoAberto);

        }

        main();
    </script>
</body>
</html>
