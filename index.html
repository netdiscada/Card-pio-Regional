<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3703/3703377.png">
    
    <title>Card√°pio Quatinga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Lobster Two', cursive; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-print { }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-height: 90vh; overflow-y: auto; width: 90%; max-width: 500px; }
        #image-zoom-modal .modal-content { width: auto; max-width: 95%; padding: 0.5rem; background: none; box-shadow: none; }
        #zoomed-image { max-width: 90vw; max-height: 85vh; border-radius: 0.75rem; }
        input:read-only { background-color: #f3f4f6; cursor: not-allowed; }
        .wizard-btn { transition: all 0.2s ease-in-out; }
        .wizard-btn:hover { transform: scale(1.03); border-color: #3b82f6; }
        .wizard-btn:active { transform: scale(0.98); background-color: #eff6ff; }
        #print-report { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            body > *:not(#print-report) { display: none !important; }
            #print-report { display: block !important; }
            #print-report h1 { font-size: 18pt; text-align: center; margin-bottom: 15px; font-family: 'Poppins', sans-serif; font-weight: 600; }
            .report-day-section { margin-bottom: 12px; page-break-inside: avoid; }
            .report-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
            #print-report th, #print-report td { border: 1px solid #999; padding: 5px; text-align: left; }
            #print-report th { background-color: #e2e8f0; font-weight: 600; }
            #print-report .rgf-col { width: 15%; }
            #print-report .nome-col { width: 60%; }
            #print-report .pedido-col { width: 25%; background-color: #dbeafe; font-weight: bold; }
        }
        #app-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; pointer-events: none; transform: translateX(-50%) translateY(20px); }
        #app-toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
        #app-toast.success { background-color: #22c55e; }
        #app-toast.error { background-color: #ef4444; }
        #app-toast.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-20 shadow-sm no-print">
        <div class="container mx-auto max-w-4xl p-2 flex justify-between items-center">
            <h1 class="font-brand text-2xl text-blue-600">Del√≠cias Urbanas</h1>
            <button id="switchToAdmin" class="text-xs text-gray-500 hover:text-blue-600 font-semibold py-1 px-2 rounded-md hover:bg-gray-100">Painel ADM</button>
        </div>
    </header>

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-20">
        
        <!-- VIS√ÉO DO USU√ÅRIO -->
        <div id="user-view" class="no-print">
            <div id="form-container">
                <p class="text-center mt-2 mb-6 text-md text-gray-500">O seu card√°pio da semana est√° servido!</p>

                <!-- CARD√ÅPIO VIS√çVEL NO TOPO (Fora do form para ser sempre visto) -->
                <div id="menu-image-container" class="mb-8 hidden fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 text-center">üì∏ Card√°pio desta Semana</h2>
                    <div class="relative max-w-md mx-auto">
                        <img id="menu-image" src="" alt="Card√°pio da Semana" class="w-full h-auto rounded-xl shadow-lg border-4 border-white cursor-pointer hover:opacity-95 transition-opacity">
                        <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h2 class="block text-lg font-semibold text-gray-800 mb-2">üë§ 1. Identifica√ß√£o</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div><label for="employeeRGF" class="block text-sm font-medium text-gray-700">Seu RGF</label><input type="text" id="employeeRGF" placeholder="Digite o seu RGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                        <div><label for="employeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="employeeName" placeholder="Preenchido automaticamente" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div>
                    </div>
                </div>

                <!-- Sec√ß√£o de Pedido -->
                <div id="order-section" class="hidden">
                    <div id="order-wizard-container" class="bg-white rounded-xl shadow-sm p-4 sm:p-6">
                        <div id="order-wizard">
                            <h3 id="wizard-day-title" class="text-2xl font-bold text-blue-600 mb-4 text-center"></h3>
                            <div id="wizard-options" class="grid grid-cols-2 gap-3"></div>
                            <div class="mt-4">
                                <textarea id="wizard-notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Anota√ß√µes? Ex: sem cebola, etc."></textarea>
                            </div>
                            <div id="wizard-progress" class="flex space-x-2 justify-center mt-4"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Sec√ß√£o: J√° fez pedido -->
                <div id="user-already-ordered-section" class="hidden fade-in bg-white rounded-xl shadow-sm p-6 mb-6 text-center border-t-4 border-green-500">
                    <h3 class="text-xl font-bold text-green-600 mb-2">‚úÖ Voc√™ j√° fez o seu pedido esta semana!</h3>
                    <p class="text-gray-600 mb-4">Abaixo est√° o resumo do que voc√™ pediu. Para altera√ß√µes, contacte o seu ADM Regional.</p>
                    <div id="user-order-summary" class="bg-gray-50 p-4 rounded-lg text-left space-y-2 border border-gray-200">
                        <!-- Preenchido via JS -->
                    </div>
                </div>

                <!-- Avisos e Orienta√ß√µes -->
                <div id="guidanceSection" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6"><p id="guidanceText" class="font-semibold">Aguardando card√°pio...</p></div>
                <div id="lockedSection" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6"><p class="font-semibold">üîí Pedidos Encerrados! O card√°pio desta semana j√° foi fechado para envio √† cozinha.</p></div>
                
                <div id="submitButtonContainer" class="hidden text-center mt-6"><button id="openConfirmationModal" class="w-full sm:w-auto bg-green-500 text-white font-bold text-lg px-8 py-3 rounded-xl hover:bg-green-600 shadow-lg">Revisar e Finalizar Pedido</button></div>
            </div>
            
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Voltar ao In√≠cio</button></div>
        </div>

        <!-- VIS√ÉO DO ADMINISTRADOR -->
        <div id="admin-view" class="hidden no-print">
            <header class="text-center border-b pb-6 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Painel de Gest√£o</h1>
                <p id="admin-role-badge" class="text-sm font-bold mt-2 inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-800">Carregando perfil...</p>
                <div class="mt-4">
                    <button id="adminLogoutBtn" class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600">Sair do Painel</button>
                </div>
            </header>
            
            <div class="mb-6 flex justify-between items-center bg-gray-100 p-3 rounded-lg border border-gray-200">
                <button id="switchToUserFromAdmin" class="text-sm text-gray-700 hover:text-blue-600 font-semibold">‚¨ÖÔ∏è Voltar ao In√≠cio</button>
                <div id="admin-regional-filter-container" class="hidden flex items-center gap-2">
                    <label class="text-sm font-semibold text-gray-700">Filtrar Vis√£o:</label>
                    <select id="adminRegionalFilter" class="px-3 py-1 border rounded bg-white text-sm">
                        <!-- Injetado via JS -->
                    </select>
                </div>
            </div>

            <!-- NOVA SEC√á√ÉO EXCLUSIVA SUPER ADM: CRIAR ADMS E REGIONAIS -->
            <section id="super-admin-management" class="bg-white rounded-xl shadow-sm p-6 mb-8 border-l-4 border-purple-500 hidden fade-in">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Gerir Regionais -->
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2">üè¢ Regionais Ativas</h3>
                        <div id="regionais-list" class="flex flex-wrap gap-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input type="text" id="newRegionalInput" placeholder="Nome da Nova Regional" class="w-full border px-3 py-2 rounded-lg text-sm">
                            <button id="addRegionalBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold text-sm">Adicionar</button>
                        </div>
                    </div>

                    <!-- Criar ADMs -->
                    <div class="border-t md:border-t-0 md:border-l md:pl-8 pt-4 md:pt-0">
                        <h3 class="font-bold text-gray-700 mb-2">üëÆ‚Äç‚ôÇÔ∏è Criar Novo Administrador</h3>
                        <form id="create-adm-form" class="space-y-3">
                            <div><input type="email" id="newAdmEmail" placeholder="Email de acesso" class="w-full border rounded-lg p-2 text-sm" required></div>
                            <div><input type="text" id="newAdmPassword" placeholder="Senha (M√≠n. 6 letras/n√∫meros)" class="w-full border rounded-lg p-2 text-sm" required minlength="6"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <select id="newAdmRole" class="w-full border rounded-lg p-2 text-sm">
                                        <option value="regional_adm">ADM Regional</option>
                                        <option value="super_adm">ADM PR√ì (Tudo)</option>
                                    </select>
                                </div>
                                <div id="newAdmRegionalContainer">
                                    <select id="newAdmRegional" class="w-full border rounded-lg p-2 text-sm"></select>
                                </div>
                            </div>
                            <button type="submit" class="bg-blue-600 text-white p-2 rounded-lg font-bold w-full text-sm">Criar Administrador</button>
                        </form>
                    </div>
                </div>
            </section>
            
            <!-- SEC√á√ÉO ADM PR√ì: UPLOAD E BLOQUEIO -->
            <section id="menu-image-uploader-section" class="bg-white rounded-xl shadow-sm p-6 mb-8 border-l-4 border-blue-500 hidden">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-4">üëë ADM PR√ì: Gest√£o Global do Card√°pio</h2>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2">üñºÔ∏è Novo Card√°pio</h3>
                        <p class="text-sm text-gray-600 mb-2">Enviar imagem. Isto limpar√° todos os pedidos anteriores.</p>
                        <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <img id="imagePreview" class="mt-4 rounded-lg max-h-40 hidden border" />
                        <button id="uploadImageBtn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400" disabled>Salvar Imagem e Feriados</button>
                    </div>

                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2">üîí Status do Card√°pio</h3>
                        <p class="text-sm text-gray-600 mb-2">Trave o card√°pio para enviar para a cozinha.</p>
                        <button id="toggleMenuLockBtn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2 transition-colors">
                            <span id="lockBtnIcon">üîì</span> <span id="lockBtnText">Card√°pio Aberto (Clique para Bloquear)</span>
                        </button>
                        
                        <div class="mt-4 border-t pt-4">
                            <h3 class="font-semibold text-gray-700 mb-2">üìÖ Feriados</h3>
                            <div id="holiday-selector" class="flex flex-wrap gap-2 text-sm"></div>
                        </div>
                    </div>
                </div>
                
                 <div id="whatsapp-notification-container" class="mt-6 text-center hidden">
                    <button id="notifyWhatsAppBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        Notificar Funcion√°rios no WhatsApp
                    </button>
                </div>
            </section>
            
            <!-- SEC√á√ÉO: RESUMO PARA A COZINHA -->
            <section id="kitchen-summary-section" class="bg-white rounded-xl shadow-sm p-6 mb-8 border-l-4 border-orange-400">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üë®‚Äçüç≥ Resumo de Produ√ß√£o (Cozinha)</h2>
                <div id="kitchen-summary-container" class="overflow-x-auto">
                    <p class="text-gray-500">A processar dados da produ√ß√£o...</p>
                </div>
            </section>
            
            <section id="order-status-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üìä Status de Pedidos da Semana</h2>
                <div id="order-status-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <p class="text-gray-500">A carregar status...</p>
                </div>
            </section>

            <section id="employee-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üë• Gerenciamento de Funcion√°rios</h2>
                <form id="add-employee-form" class="bg-gray-50 p-4 rounded-lg border mb-6 grid sm:grid-cols-4 gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">RGF</label>
                        <input type="text" id="newEmployeeRGF" placeholder="RGF" class="mt-1 w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" id="newEmployeeName" placeholder="Nome Completo" class="mt-1 w-full px-3 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Regional</label>
                        <select id="newEmployeeRegional" class="mt-1 w-full px-3 py-2 border rounded-lg" required></select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar</button>
                </form>
                <div id="employee-list-container" class="overflow-x-auto">
                    <p class="text-gray-500">A carregar lista...</p>
                </div>
            </section>

            <section id="orders-section">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Pedidos Recebidos</h2>
                    <div class="w-full sm:w-auto"><input type="text" id="searchInput" placeholder="üîé Buscar por nome..." class="w-full sm:w-64 px-4 py-2 border rounded-lg"></div>
                    <button id="generateReportBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">üñ®Ô∏è Salvar Relat√≥rio PDF</button>
                </div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div id="image-zoom-modal" class="modal-overlay hidden no-print cursor-zoom-out"><div class="modal-content"><img id="zoomed-image" src=""></div></div>
    
    <div id="edit-order-modal" class="modal-overlay hidden no-print">
        <div class="modal-content w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Editar Pedido</h2>
            <form id="edit-order-form">
                <input type="hidden" id="edit-order-id">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Nome do Funcion√°rio</label>
                    <input type="text" id="edit-order-employeeName" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 font-bold" readonly>
                </div>
                <div id="edit-menu-options" class="space-y-4 max-h-[50vh] overflow-y-auto p-1"></div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-employee-modal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Editar Funcion√°rio</h2>
            <form id="edit-employee-form">
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700">RGF</label><input type="text" id="editEmployeeRGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly></div>
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="editEmployeeName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div>
                <div class="mb-4"><label class="block text-sm font-medium text-gray-700">Regional</label><select id="editEmployeeRegional" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg"></select></div>
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="editEmployeeFerias" class="w-5 h-5 text-blue-600 rounded">
                        <span class="font-semibold text-yellow-800">üå¥ Funcion√°rio em F√©rias / Ausente</span>
                    </label>
                    <p class="text-xs text-yellow-700 mt-1 ml-8">Ele n√£o ser√° cobrado na lista de "Ainda n√£o pediram".</p>
                </div>
                <div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar</button></div>
            </form>
        </div>
    </div>
    
    <div id="confirmation-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-2xl font-bold mb-4">Confirme o seu Pedido</h2><p class="mb-6 text-gray-600">Por favor, revise as suas escolhas antes de enviar.</p><div id="confirmation-summary" class="space-y-2 mb-8"></div><div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Editar</button><button id="submitOrder" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">Confirmar e Enviar</button></div></div></div>
    
    <div id="admin-login-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Acesso Administrativo</h2><form id="admin-login-form"><div class="mb-4"><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="adminEmail" placeholder="seu-email@exemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="adminPassword" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="adminPassword" placeholder="Sua senha" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button></div></form></div></div>
    
    <div id="custom-confirm-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-xl font-bold mb-4" id="custom-confirm-title">Confirmar A√ß√£o</h2><p class="mb-6 text-gray-600" id="custom-confirm-message">Tem a certeza que deseja prosseguir?</p><div class="flex justify-end space-x-4"><button id="custom-confirm-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button id="custom-confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirmar</button></div></div></div>

    <div id="print-report"></div>
    <div id="app-toast"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, where, doc, getDoc, setDoc, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Importando a fun√ß√£o createUserWithEmailAndPassword
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI",
            authDomain: "cardapio-8ddea.firebaseapp.com",
            projectId: "cardapio-8ddea",
            storageBucket: "cardapio-8ddea.appspot.com",
            messagingSenderId: "1019677985212",
            appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // CONFIGURA√á√ÉO DO SUPER ADM 
        const APP_CONFIG = {
            SUPER_ADMIN_UID: 'LqAXao4FuOQAvzS3uQAd9et6OnK2'
        };
        
        const menuDocRef = doc(db, "cardapio", "semanal");
        const pedidosCollectionRef = collection(db, "pedidosDaSemana");
        const funcionariosCollectionRef = collection(db, "funcionarios");
        const configDocRef = doc(db, "config", "gerais"); // Nova cole√ß√£o para as Regionais din√¢micas
        
        const weekDays = ['Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];
        const mealOptions = [
            { name: "Prato Principal", emoji: "üçΩÔ∏è", description: "A op√ß√£o do dia, conforme a imagem" },
            { name: "Op√ß√£o", emoji: "üç≤", description: "A segunda op√ß√£o do dia, se houver" },
            { name: "Omelete", emoji: "üç≥", description: "Op√ß√£o fixa" },
            { name: "Fil√© de frango", emoji: "üçó", description: "Op√ß√£o fixa" }
        ];

        let weeklyMenu = { menuImageBase64: null, bloqueado: false };
        let allOrders = [];
        let tempOrderData = {};
        let userChoices = [];
        let currentDayIndex = 0;
        let fileToUpload = null;
        let activeHolidays = [];
        let currentUserEmployeeData = null; 
        
        let regionaisAtivas = ['Quatinga', 'Matriz']; // Fallback local
        let currentAdminRole = null; 
        let currentAdminRegional = 'todas'; 

        // --- INJE√á√ÉO DIN√ÇMICA PWA (APP MOBILE) ---
        function setupPWA() {
            // Gera um manifesto web em tempo de execu√ß√£o sem precisar do arquivo json f√≠sico!
            const manifest = {
                "name": "Del√≠cias Urbanas - Card√°pio",
                "short_name": "Card√°pio DU",
                "start_url": "./",
                "display": "standalone",
                "background_color": "#f8fafc",
                "theme_color": "#2563eb",
                "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3703/3703377.png", "sizes": "512x512", "type": "image/png" }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.head.insertAdjacentHTML('beforeend', `<link rel="manifest" href="${URL.createObjectURL(manifestBlob)}">`);

            // Gera um Service Worker vazio (Apenas para habilitar o bot√£o de Instala√ß√£o App)
            const swCode = `self.addEventListener('fetch', (e) => {});`;
            const swBlob = new Blob([swCode], {type: 'application/javascript'});
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(()=>console.log('SW setup'));
            }
        }
        setupPWA();

        function getDayId(dayName) { return dayName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, "").toLowerCase(); }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('app-toast');
            if(!toast) return;
            toast.textContent = message;
            toast.className = `show ${type}`;
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, duration);
        }
        
        function showCustomConfirm(message, onConfirm) {
            const modal = document.getElementById('custom-confirm-modal');
            document.getElementById('custom-confirm-message').textContent = message;
            modal.classList.remove('hidden');
            const okBtn = document.getElementById('custom-confirm-ok-btn');
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            newOkBtn.addEventListener('click', () => { onConfirm(); modal.classList.add('hidden'); });
        }

        // --- CARREGAR CONFIGURA√á√ïES (REGIONAIS DIN√ÇMICAS) ---
        function loadConfigurations() {
            onSnapshot(configDocRef, (docSnap) => {
                if(docSnap.exists()) {
                    regionaisAtivas = docSnap.data().regionais || ['Quatinga', 'Matriz'];
                } else if (currentAdminRole === 'super_adm') {
                    // Inicializa a BD caso n√£o exista
                    setDoc(configDocRef, { regionais: regionaisAtivas });
                }
                updateRegionalDropdowns();
            });
        }

        function updateRegionalDropdowns() {
            // Renderiza as tags das regionais
            const listContainer = document.getElementById('regionais-list');
            if (listContainer) {
                listContainer.innerHTML = regionaisAtivas.map(r => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-semibold">${r}</span>`).join('');
            }

            // Atualiza todos os selects do sistema
            const selects = ['adminRegionalFilter', 'newEmployeeRegional', 'editEmployeeRegional', 'newAdmRegional'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                const currentVal = el.value;
                let html = '';
                if(id === 'adminRegionalFilter') html += '<option value="todas">Todas as Regionais</option>';
                regionaisAtivas.forEach(reg => html += `<option value="${reg}">${reg}</option>`);
                el.innerHTML = html;
                if(currentVal && regionaisAtivas.includes(currentVal)) el.value = currentVal;
                else if (id === 'adminRegionalFilter' && currentVal === 'todas') el.value = 'todas';
            });
        }

        // --- GEST√ÉO DE MENU & BLOQUEIO ---
        function loadAndDisplayMenu() {
            onSnapshot(menuDocRef, (docSnap) => {
                const menuData = (docSnap.exists() && docSnap.data()) ? docSnap.data() : { menuImageBase64: '', holidays: [], bloqueado: false };
                
                activeHolidays = menuData.holidays || []; 
                weeklyMenu.bloqueado = menuData.bloqueado || false;
                
                renderHolidayCheckboxes();
                updateMenuLockUI();

                if (menuData.menuImageBase64) {
                    weeklyMenu.menuImageBase64 = menuData.menuImageBase64;
                    document.getElementById('menu-image').src = weeklyMenu.menuImageBase64;
                    document.getElementById('menu-image-container').classList.remove('hidden'); 
                    currentDayIndex = 0;
                    userChoices = [];
                    renderWizardStep(0);
                    
                    const rgf = document.getElementById('employeeRGF').value.trim();
                    if(rgf) {
                        checkIfUserAlreadyOrdered(rgf);
                    }
                } else {
                    weeklyMenu.menuImageBase64 = null;
                    document.getElementById('menu-image-container').classList.add('hidden');
                }
                validateForm(); 
            }, (error) => { console.error("Erro ao carregar card√°pio:", error); });
        }

        async function toggleMenuLock() {
            const newState = !weeklyMenu.bloqueado;
            const message = newState ? "Deseja BLOQUEAR o card√°pio? Ningu√©m poder√° enviar pedidos." : "Deseja DESBLOQUEAR o card√°pio?";
            showCustomConfirm(message, async () => {
                try { await updateDoc(menuDocRef, { bloqueado: newState }); showToast(newState ? "Card√°pio Bloqueado!" : "Aberto!", "success"); } 
                catch (error) { showToast("Falha ao alterar.", "error"); }
            });
        }

        function updateMenuLockUI() {
            const btn = document.getElementById('toggleMenuLockBtn');
            const icon = document.getElementById('lockBtnIcon');
            const text = document.getElementById('lockBtnText');
            if (!btn) return;
            if (weeklyMenu.bloqueado) {
                btn.className = "w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 flex items-center justify-center gap-2";
                icon.textContent = "üîí"; text.textContent = "Pedidos Encerrados (Clique para Abrir)";
            } else {
                btn.className = "w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2";
                icon.textContent = "üîì"; text.textContent = "Card√°pio Aberto (Clique para Bloquear)";
            }
        }

        // --- GEST√ÉO DE FUNCION√ÅRIOS ---
        async function loadAndRenderEmployees() {
            const container = document.getElementById('employee-list-container');
            try {
                const q = query(funcionariosCollectionRef, orderBy("nome"));
                const snapshot = await getDocs(q);
                let employees = [];
                snapshot.forEach(doc => employees.push({ id: doc.id, ...doc.data() }));

                const viewRegional = document.getElementById('adminRegionalFilter').value;
                if (viewRegional !== 'todas') employees = employees.filter(emp => emp.regionalId === viewRegional);

                if (employees.length === 0) { container.innerHTML = '<p class="text-gray-500 py-4">Nenhum funcion√°rio encontrado.</p>'; return; }

                let tableHTML = `<table class="min-w-full bg-white border text-sm"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">RGF</th><th class="py-2 px-3 border-b text-left">Nome</th><th class="py-2 px-3 border-b text-left">Regional</th><th class="py-2 px-3 border-b text-center">Status</th><th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;
                employees.forEach(emp => {
                    const statusBadge = emp.emFerias ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-bold">üå¥ F√©rias</span>' : '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-bold">Ativo</span>';
                    tableHTML += `<tr><td class="py-2 px-3 border-b font-mono">${emp.id}</td><td class="py-2 px-3 border-b font-semibold">${emp.nome}</td><td class="py-2 px-3 border-b">${emp.regionalId || 'N/A'}</td><td class="py-2 px-3 border-b text-center">${statusBadge}</td><td class="py-2 px-3 border-b space-x-2"><button data-id="${emp.id}" class="edit-employee-btn text-blue-600 font-semibold">Editar</button><button data-id="${emp.id}" data-name="${emp.nome}" class="delete-employee-btn text-red-600 font-semibold">Excluir</button></td></tr>`;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            } catch (error) { container.innerHTML = `<p class="text-red-500">Falha ao carregar funcion√°rios.</p>`; }
        }

        async function handleAddEmployee(e) {
            e.preventDefault();
            const rgf = document.getElementById('newEmployeeRGF').value.trim();
            const nome = document.getElementById('newEmployeeName').value.trim();
            let regional = document.getElementById('newEmployeeRegional').value;
            if (currentAdminRole === 'regional_adm') regional = currentAdminRegional;

            try {
                await setDoc(doc(db, "funcionarios", rgf), { nome, regionalId: regional, emFerias: false });
                showToast("Funcion√°rio adicionado!", 'success');
                e.target.reset(); loadAndRenderEmployees(); 
            } catch (error) { showToast("Erro ao adicionar.", 'error'); }
        }

        function handleDeleteEmployee(rgf, name) {
            showCustomConfirm(`Excluir o funcion√°rio ${name} (RGF: ${rgf})?`, async () => {
                try { await deleteDoc(doc(db, "funcionarios", rgf)); showToast("Funcion√°rio exclu√≠do.", 'success'); loadAndRenderEmployees(); } 
                catch (error) { showToast("Falha ao excluir.", 'error'); }
            });
        }
        
        async function openEmployeeEditModal(rgf) {
            try {
                const docSnap = await getDoc(doc(db, "funcionarios", rgf));
                if (docSnap.exists()) {
                    const emp = docSnap.data();
                    document.getElementById('editEmployeeRGF').value = rgf;
                    document.getElementById('editEmployeeName').value = emp.nome;
                    document.getElementById('editEmployeeRegional').value = emp.regionalId || regionaisAtivas[0];
                    document.getElementById('editEmployeeFerias').checked = emp.emFerias || false;
                    document.getElementById('editEmployeeRegional').disabled = currentAdminRole === 'regional_adm';
                    document.getElementById('edit-employee-modal').classList.remove('hidden');
                }
            } catch(e) { showToast("Erro ao abrir funcion√°rio.", 'error'); }
        }

        async function handleSaveEmployeeChanges(e) {
            e.preventDefault();
            const rgf = document.getElementById('editEmployeeRGF').value;
            const nome = document.getElementById('editEmployeeName').value.trim();
            const regionalId = document.getElementById('editEmployeeRegional').value;
            const emFerias = document.getElementById('editEmployeeFerias').checked;
            try {
                await updateDoc(doc(db, "funcionarios", rgf), { nome, regionalId, emFerias });
                showToast("Atualizado com sucesso!", 'success');
                document.getElementById('edit-employee-modal').classList.add('hidden');
                loadAndRenderEmployees(); renderOrderStatus(allOrders);
            } catch (error) { showToast("Falha ao salvar.", 'error'); }
        }
        
        // --- L√ìGICA DO UTILIZADOR ---
        async function findEmployeeByRGF(rgf) {
            const nameInput = document.getElementById('employeeName');
            currentUserEmployeeData = null;
            document.getElementById('user-already-ordered-section').classList.add('hidden');
            
            if (!rgf) { nameInput.value = ''; nameInput.placeholder = 'Preenchido automaticamente'; return; }
            try {
                const docSnap = await getDoc(doc(db, "funcionarios", rgf));
                if (docSnap.exists()) {
                    currentUserEmployeeData = { rgf: rgf, ...docSnap.data() };
                    nameInput.value = currentUserEmployeeData.nome;
                    checkIfUserAlreadyOrdered(rgf);
                } else { nameInput.value = ''; nameInput.placeholder = 'RGF n√£o encontrado'; validateForm(); }
            } catch (error) { nameInput.value = ''; nameInput.placeholder = 'Erro na busca'; }
        }

        async function checkIfUserAlreadyOrdered(rgf) {
            try {
                const q = query(pedidosCollectionRef, where("employeeRGF", "==", rgf));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    showUserAlreadyOrderedSummary(snapshot.docs[0].data());
                } else {
                    document.getElementById('user-already-ordered-section').classList.add('hidden');
                    validateForm(); 
                }
            } catch(error) { console.error(error); }
        }

        function showUserAlreadyOrderedSummary(order) {
            document.getElementById('order-section').classList.add('hidden');
            document.getElementById('guidanceSection').classList.add('hidden');
            document.getElementById('lockedSection').classList.add('hidden');
            document.getElementById('submitButtonContainer').classList.add('hidden');
            
            const summaryDiv = document.getElementById('user-order-summary');
            summaryDiv.innerHTML = '';
            weekDays.forEach(day => {
                const dayId = getDayId(day);
                if (activeHolidays.includes(dayId)) return;
                const choice = order[dayId] || 'Nenhuma Op√ß√£o';
                const notes = order[`${dayId}_notes`] ? ` <span class="text-sm italic text-gray-500">(${order[`${dayId}_notes`]})</span>` : '';
                summaryDiv.innerHTML += `<p class="border-b pb-1"><strong class="text-gray-800">${day}:</strong> ${choice}${notes}</p>`;
            });
            document.getElementById('user-already-ordered-section').classList.remove('hidden');
        }
        
        function renderWizardStep(index) {
            const wizardContainer = document.getElementById('order-wizard-container');
            if (index >= weekDays.length) {
                wizardContainer.parentElement.classList.add('hidden');
                document.getElementById('submitButtonContainer').classList.remove('hidden');
                return;
            }
            const day = weekDays[index];
            const dayId = getDayId(day);
            if (activeHolidays.includes(dayId)) {
                userChoices[index] = { day: day, choice: "FERIADO", notes: "" };
                currentDayIndex = index + 1; renderWizardStep(currentDayIndex); return;
            }
            document.getElementById('wizard-day-title').textContent = day;
            const optionsContainer = document.getElementById('wizard-options');
            optionsContainer.innerHTML = '';
            mealOptions.forEach(opt => {
                optionsContainer.innerHTML += `<button data-value="${opt.name}" class="wizard-btn text-left p-2 border-2 border-gray-200 rounded-lg"><div class="flex items-center"><span class="text-xl mr-2">${opt.emoji}</span><div><p class="font-semibold text-gray-800 text-sm">${opt.name}</p><p class="text-xs text-gray-500">${opt.description}</p></div></div></button>`;
            });
            document.getElementById('wizard-notes').value = '';
            updateWizardProgress(index);
            wizardContainer.classList.add('fade-in'); setTimeout(() => wizardContainer.classList.remove('fade-in'), 300);
        }

        function updateWizardProgress(index) {
            const progressContainer = document.getElementById('wizard-progress');
            progressContainer.innerHTML = '';
            for(let i=0; i < weekDays.length; i++) {
                const dotClass = i < index ? 'bg-blue-600' : (i === index ? 'bg-blue-300' : 'bg-gray-300');
                progressContainer.innerHTML += `<div class="w-2.5 h-2.5 rounded-full ${dotClass}"></div>`;
            }
        }
        
        function handleWizardSelection(event) {
            const choiceBtn = event.target.closest('.wizard-btn');
            if (!choiceBtn) return;
            userChoices[currentDayIndex] = { day: weekDays[currentDayIndex], choice: choiceBtn.dataset.value, notes: document.getElementById('wizard-notes').value.trim() };
            currentDayIndex++; renderWizardStep(currentDayIndex);
        }

        function renderHolidayCheckboxes() {
            const container = document.getElementById('holiday-selector');
            if (!container) return;
            container.innerHTML = '';
            weekDays.forEach(day => {
                const dayId = getDayId(day);
                const isChecked = activeHolidays.includes(dayId) ? 'checked' : '';
                container.innerHTML += `<label class="flex items-center space-x-1 cursor-pointer bg-white p-1 rounded border"><input type="checkbox" value="${dayId}" class="holiday-checkbox text-blue-600" ${isChecked}><span>${day.substring(0,3)}</span></label>`;
            });
        }

        function validateForm() {
            const name = document.getElementById('employeeName')?.value.trim();
            const rgf = document.getElementById('employeeRGF')?.value.trim();
            const guidanceSection = document.getElementById('guidanceSection');
            const orderSection = document.getElementById('order-section');
            const lockedSection = document.getElementById('lockedSection');
            
            const alreadyOrdered = !document.getElementById('user-already-ordered-section').classList.contains('hidden');

            if (alreadyOrdered) {
                orderSection.classList.add('hidden'); 
                guidanceSection.classList.add('hidden'); 
                lockedSection.classList.add('hidden');
                return; 
            }

            if (weeklyMenu.menuImageBase64) {
                if (weeklyMenu.bloqueado) {
                    orderSection.classList.add('hidden'); guidanceSection.classList.add('hidden'); lockedSection.classList.remove('hidden');
                } else if (!name || !rgf) {
                    orderSection.classList.add('hidden'); lockedSection.classList.add('hidden'); guidanceSection.classList.remove('hidden');
                    document.getElementById('guidanceText').textContent = 'Por favor, preencha o seu RGF para fazer o pedido.';
                } else {
                    guidanceSection.classList.add('hidden'); lockedSection.classList.add('hidden'); orderSection.classList.remove('hidden');
                }
            } else {
                orderSection.classList.add('hidden'); lockedSection.classList.add('hidden'); guidanceSection.classList.remove('hidden');
                document.getElementById('guidanceText').textContent = 'O administrador ainda n√£o enviou o card√°pio da semana.';
            }
        }

        function openConfirmationModal() {
            if (!currentUserEmployeeData) return;
            tempOrderData = { employeeName: currentUserEmployeeData.nome, employeeRGF: currentUserEmployeeData.rgf, regionalId: currentUserEmployeeData.regionalId || regionaisAtivas[0], timestamp: serverTimestamp() };
            const summaryContainer = document.getElementById('confirmation-summary');
            summaryContainer.innerHTML = '';
            userChoices.forEach(item => {
                const dayId = getDayId(item.day);
                tempOrderData[dayId] = item.choice;
                if(item.notes) tempOrderData[`${dayId}_notes`] = item.notes;
                const displayChoice = item.choice === 'FERIADO' ? 'üèñÔ∏è FERIADO' : item.choice;
                const styleClass = item.choice === 'FERIADO' ? 'text-gray-400 italic' : 'text-gray-800';
                summaryContainer.innerHTML += `<p class="${styleClass}"><span class="font-bold">${item.day}:</span> ${displayChoice} ${item.notes ? `<span class="text-sm">(${item.notes})</span>` : ''}</p>`;
            });
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        async function submitOrder() {
            const button = document.getElementById('submitOrder');
            button.disabled = true; button.textContent = 'A enviar...';
            try {
                await addDoc(pedidosCollectionRef, tempOrderData);
                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');
                document.getElementById('success-text').textContent = `Obrigado, ${tempOrderData.employeeName}. O seu pedido foi registado!`;
            } catch (error) { showToast("Ocorreu um erro ao enviar.", 'error'); } 
            finally { button.disabled = false; button.textContent = 'Confirmar e Enviar'; }
        }
        
        // --- PROCESSAMENTO DE DADOS (ADM) ---
        function loadAdminData() {
            onSnapshot(pedidosCollectionRef, (snapshot) => {
                const latestOrdersMap = new Map();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.employeeRGF) {
                        const ts = data.timestamp ? data.timestamp.toMillis() : 0;
                         if (!latestOrdersMap.has(data.employeeRGF) || ts > latestOrdersMap.get(data.employeeRGF).timestamp) {
                             latestOrdersMap.set(data.employeeRGF, { doc: doc, timestamp: ts });
                         }
                    }
                });
                
                let rawOrders = Array.from(latestOrdersMap.values()).map(item => item.doc);
                const viewRegional = document.getElementById('adminRegionalFilter').value;
                if (viewRegional !== 'todas') rawOrders = rawOrders.filter(doc => doc.data().regionalId === viewRegional);

                allOrders = rawOrders.sort((a, b) => a.data().employeeName.localeCompare(b.data().employeeName));
                renderOrdersTable(allOrders); renderOrderStatus(allOrders); renderKitchenSummary(allOrders);
            });
        }
        
        async function renderOrderStatus(orders) {
            const container = document.getElementById('order-status-container');
            const viewRegional = document.getElementById('adminRegionalFilter').value;
            try {
                const employeeSnapshot = await getDocs(query(funcionariosCollectionRef, orderBy("nome")));
                let allEmployees = employeeSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (viewRegional !== 'todas') allEmployees = allEmployees.filter(emp => emp.regionalId === viewRegional);
                
                const orderedRGFs = new Set(orders.map(orderDoc => orderDoc.data().employeeRGF));
                const haveOrdered = allEmployees.filter(emp => orderedRGFs.has(emp.id));
                const onVacation = allEmployees.filter(emp => emp.emFerias && !orderedRGFs.has(emp.id));
                const haveNotOrdered = allEmployees.filter(emp => !emp.emFerias && !orderedRGFs.has(emp.id));

                container.innerHTML = `<div><h3 class="font-bold text-green-600 mb-2">‚úÖ J√° Pediram (${haveOrdered.length})</h3><ul class="text-sm space-y-1">${haveOrdered.map(e => `<li class="p-1 bg-green-50 rounded">${e.nome}</li>`).join('') || 'Ningu√©m'}</ul></div><div><h3 class="font-bold text-red-600 mb-2">‚ùå Faltam Pedir (${haveNotOrdered.length})</h3><ul class="text-sm space-y-1">${haveNotOrdered.map(e => `<li class="p-1 bg-red-50 rounded">${e.nome}</li>`).join('') || 'Equipa completa!'}</ul></div><div><h3 class="font-bold text-yellow-600 mb-2">üå¥ Em F√©rias (${onVacation.length})</h3><ul class="text-sm space-y-1">${onVacation.map(e => `<li class="p-1 bg-yellow-50 rounded">${e.nome}</li>`).join('') || 'Nenhum'}</ul></div>`;
            } catch (error) { container.innerHTML = '<p class="text-red-500">Erro ao carregar status.</p>'; }
        }

        function renderKitchenSummary(orders) {
            const container = document.getElementById('kitchen-summary-container');
            if (orders.length === 0) { container.innerHTML = '<p class="text-gray-500">Sem pedidos.</p>'; return; }

            const summary = {};
            weekDays.forEach(day => {
                const dayId = getDayId(day);
                if (activeHolidays.includes(dayId)) return;
                summary[dayId] = {}; mealOptions.forEach(opt => summary[dayId][opt.name] = 0);
                orders.forEach(orderDoc => {
                    const choice = orderDoc.data()[dayId];
                    if (choice && summary[dayId][choice] !== undefined) summary[dayId][choice]++;
                });
            });

            let html = '<div class="grid sm:grid-cols-2 md:grid-cols-5 gap-4">';
            weekDays.forEach(day => {
                const dayId = getDayId(day);
                if (activeHolidays.includes(dayId)) return;
                html += `<div class="bg-gray-50 border rounded-lg p-3"><h4 class="font-bold text-blue-700 border-b pb-1 mb-2">${day.substring(0,3)}</h4><ul class="text-sm space-y-1">`;
                mealOptions.forEach(opt => {
                    const count = summary[dayId][opt.name];
                    if (count > 0) html += `<li class="flex justify-between"><span>${opt.emoji} ${opt.name}</span> <span class="font-bold text-gray-800">${count}</span></li>`;
                });
                html += '</ul></div>';
            });
            container.innerHTML = html + '</div>';
        }
        
        function renderOrdersTable(orders) {
            const container = document.getElementById('ordersTableContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredOrders = orders.filter(doc => doc.data().employeeName.toLowerCase().includes(searchTerm));

            if (!weeklyMenu.menuImageBase64) { container.innerHTML = '<p class="text-gray-500">Aguardando card√°pio...</p>'; return; }
            if (filteredOrders.length === 0) { container.innerHTML = '<p class="text-gray-500">Nenhum pedido.</p>'; return; }
            
            let tableHTML = `<table class="min-w-full bg-white border text-sm"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">Nome</th><th class="py-2 px-3 border-b text-left">Reg.</th>`;
            weekDays.forEach(item => tableHTML += `<th class="py-2 px-3 border-b text-left">${item.substring(0,3)}</th>`);
            tableHTML += `<th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;

            filteredOrders.forEach(doc => {
                const order = doc.data();
                tableHTML += `<tr><td class="py-2 px-3 border-b font-bold">${order.employeeName}</td><td class="py-2 px-3 border-b text-xs text-gray-500">${order.regionalId || '-'}</td>`;
                weekDays.forEach(day => {
                    const dayId = getDayId(day);
                    let choice = order[dayId] || '';
                    if (activeHolidays.includes(dayId)) choice = 'FERIADO';
                    if (choice === 'FERIADO') {
                        tableHTML += `<td class="py-2 px-3 border-b bg-gray-100 text-gray-400 text-xs text-center">FERIADO</td>`;
                    } else {
                        let content = choice.split(' ')[0];
                        if (order[`${dayId}_notes`]) content += ` <span title="${order[`${dayId}_notes`]}" class="cursor-help text-blue-500 font-bold">*</span>`;
                        tableHTML += `<td class="py-2 px-3 border-b">${content || '-'}</td>`;
                    }
                });
                tableHTML += `<td class="py-2 px-3 border-b space-x-2 whitespace-nowrap"><button data-id="${doc.id}" class="edit-order-btn text-blue-600 hover:text-blue-800 font-semibold">Editar</button><button data-id="${doc.id}" class="delete-order-btn text-red-600 hover:text-red-800 font-semibold">Excluir</button></td></tr>`;
            });
            container.innerHTML = tableHTML + `</tbody></table>`;
        }

        function openEditOrderModal(orderId) {
            const orderDoc = allOrders.find(doc => doc.id === orderId);
            if (!orderDoc) return;
            const order = orderDoc.data();
            document.getElementById('edit-order-id').value = orderId;
            document.getElementById('edit-order-employeeName').value = order.employeeName;
            const optionsContainer = document.getElementById('edit-menu-options');
            optionsContainer.innerHTML = '';
            weekDays.forEach(day => {
                const dayId = getDayId(day);
                if (activeHolidays.includes(dayId)) return; 
                const currentChoice = order[dayId] || '';
                const currentNotes = order[`${dayId}_notes`] || '';
                let selectHTML = `<select id="edit-choice-${dayId}" class="w-full px-3 py-2 border rounded-lg mb-2 text-sm bg-white"><option value="">(Nenhuma)</option>${mealOptions.map(opt => `<option value="${opt.name}" ${currentChoice === opt.name ? 'selected' : ''}>${opt.name}</option>`).join('')}</select>`;
                optionsContainer.innerHTML += `<div class="p-3 border rounded-lg bg-gray-50 border-gray-200"><label class="block font-semibold text-gray-700 mb-2">${day}</label>${selectHTML}<input type="text" id="edit-notes-${dayId}" value="${currentNotes}" placeholder="Anota√ß√µes" class="w-full px-3 py-2 border rounded-lg text-sm bg-white"></div>`;
            });
            document.getElementById('edit-order-modal').classList.remove('hidden');
        }

        function generateAndPrintReport() {
            if (allOrders.length === 0) { showToast("N√£o h√° pedidos.", "info"); return; }
            const reportContainer = document.getElementById('print-report');
            const viewRegional = document.getElementById('adminRegionalFilter').value;
            const tituloReg = viewRegional === 'todas' ? 'Todas as Regionais' : `Regional: ${viewRegional}`;
            reportContainer.innerHTML = `<h1>Card√°pio da Semana - ${tituloReg}</h1>`;
            let allDaysHTML = '';
            weekDays.forEach(day => {
                const dayId = getDayId(day);
                if (activeHolidays.includes(dayId)) return;
                let tableHTML = `<div class="report-day-section"><table class="report-table"><thead><tr><th class="rgf-col">RGF</th><th class="nome-col">NOME</th><th class="pedido-col">${day}</th></tr></thead><tbody>`;
                const dailyOrders = allOrders.filter(doc => doc.data()[dayId] && doc.data()[dayId] !== 'FERIADO');
                dailyOrders.forEach(orderDoc => {
                    const order = orderDoc.data();
                    let choice = (order[dayId] || '').toUpperCase();
                    if (choice === 'PRATO PRINCIPAL') choice = 'PRATO';
                    if (order[`${dayId}_notes`]) choice += ` <span style="font-style: italic; font-weight: normal;">(${order[`${dayId}_notes`]})</span>`;
                    tableHTML += `<tr><td>${order.employeeRGF || '-'}</td><td>${order.employeeName}</td><td>${choice}</td></tr>`;
                });
                allDaysHTML += tableHTML + '</tbody></table></div>';
            });
            reportContainer.innerHTML += allDaysHTML; window.print();
        }
        
        async function clearAllOrders() {
            const querySnapshot = await getDocs(pedidosCollectionRef);
            const deletionPromises = [];
            querySnapshot.forEach((doc) => deletionPromises.push(deleteDoc(doc.ref)));
            await Promise.all(deletionPromises);
        }

        // --- UPLOAD ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            fileToUpload = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('uploadImageBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        async function uploadImageAndSaveMenu() {
            if (!fileToUpload) return;
            const selectedHolidays = Array.from(document.querySelectorAll('.holiday-checkbox:checked')).map(cb => cb.value);
            showCustomConfirm("Deseja atualizar o card√°pio? TODOS os pedidos anteriores ser√£o exclu√≠dos.", async () => {
                const btn = document.getElementById('uploadImageBtn');
                btn.disabled = true; btn.textContent = "A enviar...";
                try {
                    const compressedFile = await imageCompression(fileToUpload, { maxSizeMB: 0.5, maxWidthOrHeight: 1024 });
                    const base64String = await new Promise((resolve, reject) => {
                        const reader = new FileReader(); reader.readAsDataURL(compressedFile);
                        reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
                    });
                    await setDoc(menuDocRef, { menuImageBase64: base64String, holidays: selectedHolidays, bloqueado: false });
                    await clearAllOrders();
                    showToast("Card√°pio e Feriados atualizados!", "success");
                    document.getElementById('whatsapp-notification-container').classList.remove('hidden');
                    document.getElementById('imageUpload').value = ''; fileToUpload = null;
                } catch (error) { showToast("Falha ao guardar.", "error"); } 
                finally { btn.disabled = true; btn.textContent = "Salvar Imagem e Feriados"; }
            });
        }

        // --- GEST√ÉO DE SESS√ÉO E ACESSOS ---
        let isAuthenticating = false;
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Se for utilizador an√≥nimo (funcion√°rio normal), apenas mostra a vis√£o de utilizador e para aqui.
                if (user.isAnonymous) {
                    showUserView();
                    return;
                }

                try {
                    let isAdmin = false;
                    try {
                        const adminDocRef = doc(db, 'usuarios_adm', user.uid);
                        const adminDoc = await getDoc(adminDocRef);
                        if (adminDoc.exists()) {
                            const data = adminDoc.data();
                            currentAdminRole = data.role; 
                            currentAdminRegional = data.regionalId || 'todas';
                            isAdmin = true;
                        }
                    } catch (dbError) { console.warn("Lendo BD (normal se sem regra)..."); }

                    if (!isAdmin && user.uid === APP_CONFIG.SUPER_ADMIN_UID) {
                        currentAdminRole = 'super_adm'; currentAdminRegional = 'todas'; isAdmin = true;
                    } 
                    
                    if (isAdmin) {
                        applyAdminRoleUI(); showAdminView();
                    } else {
                        await signOut(auth); showToast("Acesso Negado a conta de Administrador.", "error"); showUserView();
                    }
                } catch(e) { showUserView(); }
            } else {
                if (!auth.currentUser && !isAuthenticating) {
                    isAuthenticating = true;
                    signInAnonymously(auth).catch(err => {
                        console.error("Erro no login an√≥nimo:", err);
                        if (err.code === 'auth/too-many-requests') {
                            showToast("Muitos acessos detectados. Aguarde um instante para o sistema estabilizar.", "error");
                        }
                    }).finally(() => {
                        isAuthenticating = false;
                    });
                }
                showUserView();
            }
        });

        function applyAdminRoleUI() {
            const badge = document.getElementById('admin-role-badge');
            const uploaderSection = document.getElementById('menu-image-uploader-section');
            const filterContainer = document.getElementById('admin-regional-filter-container');
            const regionalSelectAdd = document.getElementById('newEmployeeRegional');
            const superAdminSection = document.getElementById('super-admin-management');
            
            if (currentAdminRole === 'super_adm') {
                badge.textContent = 'üëë ADM PR√ì (Todas Regionais)';
                badge.className = "text-sm font-bold mt-2 inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-800";
                uploaderSection.classList.remove('hidden');
                filterContainer.classList.remove('hidden');
                superAdminSection.classList.remove('hidden'); // Exibe gest√£o de regionais/utilizadores
                document.getElementById('adminRegionalFilter').value = 'todas';
            } else {
                badge.textContent = `üìç ADM Regional (${currentAdminRegional})`;
                badge.className = "text-sm font-bold mt-2 inline-block px-3 py-1 rounded-full bg-green-100 text-green-800";
                uploaderSection.classList.add('hidden'); 
                filterContainer.classList.add('hidden');
                superAdminSection.classList.add('hidden'); 
                document.getElementById('adminRegionalFilter').value = currentAdminRegional; 
                regionalSelectAdd.value = currentAdminRegional; 
                regionalSelectAdd.disabled = true;
            }
            loadConfigurations(); // Recarrega para mostrar as selects
        }

        function showUserView() { document.getElementById('user-view').classList.remove('hidden'); document.getElementById('admin-view').classList.add('hidden'); document.getElementById('admin-login-modal').classList.add('hidden'); loadAndDisplayMenu(); }
        function showAdminView() { document.getElementById('user-view').classList.add('hidden'); document.getElementById('admin-view').classList.remove('hidden'); document.getElementById('admin-login-modal').classList.add('hidden'); loadAndDisplayMenu(); loadAdminData(); loadAndRenderEmployees(); }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Entrando...';
            try { await signInWithEmailAndPassword(auth, document.getElementById('adminEmail').value, document.getElementById('adminPassword').value); } 
            catch (error) { showToast("Email ou senha incorretos.", 'error'); } 
            finally { btn.disabled = false; btn.textContent = 'Entrar'; }
        }

        function main() {
            const rgfInput = document.getElementById('employeeRGF');
            rgfInput.addEventListener('input', () => { findEmployeeByRGF(rgfInput.value); validateForm(); });
            rgfInput.addEventListener('blur', () => localStorage.setItem('employeeRGF', rgfInput.value));
            
            rgfInput.value = localStorage.getItem('employeeRGF') || '';
            if(rgfInput.value) { findEmployeeByRGF(rgfInput.value); validateForm(); }
            
            document.getElementById('wizard-options').addEventListener('click', handleWizardSelection);
            document.getElementById('openConfirmationModal').addEventListener('click', openConfirmationModal);
            document.getElementById('submitOrder').addEventListener('click', submitOrder);
            document.querySelectorAll('.cancel-modal-btn, #custom-confirm-cancel-btn').forEach(btn => { btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.add('hidden')); });
            document.getElementById('switchToAdmin').addEventListener('click', () => document.getElementById('admin-login-modal').classList.remove('hidden'));
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            document.getElementById('adminLogoutBtn').addEventListener('click', async () => { await signOut(auth); window.location.reload(); });
            document.getElementById('switchToUserFromAdmin').addEventListener('click', showUserView);
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('employee-list-container').addEventListener('click', (e) => {
                if (e.target.closest('.edit-employee-btn')) openEmployeeEditModal(e.target.closest('.edit-employee-btn').dataset.id);
                if (e.target.closest('.delete-employee-btn')) handleDeleteEmployee(e.target.closest('.delete-employee-btn').dataset.id, e.target.closest('.delete-employee-btn').dataset.name);
            });
            document.getElementById('edit-employee-form').addEventListener('submit', handleSaveEmployeeChanges);
            document.getElementById('ordersTableContainer').addEventListener('click', (e) => {
                if (e.target.closest('.edit-order-btn')) openEditOrderModal(e.target.closest('.edit-order-btn').dataset.id); 
                if (e.target.closest('.delete-order-btn')) showCustomConfirm("Excluir pedido?", async () => { await deleteDoc(doc(db, "pedidosDaSemana", e.target.closest('.delete-order-btn').dataset.id)); showToast("Pedido exclu√≠do", 'success'); });
            });
            document.getElementById('edit-order-form').addEventListener('submit', async (e) => {
                e.preventDefault(); const id = document.getElementById('edit-order-id').value; const updateData = {};
                weekDays.forEach(day => {
                    const dayId = getDayId(day); if (activeHolidays.includes(dayId)) return;
                    const sel = document.getElementById(`edit-choice-${dayId}`);
                    if (sel) { updateData[dayId] = sel.value; updateData[`${dayId}_notes`] = document.getElementById(`edit-notes-${dayId}`).value; }
                });
                await updateDoc(doc(db, "pedidosDaSemana", id), updateData); showToast("Atualizado!", 'success'); document.getElementById('edit-order-modal').classList.add('hidden');
            });
            document.getElementById('adminRegionalFilter').addEventListener('change', () => { loadAndRenderEmployees(); loadAdminData(); });
            document.getElementById('toggleMenuLockBtn').addEventListener('click', toggleMenuLock);
            document.getElementById('searchInput').addEventListener('input', () => renderOrdersTable(allOrders));
            document.getElementById('generateReportBtn').addEventListener('click', generateAndPrintReport);
            document.getElementById('notifyWhatsAppBtn').addEventListener('click', () => window.open(`https://api.whatsapp.com/send?text=O%20card%C3%A1pio%20da%20semana%20foi%20atualizado!%20%E2%9C%A8%20%0A%0A%F0%9F%91%89%20${encodeURIComponent(window.location.href)}`));
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            document.getElementById('uploadImageBtn').addEventListener('click', uploadImageAndSaveMenu);

            const zoomModal = document.getElementById('image-zoom-modal'); const menuImg = document.getElementById('menu-image');
            menuImg.addEventListener('click', () => { document.getElementById('zoomed-image').src = menuImg.src; zoomModal.classList.remove('hidden'); });
            zoomModal.addEventListener('click', () => zoomModal.classList.add('hidden'));

            // --- L√ìGICA DE SUPER ADMIN (Criar Regional e ADMs) ---
            document.getElementById('addRegionalBtn').addEventListener('click', async () => {
                const val = document.getElementById('newRegionalInput').value.trim();
                if(!val) return;
                if(regionaisAtivas.includes(val)) { showToast('Regional j√° existe!', 'error'); return; }
                const novasReg = [...regionaisAtivas, val];
                try { await updateDoc(configDocRef, { regionais: novasReg }); document.getElementById('newRegionalInput').value = ''; showToast('Regional adicionada!', 'success'); } 
                catch(e) { showToast('Erro ao adicionar.', 'error'); }
            });

            document.getElementById('newAdmRole').addEventListener('change', (e) => {
                document.getElementById('newAdmRegionalContainer').style.display = e.target.value === 'super_adm' ? 'none' : 'block';
            });

            document.getElementById('create-adm-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('newAdmEmail').value.trim();
                const pwd = document.getElementById('newAdmPassword').value;
                const role = document.getElementById('newAdmRole').value;
                const reg = document.getElementById('newAdmRegional').value;
                const btn = e.target.querySelector('button');
                btn.disabled = true; btn.textContent = 'A criar...';
                
                try {
                    // Usamos uma app Firebase secund√°ria para criar o ADM sem deslogar o Super ADM atual!
                    const secondaryApp = initializeApp(firebaseConfig, "SecondaryAppToCreateUsers");
                    const secondaryAuth = getAuth(secondaryApp);
                    const cred = await createUserWithEmailAndPassword(secondaryAuth, email, pwd);
                    
                    await setDoc(doc(db, "usuarios_adm", cred.user.uid), {
                        email: email, role: role, regionalId: role === 'super_adm' ? 'todas' : reg
                    });
                    
                    await signOut(secondaryAuth);
                    showToast("Administrador criado com sucesso!", "success");
                    e.target.reset();
                } catch(err) {
                    console.error(err);
                    showToast("Erro ao criar utilizador. A senha tem mais de 6 caracteres?", "error");
                } finally {
                    btn.disabled = false; btn.textContent = 'Criar Administrador';
                }
            });
        }
        main();
    </script>
</body>
</html>
