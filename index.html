<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Del√≠cias Urbanas - App de Pedidos com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Lobster Two', cursive; }
        .menu-option-card:has(input:checked) { border-color: #2563eb; background-color: #eff6ff; transform: scale(1.02); }
        .menu-option-card:has(input:checked) .checkmark { opacity: 1; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-print { }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); max-height: 90vh; overflow-y: auto; width: 90%; max-width: 640px; }
        input:read-only { background-color: #f3f4f6; cursor: not-allowed; }

        #print-report { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 15mm; }
            .no-print { display: none !important; }
            body > *:not(#print-report) { display: none !important; }
            #print-report { display: block !important; }
            #print-report h1 { font-size: 20pt; text-align: center; margin-bottom: 12px; font-family: 'Poppins', sans-serif; }
            #print-report .report-day-section { margin-bottom: 20px; page-break-inside: avoid; }
            #print-report .report-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
            #print-report th, #print-report td { border: 1px solid #ccc; padding: 6px; text-align: left; }
            #print-report th { background-color: #e2e8f0; font-weight: 600; }
            #print-report .rgf-col { width: 15%; } #print-report .nome-col { width: 60%; } #print-report .pedido-col { width: 25%; background-color: #dbeafe; font-weight: bold; }
        }

        /* Estilos para o Toast/Feedback */
        #app-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Permite cliques atrav√©s do toast */
        }
        #app-toast.show {
            opacity: 1;
            pointer-events: auto;
        }
        #app-toast.success { background-color: #4CAF50; }
        #app-toast.error { background-color: #f44336; }
        #app-toast.info { background-color: #2196F3; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-20">
        
        <div id="user-view" class="no-print">
            <div id="form-container">
                <header class="text-center mb-8"><h1 class="font-brand text-5xl text-blue-600">Del√≠cias Urbanas</h1><p class="mt-2 text-md text-gray-500">O seu card√°pio da semana est√° servido!</p></header>
                
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h2 class="block text-lg font-semibold text-gray-800 mb-2">üë§ 1. Identifica√ß√£o</h2>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div><label for="employeeRGF" class="block text-sm font-medium text-gray-700">Seu RGF</label><input type="text" id="employeeRGF" placeholder="Digite o seu RGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg"></div>
                        <div><label for="employeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="employeeName" placeholder="Preenchido automaticamente" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6"><h2 class="text-lg font-semibold text-gray-800 mb-4">üç≤ 2. Escolha os seus pratos</h2><div id="menu" class="space-y-8"><div class="text-center text-gray-500">A carregar o card√°pio...</div></div></div>
                <div id="guidanceSection" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mb-6"><p id="guidanceText" class="font-semibold">Digite seu RGF e escolha uma op√ß√£o para cada dia.</p></div>
                <div id="submitButtonContainer" class="hidden text-center"><button id="openConfirmationModal" class="w-full sm:w-auto bg-green-500 text-white font-bold text-lg px-8 py-3 rounded-xl hover:bg-green-600 shadow-lg">Revisar e Finalizar Pedido</button></div>
            </div>
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Fazer Novo Pedido</button></div>
            <footer class="text-center mt-10">
                <button id="switchToAdmin" class="text-sm text-gray-500 hover:text-blue-600">Aceder ao Painel do Administrador</button>
            </footer>
        </div>

        <div id="admin-view" class="hidden no-print">
            <header class="text-center border-b pb-6 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Painel do Administrador</h1>
                <p class="text-lg text-gray-600 mt-1">Del√≠cias Urbanas</p>
                <div class="mt-4">
                    <button id="adminLogoutBtn" class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600">Sair do Painel</button>
                </div>
            </header>
            <div class="mb-8">
                <button id="switchToUserFromAdmin" class="text-sm text-gray-500 hover:text-blue-600">‚Üê Voltar para o Card√°pio (Vis√£o Usu√°rio)</button>
            </div>
            
            <section id="employee-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üë• Gerenciamento de Funcion√°rios</h2>
                <form id="add-employee-form" class="grid sm:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="newEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label>
                        <input type="text" id="newEmployeeRGF" placeholder="RGF do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="newEmployeeName" placeholder="Nome do funcion√°rio" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Funcion√°rio</button>
                </form>
                <div id="employee-list-container" class="overflow-x-auto">
                    <p class="text-gray-500">A carregar lista de funcion√°rios...</p>
                </div>
            </section>

            <section id="menu-updater-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-4">ü§ñ Atualizar Card√°pio com Imagem (IA)</h2>
                <p class="text-gray-600 mb-4">Envie uma imagem do novo card√°pio. A nossa intelig√™ncia artificial ir√° ler e preencher os campos para si.</p>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" class="mt-4 rounded-lg max-h-80 hidden" />
                <div id="image-processor-container" class="mt-4 text-center hidden"><button id="processImageBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Analisar Card√°pio</button></div>
                <div id="loader" class="hidden mx-auto my-4 loader"></div>
                <div id="confirmation-form" class="hidden mt-6"></div>
            </section>
            
            <section id="dashboard-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">üìä Dashboard de Totais da Semana</h2>
                <div id="admin-dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><p class="text-gray-500">A calcular totais...</p></div>
            </section>

            <section id="orders-section">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Pedidos Recebidos</h2>
                    <div class="w-full sm:w-auto"><input type="text" id="searchInput" placeholder="üîé Buscar por nome..." class="w-full sm:w-64 px-4 py-2 border rounded-lg"></div>
                    <button id="generateReportBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">üñ®Ô∏è Salvar Relat√≥rio como PDF</button>
                </div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>
        </div>
    </div>

    <div id="edit-order-modal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Editar Pedido</h2>
            <form id="edit-order-form">
                 <input type="hidden" id="edit-order-id">
                <div class="mb-4">
                    <label class="block text-lg font-semibold text-gray-800 mb-2">Nome do Funcion√°rio</label>
                    <input type="text" id="edit-order-employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                </div>
                <div id="edit-menu-options" class="space-y-6"></div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancel-order-edit" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-employee-modal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Editar Funcion√°rio</h2>
            <form id="edit-employee-form">
                <div class="mb-4">
                    <label for="editEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label>
                    <input type="text" id="editEmployeeRGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly>
                </div>
                <div class="mb-4">
                    <label for="editEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                    <input type="text" id="editEmployeeName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancel-employee-edit" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay hidden no-print">
        <div class="modal-content fade-in">
            <h2 class="text-2xl font-bold mb-4">Confirme o seu Pedido</h2>
            <p class="mb-6 text-gray-600">Por favor, revise as suas escolhas antes de enviar.</p>
            <div id="confirmation-summary" class="space-y-2 mb-8"></div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-confirmation" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Editar</button>
                <button id="submitOrder" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">Confirmar e Enviar</button>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="modal-overlay hidden no-print">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Aceder ao Painel de Administrador</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="adminEmail" placeholder="seu-email@exemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="adminPassword" placeholder="Sua senha" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="cancel-admin-login" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="print-report"></div>
    <div id="app-toast" class="hidden"></div> <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import imageCompression from 'https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js';

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI",
          authDomain: "cardapio-8ddea.firebaseapp.com",
          projectId: "cardapio-8ddea",
          storageBucket: "cardapio-8ddea.firebasestorage.app",
          messagingSenderId: "1019677985212",
          appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- CONSTANTES E CONFIGURA√á√ïES DA APLICA√á√ÉO ---
        const APP_CONFIG = {
            ADMIN_UID: 'LqAXao4FuOQAvzS3uQAd9et6OnK2', // SEU UID DE ADMINISTRADOR J√Å INSERIDO AQUI
        };

        const menuDocRef = doc(db, "cardapio", "semanal");
        const pedidosCollectionRef = collection(db, "pedidosDaSemana");
        const funcionariosCollectionRef = collection(db, "funcionarios");

        // --- ESTADO DA APLICA√á√ÉO ---
        const opcoesFixas = [{ name: 'Omelete', emoji: 'üç≥' }, { name: 'Fil√© de frango', emoji: 'üêî' }];
        let menuDaSemana = [];
        let allOrders = [];
        let tempOrderData = {};
        let isAdminLoggedIn = false; // Estado para controlar o login do admin

        // --- FUN√á√ïES AUXILIARES ---
        // Fun√ß√£o para gerar IDs de dia consistentes
        function getDayId(dayName) {
            return dayName.replace(/[^a-zA-Z]/g, "").toLowerCase();
        }

        // Fun√ß√£o para exibir mensagens Toast
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('app-toast');
            toast.textContent = message;
            toast.className = 'fade-in show'; // Reseta classes e adiciona 'show'
            toast.classList.add(type);

            setTimeout(() => {
                toast.classList.remove('show');
                // Pequeno delay para a anima√ß√£o fade-out antes de remover as classes de tipo
                setTimeout(() => {
                    toast.className = ''; // Remove todas as classes
                    toast.classList.add('hidden'); // Esconde o elemento
                }, 300); 
            }, duration);
            toast.classList.remove('hidden'); // Garante que esteja vis√≠vel
        }

        // --- GERENCIAMENTO DE FUNCION√ÅRIOS ---
        function loadAndRenderEmployees() {
            const q = query(funcionariosCollectionRef, orderBy("nome"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('employee-list-container');
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum funcion√°rio cadastrado.</p>';
                    return;
                }
                let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">RGF</th><th class="py-2 px-3 border-b text-left">Nome</th><th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    tableHTML += `<tr>
                        <td class="py-2 px-3 border-b font-mono">${doc.id}</td>
                        <td class="py-2 px-3 border-b font-semibold">${employee.nome}</td>
                        <td class="py-2 px-3 border-b space-x-2">
                            <button data-id="${doc.id}" data-name="${employee.nome}" class="edit-employee-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button>
                            <button data-id="${doc.id}" class="delete-employee-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button>
                        </td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            });
        }

        async function handleAddEmployee(e) {
            e.preventDefault();
            const rgfInput = document.getElementById('newEmployeeRGF');
            const nameInput = document.getElementById('newEmployeeName');
            const rgf = rgfInput.value.trim();
            const nome = nameInput.value.trim();

            if (!rgf || !nome) {
                showToast("Por favor, preencha o RGF e o Nome.", 'error');
                return;
            }

            try {
                // Tenta buscar para ver se o RGF j√° existe
                const docSnap = await getDoc(doc(db, "funcionarios", rgf));
                if (docSnap.exists()) {
                    showToast("RGF j√° cadastrado para: " + docSnap.data().nome, 'info');
                    return;
                }

                await setDoc(doc(db, "funcionarios", rgf), { nome });
                showToast("Funcion√°rio adicionado com sucesso!", 'success');
                rgfInput.value = '';
                nameInput.value = '';
            } catch (error) {
                console.error("Erro ao adicionar funcion√°rio: ", error);
                showToast("Ocorreu um erro ao adicionar o funcion√°rio: " + error.message, 'error');
            }
        }

        async function handleDeleteEmployee(rgf) {
            if (confirm(`Tem a certeza que deseja excluir o funcion√°rio com RGF ${rgf}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                try {
                    await deleteDoc(doc(db, "funcionarios", rgf));
                    showToast("Funcion√°rio exclu√≠do com sucesso.", 'success');
                } catch (error) {
                    console.error("Erro ao excluir funcion√°rio: ", error);
                    showToast("Falha ao excluir o funcion√°rio: " + error.message, 'error');
                }
            }
        }
        
        function openEmployeeEditModal(rgf, nome) {
            document.getElementById('editEmployeeRGF').value = rgf;
            document.getElementById('editEmployeeName').value = nome;
            document.getElementById('edit-employee-modal').classList.remove('hidden');
        }

        async function handleSaveEmployeeChanges(e) {
            e.preventDefault();
            const rgf = document.getElementById('editEmployeeRGF').value;
            const newName = document.getElementById('editEmployeeName').value.trim();

            if (!newName) {
                showToast("O nome n√£o pode ficar em branco.", 'error');
                return;
            }
            try {
                await updateDoc(doc(db, "funcionarios", rgf), { nome: newName });
                showToast("Funcion√°rio atualizado com sucesso!", 'success');
                document.getElementById('edit-employee-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar altera√ß√µes do funcion√°rio: ", error);
                showToast("Falha ao salvar as altera√ß√µes do funcion√°rio: " + error.message, 'error');
            }
        }
        
        // --- L√ìGICA DE AUTOCOMPLETE ---
        async function findEmployeeByRGF(rgf) {
            const nameInput = document.getElementById('employeeName');
            if (!rgf) {
                nameInput.value = '';
                nameInput.placeholder = 'Preenchido automaticamente';
                return;
            }
            try {
                const employeeDocRef = doc(db, "funcionarios", rgf);
                const docSnap = await getDoc(employeeDocRef);
                if (docSnap.exists()) {
                    nameInput.value = docSnap.data().nome;
                    validateForm();
                } else {
                    nameInput.value = '';
                    nameInput.placeholder = 'RGF n√£o encontrado';
                    // showToast("RGF n√£o encontrado. Verifique o RGF ou pe√ßa para um administrador cadastr√°-lo.", 'info', 5000); // Opcional, se quiser um toast aqui
                }
            } catch (error) {
                console.error("Erro ao buscar funcion√°rio:", error);
                nameInput.value = '';
                nameInput.placeholder = 'Erro na busca';
                showToast("Erro ao buscar funcion√°rio: " + error.message, 'error');
            }
        }
        
        // --- L√ìGICA PRINCIPAL DO USU√ÅRIO ---
        function createFallbackMenu() {
            const days = ['Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];
            return days.map(day => ({ day, pratoPrincipal: { name: 'Card√°pio n√£o definido', emoji: 'ü§∑' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } }));
        }

        async function loadAndDisplayMenu() {
            try {
                const docSnap = await getDoc(menuDocRef);
                menuDaSemana = (docSnap.exists() && docSnap.data().menu?.length > 0) ? docSnap.data().menu : createFallbackMenu();
            } catch (error) {
                console.error("Erro ao carregar o card√°pio:", error);
                showToast("Erro ao carregar o card√°pio. Usando card√°pio padr√£o.", 'error');
                menuDaSemana = createFallbackMenu();
            }
            createMenuHTML();
        }
        
        function createMenuHTML() {
            const menuContainer = document.getElementById('menu');
            if (!menuContainer) return;
            menuContainer.innerHTML = '';
            menuDaSemana.forEach(item => {
                const dayId = getDayId(item.day); // Usando a fun√ß√£o auxiliar
                const allOptions = [
                    { ...item.pratoPrincipal, type: 'Prato Principal' },
                    ...(item.opcao?.name ? [{ ...item.opcao, type: 'Op√ß√£o do Dia' }] : []),
                    ...opcoesFixas.map(fixa => ({ ...fixa, type: 'Op√ß√£o Fixa' })),
                    { name: 'N√£o vou almo√ßar', emoji: '‚úñÔ∏è', type: 'Aus√™ncia' }
                ];

                let dayHTML = `<div class="day-section"><h3 class="text-xl font-bold text-gray-800">${item.day}</h3><div class="text-sm font-semibold text-blue-600 bg-blue-100 rounded-full inline-block px-3 py-1 mb-3">Guarni√ß√£o: ${item.guarnicao.name} ${item.guarnicao.emoji}</div><div class="space-y-3">`;
                allOptions.forEach((option) => {
                    if (option.name) {
                        dayHTML += `<label class="menu-option-card block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-transform duration-200"><input type="radio" name="${dayId}" value="${option.name}" class="hidden"><div class="flex items-center"><span class="text-3xl mr-4">${option.emoji}</span><div class="flex-grow"><p class="font-semibold text-gray-800">${option.name}</p><p class="text-sm text-gray-500">${option.type}</p></div><svg xmlns="http://www.w3.org/2000/svg" class="checkmark h-6 w-6 text-blue-600 opacity-0 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" /></svg></div></label>`;
                    }
                });
                dayHTML += `</div></div>`;
                menuContainer.innerHTML += dayHTML;
            });
            validateForm();
        }

        function validateForm() {
            const name = document.getElementById('employeeName')?.value.trim();
            const rgf = document.getElementById('employeeRGF')?.value.trim();
            const guidanceSection = document.getElementById('guidanceSection');
            const guidanceText = document.getElementById('guidanceText');
            const submitBtnContainer = document.getElementById('submitButtonContainer');
            if (!name || !rgf || !guidanceSection) return;

            const missingDays = menuDaSemana.filter(item => !document.querySelector(`input[name="${getDayId(item.day)}"]:checked`)).map(item => item.day);
            
            if (name && rgf && missingDays.length === 0) {
                guidanceSection.classList.add('hidden');
                submitBtnContainer.classList.remove('hidden');
            } else {
                submitBtnContainer.classList.add('hidden');
                guidanceSection.classList.remove('hidden');
                let message = '';
                if(!rgf) message = 'Digite seu RGF para come√ßar. ';
                else if(!name) message = 'RGF n√£o encontrado no sistema. Verifique o RGF ou pe√ßa para um administrador cadastr√°-lo. ';
                if (missingDays.length > 0) message += `Falta selecionar op√ß√µes para: ${missingDays.join(', ')}.`;
                guidanceText.textContent = message || 'Por favor, preencha todos os campos.';
            }
        }

        function openConfirmationModal() {
            tempOrderData = {
                employeeName: document.getElementById('employeeName').value.trim(),
                employeeRGF: document.getElementById('employeeRGF').value.trim(),
                timestamp: serverTimestamp()
            };
            const summaryContainer = document.getElementById('confirmation-summary');
            summaryContainer.innerHTML = '';
            menuDaSemana.forEach(item => {
                const dayId = getDayId(item.day); // Usando a fun√ß√£o auxiliar
                const choice = document.querySelector(`input[name="${dayId}"]:checked`).value;
                tempOrderData[dayId] = choice;
                summaryContainer.innerHTML += `<p><span class="font-bold">${item.day}:</span> ${choice}</p>`;
            });
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        async function submitOrder() {
            const button = document.getElementById('submitOrder');
            button.disabled = true; 
            button.textContent = 'A enviar...';
            try {
                await addDoc(pedidosCollectionRef, tempOrderData);
                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('form-container').classList.add('hidden');
                const successMessage = document.getElementById('success-message');
                document.getElementById('success-text').textContent = `Obrigado, ${tempOrderData.employeeName}. O seu pedido foi registado com sucesso.`;
                successMessage.classList.remove('hidden');
                showToast("Pedido enviado com sucesso!", 'success');
            } catch (error) {
                console.error("Erro ao enviar pedido: ", error);
                showToast("Ocorreu um erro ao enviar o seu pedido. Tente novamente: " + error.message, 'error');
            } finally {
                button.disabled = false; 
                button.textContent = 'Confirmar e Enviar';
            }
        }
        
        // --- FUN√á√ïES DA √ÅREA DO ADMINISTRADOR ---
        function loadAdminData() {
            // A query agora filtra os pedidos para mostrar apenas os mais recentes por funcion√°rio
            // Isso assume que o pedido mais recente de cada funcion√°rio √© o que interessa para o dashboard/tabela
            onSnapshot(pedidosCollectionRef, (snapshot) => {
                const latestOrdersMap = new Map(); // Map<employeeRGF, {orderDoc, timestamp}>
                snapshot.forEach(doc => {
                    const orderData = doc.data();
                    const rgf = orderData.employeeRGF;
                    const timestamp = orderData.timestamp ? orderData.timestamp.toMillis() : 0; // Converte Timestamp para millis

                    if (rgf) { // Garante que o RGF existe
                        if (!latestOrdersMap.has(rgf) || timestamp > latestOrdersMap.get(rgf).timestamp) {
                            latestOrdersMap.set(rgf, { orderDoc: doc, timestamp: timestamp });
                        }
                    }
                });
                
                // Converte o mapa para um array de documentos e ordena pelo nome do funcion√°rio
                allOrders = Array.from(latestOrdersMap.values())
                    .map(item => item.orderDoc)
                    .sort((a, b) => a.data().employeeName.localeCompare(b.data().employeeName));

                updateDashboard(allOrders);
                renderOrdersTable(allOrders);
            }, (error) => {
                console.error("Erro ao carregar dados do administrador:", error);
                showToast("Erro ao carregar dados do administrador: " + error.message, 'error');
            });
        }


        function updateDashboard(orders) {
            const dashboard = document.getElementById('admin-dashboard');
            if (orders.length === 0) {
                dashboard.innerHTML = '<p class="text-gray-500">Nenhum pedido para calcular totais.</p>';
                return;
            }

            const dailyCounts = {};
            menuDaSemana.forEach(dayItem => {
                dailyCounts[dayItem.day] = {}; // Inicializa para cada dia
                orders.forEach(orderDoc => {
                    const dayId = getDayId(dayItem.day); // Usando a fun√ß√£o auxiliar
                    const choice = orderDoc.data()[dayId];
                    if (choice && choice !== 'N√£o vou almo√ßar') {
                        dailyCounts[dayItem.day][choice] = (dailyCounts[dayItem.day][choice] || 0) + 1;
                    }
                });
            });

            dashboard.innerHTML = '';
            Object.entries(dailyCounts).forEach(([day, counts]) => {
                let dayHTML = `<div class="p-4 bg-gray-50 rounded-lg"><h3 class="font-bold text-lg text-gray-800 mb-2">${day}</h3><div class="space-y-1">`;
                const sortedCounts = Object.entries(counts).sort(([,a],[,b]) => b - a);
                if (sortedCounts.length === 0) {
                    dayHTML += `<p class="text-sm text-gray-500">Nenhum pedido neste dia.</p>`;
                } else {
                    sortedCounts.forEach(([item, count]) => {
                        dayHTML += `<div class="flex justify-between text-sm"><span class="text-gray-600">${item}</span><span class="font-semibold text-blue-700">${count}</span></div>`;
                    });
                }
                dayHTML += '</div></div>';
                dashboard.innerHTML += dayHTML;
            });
        }

        function renderOrdersTable(orders) {
            const container = document.getElementById('ordersTableContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredOrders = orders.filter(doc => doc.data().employeeName.toLowerCase().includes(searchTerm));

            if (filteredOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum pedido encontrado.</p>';
                return;
            }

            let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">Funcion√°rio</th><th class="py-2 px-3 border-b text-left">RGF</th>`;
            menuDaSemana.forEach(item => tableHTML += `<th class="py-2 px-3 border-b text-left">${item.day.substring(0,3)}</th>`);
            tableHTML += `<th class="py-2 px-3 border-b text-left">A√ß√µes</th></tr></thead><tbody>`;

            filteredOrders.forEach(doc => {
                const order = doc.data();
                tableHTML += `<tr><td class="py-2 px-3 border-b font-bold">${order.employeeName}</td><td class="py-2 px-3 border-b">${order.employeeRGF || 'N/A'}</td>`;
                menuDaSemana.forEach(dayMenuItem => {
                    const dayId = getDayId(dayMenuItem.day); // Usando a fun√ß√£o auxiliar
                    let choice = order[dayId] || 'N/A';
                    if (choice === dayMenuItem.pratoPrincipal.name) choice = 'Prato';
                    else if (dayMenuItem.opcao?.name && choice === dayMenuItem.opcao.name) choice = 'Op√ß√£o';
                    tableHTML += `<td class="py-2 px-3 border-b">${choice}</td>`;
                });
                tableHTML += `<td class="py-2 px-3 border-b space-x-2"><button data-id="${doc.id}" class="edit-order-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button><button data-id="${doc.id}" class="delete-order-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button></td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function generateAndPrintReport() {
            const reportContainer = document.getElementById('print-report');
            reportContainer.innerHTML = '<h1>Relat√≥rio de Pedidos da Semana - Regional Quatinga</h1>';
            
            menuDaSemana.forEach(dayMenuItem => {
                const dayId = getDayId(dayMenuItem.day); // Usando a fun√ß√£o auxiliar
                let tableHTML = `<div class="report-day-section"><table class="report-table"><thead><tr><th class="rgf-col">RGF</th><th class="nome-col">NOME</th><th class="pedido-col">${dayMenuItem.day}</th></tr></thead><tbody>`;
                
                const dailyOrders = allOrders.filter(orderDoc => {
                    const choice = orderDoc.data()[dayId];
                    return choice && choice !== 'N√£o vou almo√ßar';
                });
                
                dailyOrders.sort((a,b) => a.data().employeeName.localeCompare(b.data().employeeName));

                dailyOrders.forEach(orderDoc => {
                    const order = orderDoc.data();
                    let choice = order[dayId];
                    if (choice === dayMenuItem.pratoPrincipal.name) choice = 'Prato';
                    else if (dayMenuItem.opcao?.name && choice === dayMenuItem.opcao.name) choice = 'Op√ß√£o';
                    tableHTML += `<tr><td>${order.employeeRGF || 'N/A'}</td><td>${order.employeeName}</td><td>${choice}</td></tr>`;
                });
                
                tableHTML += '</tbody></table></div>';
                reportContainer.innerHTML += tableHTML;
            });
            
            window.print();
        }

        async function openOrderEditModal(docId) {
            const modal = document.getElementById('edit-order-modal');
            const formContent = document.getElementById('edit-menu-options');
            const employeeNameInput = document.getElementById('edit-order-employeeName');
            const orderIdInput = document.getElementById('edit-order-id');

            formContent.innerHTML = '<p class="text-center text-gray-500">A carregar dados do pedido...</p>';
            modal.classList.remove('hidden');

            try {
                const orderDocRef = doc(db, "pedidosDaSemana", docId);
                const docSnap = await getDoc(orderDocRef);

                if (!docSnap.exists()) {
                    showToast("Erro: Pedido n√£o encontrado.", 'error');
                    modal.classList.add('hidden');
                    return;
                }

                const orderData = docSnap.data();
                employeeNameInput.value = orderData.employeeName;
                orderIdInput.value = docId;
                formContent.innerHTML = '';

                menuDaSemana.forEach(item => {
                    const dayId = getDayId(item.day); // Usando a fun√ß√£o auxiliar
                    const currentChoice = orderData[dayId];
                    const allOptions = [
                        { ...item.pratoPrincipal },
                        ...(item.opcao?.name ? [{ ...item.opcao }] : []),
                        ...opcoesFixas,
                        { name: 'N√£o vou almo√ßar', emoji: '‚úñÔ∏è' }
                    ];

                    let dayHTML = `<fieldset class="day-section border p-4 rounded-lg"><legend class="font-bold text-lg text-gray-800 px-2">${item.day}</legend><div class="space-y-2 mt-2">`;
                    allOptions.forEach((option, index) => {
                        if (option.name) {
                            const uniqueId = `${dayId}-${index}`;
                            const isChecked = (option.name === currentChoice) ? 'checked' : '';
                            dayHTML += `
                                <div class="flex items-center">
                                    <input type="radio" id="${uniqueId}" name="${dayId}" value="${option.name}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${isChecked} required>
                                    <label for="${uniqueId}" class="ml-3 block text-sm font-medium text-gray-700">${option.emoji || ''} ${option.name}</label>
                                </div>`;
                        }
                    });
                    dayHTML += `</div></fieldset>`;
                    formContent.innerHTML += dayHTML;
                });
            } catch (error) {
                console.error("Erro ao abrir modal de edi√ß√£o:", error);
                showToast("N√£o foi poss√≠vel carregar os dados do pedido para edi√ß√£o: " + error.message, 'error');
                modal.classList.add('hidden');
            }
        }

        async function saveOrderChanges(event) {
            event.preventDefault();
            const button = event.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'A salvar...';

            const docId = document.getElementById('edit-order-id').value;
            const updateData = {};

            menuDaSemana.forEach(item => {
                const dayId = getDayId(item.day); // Usando a fun√ß√£o auxiliar
                const selectedOption = document.querySelector(`#edit-order-form input[name="${dayId}"]:checked`);
                if (selectedOption) {
                    updateData[dayId] = selectedOption.value;
                }
            });

            try {
                await updateDoc(doc(db, "pedidosDaSemana", docId), updateData);
                showToast("Pedido atualizado com sucesso!", 'success');
                document.getElementById('edit-order-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar altera√ß√µes do pedido:", error);
                showToast("Falha ao salvar as altera√ß√µes do pedido: " + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Salvar Altera√ß√µes';
            }
        }

        async function deleteOrder(docId) {
            if (confirm(`Tem a certeza que deseja excluir este pedido? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                try {
                    await deleteDoc(doc(db, "pedidosDaSemana", docId));
                    showToast("Pedido exclu√≠do com sucesso.", 'success');
                } catch (error) {
                    console.error("Erro ao excluir pedido: ", error);
                    showToast("Falha ao excluir o pedido: " + error.message, 'error');
                }
            }
        }

        // --- FUN√á√ïES DE ATUALIZA√á√ÉO DE CARD√ÅPIO POR IA ---
        const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
        
        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const file = event.target.files[0]; 
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('image-processor-container').classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        });

        document.getElementById('processImageBtn').addEventListener('click', async () => {
            const loader = document.getElementById('loader'); 
            const button = document.getElementById('processImageBtn'); 
            const confirmationForm = document.getElementById('confirmation-form');
            
            button.disabled = true; 
            button.textContent = 'A analisar...'; 
            loader.classList.remove('hidden'); 
            confirmationForm.classList.add('hidden');
            
            const file = document.getElementById('imageUpload').files[0]; 

            // Op√ß√µes de compress√£o
            const options = {
                maxSizeMB: 1.5,           // Aumentado um pouco para melhor qualidade se necess√°rio
                maxWidthOrHeight: 1500, // Aumentado para melhor detalhe para IA
                useWebWorker: true      
            };

            let compressedFile;
            try {
                compressedFile = await imageCompression(file, options);
                console.log('Imagem original (bytes):', file.size);
                console.log('Imagem comprimida (bytes):', compressedFile.size);
            } catch (error) {
                console.error("Erro ao comprimir imagem:", error);
                showToast("Erro ao comprimir a imagem. Tente novamente.", 'error');
                button.disabled = false; 
                button.textContent = 'Analisar Card√°pio'; 
                loader.classList.add('hidden');
                return; 
            }

            const base64ImageData = (await toBase64(compressedFile)).split(',')[1];
            const prompt = `Analise a imagem deste card√°pio. Extraia as informa√ß√µes para cada dia da semana (de Segunda a Sexta). Para cada dia, identifique o 'Prato Principal', a 'Op√ß√£o' e a 'Guarni√ß√£o'.
            Retorne os dados EXCLUSIVAMENTE como um objeto JSON. A estrutura do JSON deve ser:
            {
              "menu": [
                {"day": "Segunda-feira", "pratoPrincipal": {"name": "Nome do Prato Principal", "emoji": "üçΩÔ∏è"}, "opcao": {"name": "Nome da Op√ß√£o", "emoji": "ü•£"}, "guarnicao": {"name": "Nome da Guarni√ß√£o", "emoji": "ü•ó"}},
                // ... repita para Ter√ßa, Quarta, Quinta, Sexta
              ]
            }
            Se um campo n√£o existir para um dia (ex: sem 'Op√ß√£o'), o valor de 'name' deve ser uma string vazia (""). Atribua emojis apropriados e variados para cada prato e guarni√ß√£o, se poss√≠vel, mas se n√£o tiver certeza, use os emojis padr√£o (üçΩÔ∏è, ü•£, ü•ó).`;
            
            const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: compressedFile.type, data: base64ImageData } }] }] };
            const apiKey = firebaseConfig.apiKey; // Reutilizando a apiKey do Firebase para Gemini
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`; 

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { 
                    const errorBody = await response.json(); 
                    console.error("Erro na resposta da API Gemini:", errorBody);
                    throw new Error(`Erro da API Gemini: ${errorBody.error.message || response.statusText}`); 
                }
                const result = await response.json();
                
                // Extra√ß√£o e valida√ß√£o robusta da resposta da IA
                let textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResponse) {
                    throw new Error("Resposta da IA vazia ou mal formatada.");
                }
                
                // Tenta limpar e parsear o JSON
                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                const menuData = JSON.parse(textResponse);

                // Valida√ß√£o da estrutura JSON
                if (!menuData || !Array.isArray(menuData.menu) || menuData.menu.length === 0) {
                    throw new Error("Estrutura do JSON da IA inv√°lida: 'menu' n√£o √© um array ou est√° vazio.");
                }
                
                displayConfirmationForm(menuData.menu);

            } catch (error) { 
                console.error("Erro ao analisar a imagem ou processar IA:", error); 
                showToast("Ocorreu um erro ao ler a imagem ou analisar com IA: " + error.message, 'error', 8000); 
            } 
            finally { 
                button.disabled = false; 
                button.textContent = 'Analisar Card√°pio'; 
                loader.classList.add('hidden'); 
            }
        });

        function displayConfirmationForm(menuData) {
            const container = document.getElementById('confirmation-form'); 
            container.innerHTML = '<h3 class="text-xl font-semibold mb-4">Confirme os Dados Extra√≠dos</h3>';
            
            menuData.forEach((item, index) => {
                container.innerHTML += `<div class="p-4 bg-gray-50 rounded-lg mb-4">
                    <h4 class="font-bold">${item.day}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
                        <div>
                            <label class="block text-sm font-medium">Prato Principal</label>
                            <input type="text" id="prato-${index}" value="${item.pratoPrincipal.name || ''}" class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Op√ß√£o</label>
                            <input type="text" id="opcao-${index}" value="${item.opcao.name || ''}" class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Guarni√ß√£o</label>
                            <input type="text" id="guarnicao-${index}" value="${item.guarnicao.name || ''}" class="w-full border rounded p-1">
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML += `<div class="text-center mt-4">
                <button id="saveNewMenuBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Salvar Novo Card√°pio</button>
                <button type="button" id="cancelNewMenuBtn" class="w-full mt-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
            </div>`;
            container.classList.remove('hidden'); 
            
            document.getElementById('saveNewMenuBtn').addEventListener('click', () => saveNewMenu(menuData.length));
            document.getElementById('cancelNewMenuBtn').addEventListener('click', () => {
                container.classList.add('hidden');
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('image-processor-container').classList.add('hidden');
                document.getElementById('imageUpload').value = ''; // Limpa o input de arquivo
                showToast("Atualiza√ß√£o de card√°pio cancelada.", 'info');
            });
        }

        async function saveNewMenu(itemCount) {
             const button = document.getElementById('saveNewMenuBtn'); 
             button.disabled = true; 
             button.textContent = 'A salvar...'; 
             
             const newMenu = [];
             for(let i = 0; i < itemCount; i++) { 
                const dayName = document.querySelector(`#prato-${i}`).closest('.p-4').querySelector('h4').textContent;
                newMenu.push({ 
                    day: dayName, 
                    pratoPrincipal: { name: document.getElementById(`prato-${i}`).value.trim(), emoji: 'üçΩÔ∏è' }, 
                    opcao: { name: document.getElementById(`opcao-${i}`).value.trim(), emoji: 'ü•£' }, 
                    guarnicao: { name: document.getElementById(`guarnicao-${i}`).value.trim(), emoji: 'ü•ó' } 
                }); 
            }
             try { 
                await setDoc(menuDocRef, { menu: newMenu }); 
                showToast('Card√°pio atualizado com sucesso!', 'success'); 
                document.getElementById('confirmation-form').classList.add('hidden'); 
                document.getElementById('imagePreview').classList.add('hidden'); 
                document.getElementById('image-processor-container').classList.add('hidden'); 
                document.getElementById('imageUpload').value = ''; 
                await loadAndDisplayMenu(); // Recarrega o card√°pio para o usu√°rio ver as mudan√ßas
            } 
             catch (error) { 
                console.error("Erro ao salvar o card√°pio:", error); 
                showToast("Ocorreu um erro ao salvar o novo card√°pio: " + error.message, 'error'); 
            } 
             finally { 
                button.disabled = false; 
                button.textContent = 'Salvar Novo Card√°pio'; 
            }
        }

        // --- L√ìGICA DE AUTENTICA√á√ÉO E TROCA DE VISTAS ---

        // Observa o estado de autentica√ß√£o do Firebase
        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === APP_CONFIG.ADMIN_UID) {
                isAdminLoggedIn = true;
                showAdminView();
            } else {
                isAdminLoggedIn = false;
                showUserView(); // Garante que a vis√£o do usu√°rio seja mostrada se n√£o for admin logado
            }
        });

        function showUserView() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            loadAndDisplayMenu(); // Garante que o card√°pio do usu√°rio esteja atualizado
        }

        function showAdminView() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden'); // Fecha o modal de login
            loadAdminData(); // Carrega dados de admin somente quando logado
            loadAndRenderEmployees(); // Carrega lista de funcion√°rios
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const loginButton = e.target.querySelector('button[type="submit"]');

            loginButton.disabled = true;
            loginButton.textContent = 'Entrando...';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (userCredential.user.uid === APP_CONFIG.ADMIN_UID) {
                    showToast("Login de administrador bem-sucedido!", 'success');
                    // onAuthStateChanged ir√° chamar showAdminView()
                } else {
                    await signOut(auth); // Desloga o usu√°rio se n√£o for o UID de admin esperado
                    showToast("Credenciais v√°lidas, mas este usu√°rio n√£o √© um administrador.", 'error');
                }
            } catch (error) {
                console.error("Erro no login de administrador:", error);
                let errorMessage = "Erro no login. ";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage += "Email ou senha incorretos.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += "Formato de email inv√°lido.";
                } else {
                    errorMessage += error.message;
                }
                showToast(errorMessage, 'error', 5000);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Entrar';
            }
        }

        async function handleAdminLogout() {
            try {
                await signOut(auth);
                showToast("Logout de administrador bem-sucedido!", 'info');
                // onAuthStateChanged ir√° chamar showUserView()
            } catch (error) {
                console.error("Erro no logout:", error);
                showToast("Erro ao fazer logout: " + error.message, 'error');
            }
        }

        // --- FUN√á√ÉO PRINCIPAL E EVENT LISTENERS ---
        async function main() {
            // N√£o √© mais necess√°rio signInAnonymously(auth) aqui,
            // onAuthStateChanged gerenciar√° a vis√£o inicial
            
            // Listeners da Vis√£o do Usu√°rio
            const userView = document.getElementById('user-view');
            if (userView) {
                const rgfInput = document.getElementById('employeeRGF');
                rgfInput.value = localStorage.getItem('employeeRGF') || '';
                // Chame findEmployeeByRGF no carregamento e blur
                if(rgfInput.value) { findEmployeeByRGF(rgfInput.value); }
                rgfInput.addEventListener('blur', (e) => {
                    findEmployeeByRGF(e.target.value);
                    localStorage.setItem('employeeRGF', e.target.value); // Salvar no blur
                });
                rgfInput.addEventListener('input', (e) => {
                    // validateForm() √© chamado no findEmployeeByRGF
                    // N√£o √© mais necess√°rio salvar no localStorage em cada input
                    // localStorage.setItem('employeeRGF', e.target.value); 
                    validateForm();
                });
                document.getElementById('menu').addEventListener('change', validateForm);
                document.getElementById('openConfirmationModal').addEventListener('click', openConfirmationModal);
                document.getElementById('submitOrder').addEventListener('click', submitOrder);
                document.getElementById('cancel-confirmation').addEventListener('click', () => document.getElementById('confirmation-modal').classList.add('hidden'));
            }

            // Listeners de Troca de Vis√£o (Admin/Usu√°rio)
            document.getElementById('switchToAdmin').addEventListener('click', () => {
                document.getElementById('admin-login-modal').classList.remove('hidden');
            });
            document.getElementById('cancel-admin-login').addEventListener('click', () => {
                document.getElementById('admin-login-modal').classList.add('hidden');
            });
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            
            document.getElementById('adminLogoutBtn').addEventListener('click', handleAdminLogout);
            document.getElementById('switchToUserFromAdmin').addEventListener('click', showUserView);
            
            // Listeners da Vis√£o do Admin (apenas se for admin logado)
            // Estes listeners ser√£o adicionados independentemente do estado de login,
            // mas as opera√ß√µes subjacentes ser√£o protegidas pelas Security Rules.
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('employee-list-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-employee-btn')) {
                    openEmployeeEditModal(e.target.dataset.id, e.target.dataset.name);
                }
                if (e.target.classList.contains('delete-employee-btn')) {
                    handleDeleteEmployee(e.target.dataset.id);
                }
            });
            document.getElementById('edit-employee-form').addEventListener('submit', handleSaveEmployeeChanges);
            document.getElementById('cancel-employee-edit').addEventListener('click', () => {
                document.getElementById('edit-employee-modal').classList.add('hidden');
            });

            document.getElementById('searchInput').addEventListener('input', () => renderOrdersTable(allOrders));
            document.getElementById('generateReportBtn').addEventListener('click', generateAndPrintReport);
            
            document.getElementById('ordersTableContainer').addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-order-btn')) {
                    openOrderEditModal(e.target.dataset.id);
                }
                if (e.target.classList.contains('delete-order-btn')) {
                    deleteOrder(e.target.dataset.id);
                }
            });

            document.getElementById('edit-order-form').addEventListener('submit', saveOrderChanges);
            document.getElementById('cancel-order-edit').addEventListener('click', () => {
                document.getElementById('edit-order-modal').classList.add('hidden');
            });
        }

        main().catch(error => console.error("Falha na inicializa√ß√£o:", error));
    </script>
</body>
</html>
