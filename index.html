<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio Quatinga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lobster+Two:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <style>
        /* Tema Futurista com Cores Vivas */
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #ffffff;
            --text-secondary: #e94560;
            --text-muted: #533483;
            --accent-primary: #00d4ff;
            --accent-secondary: #ff006e;
            --accent-tertiary: #8338ec;
            --border-color: #533483;
            --success-color: #00f5ff;
            --warning-color: #ffbe0b;
            --error-color: #ff006e;
            --neon-blue: #00d4ff;
            --neon-pink: #ff006e;
            --neon-purple: #8338ec;
            --neon-green: #00f5ff;
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Efeito de partículas no fundo */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 20%, var(--neon-blue) 0%, transparent 50%),
                radial-gradient(circle at 80% 40%, var(--neon-pink) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, var(--neon-purple) 0%, transparent 50%);
            opacity: 0.03;
            z-index: -1;
            animation: pulse 4s ease-in-out infinite alternate;
        }
        
        .font-brand { 
            font-family: 'Lobster Two', cursive; 
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px var(--neon-blue);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { filter: drop-shadow(0 0 5px var(--neon-blue)); }
            to { filter: drop-shadow(0 0 20px var(--neon-pink)); }
        }
        
        /* Cards e Containers */
        .bg-white {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color);
            box-shadow: 
                0 8px 32px rgba(0, 212, 255, 0.1),
                0 4px 16px rgba(255, 0, 110, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px !important;
        }
        
        .bg-slate-50 {
            background: var(--bg-primary) !important;
        }
        
        /* Mobile-first responsive design */
        .container {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
        
        @media (min-width: 640px) {
            .container {
                padding-left: 1.5rem !important;
                padding-right: 1.5rem !important;
            }
        }
        
        /* Inputs e Forms */
        input, textarea, select {
            background: var(--bg-tertiary) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--accent-primary) !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        input::placeholder, textarea::placeholder {
            color: var(--text-muted) !important;
        }
        
        /* Menu Cards - Otimizado para Mobile */
        .menu-option-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 0.75rem;
        }
        
        .menu-option-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .menu-option-card:hover:before {
            left: 100%;
        }
        
        .menu-option-card:has(input:checked) { 
            border-color: var(--neon-blue); 
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(255, 0, 110, 0.1));
            transform: scale(1.02); 
            box-shadow: 
                0 0 20px rgba(0, 212, 255, 0.3),
                0 0 40px rgba(255, 0, 110, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 640px) {
            .menu-option-card {
                padding: 0.75rem !important;
            }
            
            .menu-option-card .flex {
                flex-direction: row;
                align-items: center;
                gap: 0.75rem;
            }
        }
        
        .menu-option-card:has(input:checked) .checkmark { opacity: 1; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader { 
            border: 4px solid var(--bg-tertiary); 
            border-radius: 50%; 
            border-top: 4px solid var(--accent-primary); 
            width: 40px; 
            height: 40px; 
            animation: spin 2s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Dish Images - Mobile Optimized */
        .dish-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--neon-blue);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        .dish-image:hover {
            transform: scale(1.05);
            border-color: var(--neon-pink);
            box-shadow: 0 0 15px rgba(255, 0, 110, 0.5);
        }
        
        @media (min-width: 640px) {
            .dish-image {
                width: 80px;
                height: 80px;
                border-radius: 12px;
            }
        }
        
        .image-loading {
            background: linear-gradient(90deg, var(--bg-tertiary), var(--border-color), var(--bg-tertiary));
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
                 @keyframes shimmer {
             0% { background-position: -200% 0; }
             100% { background-position: 200% 0; }
         }
         
         /* Glassmorphism Effects */
         .glass-card {
             background: rgba(30, 41, 59, 0.8);
             backdrop-filter: blur(10px);
             border: 1px solid rgba(255, 255, 255, 0.1);
         }
         
         /* Hover Effects */
         button:hover {
             transform: translateY(-2px);
             box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
         }
         
         /* Progress Bar Styling */
         .progress-bar-container {
             background: var(--bg-tertiary);
             border-radius: 10px;
             overflow: hidden;
             box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
         }
         
         .progress-bar {
             background: linear-gradient(90deg, var(--accent-primary), #8b5cf6);
             height: 8px;
             border-radius: 10px;
             transition: width 0.3s ease;
             box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
         }
         
         /* Custom Scrollbar */
         ::-webkit-scrollbar {
             width: 8px;
         }
         
         ::-webkit-scrollbar-track {
             background: var(--bg-tertiary);
             border-radius: 4px;
         }
         
         ::-webkit-scrollbar-thumb {
             background: linear-gradient(135deg, var(--accent-primary), #8b5cf6);
             border-radius: 4px;
         }
         
         ::-webkit-scrollbar-thumb:hover {
             background: linear-gradient(135deg, var(--accent-secondary), #7c3aed);
         }
         
         /* File Input Styling */
         input[type="file"] {
             background: var(--bg-tertiary) !important;
             border: 2px dashed var(--border-color) !important;
             border-radius: 12px !important;
             padding: 20px !important;
             text-align: center !important;
             transition: all 0.3s ease !important;
         }
         
         input[type="file"]:hover {
             border-color: var(--accent-primary) !important;
             background: rgba(59, 130, 246, 0.05) !important;
         }
         
         /* Toast Notifications */
         .toast-success {
             background: linear-gradient(135deg, var(--success-color), #059669) !important;
         }
         
         .toast-error {
             background: linear-gradient(135deg, var(--error-color), #dc2626) !important;
         }
         
         .toast-info {
             background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)) !important;
         }
         
         /* Loading Animation */
         .pulse {
             animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
         }
         
                 @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        
        /* Floating particles animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-10px) rotate(120deg); }
            66% { transform: translateY(5px) rotate(240deg); }
        }
        
        .floating-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            background: var(--neon-blue);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
            z-index: -1;
            box-shadow: 0 0 10px var(--neon-blue);
        }
        
        .floating-particle:nth-child(2) {
            background: var(--neon-pink);
            box-shadow: 0 0 10px var(--neon-pink);
            animation-delay: -2s;
            animation-duration: 8s;
        }
        
        .floating-particle:nth-child(3) {
            background: var(--neon-purple);
            box-shadow: 0 0 10px var(--neon-purple);
            animation-delay: -4s;
            animation-duration: 10s;
        }
        .no-print { }
        
        /* Modals */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: rgba(0, 0, 0, 0.8); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            transition: opacity 0.3s ease; 
            backdrop-filter: blur(4px);
        }
        
        .modal-content { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border-color);
            padding: 2rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
            max-height: 90vh; 
            overflow-y: auto; 
            width: 90%; 
            max-width: 500px; 
            color: var(--text-primary);
        }
        
        input:read-only { 
            background-color: var(--bg-tertiary) !important; 
            cursor: not-allowed; 
            opacity: 0.6;
        }
        
        /* Buttons */
        .bg-blue-500, .bg-blue-600 {
            background: linear-gradient(135deg, var(--neon-blue), var(--accent-primary)) !important;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3) !important;
        }
        
        .bg-green-500, .bg-green-600 {
            background: linear-gradient(135deg, var(--neon-green), var(--success-color)) !important;
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3) !important;
        }
        
        .bg-red-500, .bg-red-600 {
            background: linear-gradient(135deg, var(--neon-pink), var(--error-color)) !important;
            box-shadow: 0 0 20px rgba(255, 0, 110, 0.3) !important;
        }
        
        .bg-purple-600, .bg-purple-700 {
            background: linear-gradient(135deg, var(--neon-purple), var(--accent-tertiary)) !important;
            box-shadow: 0 0 20px rgba(131, 56, 236, 0.3) !important;
        }
        
        .bg-yellow-100 {
            background: rgba(255, 190, 11, 0.1) !important;
            border-color: var(--warning-color) !important;
            color: var(--warning-color) !important;
        }
        
        /* Tables */
        table {
            background: var(--bg-secondary) !important;
        }
        
        th {
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
        }
        
        td {
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Text Colors */
        .text-gray-500, .text-gray-600, .text-gray-700, .text-gray-800 {
            color: var(--text-secondary) !important;
        }
        
        .text-blue-600 {
            color: var(--accent-primary) !important;
        }
        
        .text-green-600 {
            color: var(--success-color) !important;
        }
        
        .text-red-600 {
            color: var(--error-color) !important;
        }
        #print-report { display: none; }
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            body > *:not(#print-report) { display: none !important; }
            #print-report { display: block !important; }
            #print-report h1 { font-size: 18pt; text-align: center; margin-bottom: 15px; font-family: 'Poppins', sans-serif; font-weight: 600; }
            .report-day-section { margin-bottom: 12px; page-break-inside: avoid; }
            .report-table { width: 100%; border-collapse: collapse; font-size: 9pt; }
            #print-report th, #print-report td { border: 1px solid #999; padding: 5px; text-align: left; }
            #print-report th { background-color: #e2e8f0; font-weight: 600; }
            #print-report .rgf-col { width: 15%; }
            #print-report .nome-col { width: 60%; }
            #print-report .pedido-col { width: 25%; background-color: #dbeafe; font-weight: bold; }
        }
        #app-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; pointer-events: none; transform: translateX(-50%) translateY(20px); }
        #app-toast.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
        #app-toast.success { background-color: #22c55e; }
        #app-toast.error { background-color: #ef4444; }
        #app-toast.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50">
    <!-- Floating particles for futuristic effect -->
    <div class="floating-particle" style="top: 10%; left: 10%;"></div>
    <div class="floating-particle" style="top: 20%; left: 80%;"></div>
    <div class="floating-particle" style="top: 60%; left: 15%;"></div>
    <div class="floating-particle" style="top: 80%; left: 70%;"></div>
    <div class="floating-particle" style="top: 40%; left: 90%;"></div>
    <div class="floating-particle" style="top: 70%; left: 5%;"></div>

    <div id="app-container" class="container mx-auto max-w-4xl p-4 sm:p-6 pb-20">
        
        <div id="user-view" class="no-print">
            <div id="form-container">
                <header class="text-center mb-6 px-2">
                    <h1 class="font-brand text-3xl sm:text-5xl">Delícias Urbanas</h1>
                    <p class="mt-2 text-sm sm:text-md" style="color: var(--text-secondary)">O seu cardápio da semana está servido!</p>
                </header>
                
                <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6">
                    <h2 class="block text-lg font-semibold mb-2" style="color: var(--text-primary)">👤 1. Identificação</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="employeeRGF" class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">Seu RGF</label>
                            <input type="text" id="employeeRGF" placeholder="Digite o seu RGF" class="mt-1 w-full px-4 py-3 rounded-lg text-sm sm:text-base">
                        </div>
                        <div>
                            <label for="employeeName" class="block text-sm font-medium mb-2" style="color: var(--text-secondary)">Nome Completo</label>
                            <input type="text" id="employeeName" placeholder="Preenchido automaticamente" class="mt-1 w-full px-4 py-3 rounded-lg text-sm sm:text-base" readonly>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4" style="color: var(--text-primary)">🍽️ 2. Escolha os seus pratos</h2>
                    <div id="menu" class="space-y-6">
                        <div class="text-center" style="color: var(--text-muted)">A carregar o cardápio...</div>
                    </div>
                </div>
                <div id="guidanceSection" class="bg-gradient-to-r from-yellow-900/20 to-orange-900/20 border-l-4 border-yellow-400 p-4 rounded-md mb-6" style="border-left-color: var(--warning-color)">
                    <p id="guidanceText" class="font-semibold" style="color: var(--warning-color)">Digite seu RGF e escolha uma opção para cada dia.</p>
                </div>
                <div id="submitButtonContainer" class="hidden text-center">
                    <button id="openConfirmationModal" class="w-full sm:w-auto text-white font-bold text-lg px-8 py-3 rounded-xl shadow-lg transition-all duration-300 hover:scale-105" style="background: linear-gradient(135deg, var(--neon-green), var(--success-color)); box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);">
                        ✨ Revisar e Finalizar Pedido
                    </button>
                </div>
            </div>
            <div id="success-message" class="hidden text-center p-10 bg-white rounded-lg shadow-lg"><h2 class="text-3xl font-bold text-green-500">Pedido Enviado com Sucesso!</h2><p id="success-text" class="mt-4 text-gray-600"></p><button onclick="location.reload()" class="mt-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Fazer Novo Pedido</button></div>
            <footer class="text-center mt-10">
                <button id="switchToAdmin" class="text-sm text-gray-500 hover:text-blue-600">Aceder ao Painel do Administrador</button>
            </footer>
        </div>

        <div id="admin-view" class="hidden no-print">
            <header class="text-center border-b pb-6 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Painel do Administrador</h1>
                <p class="text-lg text-gray-600 mt-1">Delícias Urbanas</p>
                <div class="mt-4">
                    <button id="adminLogoutBtn" class="bg-red-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-red-600">Sair do Painel</button>
                </div>
            </header>
            <div class="mb-8">
                <button id="switchToUserFromAdmin" class="text-sm text-gray-500 hover:text-blue-600">⬅️ Voltar para o Cardápio (Visão Usuário)</button>
            </div>
            
            <section id="order-status-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">📊 Status de Pedidos da Semana</h2>
                <div id="order-status-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p class="text-gray-500">A carregar status dos pedidos...</p>
                </div>
            </section>

            <section id="menu-updater-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-4">🍜 Atualizar Cardápio com Imagem (IA)</h2>
                <p class="text-gray-600 mb-4">Envie uma imagem do novo cardápio. A nossa inteligência artificial irá ler e preencher os campos para si.</p>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" class="mt-4 rounded-lg max-h-80 hidden" />
                <div id="image-processor-container" class="mt-4 text-center hidden"><button id="processImageBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Analisar Cardápio</button></div>
                <div id="loader" class="hidden mx-auto my-4 loader"></div>
                <div id="confirmation-form" class="hidden mt-6"></div>
                <div id="whatsapp-notification-container" class="mt-4 text-center hidden">
                    <button id="notifyWhatsAppBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="white"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.287.492-1.24 4.515 4.639-1.219.452.273zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.371-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01s-.521.074-.792.372c-.272.296-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                        Notificar Funcionários no WhatsApp
                    </button>
                </div>
            </section>

            <section id="ai-image-search-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">🤖 Busca Automática de Imagens (IA)</h2>
                <p class="text-gray-600 mb-4">A IA busca automaticamente imagens de alta qualidade sempre que o cardápio é atualizado.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="imageQuality" class="block text-sm font-medium text-gray-700 mb-2">Qualidade das Imagens</label>
                        <select id="imageQuality" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="small">Pequena (rápido, menor qualidade)</option>
                            <option value="medium" selected>Média (balanceado)</option>
                            <option value="large">Grande (melhor qualidade)</option>
                        </select>
                    </div>
                    <div>
                        <label for="imageStyle" class="block text-sm font-medium text-gray-700 mb-2">Estilo de Imagem</label>
                        <select id="imageStyle" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="food photography">Fotografia Gastronômica</option>
                            <option value="appetizing food" selected>Comida Apetitosa</option>
                            <option value="professional food">Comida Profissional</option>
                            <option value="homemade food">Comida Caseira</option>
                        </select>
                    </div>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md">
                    <div class="flex items-center">
                        <svg class="h-5 w-5 mr-2 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <p class="font-semibold">🤖 Sistema Automático Ativo</p>
                        <div id="ai-status-indicator" class="ml-2 hidden">
                            <div class="flex items-center">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                                <span class="ml-2 text-xs">Buscando...</span>
                            </div>
                        </div>
                    </div>
                    <p class="mt-1 text-sm">As imagens são buscadas automaticamente quando você atualiza o cardápio. As configurações acima serão aplicadas.</p>
                </div>
                
                <div id="image-search-progress" class="hidden mt-4">
                    <div class="progress-bar-container mb-2">
                        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-sm text-gray-400 text-center">Buscando imagens automaticamente...</p>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button id="clearImageCache" class="text-xs text-gray-500 hover:text-red-600 underline">
                        🗑️ Limpar cache de imagens (forçar nova busca)
                    </button>
                </div>
            </section>

            <section id="employee-management-section" class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">👥 Gerenciamento de Funcionários</h2>
                <form id="add-employee-form" class="grid sm:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="newEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label>
                        <input type="text" id="newEmployeeRGF" placeholder="RGF do funcionário" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="newEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                        <input type="text" id="newEmployeeName" placeholder="Nome do funcionário" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Adicionar Funcionário</button>
                </form>
                <div id="employee-list-container" class="overflow-x-auto">
                    <p class="text-gray-500">A carregar lista de funcionários...</p>
                </div>
            </section>

            <section id="orders-section">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Pedidos Recebidos</h2>
                    <div class="w-full sm:w-auto"><input type="text" id="searchInput" placeholder="🔎 Buscar por nome..." class="w-full sm:w-64 px-4 py-2 border rounded-lg"></div>
                    <button id="generateReportBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 shadow-lg">🖨️ Salvar Relatório como PDF</button>
                </div>
                <div id="ordersTableContainer" class="overflow-x-auto"><p class="text-gray-500">A carregar pedidos...</p></div>
            </section>
        </div>
    </div>

    <div id="edit-order-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Pedido</h2><form id="edit-order-form"><input type="hidden" id="edit-order-id"><div class="mb-4"><label class="block text-lg font-semibold text-gray-800 mb-2">Nome do Funcionário</label><input type="text" id="edit-order-employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly></div><div id="edit-menu-options" class="space-y-6"></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Alterações</button></div></form></div></div>
    <div id="edit-employee-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Editar Funcionário</h2><form id="edit-employee-form"><div class="mb-4"><label for="editEmployeeRGF" class="block text-sm font-medium text-gray-700">RGF</label><input type="text" id="editEmployeeRGF" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" readonly></div><div class="mb-4"><label for="editEmployeeName" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="editEmployeeName" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Alterações</button></div></form></div></div>
    <div id="confirmation-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-2xl font-bold mb-4">Confirme o seu Pedido</h2><p class="mb-6 text-gray-600">Por favor, revise as suas escolhas antes de enviar.</p><div id="confirmation-summary" class="space-y-2 mb-8"></div><div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Editar</button><button id="submitOrder" class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600">Confirmar e Enviar</button></div></div></div>
    <div id="admin-login-modal" class="modal-overlay hidden no-print"><div class="modal-content"><h2 class="text-2xl font-bold mb-4">Aceder ao Painel de Administrador</h2><form id="admin-login-form"><div class="mb-4"><label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="adminEmail" placeholder="seu-email@exemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="adminPassword" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="adminPassword" placeholder="Sua senha" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Entrar</button></div></form></div></div>
    <div id="custom-confirm-modal" class="modal-overlay hidden no-print"><div class="modal-content fade-in"><h2 class="text-xl font-bold mb-4" id="custom-confirm-title">Confirmar Ação</h2><p class="mb-6 text-gray-600" id="custom-confirm-message">Tem a certeza que deseja prosseguir?</p><div class="flex justify-end space-x-4"><button id="custom-confirm-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button><button id="custom-confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Confirmar</button></div></div></div>

    <div id="print-report"></div>
    <div id="app-toast"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, getDoc, setDoc, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDa24jUk24wjlMsJUC4uXwnbmxM4vCtocI",
            authDomain: "cardapio-8ddea.firebaseapp.com",
            projectId: "cardapio-8ddea",
            storageBucket: "cardapio-8ddea.appspot.com",
            messagingSenderId: "1019677985212",
            appId: "1:1019677985212:web:57c7820a62585a867dc3b9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const APP_CONFIG = {
            ADMIN_UID: 'LqAXao4FuOQAvzS3uQAd9et6OnK2',
        };
        
        const menuDocRef = doc(db, "cardapio", "semanal");
        const pedidosCollectionRef = collection(db, "pedidosDaSemana");
        const funcionariosCollectionRef = collection(db, "funcionarios");
        
        const fixedOptions = [{ name: 'Omelete', emoji: '🍳' }, { name: 'Filé de frango', emoji: '🍗' }];
        let weeklyMenu = [];
        let allOrders = [];
        let tempOrderData = {};
        
        function getDayId(dayName) { return dayName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z]/g, "").toLowerCase(); }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('app-toast');
            if(!toast) return;
            toast.textContent = message;
            toast.className = 'show';
            toast.classList.add(type);
            
            // Adicionar classes de toast melhoradas
            if (type === 'success') toast.classList.add('toast-success');
            if (type === 'error') toast.classList.add('toast-error');
            if (type === 'info') toast.classList.add('toast-info');
            
            setTimeout(() => { 
                toast.className = toast.className.replace('show', ''); 
                toast.classList.remove('toast-success', 'toast-error', 'toast-info');
            }, duration);
        }
        
        function showCustomConfirm(message, onConfirm) {
            const modal = document.getElementById('custom-confirm-modal');
            const messageEl = document.getElementById('custom-confirm-message');
            const okBtn = document.getElementById('custom-confirm-ok-btn');
            
            messageEl.textContent = message;
            modal.classList.remove('hidden');

            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            newOkBtn.addEventListener('click', () => {
                onConfirm();
                modal.classList.add('hidden');
            });
        }

        function loadAndRenderEmployees() {
            const q = query(funcionariosCollectionRef, orderBy("nome"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('employee-list-container');
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum funcionário cadastrado.</p>';
                    return;
                }
                let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">RGF</th><th class="py-2 px-3 border-b text-left">Nome</th><th class="py-2 px-3 border-b text-left">Ações</th></tr></thead><tbody>`;
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    tableHTML += `<tr>
                        <td class="py-2 px-3 border-b font-mono">${doc.id}</td>
                        <td class="py-2 px-3 border-b font-semibold">${employee.nome}</td>
                        <td class="py-2 px-3 border-b space-x-2">
                            <button data-id="${doc.id}" data-name="${employee.nome}" class="edit-employee-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button>
                            <button data-id="${doc.id}" data-name="${employee.nome}" class="delete-employee-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button>
                        </td>
                    </tr>`;
                });
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            }, (error) => {
                 console.error("Erro ao carregar funcionários:", error);
                 showToast("Falha ao carregar funcionários. Verifique o console para mais detalhes.", "error");
            });
        }

        async function handleAddEmployee(e) {
            e.preventDefault();
            const rgfInput = document.getElementById('newEmployeeRGF');
            const nameInput = document.getElementById('newEmployeeName');
            const rgf = rgfInput.value.trim();
            const nome = nameInput.value.trim();

            if (!rgf || !nome) { showToast("Por favor, preencha o RGF e o Nome.", 'error'); return; }

            try {
                await setDoc(doc(db, "funcionarios", rgf), { nome });
                showToast("Funcionário adicionado com sucesso!", 'success');
                rgfInput.value = ''; nameInput.value = '';
            } catch (error) {
                console.error("Erro ao adicionar funcionário: ", error);
                showToast("Ocorreu um erro ao adicionar o funcionário.", 'error');
            }
        }

        function handleDeleteEmployee(rgf, name) {
            const message = `Tem a certeza que deseja excluir o funcionário ${name} (RGF: ${rgf})? Esta ação não pode ser desfeita.`;
            showCustomConfirm(message, async () => {
                try {
                    await deleteDoc(doc(db, "funcionarios", rgf));
                    showToast("Funcionário excluído com sucesso.", 'success');
                } catch (error) {
                    console.error("Erro ao excluir funcionário: ", error);
                    showToast("Falha ao excluir o funcionário.", 'error');
                }
            });
        }
        
        function openEmployeeEditModal(rgf, nome) {
            document.getElementById('editEmployeeRGF').value = rgf;
            document.getElementById('editEmployeeName').value = nome;
            document.getElementById('edit-employee-modal').classList.remove('hidden');
        }

        async function handleSaveEmployeeChanges(e) {
            e.preventDefault();
            const rgf = document.getElementById('editEmployeeRGF').value;
            const newName = document.getElementById('editEmployeeName').value.trim();

            if (!newName) { showToast("O nome não pode ficar em branco.", 'error'); return; }
            try {
                await updateDoc(doc(db, "funcionarios", rgf), { nome: newName });
                showToast("Funcionário atualizado com sucesso!", 'success');
                document.getElementById('edit-employee-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar alterações do funcionário: ", error);
                showToast("Falha ao salvar as alterações do funcionário.", 'error');
            }
        }
        
        async function findEmployeeByRGF(rgf) {
            const nameInput = document.getElementById('employeeName');
            if (!rgf) { nameInput.value = ''; nameInput.placeholder = 'Preenchido automaticamente'; validateForm(); return; }
            try {
                const docSnap = await getDoc(doc(db, "funcionarios", rgf));
                if (docSnap.exists()) {
                    nameInput.value = docSnap.data().nome;
                } else {
                    nameInput.value = ''; nameInput.placeholder = 'RGF não encontrado';
                }
                validateForm();
            } catch (error) {
                console.error("Erro ao buscar funcionário:", error);
                nameInput.value = ''; nameInput.placeholder = 'Erro na busca';
                showToast("Erro ao buscar funcionário.", 'error');
            }
        }
        
        function createFallbackMenu() {
            const days = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];
            return days.map(day => ({ day, isHoliday: false, isSpecial: false, pratoPrincipal: { name: 'Cardápio não definido', emoji: '🚧' }, opcao: { name: '', emoji: '' }, guarnicao: { name: 'A definir', emoji: '' } }));
        }

        function loadAndDisplayMenu() {
            onSnapshot(menuDocRef, async (docSnap) => {
                weeklyMenu = (docSnap.exists() && docSnap.data().menu?.length > 0) ? docSnap.data().menu : createFallbackMenu();
                
                // Buscar imagens automaticamente se necessário (apenas para pratos principais e opções)
                const needsImages = weeklyMenu.some(dayMenu => 
                    !dayMenu.isHoliday && (
                        (dayMenu.pratoPrincipal?.name && !dayMenu.pratoPrincipal.image) ||
                        (dayMenu.opcao?.name && !dayMenu.opcao.image)
                    )
                );
                
                if (needsImages) {
                    // Buscar imagens silenciosamente em background
                    searchImagesForMenu(false).then(async (foundNew) => {
                        if (foundNew) {
                            // Atualizar no Firebase silenciosamente
                            try {
                                await setDoc(menuDocRef, { menu: weeklyMenu });
                                createMenuHTML(); // Atualizar a exibição
                            } catch (error) {
                                console.error("Erro ao salvar imagens:", error);
                            }
                        }
                    });
                }
                
                createMenuHTML();
                renderOrdersTable(allOrders); 
            }, (error) => {
                 console.error("Erro ao carregar o cardápio:", error);
                 showToast("Erro ao carregar o cardápio. Usando cardápio padrão.", 'error');
                 weeklyMenu = createFallbackMenu();
                 createMenuHTML();
                 renderOrdersTable(allOrders);
            });
        }
        
        function createMenuHTML() {
            const menuContainer = document.getElementById('menu');
            if (!menuContainer) return;
            menuContainer.innerHTML = '';

            weeklyMenu.forEach(item => {
                const dayId = getDayId(item.day);
                let dayHTML = `<div class="day-section space-y-3 p-3 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-color);">`;
                
                let dayTitleHTML = `<h3 class="text-lg sm:text-xl font-bold" style="color: var(--text-primary)">${item.day}</h3>`;
                if (item.isSpecial) {
                    dayTitleHTML = `<div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3">
                        <h3 class="text-lg sm:text-xl font-bold" style="color: var(--text-primary)">${item.day}</h3>
                        <span class="text-xs sm:text-sm font-semibold rounded-full px-3 py-1 self-start" style="color: var(--neon-purple); background: rgba(131, 56, 236, 0.2); border: 1px solid var(--neon-purple);">✨ Almoço Especial</span>
                    </div>`;
                }
                
                if (item.isHoliday) {
                    dayHTML += dayTitleHTML;
                    dayHTML += `
                        <div class="bg-gradient-to-r from-indigo-900/20 to-purple-900/20 border-l-4 p-4 rounded-md" style="border-left-color: var(--neon-purple);">
                            <p class="font-bold text-sm sm:text-base" style="color: var(--neon-purple)">🎊 Feriado</p>
                            <p class="text-xs sm:text-sm" style="color: var(--text-secondary)">Não haverá refeição neste dia.</p>
                        </div>`;
                } else {
                    const allOptions = [
                        { ...item.pratoPrincipal, type: 'Prato Principal' },
                        ...(item.opcao?.name ? [{ ...item.opcao, type: 'Opção do Dia' }] : []),
                        ...fixedOptions.map(fixa => ({ ...fixa, type: 'Opção Fixa' })),
                    ];

                    dayHTML += dayTitleHTML;
                    if (item.guarnicao?.name) {
                        dayHTML += `<div class="text-xs sm:text-sm font-semibold rounded-full inline-block px-3 py-1 mb-3" style="color: var(--neon-blue); background: rgba(0, 212, 255, 0.1); border: 1px solid var(--neon-blue);">Guarnição: ${item.guarnicao.name} ${item.guarnicao.emoji || ''}</div>`;
                    }
                    
                    dayHTML += `<div class="space-y-3">`;
                    allOptions.forEach((option) => {
                        if (option.name) {
                            const imageHTML = option.image ? 
                                `<img src="${option.image}" alt="${option.imageAlt || option.name}" class="dish-image mr-4" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                 <span class="text-3xl mr-4" style="display: none;">${option.emoji || '🍽️'}</span>` :
                                `<span class="text-3xl mr-4">${option.emoji || '🍽️'}</span>`;
                            
                            dayHTML += `<label class="menu-option-card block p-3 sm:p-4 cursor-pointer transition-all duration-200">
                                <input type="radio" name="${dayId}" value="${option.name}" class="hidden">
                                <div class="flex items-center gap-3">
                                    ${imageHTML}
                                    <div class="flex-grow min-w-0">
                                        <p class="font-semibold text-sm sm:text-base truncate" style="color: var(--text-primary)">${option.name}</p>
                                        <p class="text-xs sm:text-sm" style="color: var(--text-secondary)">${option.type}</p>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="checkmark h-5 w-5 sm:h-6 sm:w-6 opacity-0 transition-opacity flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3" style="color: var(--neon-blue);"><path d="M5 13l4 4L19 7" /></svg>
                                </div>
                            </label>`;
                        }
                    });
                    dayHTML += `</div>`;
                    
                    dayHTML += `<div class="mt-3">
                        <textarea id="notes-${dayId}" name="notes-${dayId}" rows="2" class="w-full px-3 py-2 rounded-lg text-xs sm:text-sm" placeholder="Anotações? Ex: sem cebola, ponto da carne, etc." style="background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);"></textarea>
                    </div>`;
                }

                dayHTML += `</div>`;
                menuContainer.innerHTML += dayHTML;
            });

            validateForm();
        }

        function validateForm() {
            const name = document.getElementById('employeeName')?.value.trim();
            const rgf = document.getElementById('employeeRGF')?.value.trim();
            const guidanceSection = document.getElementById('guidanceSection');
            const guidanceText = document.getElementById('guidanceText');
            const submitBtnContainer = document.getElementById('submitButtonContainer');
            if (!guidanceSection || !submitBtnContainer) return;

            const nonHolidayItems = weeklyMenu.filter(item => !item.isHoliday);
            const hasAllSelections = nonHolidayItems.length > 0 && nonHolidayItems.every(item => document.querySelector(`input[name="${getDayId(item.day)}"]:checked`));

            if (name && rgf && hasAllSelections) {
                guidanceSection.classList.add('hidden');
                submitBtnContainer.classList.remove('hidden');
            } else {
                submitBtnContainer.classList.add('hidden');
                guidanceSection.classList.remove('hidden');
                let message = '';
                if(!rgf) message = 'Digite seu RGF para começar. ';
                else if(!name) message = 'RGF não encontrado. Peça para um administrador cadastrá-lo. ';
                else if (!hasAllSelections) {
                    const missingDays = nonHolidayItems
                        .filter(item => !document.querySelector(`input[name="${getDayId(item.day)}"]:checked`))
                        .map(item => item.day);
                    if (missingDays.length > 0) message += `Falta selecionar opções para: ${missingDays.join(', ')}.`;
                }
                guidanceText.textContent = message || 'Por favor, preencha todos os campos.';
            }
        }

        function openConfirmationModal() {
            tempOrderData = {
                employeeName: document.getElementById('employeeName').value.trim(),
                employeeRGF: document.getElementById('employeeRGF').value.trim(),
                timestamp: serverTimestamp()
            };
            const summaryContainer = document.getElementById('confirmation-summary');
            summaryContainer.innerHTML = '';
            
            weeklyMenu.forEach(item => {
                const dayId = getDayId(item.day);
                
                if (!item.isHoliday) {
                    const choiceInput = document.querySelector(`input[name="${dayId}"]:checked`);
                    if (!choiceInput) return;
                    const choice = choiceInput.value;
                    const notes = document.getElementById(`notes-${dayId}`).value.trim();

                    tempOrderData[dayId] = choice;
                    if(notes) {
                        tempOrderData[`${dayId}_notes`] = notes;
                    }

                    summaryContainer.innerHTML += `<p><span class="font-bold">${item.day}:</span> ${choice} ${notes ? `<span class="text-sm text-gray-500 italic">(${notes})</span>` : ''}</p>`;
                }
            });
            
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        async function submitOrder() {
            const button = document.getElementById('submitOrder');
            button.disabled = true; button.textContent = 'A enviar...';
            try {
                await addDoc(pedidosCollectionRef, tempOrderData);
                document.getElementById('confirmation-modal').classList.add('hidden');
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('success-text').textContent = `Obrigado, ${tempOrderData.employeeName}. O seu pedido foi registado com sucesso.`;
                document.getElementById('success-message').classList.remove('hidden');
                showToast("Pedido enviado com sucesso!", 'success');
            } catch (error) {
                console.error("Erro ao enviar pedido: ", error);
                showToast("Ocorreu um erro ao enviar o seu pedido.", 'error');
            } finally {
                button.disabled = false; button.textContent = 'Confirmar e Enviar';
            }
        }
        
        function loadAdminData() {
            onSnapshot(pedidosCollectionRef, (snapshot) => {
                const latestOrdersMap = new Map();
                snapshot.forEach(doc => {
                    const orderData = doc.data();
                    if (orderData.employeeRGF) {
                        const timestamp = orderData.timestamp ? orderData.timestamp.toMillis() : 0;
                         if (!latestOrdersMap.has(orderData.employeeRGF) || timestamp > latestOrdersMap.get(orderData.employeeRGF).timestamp) {
                             latestOrdersMap.set(orderData.employeeRGF, { doc: doc, timestamp: timestamp });
                         }
                    }
                });
                
                allOrders = Array.from(latestOrdersMap.values())
                    .map(item => item.doc)
                    .sort((a, b) => a.data().employeeName.localeCompare(b.data().employeeName));

                renderOrdersTable(allOrders);
                renderOrderStatus(allOrders);
            }, (error) => {
                console.error("Erro ao carregar dados do administrador:", error);
                showToast("Erro ao carregar dados do administrador.", 'error');
            });
        }
        
        async function renderOrderStatus(orders) {
            const container = document.getElementById('order-status-container');
            container.innerHTML = '<p class="text-gray-500">A processar...</p>';

            try {
                const employeeSnapshot = await getDocs(query(funcionariosCollectionRef, orderBy("nome")));
                const allEmployees = employeeSnapshot.docs.map(doc => ({ id: doc.id, rgf: doc.id, ...doc.data() }));
                
                const orderedRGFs = new Set(orders.map(orderDoc => orderDoc.data().employeeRGF));

                const haveOrdered = allEmployees.filter(emp => orderedRGFs.has(emp.rgf));
                const haveNotOrdered = allEmployees.filter(emp => !orderedRGFs.has(emp.rgf));

                let html = `
                    <div class="bg-gradient-to-r from-green-900/20 to-green-800/20 p-4 rounded-lg border border-green-500/30">
                        <h3 class="font-semibold text-lg mb-2" style="color: var(--neon-green)">✅ Já Pediram (${haveOrdered.length})</h3>
                        <ul class="space-y-1 text-sm">${haveOrdered.map(e => `<li class="p-2 bg-green-900/30 rounded-md border border-green-500/20 text-green-300">${e.nome}</li>`).join('') || '<li class="text-gray-400">Ninguém fez pedido ainda.</li>'}</ul>
                    </div>
                    <div class="bg-gradient-to-r from-red-900/20 to-red-800/20 p-4 rounded-lg border border-red-500/30">
                        <h3 class="font-semibold text-lg mb-2" style="color: var(--neon-pink)">❌ Ainda Não Pediram (${haveNotOrdered.length})</h3>
                        <ul class="space-y-1 text-sm">${haveNotOrdered.map(e => `<li class="p-2 bg-red-900/30 rounded-md border border-red-500/20 text-red-300">${e.nome}</li>`).join('') || '<li class="text-gray-400">Todos os funcionários fizeram pedido!</li>'}</ul>
                    </div>
                `;
                container.innerHTML = html;

            } catch (error) {
                console.error("Erro ao renderizar status de pedidos:", error);
                container.innerHTML = '<p class="text-red-500">Falha ao carregar status dos funcionários.</p>';
            }
        }
        
        function renderOrdersTable(orders) {
            const container = document.getElementById('ordersTableContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredOrders = orders.filter(doc => doc.data().employeeName.toLowerCase().includes(searchTerm));

            if (!weeklyMenu || weeklyMenu.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">Aguardando cardápio...</p>'; return; }
            if (filteredOrders.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum pedido encontrado.</p>'; return; }
            
            let tableHTML = `<table class="min-w-full bg-white border"><thead><tr class="bg-gray-50"><th class="py-2 px-3 border-b text-left">Funcionário</th><th class="py-2 px-3 border-b text-left">RGF</th>`;
            weeklyMenu.forEach(item => tableHTML += `<th class="py-2 px-3 border-b text-left">${item.day.substring(0,3)}</th>`);
            tableHTML += `<th class="py-2 px-3 border-b text-left">Ações</th></tr></thead><tbody>`;

            filteredOrders.forEach(doc => {
                const order = doc.data();
                tableHTML += `<tr><td class="py-2 px-3 border-b font-bold">${order.employeeName}</td><td class="py-2 px-3 border-b">${order.employeeRGF || 'N/A'}</td>`;
                weeklyMenu.forEach(dayMenuItem => {
                    const dayId = getDayId(dayMenuItem.day);
                    let cellContent = '';

                    if (dayMenuItem.isHoliday) {
                        cellContent = '<span class="text-xs text-indigo-600">Feriado</span>';
                    } else {
                        let choice = order[dayId] || 'N/A';
                        const notes = order[`${dayId}_notes`];
                        const mainDishName = dayMenuItem.pratoPrincipal.name;
                        const optionDishName = dayMenuItem.opcao?.name;

                        let reportChoice = choice;
                        if (choice === mainDishName) {
                            reportChoice = 'Prato';
                        } else if (optionDishName && choice === optionDishName) {
                            reportChoice = 'Opção';
                        }
                        
                        cellContent = reportChoice;
                        if (notes) {
                            cellContent += ` <span title="${notes}" class="cursor-help text-blue-500 font-bold">*</span>`;
                        }
                    }
                    tableHTML += `<td class="py-2 px-3 border-b">${cellContent}</td>`;
                });
                tableHTML += `<td class="py-2 px-3 border-b space-x-2"><button data-id="${doc.id}" class="edit-order-btn text-blue-600 hover:text-blue-800 text-sm font-semibold">Editar</button><button data-id="${doc.id}" data-name="${order.employeeName}" class="delete-order-btn text-red-600 hover:text-red-800 text-sm font-semibold">Excluir</button></td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function generateAndPrintReport() {
            const reportContainer = document.getElementById('print-report');
            if (allOrders.length === 0 || weeklyMenu.length === 0) {
                showToast("Não há pedidos ou cardápio para gerar o relatório.", "info");
                return;
            }
            reportContainer.innerHTML = '<h1>Regional Quatinga</h1>';
            
            let allDaysHTML = '';
            weeklyMenu.forEach(dayMenuItem => {
                if (dayMenuItem.isHoliday) return; 

                const dayId = getDayId(dayMenuItem.day);
                let tableHTML = `<div class="report-day-section"><table class="report-table"><thead><tr><th class="rgf-col">RGF</th><th class="nome-col">NOME</th><th class="pedido-col">${dayMenuItem.day}</th></tr></thead><tbody>`;
                
                const dailyOrders = allOrders
                    .filter(orderDoc => orderDoc.data()[dayId])
                    .sort((a,b) => a.data().employeeName.localeCompare(b.data().employeeName));
                
                dailyOrders.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const choice = order[dayId];
                    const notes = order[`${dayId}_notes`];
                    
                    const mainDishName = dayMenuItem.pratoPrincipal.name;
                    const optionDishName = dayMenuItem.opcao?.name;
                    let reportChoice = '';

                    if (choice === mainDishName) { reportChoice = 'PRATO'; } 
                    else if (optionDishName && choice === optionDishName) { reportChoice = 'OPÇÃO'; } 
                    else { reportChoice = choice.toUpperCase(); }
                    
                    let choiceHTML = reportChoice;
                    if (notes) { choiceHTML += ` <span style="font-style: italic; font-weight: normal;">(${notes})</span>`; }

                    tableHTML += `<tr><td>${order.employeeRGF || 'N/A'}</td><td>${order.employeeName}</td><td>${choiceHTML}</td></tr>`;
                });
                tableHTML += '</tbody></table></div>';
                allDaysHTML += tableHTML;
            });
            reportContainer.innerHTML += allDaysHTML;
            window.print();
        }

        async function openOrderEditModal(docId) {
            const modal = document.getElementById('edit-order-modal');
            const formContent = document.getElementById('edit-menu-options');
            const employeeNameInput = document.getElementById('edit-order-employeeName');
            const orderIdInput = document.getElementById('edit-order-id');

            formContent.innerHTML = '<p class="text-center text-gray-500">A carregar...</p>';
            modal.classList.remove('hidden');

            try {
                const docSnap = await getDoc(doc(db, "pedidosDaSemana", docId));
                if (!docSnap.exists()) { showToast("Erro: Pedido não encontrado.", 'error'); modal.classList.add('hidden'); return; }

                const orderData = docSnap.data();
                employeeNameInput.value = orderData.employeeName;
                orderIdInput.value = docId;
                formContent.innerHTML = '';

                weeklyMenu.forEach(item => {
                    const dayId = getDayId(item.day);
                    let dayHTML = `<fieldset class="day-section border p-4 rounded-lg"><legend class="font-bold text-lg text-gray-800 px-2">${item.day}</legend>`;
                    
                    if(item.isHoliday) {
                        dayHTML += `<div class="bg-indigo-100 text-indigo-700 p-3 rounded-md text-center">Feriado</div>`;
                    } else {
                        const currentChoice = orderData[dayId];
                        const currentNotes = orderData[`${dayId}_notes`] || '';
                        const allOptions = [ { ...item.pratoPrincipal }, ...(item.opcao?.name ? [{ ...item.opcao }] : []), ...fixedOptions ];
                        
                        dayHTML += `<div class="space-y-2 mt-2">`;
                        allOptions.forEach((option, index) => {
                            if (option.name) {
                                const uniqueId = `edit-${dayId}-${index}`;
                                const isChecked = (option.name === currentChoice) ? 'checked' : '';
                                dayHTML += `<div class="flex items-center"><input type="radio" id="${uniqueId}" name="${dayId}" value="${option.name}" class="h-4 w-4 text-blue-600 border-gray-300" ${isChecked} required><label for="${uniqueId}" class="ml-3 block text-sm font-medium text-gray-700">${option.emoji || ''} ${option.name}</label></div>`;
                            }
                        });
                        dayHTML += `</div>`;
                        
                        dayHTML += `<div class="mt-4">
                            <label for="edit-notes-${dayId}" class="block text-sm font-medium text-gray-700">Anotações</label>
                            <textarea id="edit-notes-${dayId}" name="edit-notes-${dayId}" rows="2" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">${currentNotes}</textarea>
                        </div>`;
                    }
                    
                    dayHTML += `</fieldset>`;
                    formContent.innerHTML += dayHTML;
                });
            } catch (error) {
                console.error("Erro ao abrir modal de edição:", error);
                showToast("Não foi possível carregar os dados do pedido.", 'error');
                modal.classList.add('hidden');
            }
        }

        async function saveOrderChanges(event) {
            event.preventDefault();
            const button = event.target.querySelector('button[type="submit"]');
            button.disabled = true; button.textContent = 'A salvar...';
            const docId = document.getElementById('edit-order-id').value;
            const updateData = {};
            
            weeklyMenu.forEach(item => {
                if (!item.isHoliday) {
                    const dayId = getDayId(item.day);
                    const selectedOption = document.querySelector(`#edit-order-form input[name="${dayId}"]:checked`);
                    if (selectedOption) { 
                        updateData[dayId] = selectedOption.value; 
                    }
                    const notes = document.getElementById(`edit-notes-${dayId}`).value.trim();
                    updateData[`${dayId}_notes`] = notes;
                }
            });

            try {
                await updateDoc(doc(db, "pedidosDaSemana", docId), updateData);
                showToast("Pedido atualizado com sucesso!", 'success');
                document.getElementById('edit-order-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar alterações do pedido:", error);
                showToast("Falha ao salvar as alterações do pedido.", 'error');
            } finally {
                button.disabled = false; button.textContent = 'Salvar Alterações';
            }
        }

        function deleteOrder(docId, name) {
            const message = `Tem a certeza que deseja excluir o pedido de ${name}? Esta ação não pode ser desfeita.`;
            showCustomConfirm(message, async () => {
                try {
                    await deleteDoc(doc(db, "pedidosDaSemana", docId));
                    showToast("Pedido excluído com sucesso.", 'success');
                } catch (error) {
                    console.error("Erro ao excluir pedido: ", error);
                    showToast("Falha ao excluir o pedido.", 'error');
                }
            });
        }

        const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result.split(',')[1]); reader.onerror = error => reject(error); });
        
        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('image-processor-container').classList.remove('hidden');
                document.getElementById('whatsapp-notification-container').classList.add('hidden');
            }
            reader.readAsDataURL(file);
        });

        document.getElementById('processImageBtn').addEventListener('click', async () => {
            if (typeof imageCompression === 'undefined') {
                showToast('Erro: Biblioteca de compressão não carregou.', 'error');
                return;
            }

            const loader = document.getElementById('loader'); const button = document.getElementById('processImageBtn'); const confirmationForm = document.getElementById('confirmation-form');
            button.disabled = true; button.textContent = 'A analisar...'; loader.classList.remove('hidden'); confirmationForm.classList.add('hidden');
            const file = document.getElementById('imageUpload').files[0]; 
            const options = { maxSizeMB: 1.5, maxWidthOrHeight: 1500, useWebWorker: true };
            try {
                const compressedFile = await imageCompression(file, options);
                const base64ImageData = await toBase64(compressedFile);
                
                const prompt = `Analise a imagem deste cardápio semanal. Extraia as informações para cada dia (Segunda a Sexta). Para cada dia, identifique o 'Prato Principal', a 'Opção' e a 'Guarnição'. Se o dia for um feriado, marque-o. Além disso, determine se o almoço é 'especial' (ex: uma refeição comemorativa, temática ou de maior qualidade) e defina o campo booleano 'isSpecial'. Retorne um objeto JSON seguindo esta estrutura: {"menu": [{"day": "Segunda-feira", "isHoliday": false, "isSpecial": false, "pratoPrincipal": {"name": "Nome", "emoji": "🍛"}, "opcao": {"name": "Nome", "emoji": "🍲"}, "guarnicao": {"name": "Nome", "emoji": "🥗"}}, ...]}. Se um campo não existir, retorne o nome como string vazia. Atribua emojis apropriados. O JSON deve ser a única coisa na resposta.`;

                const payload = { contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: compressedFile.type, data: base64ImageData } }] }] };
                const apiKey = firebaseConfig.apiKey;
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`; 

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const err = await response.json(); throw new Error(`API Error: ${err.error.message}`); }
                const result = await response.json();
                
                let textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResponse) { throw new Error("Resposta da IA vazia ou mal formatada."); }
                
                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                const menuData = JSON.parse(textResponse);

                if (!menuData || !Array.isArray(menuData.menu)) { throw new Error("Estrutura do JSON da IA inváĺida."); }
                
                displayConfirmationForm(menuData.menu);

            } catch (error) { 
                console.error("Erro ao processar IA:", error); showToast("Erro ao ler imagem com IA: " + error.message, 'error', 8000); 
            } finally { 
                button.disabled = false; button.textContent = 'Analisar Cardápio'; loader.classList.add('hidden'); 
            }
        });

        function displayConfirmationForm(menuData) {
            const container = document.getElementById('confirmation-form'); 
            container.innerHTML = '<h3 class="text-xl font-semibold mb-4">Confirme os Dados Extraídos</h3>';
            
            menuData.forEach((item, index) => {
                container.innerHTML += `<div class="p-4 bg-gray-50 rounded-lg mb-4">
                    <h4 class="font-bold">${item.day}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
                        <div><label class="block text-sm font-medium">Prato Principal</label><input type="text" id="prato-${index}" value="${item.pratoPrincipal.name || ''}" class="w-full border rounded p-1"></div>
                        <div><label class="block text-sm font-medium">Opção</label><input type="text" id="opcao-${index}" value="${item.opcao.name || ''}" class="w-full border rounded p-1"></div>
                        <div><label class="block text-sm font-medium">Guarnição</label><input type="text" id="guarnicao-${index}" value="${item.guarnicao.name || ''}" class="w-full border rounded p-1"></div>
                    </div>
                    <div class="mt-3 flex items-center space-x-6">
                        <label class="flex items-center"><input type="checkbox" id="holiday-${index}" ${item.isHoliday ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600"> <span class="ml-2 text-sm text-gray-900">Marcar como Feriado</span></label>
                        <label class="flex items-center"><input type="checkbox" id="special-${index}" ${item.isSpecial ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-purple-600"> <span class="ml-2 text-sm text-gray-900">✨ Almoço Especial</span></label>
                    </div>
                    </div>`;
            });
            container.innerHTML += `<div class="text-center mt-4"><button id="saveNewMenuBtn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Salvar Novo Cardápio</button><button type="button" id="cancelNewMenuBtn" class="w-full mt-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button></div>`;
            container.classList.remove('hidden'); 
            
            document.getElementById('saveNewMenuBtn').addEventListener('click', () => {
                const message = "Tem certeza que deseja salvar o novo cardápio? TODOS os pedidos da semana anterior serão excluídos permanentemente. Esta ação não pode ser desfeita.";
                showCustomConfirm(message, () => {
                    saveNewMenu(menuData);
                });
            });

            document.getElementById('cancelNewMenuBtn').addEventListener('click', () => {
                container.classList.add('hidden'); document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('image-processor-container').classList.add('hidden'); document.getElementById('imageUpload').value = ''; 
                showToast("Atualização cancelada.", 'info');
            });
        }
        
        async function clearAllOrders() {
            console.log("Iniciando a limpeza de todos os pedidos da semana...");
            const querySnapshot = await getDocs(pedidosCollectionRef);
            const deletionPromises = [];
            querySnapshot.forEach((doc) => {
                deletionPromises.push(deleteDoc(doc.ref));
            });
            await Promise.all(deletionPromises);
            console.log(`${deletionPromises.length} pedidos foram excluídos com sucesso.`);
        }

        async function saveNewMenu(menuData) {
            const button = document.getElementById('saveNewMenuBtn'); 
            const cancelButton = document.getElementById('cancelNewMenuBtn');
            button.disabled = true;
            cancelButton.disabled = true;
            button.textContent = 'A salvar...'; 

            const newMenu = menuData.map((item, i) => ({ 
                day: item.day, 
                pratoPrincipal: { name: document.getElementById(`prato-${i}`).value.trim(), emoji: '🍛' }, 
                opcao: { name: document.getElementById(`opcao-${i}`).value.trim(), emoji: '🍲' }, 
                guarnicao: { name: document.getElementById(`guarnicao-${i}`).value.trim(), emoji: '🥗' },
                isHoliday: document.getElementById(`holiday-${i}`).checked,
                isSpecial: document.getElementById(`special-${i}`).checked,
            })); 

            try { 
                await setDoc(menuDocRef, { menu: newMenu });
                await clearAllOrders();
                
                // Buscar imagens automaticamente para o novo cardápio
                weeklyMenu = newMenu; // Atualizar a variável global
                await searchImagesForMenu(true);
                
                // Atualizar o cardápio no Firebase com as imagens
                await setDoc(menuDocRef, { menu: weeklyMenu });
                
                showToast('Cardápio atualizado e pedidos zerados!', 'success'); 
                document.getElementById('confirmation-form').classList.add('hidden'); 
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('image-processor-container').classList.add('hidden'); 
                document.getElementById('imageUpload').value = ''; 
                document.getElementById('whatsapp-notification-container').classList.remove('hidden');
            } catch (error) { 
                console.error("Erro ao salvar o cardápio ou zerar pedidos:", error); 
                showToast("Erro ao salvar o novo cardápio.", 'error'); 
            } finally { 
                button.disabled = false; 
                cancelButton.disabled = false;
                button.textContent = 'Salvar Novo Cardápio'; 
            }
        }
        
        function handleWhatsAppNotification() {
            const message = `O cardápio da semana foi atualizado! ✨ Confira as delícias e faça seu pedido: ${window.location.href}`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            showToast('Abra o WhatsApp para enviar a notificação.', 'info');
        }

        // Sistema de busca automática de imagens via IA
        let foundImages = {};
        let imageCache = JSON.parse(localStorage.getItem('dishImageCache') || '{}');
        
        async function searchFoodImage(dishName, quality = 'medium', style = 'appetizing food') {
            try {
                // Verificar cache primeiro
                const cacheKey = `${dishName}-${quality}-${style}`;
                if (imageCache[cacheKey]) {
                    return imageCache[cacheKey];
                }
                
                // Busca otimizada para comida brasileira
                const searchQuery = `${dishName} comida brasileira prato delicioso`;
                const sizeParam = quality === 'small' ? 'small' : quality === 'large' ? 'large' : 'medium';
                
                // Simulando busca de imagem (em produção, usar API real como Unsplash, Pexels, etc.)
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(searchQuery)}&per_page=1&client_id=demo`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                }).catch(() => null);
                
                // Fallback para imagens de exemplo se a API não estiver disponível
                const fallbackImages = {
                    'small': 'https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=150&h=150&fit=crop',
                    'medium': 'https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=300&h=300&fit=crop',
                    'large': 'https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b?w=500&h=500&fit=crop'
                };
                
                if (response && response.ok) {
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const photo = data.results[0];
                        const imageUrl = quality === 'small' ? photo.urls.small : 
                                       quality === 'large' ? photo.urls.regular : photo.urls.small;
                        return {
                            url: imageUrl,
                            alt: photo.alt_description || dishName,
                            credit: photo.user.name
                        };
                    }
                }
                
                // Usar imagens de fallback de comida brasileira
                const brazilianFoodImages = [
                    'https://images.unsplash.com/photo-1565299624946-b28f40a0ca4b', // Feijoada
                    'https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445', // Arroz e feijão
                    'https://images.unsplash.com/photo-1546069901-ba9599a7e63c', // Carne
                    'https://images.unsplash.com/photo-1565958011703-44f9829ba187', // Frango
                    'https://images.unsplash.com/photo-1540189549336-e6e99c3679fe', // Peixe
                    'https://images.unsplash.com/photo-1565299507177-b0ac66763828', // Salada
                    'https://images.unsplash.com/photo-1555939594-58d7cb561ad1', // Massa
                    'https://images.unsplash.com/photo-1574484284002-952d92456975', // Coxinha
                    'https://images.unsplash.com/photo-1571091718767-18b5b1457add', // Pão de açúcar
                    'https://images.unsplash.com/photo-1563379091339-03246963d321'  // Açaí
                ];
                
                const hashCode = dishName.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0);
                
                const imageIndex = Math.abs(hashCode) % brazilianFoodImages.length;
                const baseUrl = brazilianFoodImages[imageIndex];
                const sizeQuery = quality === 'small' ? 'w=150&h=150' : 
                                quality === 'large' ? 'w=500&h=500' : 'w=300&h=300';
                
                const result = {
                    url: `${baseUrl}?${sizeQuery}&fit=crop`,
                    alt: dishName,
                    credit: 'Unsplash'
                };
                
                // Salvar no cache
                imageCache[cacheKey] = result;
                localStorage.setItem('dishImageCache', JSON.stringify(imageCache));
                
                return result;
                
            } catch (error) {
                console.error('Erro ao buscar imagem:', error);
                return null;
            }
        }
        
        async function searchImagesForMenu(showProgress = true) {
            const progressContainer = document.getElementById('image-search-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const statusIndicator = document.getElementById('ai-status-indicator');
            
            if (!weeklyMenu || weeklyMenu.length === 0) {
                return false;
            }
            
            if (showProgress) {
                progressContainer.classList.remove('hidden');
                showToast('🤖 Buscando imagens automaticamente...', 'info');
            } else {
                // Mostrar indicador silencioso
                if (statusIndicator) {
                    statusIndicator.classList.remove('hidden');
                }
            }
            
            const quality = document.getElementById('imageQuality')?.value || 'medium';
            const style = document.getElementById('imageStyle')?.value || 'appetizing food';
            
            let totalDishes = 0;
            let processedDishes = 0;
            let newImagesFound = 0;
            
            // Contar total de pratos que precisam de imagens (apenas pratos principais e opções)
            weeklyMenu.forEach(dayMenu => {
                if (!dayMenu.isHoliday) {
                    ['pratoPrincipal', 'opcao'].forEach(key => {
                        if (dayMenu[key]?.name && !dayMenu[key].image) {
                            totalDishes++;
                        }
                    });
                }
            });
            
            if (totalDishes === 0) {
                if (showProgress) {
                    progressContainer.classList.add('hidden');
                }
                return true; // Todos os pratos já têm imagens
            }
            
            // Buscar imagens para cada prato
            for (const dayMenu of weeklyMenu) {
                if (dayMenu.isHoliday) continue;
                
                const dishes = [
                    { key: 'pratoPrincipal', dish: dayMenu.pratoPrincipal },
                    { key: 'opcao', dish: dayMenu.opcao }
                ];
                
                for (const { key, dish } of dishes) {
                    if (dish?.name && !dish.image) {
                        if (showProgress) {
                            progressText.textContent = `Buscando: ${dish.name}`;
                        }
                        
                        const imageData = await searchFoodImage(dish.name, quality, style);
                        if (imageData) {
                            // Aplicar imagem diretamente ao prato
                            dish.image = imageData.url;
                            dish.imageAlt = imageData.alt;
                            newImagesFound++;
                        }
                        
                        processedDishes++;
                        if (showProgress) {
                            const progress = (processedDishes / totalDishes) * 100;
                            progressBar.style.width = `${progress}%`;
                        }
                        
                        // Pequeno delay para não sobrecarregar a API
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                }
            }
            
            if (showProgress) {
                progressText.textContent = 'Imagens aplicadas automaticamente!';
                
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 2000);
                
                if (newImagesFound > 0) {
                    showToast(`✨ ${newImagesFound} imagens aplicadas automaticamente!`, 'success');
                }
            } else {
                // Esconder indicador silencioso
                if (statusIndicator) {
                    statusIndicator.classList.add('hidden');
                }
            }
            
            return newImagesFound > 0;
        }
        
        function clearImageCache() {
            localStorage.removeItem('dishImageCache');
            imageCache = {};
            
            // Limpar imagens do cardápio atual (apenas pratos principais e opções)
            if (weeklyMenu) {
                weeklyMenu.forEach(dayMenu => {
                    if (!dayMenu.isHoliday) {
                        ['pratoPrincipal', 'opcao'].forEach(key => {
                            if (dayMenu[key]) {
                                delete dayMenu[key].image;
                                delete dayMenu[key].imageAlt;
                            }
                        });
                    }
                });
                
                // Buscar novas imagens automaticamente
                searchImagesForMenu(true).then(async (foundNew) => {
                    if (foundNew) {
                        try {
                            await setDoc(menuDocRef, { menu: weeklyMenu });
                            createMenuHTML();
                        } catch (error) {
                            console.error("Erro ao salvar novas imagens:", error);
                        }
                    }
                });
            }
            
            showToast('Cache de imagens limpo! Buscando novas imagens...', 'info');
        }


        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === APP_CONFIG.ADMIN_UID) {
                showAdminView();
            } else {
                if (!auth.currentUser) {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Erro no login anónimo:", error);
                        showToast("Não foi possível conectar-se. Verifique a sua ligação.", "error");
                    });
                }
                showUserView();
            }
        });

        function showUserView() {
            document.getElementById('user-view').classList.remove('hidden');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            loadAndDisplayMenu(); 
        }

        function showAdminView() {
            document.getElementById('user-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('admin-login-modal').classList.add('hidden');
            loadAndDisplayMenu(); 
            loadAdminData();
            loadAndRenderEmployees();
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = 'Entrando...';
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (userCredential.user.uid !== APP_CONFIG.ADMIN_UID) {
                    await signOut(auth);
                    showToast("Credenciais válidas, mas este usuário não é um administrador.", 'error');
                }
            } catch (error) {
                console.error("Erro no login de administrador:", error);
                const msg = (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') ? "Email ou senha incorretos." : "Ocorreu um erro no login.";
                showToast(msg, 'error', 5000);
            } finally {
                btn.disabled = false; btn.textContent = 'Entrar';
            }
        }

        async function handleAdminLogout() {
            try { await signOut(auth); showToast("Logout de administrador bem-sucedido!", 'info'); } 
            catch (error) { console.error("Erro no logout:", error); showToast("Erro ao fazer logout.", 'error'); }
        }

        function main() {
            const rgfInput = document.getElementById('employeeRGF');
            rgfInput.value = localStorage.getItem('employeeRGF') || '';
            if(rgfInput.value) { findEmployeeByRGF(rgfInput.value); }
            rgfInput.addEventListener('blur', (e) => { localStorage.setItem('employeeRGF', e.target.value); findEmployeeByRGF(e.target.value); });
            rgfInput.addEventListener('input', validateForm);
            
            document.getElementById('menu').addEventListener('change', validateForm);
            document.getElementById('openConfirmationModal').addEventListener('click', openConfirmationModal);
            document.getElementById('submitOrder').addEventListener('click', submitOrder);
            
            document.querySelectorAll('.cancel-modal-btn, #custom-confirm-cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.add('hidden'));
            });

            document.getElementById('switchToAdmin').addEventListener('click', () => document.getElementById('admin-login-modal').classList.remove('hidden'));
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            
            document.getElementById('adminLogoutBtn').addEventListener('click', handleAdminLogout);
            document.getElementById('switchToUserFromAdmin').addEventListener('click', showUserView);
            
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('employee-list-container').addEventListener('click', (e) => {
                if (e.target.closest('.edit-employee-btn')) { openEmployeeEditModal(e.target.closest('.edit-employee-btn').dataset.id, e.target.closest('.edit-employee-btn').dataset.name); }
                if (e.target.closest('.delete-employee-btn')) { handleDeleteEmployee(e.target.closest('.delete-employee-btn').dataset.id, e.target.closest('.delete-employee-btn').dataset.name); }
            });
            document.getElementById('edit-employee-form').addEventListener('submit', handleSaveEmployeeChanges);
            
            document.getElementById('searchInput').addEventListener('input', () => renderOrdersTable(allOrders));
            document.getElementById('generateReportBtn').addEventListener('click', generateAndPrintReport);
            
            document.getElementById('ordersTableContainer').addEventListener('click', function(e) {
                if (e.target.closest('.edit-order-btn')) { openOrderEditModal(e.target.closest('.edit-order-btn').dataset.id); }
                if (e.target.closest('.delete-order-btn')) { deleteOrder(e.target.closest('.delete-order-btn').dataset.id, e.target.closest('.delete-order-btn').dataset.name); }
            });
            document.getElementById('edit-order-form').addEventListener('submit', saveOrderChanges);
            
            document.getElementById('notifyWhatsAppBtn').addEventListener('click', handleWhatsAppNotification);
            
            // Event listener para limpar cache de imagens
            document.getElementById('clearImageCache').addEventListener('click', clearImageCache);
        }

        main();
    </script>
</body>
</html>
