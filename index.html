<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Marmitas - Com Painel Adm</title>
    <style>
        :root {
            --primary: #4a69bd; /* Azul Profundo */
            --secondary: #6a89cc;
            --accent: #f6b93b; /* Amarelo */
            --danger: #e55039;
            --dark: #1e3799;
            --light: #f8f9fa;
            --success: #38ada9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef2f3;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Navega√ß√£o / Abas */
        .nav-tabs {
            display: flex;
            background: white;
            padding: 5px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .nav-btn {
            padding: 10px 25px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 25px;
            font-weight: 600;
            color: #777;
            transition: 0.3s;
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(74, 105, 189, 0.3);
        }

        /* Container Principal */
        .main-container {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            min-height: 400px;
        }

        /* --- Estilos do Wizard (Usu√°rio) --- */
        .wizard-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.3);
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.4s ease;
        }

        .wizard-body {
            padding: 30px;
        }

        .step-title {
            font-size: 1.4em;
            color: var(--dark);
            text-align: center;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .step-subtitle {
            text-align: center;
            color: #7f8fa6;
            margin-bottom: 25px;
            font-size: 0.9em;
        }

        /* Cart√µes de Op√ß√£o */
        .option-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
        }

        .option-card:hover { border-color: var(--secondary); background: #fdfdfd; }
        .option-card.selected {
            border-color: var(--primary);
            background-color: #f0f6ff;
        }
        .option-card input { display: none; }

        .btn-action {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }

        .btn-next { background: var(--primary); color: white; }
        .btn-prev { background: #dfe4ea; color: #555; }
        .btn-next:hover { background: var(--dark); }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* --- Estilos do Admin --- */
        #adminPanel {
            padding: 20px;
            display: none; /* Oculto por padr√£o */
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .config-area {
            background: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 20px;
            border: 1px solid #ffeeba;
        }

        .config-area input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th { background: var(--primary); color: white; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background-color: #f9f9f9; }

        .badge-total {
            background: var(--success);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .btn-sm {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
        }
        .btn-edit { background: var(--accent); color: #333; }
        .btn-del { background: var(--danger); color: white; }

        /* Estado: Editando (Aviso Visual) */
        .editing-banner {
            background: var(--accent);
            color: #333;
            text-align: center;
            padding: 5px;
            font-size: 0.8em;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="mudarAba('usuario')" id="tabUser">Fazer Pedido</button>
        <button class="nav-btn" onclick="mudarAba('admin')" id="tabAdmin">Administra√ß√£o</button>
    </div>

    <div class="main-container">
        <div id="editingBanner" class="editing-banner">‚ö†Ô∏è MODO DE EDI√á√ÉO ADMINISTRATIVA</div>

        <div id="userPanel">
            <div class="wizard-header">
                <h2 style="margin:0">Marmita Express</h2>
                <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
            </div>

            <div class="wizard-body" id="wizardContent">
                </div>
        </div>

        <div id="adminPanel">
            <div class="admin-header">
                <h3 style="margin:0; color: var(--primary)">Gerenciamento</h3>
                <button onclick="renderAdminTable()" class="btn-sm btn-edit">üîÑ Atualizar</button>
            </div>

            <div class="config-area">
                <strong>Configura√ß√µes Globais</strong><br>
                <label>Data In√≠cio:</label>
                <input type="date" id="startDate" onchange="reiniciarSistema()">
                <label>Feriados (DD/MM/AAAA):</label>
                <input type="text" id="feriadosInput" value="25/12/2026, 01/01/2027" placeholder="Ex: 15/11/2024" onchange="reiniciarSistema()">
            </div>

            <div style="overflow-x: auto;">
                <table id="tabelaPedidos">
                    <thead>
                        <tr>
                            <th>Funcion√°rio</th>
                            <th>Total</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyPedidos">
                        </tbody>
                </table>
            </div>
            <div id="emptyMsg" style="text-align:center; color:#999; margin-top:20px; display:none;">
                Nenhum pedido realizado.
            </div>
        </div>
    </div>

<script>
    // --- ESTADO GLOBAL ---
    let pedidosSalvos = []; // Banco de dados em mem√≥ria
    let pedidoAtual = {};   // O pedido sendo preenchido no momento
    let currentStep = 0;    // Passo atual do Wizard
    let diasCalculados = [];
    let modoEdicaoAdmin = false; // Flag para saber se √© o admin editando

    // Inicializa√ß√£o
    document.getElementById('startDate').valueAsDate = new Date();
    
    // --- FUN√á√ïES AUXILIARES ---
    function formatarData(date) {
        return date.toLocaleDateString('pt-BR');
    }

    function getFeriados() {
        const val = document.getElementById('feriadosInput').value;
        if (!val) return [];
        return val.split(',').map(s => s.trim());
    }

    function calcularDias() {
        const inputData = document.getElementById('startDate').value;
        const inicio = new Date(inputData);
        inicio.setMinutes(inicio.getMinutes() + inicio.getTimezoneOffset());
        
        const nomes = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta'];
        const dias = [];
        
        for(let i=0; i<5; i++) {
            const d = new Date(inicio);
            d.setDate(inicio.getDate() + i);
            dias.push({
                nome: nomes[i],
                dataStr: formatarData(d)
            });
        }
        return dias;
    }

    // --- CONTROLE DE ABAS ---
    function mudarAba(aba) {
        // Reset visual
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('userPanel').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';

        if (aba === 'usuario') {
            document.getElementById('tabUser').classList.add('active');
            document.getElementById('userPanel').style.display = 'block';
            
            // Se N√ÉO estivermos no meio de uma edi√ß√£o de admin, reseta para um novo pedido
            if (!modoEdicaoAdmin) {
                iniciarNovoPedido();
            }
        } else {
            document.getElementById('tabAdmin').classList.add('active');
            document.getElementById('adminPanel').style.display = 'block';
            
            // Se sair para admin, cancela qualquer edi√ß√£o pendente
            if (modoEdicaoAdmin) cancelarEdicaoAdmin();
            renderAdminTable();
        }
    }

    // --- WIZARD (L√ìGICA PRINCIPAL) ---

    function iniciarNovoPedido() {
        modoEdicaoAdmin = false;
        document.getElementById('editingBanner').style.display = 'none';
        
        pedidoAtual = {
            id: null,
            cliente: '',
            itens: [],
            total: 0
        };
        currentStep = 0;
        diasCalculados = calcularDias();
        renderStep();
    }

    function reiniciarSistema() {
        diasCalculados = calcularDias();
        // Se estiver na aba admin, atualiza tabela, se usuario, reinicia wizard
        if(document.getElementById('adminPanel').style.display === 'block') {
            renderAdminTable();
        } else {
            iniciarNovoPedido();
        }
    }

    function renderStep() {
        const container = document.getElementById('wizardContent');
        const feriados = getFeriados();

        // 1. Passo: Nome
        if (currentStep === 0) {
            atualizarBarra(0);
            container.innerHTML = `
                <div class="step-title">Identifica√ß√£o</div>
                <div class="step-subtitle">Quem est√° pedindo?</div>
                <input type="text" id="inputNome" placeholder="Nome Completo" value="${pedidoAtual.cliente}" 
                    style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em; box-sizing:border-box;">
                <div class="controls">
                    <button class="btn-action btn-next" onclick="proximoPasso()">Iniciar Pedido</button>
                </div>
            `;
            return;
        }

        // 2. Passos: Dias da Semana (1 a 5)
        const diaIndex = currentStep - 1;
        
        if (diaIndex >= 5) {
            renderResumo();
            return;
        }

        const diaInfo = diasCalculados[diaIndex];

        // --- L√ìGICA DE FERIADO ---
        if (feriados.includes(diaInfo.dataStr)) {
            // Salva automaticamente como Feriado
            salvarItem(diaInfo, 'Feriado', '', 0);
            
            // Recursividade: Avan√ßa o contador E chama a fun√ß√£o de novo
            currentStep++;
            renderStep();
            return; // Para a execu√ß√£o deste frame
        }

        // Renderiza Dia Normal
        atualizarBarra((currentStep / 5) * 100);
        
        // Recupera sele√ß√£o anterior se houver (para edi√ß√£o)
        const itemExistente = pedidoAtual.itens.find(i => i.dia === diaInfo.nome) || {};
        const pratoSel = itemExistente.prato || '';
        const obsSel = itemExistente.obs || '';

        container.innerHTML = `
            <div class="step-title">${diaInfo.nome}</div>
            <div class="step-subtitle">${diaInfo.dataStr}</div>

            <label class="option-card ${pratoSel === 'Tradicional' ? 'selected' : ''}" onclick="selecionarOpcao(this)">
                <div><strong>üçõ Tradicional</strong> <br><small style="color:#666">Arroz, feij√£o, prote√≠na</small></div>
                <div>R$ 20</div>
                <input type="radio" name="prato" value="Tradicional" ${pratoSel === 'Tradicional' ? 'checked' : ''}>
            </label>

            <label class="option-card ${pratoSel === 'Fitness' ? 'selected' : ''}" onclick="selecionarOpcao(this)">
                <div><strong>ü•ó Fitness</strong> <br><small style="color:#666">Legumes, frango grelhado</small></div>
                <div>R$ 22</div>
                <input type="radio" name="prato" value="Fitness" ${pratoSel === 'Fitness' ? 'checked' : ''}>
            </label>

            <label class="option-card ${pratoSel === '' ? 'selected' : ''}" onclick="selecionarOpcao(this)">
                <div><strong>‚ùå N√£o pedir</strong></div>
                <div>R$ 0</div>
                <input type="radio" name="prato" value="" ${pratoSel === '' ? 'checked' : ''}>
            </label>

            <input type="text" id="inputObs" placeholder="Observa√ß√£o (Ex: Sem cebola)" value="${obsSel}"
                style="width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing:border-box;">

            <div class="controls">
                <button class="btn-action btn-prev" onclick="passoAnterior()">Voltar</button>
                <button class="btn-action btn-next" onclick="proximoPasso()">Pr√≥ximo</button>
            </div>
        `;
    }

    function renderResumo() {
        atualizarBarra(100);
        
        const total = pedidoAtual.itens.reduce((acc, i) => acc + (i.valor || 0), 0);
        pedidoAtual.total = total;

        let listaHtml = pedidoAtual.itens
            .filter(i => i.prato && i.prato !== 'Feriado') // N√£o mostra vazios ou feriados no resumo
            .map(i => `
                <li style="margin-bottom: 5px;">
                    <b>${i.dia}:</b> ${i.prato} 
                    ${i.obs ? `<span style="color:#e55039">(${i.obs})</span>` : ''}
                </li>
            `).join('');

        if(listaHtml === '') listaHtml = '<p>Nenhum prato selecionado.</p>';
        else listaHtml = `<ul style="padding-left: 20px;">${listaHtml}</ul>`;

        const btnTexto = modoEdicaoAdmin ? 'üíæ Salvar Altera√ß√µes' : '‚úÖ Finalizar Pedido';

        document.getElementById('wizardContent').innerHTML = `
            <div class="step-title">Confirma√ß√£o</div>
            <div class="step-subtitle">Verifique os dados</div>
            
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
                <strong>Funcion√°rio:</strong> ${pedidoAtual.cliente} <br>
                ${listaHtml}
                <hr style="border:0; border-top:1px dashed #ccc;">
                <h3 style="text-align:right; margin:0; color:var(--primary)">Total: R$ ${total},00</h3>
            </div>

            <div class="controls">
                <button class="btn-action btn-prev" onclick="passoAnterior()">Voltar</button>
                <button class="btn-action btn-next" onclick="finalizarPedido()">${btnTexto}</button>
            </div>
        `;
    }

    // --- CONTROLES DO WIZARD ---

    function selecionarOpcao(el) {
        document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        el.querySelector('input').checked = true;
    }

    function salvarItem(diaInfo, prato, obs, valor) {
        // Remove entrada anterior se houver
        pedidoAtual.itens = pedidoAtual.itens.filter(i => i.dia !== diaInfo.nome);
        // Adiciona nova
        pedidoAtual.itens.push({
            dia: diaInfo.nome,
            data: diaInfo.dataStr,
            prato: prato,
            obs: obs,
            valor: valor
        });
    }

    function proximoPasso() {
        // Passo 0: Valida√ß√£o de Nome
        if (currentStep === 0) {
            const nome = document.getElementById('inputNome').value;
            if(!nome.trim()) { alert('Digite o nome!'); return; }
            pedidoAtual.cliente = nome;
            currentStep++;
            renderStep();
            return;
        }

        // Passos de Dia: Coleta dados
        const radio = document.querySelector('input[name="prato"]:checked');
        const obs = document.getElementById('inputObs').value;
        const diaInfo = diasCalculados[currentStep - 1];

        let prato = radio ? radio.value : '';
        let valor = 0;
        if(prato === 'Tradicional') valor = 20;
        if(prato === 'Fitness') valor = 22;

        salvarItem(diaInfo, prato, obs, valor);

        currentStep++;
        renderStep();
    }

    function passoAnterior() {
        if (currentStep > 0) {
            currentStep--;
            // Se voltar para um dia que √© feriado, volta mais um (recursivo)
            const diaIndex = currentStep - 1;
            if (diaIndex >= 0) {
                 const diaInfo = diasCalculados[diaIndex];
                 if (getFeriados().includes(diaInfo.dataStr)) {
                     passoAnterior();
                     return;
                 }
            }
            renderStep();
        }
    }

    function atualizarBarra(pct) {
        document.getElementById('progressBar').style.width = pct + '%';
    }

    function finalizarPedido() {
        if (pedidoAtual.id) {
            // Atualizar Existente
            const index = pedidosSalvos.findIndex(p => p.id === pedidoAtual.id);
            if (index !== -1) pedidosSalvos[index] = pedidoAtual;
            alert('Pedido atualizado com sucesso!');
        } else {
            // Criar Novo
            pedidoAtual.id = Date.now();
            pedidosSalvos.push(pedidoAtual);
            alert('Pedido realizado!');
        }

        // Decis√£o de Roteamento
        if (modoEdicaoAdmin) {
            // Se o admin estava editando, volta para a aba admin
            mudarAba('admin');
        } else {
            // Se for usu√°rio normal, reinicia para o pr√≥ximo
            iniciarNovoPedido();
        }
    }

    // --- FUN√á√ïES DE ADMINISTRA√á√ÉO ---

    function renderAdminTable() {
        const tbody = document.getElementById('tbodyPedidos');
        const emptyMsg = document.getElementById('emptyMsg');
        tbody.innerHTML = '';

        if (pedidosSalvos.length === 0) {
            emptyMsg.style.display = 'block';
            return;
        }
        emptyMsg.style.display = 'none';

        pedidosSalvos.forEach(p => {
            const tr = document.createElement('tr');
            
            // Resumo curto dos pratos
            const resumo = p.itens
                .filter(i => i.prato && i.prato !== 'Feriado')
                .map(i => i.dia.substring(0,3)) // Seg, Ter...
                .join(', ');

            tr.innerHTML = `
                <td>
                    <strong>${p.cliente}</strong><br>
                    <small style="color:#777">${resumo || 'Sem pratos'}</small>
                </td>
                <td><span class="badge-total">R$ ${p.total}</span></td>
                <td>
                    <button class="btn-sm btn-edit" onclick="adminEditarPedido(${p.id})">‚úèÔ∏è Editar</button>
                    <button class="btn-sm btn-del" onclick="adminExcluirPedido(${p.id})">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function adminExcluirPedido(id) {
        if(confirm('Tem certeza que deseja excluir este pedido?')) {
            pedidosSalvos = pedidosSalvos.filter(p => p.id !== id);
            renderAdminTable();
        }
    }

    // *** AQUI EST√Å A L√ìGICA DE EDI√á√ÉO DO ADMIN ***
    function adminEditarPedido(id) {
        const pedido = pedidosSalvos.find(p => p.id === id);
        if (!pedido) return;

        // 1. Clona o pedido para a vari√°vel de edi√ß√£o
        // Importante usar JSON.parse/stringify para quebrar refer√™ncia direta
        pedidoAtual = JSON.parse(JSON.stringify(pedido));
        
        // 2. Define o modo Admin
        modoEdicaoAdmin = true;
        
        // 3. Atualiza interface
        diasCalculados = calcularDias(); // Garante datas frescas
        
        // Muda para a aba de usu√°rio visualmente para usar o Wizard
        document.getElementById('tabUser').classList.add('active');
        document.getElementById('tabAdmin').classList.remove('active');
        document.getElementById('userPanel').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
        
        // Mostra banner de aviso
        document.getElementById('editingBanner').style.display = 'block';

        // 4. Inicia Wizard no passo 0 (Nome) ou 1? Vamos no 0 para permitir corrigir nome.
        currentStep = 0;
        renderStep();
    }

    function cancelarEdicaoAdmin() {
        modoEdicaoAdmin = false;
        document.getElementById('editingBanner').style.display = 'none';
        iniciarNovoPedido();
    }

    // Inicia a app
    iniciarNovoPedido();

</script>
</body>
</html>
